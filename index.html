<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RevisionVault Pro - University Study Materials</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <style>
        :root {
            --primary: #1a2980;
            --secondary: #26d0ce;
            --accent: #ff4081;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            padding-bottom: 100px;
        }

        /* Fixed Header Container */
        .header-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        /* Logo Section */
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .logo-icon {
            background: rgba(255, 255, 255, 0.9);
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 22px;
            box-shadow: var(--shadow);
        }

        .logo-text h1 {
            font-size: 22px;
            margin-bottom: 2px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: white;
        }

        .logo-text p {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-shrink: 0;
        }

        .price-tag, .contact-number {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        /* Search Bar */
        .search-container {
            flex: 1;
            max-width: 600px;
            position: relative;
        }

        .search-box {
            width: 100%;
            padding: 14px 20px;
            padding-left: 45px;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.8);
        }

        .search-box:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
        }

        /* Search Suggestions */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
            border: 2px solid #e2e8f0;
        }

        .search-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .suggestion-item:hover {
            background: #f1f5f9;
        }

        .suggestion-code {
            font-weight: 700;
            color: var(--primary);
            font-size: 14px;
        }

        .suggestion-title {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Main Container */
        .main-container {
            margin-top: 100px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            min-height: calc(100vh - 180px);
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            min-height: 600px;
        }

        /* Left Sidebar */
        .sidebar-left {
            background: var(--light);
            padding: 25px 20px;
            border-right: 1px solid #e2e8f0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 700;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .tool-card {
            background: var(--card-bg);
            padding: 18px 12px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tool-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .tool-icon {
            font-size: 22px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .tool-name {
            font-size: 12px;
            font-weight: 700;
            color: var(--dark);
        }

        .timetable {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
        }

        .week-display {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            margin-bottom: 5px;
        }

        .date-range {
            color: #64748b;
            text-align: center;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }

        .schedule-item {
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
        }

        .time {
            font-weight: 700;
            color: var(--primary);
            font-size: 12px;
        }

        .subject {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .ai-chat-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent), #f50057);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        /* Main Content */
        .main-content {
            padding: 25px;
            background: white;
            overflow-y: auto;
            height: calc(100vh - 180px);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .main-title {
            font-size: 24px;
            color: var(--primary);
            font-weight: 800;
        }

        .filters {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-select {
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            color: var(--dark);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 140px;
        }

        /* Registration Success Banner */
        .registration-success-banner {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border: 3px solid var(--success);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        .registration-success-banner.active {
            display: flex;
        }

        .registration-success-banner h3 {
            color: #065f46;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .registration-success-banner p {
            color: #047857;
            margin-bottom: 20px;
            max-width: 500px;
        }

        /* Access Status */
        .access-status {
            background: linear-gradient(135deg, #ffeaea, #ffc9c9);
            border: 3px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .access-granted {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-color: var(--success);
        }

        /* Quick Unit Codes */
        .quick-units {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .unit-chip {
            background: #e0f2fe;
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .unit-chip:hover {
            background: var(--primary);
            color: white;
        }

        /* Search Results */
        .search-results {
            display: none;
            margin-top: 20px;
        }

        .search-results.active {
            display: block;
        }

        /* Materials Grid */
        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }

        .material-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            position: relative;
        }

        .material-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .material-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: linear-gradient(135deg, var(--accent), #f50057);
            color: white;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 1px;
            z-index: 1;
        }

        .material-badge.trending {
            background: linear-gradient(135deg, var(--warning), #f97316);
        }

        .material-badge.recent {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .material-image {
            height: 160px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.2);
            font-size: 60px;
            position: relative;
        }

        .material-content {
            padding: 20px;
        }

        .material-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .material-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .material-code {
            background: #e0f2fe;
            padding: 5px 12px;
            border-radius: 50px;
            color: var(--primary);
            font-weight: 800;
            font-size: 12px;
        }

        .material-year {
            background: #fee2e2;
            padding: 5px 12px;
            border-radius: 50px;
            color: var(--danger);
            font-weight: 800;
            font-size: 12px;
        }

        .material-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .material-description {
            color: #64748b;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 18px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .material-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .view-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 41, 128, 0.3);
        }

        .preview-btn {
            background: #f1f5f9;
            color: var(--dark);
            border: 2px solid #e2e8f0;
        }

        /* Right Sidebar */
        .sidebar-right {
            background: var(--light);
            padding: 25px 20px;
            border-left: 1px solid #e2e8f0;
            height: calc(100vh - 180px);
            overflow-y: auto;
        }

        .category-list {
            list-style: none;
            margin-bottom: 25px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--card-bg);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }

        .category-item:hover {
            background: #f1f5f9;
            border-color: var(--primary);
        }

        .category-name {
            font-weight: 700;
            color: var(--dark);
            font-size: 13px;
        }

        .category-count {
            background: #e0f2fe;
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 800;
            color: var(--primary);
        }

        .university-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .university-card {
            background: var(--card-bg);
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .university-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .university-logo {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: 800;
            font-size: 14px;
        }

        .premium-banner {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            margin-top: 25px;
            box-shadow: var(--shadow);
        }

        .premium-title {
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .premium-price {
            font-size: 32px;
            font-weight: 800;
            margin: 10px 0;
        }

        .premium-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .premium-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* RAISED Bottom Navigation - MODIFIED: Only 5 buttons */
        .bottom-nav {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 50px;
            padding: 12px 25px;
            display: flex;
            gap: 10px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            border: 2px solid #e2e8f0;
            min-width: 580px;
            justify-content: space-around;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 12px 18px;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 13px;
            color: #64748b;
            transition: all 0.3s;
            min-width: 90px;
            justify-content: center;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 8px 20px rgba(26, 41, 128, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 15px;
            color: #64748b;
            border-top: 1px solid #e2e8f0;
            background: var(--light);
            font-size: 13px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 41, 128, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            color: #495057;
            transition: all 0.3s;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 41, 128, 0.1);
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(26, 41, 128, 0.3);
        }

        /* University Button */
        .university-browse-btn {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.3);
            margin-top: 20px;
        }

        .university-browse-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.4);
            background: linear-gradient(135deg, #6d28d9, #5b21b6);
        }

        .university-browse-btn.small {
            padding: 10px 20px;
            font-size: 14px;
        }

        /* Upload Button */
        .upload-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669, #047857);
        }

        /* Admin Panel Styles */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-section {
            display: none;
        }

        .admin-list {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* FIXED PDF VIEWER MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 2000;
            padding: 0;
        }

        .modal.active {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: transparent;
            border-radius: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            box-shadow: none;
        }

        .modal-header {
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            height: 60px;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .close-modal {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .modal-body {
            padding: 0;
            margin: 0;
            height: 100vh;
            position: relative;
            padding-top: 60px;
        }

        /* SIMPLE PDF VIEWER */
        .pdf-viewer-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #000;
        }

        .pdf-viewer-frame {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
            background: white;
        }

        .pdf-viewer-frame.active {
            display: block;
        }

        /* PDF Loading State */
        .pdf-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #000;
            color: white;
            text-align: center;
            padding: 40px;
        }

        .pdf-loading i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.8;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .pdf-loading h3 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .pdf-loading p {
            opacity: 0.8;
            max-width: 400px;
            line-height: 1.6;
        }

        .pdf-error {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #000;
            color: white;
            text-align: center;
            padding: 40px;
        }

        .pdf-error i {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .pdf-error h3 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .pdf-error p {
            opacity: 0.9;
            max-width: 400px;
            line-height: 1.6;
        }

        /* University List Modal */
        .university-list-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2002;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }

        .university-list-modal.active {
            display: block;
        }

        .university-list-content {
            background: white;
            border-radius: var(--radius);
            max-width: 800px;
            margin: 50px auto;
            padding: 25px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .university-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .university-list-title {
            font-size: 24px;
            color: var(--primary);
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .university-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .university-list-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .university-list-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .university-list-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-weight: 800;
            font-size: 18px;
        }

        .university-list-name {
            font-weight: 700;
            color: var(--dark);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .university-list-count {
            background: #e0f2fe;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 800;
            color: var(--primary);
            display: inline-block;
        }

        /* Admin Approval Styles */
        .admin-approval-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .approve-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .approve-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .reject-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .reject-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        .send-whatsapp-btn {
            background: linear-gradient(135deg, #25d366, #128C7E);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 5px;
        }

        .send-whatsapp-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            margin-left: 10px;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-active {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-expired {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .quick-action-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            color: var(--dark);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 3px;
            background: #e2e8f0;
            z-index: 1;
        }

        .progress-step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            color: #64748b;
        }

        .step-circle.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 120px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: none;
            z-index: 2001;
            max-width: 300px;
            border-left: 5px solid var(--success);
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .notification.show {
            display: block;
            transform: translateX(0);
        }

        /* Upload Instructions */
        .upload-instructions {
            background: #f0f9ff;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .upload-instructions h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instruction-step {
            display: flex;
            align-items: start;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content h4 {
            color: var(--dark);
            margin-bottom: 5px;
        }

        .step-content p {
            color: #64748b;
            font-size: 14px;
            line-height: 1.5;
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            margin: 10px 0;
            overflow-x: auto;
        }

        /* Copy Button */
        .copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .copy-btn.copied {
            background: #10b981;
        }

        /* Account Number Display */
        .account-number-display {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 3px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .account-number {
            font-size: 24px;
            font-weight: bold;
            color: #92400e;
            letter-spacing: 2px;
            margin: 10px 0;
        }

        /* Backup Button Styles */
        .backup-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .backup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        /* JSON Upload Styles */
        .json-upload-zone {
            border: 3px dashed #7c3aed;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(124, 58, 237, 0.05);
        }

        .json-upload-zone:hover {
            background: rgba(124, 58, 237, 0.1);
            border-color: #6d28d9;
        }

        .json-upload-zone.dragover {
            background: rgba(124, 58, 237, 0.2);
            border-color: #5b21b6;
            transform: scale(1.02);
        }

        .json-document-preview {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            background: #f8fafc;
        }

        .json-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .json-stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .json-stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .json-stat-label {
            font-size: 12px;
            color: #64748b;
        }

        /* Drag and drop animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .json-upload-zone.dragover {
            animation: pulse 1s infinite;
        }

        /* NEW: Statistics Card Styles */
        .stats-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .stats-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stats-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--dark);
        }

        .stats-change {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 20px;
            margin-left: 10px;
        }

        .stats-change.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .stats-change.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .stats-details {
            font-size: 13px;
            color: #64748b;
            margin-top: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .university-stats-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .university-stats-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .university-stats-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            flex-shrink: 0;
        }

        .university-stats-info {
            flex: 1;
        }

        .university-stats-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .university-stats-count {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stats-chart {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .chart-bar {
            height: 30px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 5px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            transition: width 1s ease-in-out;
        }

        .chart-label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: 600;
            font-size: 12px;
            z-index: 1;
        }

        .chart-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: 600;
            font-size: 12px;
            z-index: 1;
        }

        /* NEW: Document Management Button Styles */
        .doc-management-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .doc-management-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
        }

        /* NEW: Admin Document Management Section */
        .doc-management-section {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8fafc;
        }

        .doc-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .doc-edit-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .doc-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }

        .doc-view-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .doc-view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        /* Material Type Badge */
        .material-type {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Firebase Connection Status */
        .firebase-status {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: var(--light);
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 999;
        }

        .firebase-status.connected {
            border-color: var(--success);
            background: #d1fae5;
        }

        .firebase-status.disconnected {
            border-color: var(--danger);
            background: #fee2e2;
        }

        /* Login Message */
        .login-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .login-message.success {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
        }

        .login-message.error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .sidebar-left, .sidebar-right {
                display: none;
            }
            .main-content {
                height: auto;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .search-container {
                width: 100%;
                max-width: 100%;
            }
            
            .main-container {
                margin-top: 140px;
            }
            
            /* Mobile Bottom Navigation */
            .bottom-nav {
                bottom: 30px;
                min-width: 95%;
                padding: 10px 15px;
                gap: 5px;
            }
            
            .nav-btn {
                min-width: auto;
                padding: 10px 12px;
                font-size: 11px;
            }
            
            .nav-btn span {
                display: none;
            }
            
            .materials-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                width: 100%;
            }
            
            .filter-select {
                width: 100%;
            }
            
            .main-content {
                height: auto;
                padding: 15px;
            }
            
            .sidebar-right {
                height: auto;
            }
            
            /* Mobile Document Viewer */
            .modal-header {
                padding: 12px 15px;
                height: 55px;
            }
            
            .modal-title {
                font-size: 16px;
                max-width: 65%;
            }
            
            .close-modal {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .modal-body {
                padding-top: 55px;
            }
            
            .pdf-loading i,
            .pdf-error i {
                font-size: 50px;
            }
            
            .pdf-loading h3,
            .pdf-error h3 {
                font-size: 20px;
            }
            
            .progress-steps {
                flex-direction: column;
                gap: 20px;
            }
            
            .progress-steps::before {
                display: none;
            }
            
            .progress-step {
                width: 100%;
                text-align: left;
                display: flex;
                align-items: center;
                gap: 15px;
            }
            
            .step-circle {
                margin: 0;
                flex-shrink: 0;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Small Mobile */
        @media (max-width: 480px) {
            .bottom-nav {
                bottom: 25px;
                padding: 8px 10px;
                min-width: 98%;
            }
            
            .nav-btn {
                padding: 8px 10px;
                min-width: 50px;
            }
            
            .nav-btn i {
                font-size: 14px;
            }
            
            .modal-header {
                padding: 10px 12px;
                height: 50px;
            }
            
            .modal-title {
                font-size: 14px;
                max-width: 60%;
            }
            
            .close-modal {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .modal-body {
                padding-top: 50px;
            }
            
            .university-list-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
            
            .doc-action-buttons {
                flex-direction: column;
            }
        }

        /* Animation for cards */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .material-card {
            animation: slideUp 0.3s ease-out;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <div class="header-container">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="logo-text">
                    <h1>RevisionVault Pro</h1>
                    <p>University Study Materials Platform</p>
                </div>
            </div>
            
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-box" placeholder="Search by Unit Code e.g AGRO222" id="searchInput">
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
            
            <div class="header-actions">
                <div class="price-tag">
                    <i class="fas fa-crown"></i>
                    <span>Ksh 67 for 5 Months</span>
                </div>
                <div class="contact-number">
                    <i class="fas fa-phone-alt"></i>
                    <span>0765 098 865</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Connection Status -->
    <div class="firebase-status" id="firebaseStatus">
        <i class="fas fa-circle" id="firebaseStatusIcon"></i>
        <span id="firebaseStatusText">Connecting to server...</span>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <div class="main-layout">
            <!-- Left Sidebar -->
            <aside class="sidebar-left">
                <div class="section-title">
                    <i class="fas fa-tools"></i>
                    <span>POWERFUL Study Tools</span>
                </div>
                <div class="tools-grid">
                    <div class="tool-card" onclick="showNotification('StudyList', 'StudyList feature coming soon!')">
                        <div class="tool-icon"><i class="fas fa-list"></i></div>
                        <div class="tool-name">STUDYLIST</div>
                    </div>
                    <div class="tool-card" onclick="showNotification('Reminders', 'Reminders feature coming soon!')">
                        <div class="tool-icon"><i class="fas fa-bell"></i></div>
                        <div class="tool-name">REMINDERS</div>
                    </div>
                    <div class="tool-card" onclick="showNotification('Notes', 'Notes feature coming soon!')">
                        <div class="tool-icon"><i class="fas fa-sticky-note"></i></div>
                        <div class="tool-name">NOTES</div>
                    </div>
                    <div class="tool-card" onclick="showNotification('Tests', 'Tests feature coming soon!')">
                        <div class="tool-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="tool-name">TESTS</div>
                    </div>
                    <div class="tool-card" onclick="showNotification('Downloads', 'Downloads feature coming soon!')">
                        <div class="tool-icon"><i class="fas fa-download"></i></div>
                        <div class="tool-name">DOWNLOADS</div>
                    </div>
                    <div class="tool-card" onclick="showNotification('Progress', 'Progress tracking coming soon!')">
                        <div class="tool-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="tool-name">PROGRESS</div>
                    </div>
                </div>

                <div class="timetable">
                    <div class="section-title">
                        <i class="fas fa-calendar-alt"></i>
                        <span>My Timetable</span>
                    </div>
                    <div class="week-display">Week 24</div>
                    <div class="date-range">Mon, June 10 - Fri, June 14</div>
                    <div class="schedule-grid">
                        <div class="schedule-item">
                            <div class="time">9:00 AM</div>
                            <div class="subject">AGRO222</div>
                        </div>
                        <div class="schedule-item">
                            <div class="time">11:00 AM</div>
                            <div class="subject">BOTA241</div>
                        </div>
                        <div class="schedule-item">
                            <div class="time">2:00 PM</div>
                            <div class="subject">ZOOL210</div>
                        </div>
                    </div>
                </div>

                <button class="ai-chat-btn" onclick="openAIChat()">
                    <i class="fas fa-robot"></i>
                    AI CHAT
                    <span>ESSAYS | RESEARCH | ASSIGNMENTS</span>
                </button>

                <!-- Quick Actions for Universities -->
                <div class="quick-actions" style="margin-top: 20px;">
                    <button class="quick-action-btn" onclick="openUniversityListModal()">
                        <i class="fas fa-university"></i> Browse Universities
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Home Tab -->
                <div id="home" class="tab-content active">
                    <div class="content-header">
                        <h1 class="main-title">Continue Reading</h1>
                        <div class="filters">
                            <select class="filter-select" onchange="filterMaterials()" id="universityFilter">
                                <option value="all">All Universities</option>
                            </select>
                            <select class="filter-select" onchange="filterMaterials()" id="yearFilter">
                                <option value="all">All Years</option>
                                <option value="1">Year 1</option>
                                <option value="2">Year 2</option>
                                <option value="3">Year 3</option>
                                <option value="4">Year 4</option>
                            </select>
                        </div>
                    </div>

                    <!-- Progress Steps for New Users -->
                    <div class="progress-steps" id="progressSteps" style="display: none;">
                        <div class="progress-step">
                            <div class="step-circle">1</div>
                            <div class="step-label">Register</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">2</div>
                            <div class="step-label">Get Code</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">3</div>
                            <div class="step-label">Activate</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle active">4</div>
                            <div class="step-label">Browse</div>
                        </div>
                    </div>

                    <div class="quick-units" id="quickUnits"></div>

                    <div id="accessStatus" class="access-status">
                        <div class="access-text">
                            <h3><i class="fas fa-lock"></i> Access Locked</h3>
                            <p>Subscribe to unlock all study materials and features</p>
                        </div>
                        <button class="view-btn" onclick="showTab('register')" style="width: auto; padding: 10px 20px;">
                            <i class="fas fa-crown"></i> Subscribe Now
                        </button>
                    </div>

                    <!-- Registration Success Banner -->
                    <div id="registrationSuccessBanner" class="registration-success-banner">
                        <div style="text-align: center; width: 100%;">
                            <h3><i class="fas fa-check-circle"></i> Registration Successful!</h3>
                            <p>Your registration has been submitted. Admin will send you an unlock code via WhatsApp.</p>
                            <p style="margin-bottom: 20px; font-weight: 600;">You can browse universities while waiting:</p>
                            
                            <div class="quick-actions">
                                <button class="quick-action-btn" onclick="openUniversityListModal()">
                                    <i class="fas fa-university"></i> Browse Universities
                                </button>
                                <button class="quick-action-btn" onclick="showTab('login')">
                                    <i class="fas fa-sign-in-alt"></i> Go to Login
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="search-results" id="searchResults">
                        <h2 class="search-results-title" id="searchResultsTitle"></h2>
                        <div class="materials-grid" id="searchResultsGrid"></div>
                    </div>

                    <div id="continueReading">
                        <div class="materials-grid" id="continueReadingGrid"></div>

                        <div class="section-divider" style="margin: 30px 0 25px; display: flex; align-items: center; gap: 15px;">
                            <div class="divider-line" style="flex: 1; height: 2px; background: linear-gradient(90deg, transparent, #e2e8f0, transparent);"></div>
                            <h2 style="font-size: 20px; color: var(--primary); font-weight: 800; white-space: nowrap;">Trending Materials</h2>
                            <div class="divider-line" style="flex: 1; height: 2px; background: linear-gradient(90deg, transparent, #e2e8f0, transparent);"></div>
                        </div>

                        <div class="materials-grid" id="trendingGrid"></div>
                    </div>
                </div>

                <!-- Materials Tab -->
                <div id="materials" class="tab-content">
                    <div class="content-header">
                        <h1 class="main-title">All Study Materials</h1>
                        <div class="filters">
                            <select class="filter-select" onchange="filterAllMaterials()" id="allUniversityFilter">
                                <option value="all">All Universities</option>
                            </select>
                            <select class="filter-select" onchange="filterAllMaterials()" id="allSubjectFilter">
                                <option value="all">All Subjects</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- University Browse Button -->
                    <div style="margin-bottom: 25px;">
                        <button class="university-browse-btn" onclick="openUniversityListModal()">
                            <i class="fas fa-university"></i> BROWSE BY UNIVERSITY
                        </button>
                    </div>
                    
                    <div class="materials-grid" id="allMaterialsGrid"></div>
                </div>

                <!-- Register Tab -->
                <div id="register" class="tab-content">
                    <div class="content-header">
                        <h1 class="main-title">Student Registration</h1>
                    </div>
                    
                    <!-- Progress Steps -->
                    <div class="progress-steps">
                        <div class="progress-step">
                            <div class="step-circle active">1</div>
                            <div class="step-label">Fill Form</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">2</div>
                            <div class="step-label">Make Payment</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">3</div>
                            <div class="step-label">Get Code</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">4</div>
                            <div class="step-label">Browse</div>
                        </div>
                    </div>

                    <!-- Registration Form -->
                    <div id="registrationForm">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="studentName" placeholder="Enter your full name">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Phone Number (WhatsApp)</label>
                            <input type="tel" class="form-input" id="studentPhone" placeholder="07XXXXXXXX">
                            <small style="color: #6c757d; font-size: 12px;">This number will be used for WhatsApp verification</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">University</label>
                            <select class="form-select" id="studentUniversity">
                                <option value="">Select University</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Course/Program</label>
                            <input type="text" class="form-input" id="studentCourse" placeholder="e.g., BSc Agriculture">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Year of Study</label>
                            <select class="form-select" id="studentYear">
                                <option value="">Select Year</option>
                                <option value="1">Year 1</option>
                                <option value="2">Year 2</option>
                                <option value="3">Year 3</option>
                                <option value="4">Year 4</option>
                            </select>
                        </div>

                        <!-- Payment Instructions -->
                        <div class="payment-instructions" style="background: #e8f5e9; border: 3px solid #4caf50; border-radius: 15px; padding: 20px; margin: 20px 0;">
                            <h3 style="color: #4caf50; margin-bottom: 15px;"> M-Pesa Payment Instructions</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">Step 1</div>
                                    <p style="font-size: 13px;">Go to <strong>M-Pesa</strong></p>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">Step 2</div>
                                    <p style="font-size: 13px;">Select <strong>Lipa Na M-Pesa</strong></p>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">Step 3</div>
                                    <p style="font-size: 13px;">Select <strong>Pay Bill</strong></p>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">Step 4</div>
                                    <p style="font-size: 13px;">Business No: <strong>247247</strong></p>
                                </div>
                            </div>
                            
                            <!-- FIXED PAYMENT ACCOUNT NUMBER -->
                            <div class="account-number-display" style="margin: 20px 0;">
                                <h3 style="color: #92400e; margin-bottom: 10px;">
                                    <i class="fas fa-copy"></i> Fixed Payment Account Number
                                </h3>
                                <div class="account-number">0330184468200</div>
                                <button class="copy-btn" onclick="copyAccountNumber()" style="margin: 10px auto; display: block;">
                                    <i class="fas fa-copy"></i> Copy Account Number
                                </button>
                                <p style="font-size: 12px; color: #92400e; margin-top: 10px;">
                                    Copy this account number for M-Pesa payment
                                </p>
                            </div>
                            
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Amount</div>
                                <div style="font-size: 32px; font-weight: bold; color: #4caf50;">Ksh 67</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">M-Pesa Transaction Code</label>
                            <input type="text" class="form-input" id="paymentCode" placeholder="Enter transaction code (e.g., SDF45G7H)">
                        </div>

                        <div class="whatsapp-notice" style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 15px; text-align: center; margin: 20px 0;">
                            <i class="fab fa-whatsapp" style="color: #25d366; font-size: 24px; margin-bottom: 10px;"></i>
                            <p><strong>WhatsApp Verification</strong></p>
                            <p style="font-size: 13px;">After submitting, your phone will send a WhatsApp message to admin automatically</p>
                        </div>

                        <button class="submit-btn" onclick="registerStudent()">
                            <i class="fas fa-paper-plane"></i> SUBMIT REGISTRATION & PAYMENT
                        </button>

                        <!-- UNLOCK CODE BUTTON -->
                        <div style="text-align: center; margin-top: 25px; padding: 20px; border: 2px dashed #e2e8f0; border-radius: 10px;">
                            <h3 style="color: var(--primary); margin-bottom: 10px;">
                                <i class="fas fa-key"></i> Already Have an Unlock Code?
                            </h3>
                            <p style="color: #64748b; margin-bottom: 15px;">If you've already received your unlock code from admin, click below to activate your account</p>
                            <button class="university-browse-btn small" onclick="showTab('login')" style="width: 100%;">
                                <i class="fas fa-unlock"></i> ENTER UNLOCK CODE & ACTIVATE
                            </button>
                        </div>

                        <!-- Quick Browse Option -->
                        <div style="text-align: center; margin-top: 25px;">
                            <p style="color: #64748b; margin-bottom: 15px;">Want to see what's available first?</p>
                            <button class="university-browse-btn small" onclick="openUniversityListModal()">
                                <i class="fas fa-university"></i> BROWSE UNIVERSITIES
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Login Tab -->
                <div id="login" class="tab-content">
                    <div class="content-header">
                        <h1 class="main-title">Student Login</h1>
                    </div>
                    
                    <!-- University Browse Button at Top -->
                    <div style="margin-bottom: 25px;">
                        <button class="university-browse-btn small" onclick="openUniversityListModal()">
                            <i class="fas fa-university"></i> BROWSE UNIVERSITIES
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="loginPhone" placeholder="07XXXXXXXX">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Unlock Code (From Admin)</label>
                        <input type="text" class="form-input" id="unlockCode" placeholder="Enter unlock code from WhatsApp">
                        <small style="color: #6c757d; font-size: 12px;">Required for first-time activation only</small>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="submit-btn" onclick="loginStudent()" style="flex: 2;">
                            <i class="fas fa-sign-in-alt"></i> LOGIN & ACTIVATE
                        </button>
                        <button class="university-browse-btn small" onclick="openUniversityListModal()" style="flex: 1;">
                            <i class="fas fa-university"></i> Browse
                        </button>
                    </div>

                    <!-- Quick Guide -->
                    <div style="background: #f0f9ff; border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-info-circle"></i> How It Works
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; color: var(--primary); margin-bottom: 8px;">1</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--dark);">Register & Pay</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; color: var(--primary); margin-bottom: 8px;">2</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--dark);">Get WhatsApp Code</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; color: var(--primary); margin-bottom: 8px;">3</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--dark);">Login & Activate</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; color: var(--primary); margin-bottom: 8px;">4</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--dark);">Browse Materials</div>
                            </div>
                        </div>
                    </div>

                    <div id="loginMessage" class="login-message"></div>
                </div>

                <!-- Upload Tab -->
                <div id="upload" class="tab-content">
                    <div class="content-header">
                        <h1 class="main-title">Upload Study Materials</h1>
                    </div>

                    <!-- Upload Instructions -->
                    <div class="upload-instructions">
                        <h3><i class="fas fa-info-circle"></i> How to Upload Materials</h3>
                        
                        <div class="instruction-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Prepare Your Document</h4>
                                <p>Make sure your document is in PDF format. Upload it to Google Drive.</p>
                            </div>
                        </div>
                        
                        <div class="instruction-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Get Shareable Link</h4>
                                <p>Right-click on the file in Google Drive  "Share"  Change to "Anyone with the link"  Copy link</p>
                            </div>
                        </div>
                        
                        <div class="instruction-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Convert to Direct Link</h4>
                                <p>Change the link format to direct preview link:</p>
                                <div class="code-block">
                                    Original: https://drive.google.com/file/d/FILE_ID/view?usp=sharing<br>
                                    Change to: https://drive.google.com/file/d/FILE_ID/preview
                                </div>
                                <button class="copy-btn" onclick="copyText('https://drive.google.com/file/d/FILE_ID/preview')">
                                    <i class="fas fa-copy"></i> Copy Format
                                </button>
                            </div>
                        </div>
                        
                        <div class="instruction-step" style="border-bottom: none;">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>Fill Upload Form</h4>
                                <p>Complete the form below with all details. Your upload will be reviewed by admin.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Form -->
                    <div id="uploadForm">
                        <div class="form-group">
                            <label class="form-label">Document Title</label>
                            <input type="text" class="form-input" id="uploadTitle" placeholder="e.g., Plant Breeding Notes">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Unit Code</label>
                            <input type="text" class="form-input" id="uploadUnitCode" placeholder="e.g., AGRO222">
                        </div>

                        <div class="form-group">
                            <label class="form-label">University</label>
                            <select class="form-select" id="uploadUniversity">
                                <option value="">Select University</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Subject/Category</label>
                            <input type="text" class="form-input" id="uploadSubject" placeholder="e.g., Agronomy">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Year of Study</label>
                            <select class="form-select" id="uploadYear">
                                <option value="">Select Year</option>
                                <option value="1">Year 1</option>
                                <option value="2">Year 2</option>
                                <option value="3">Year 3</option>
                                <option value="4">Year 4</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-input" id="uploadDescription" placeholder="Brief description of the material" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Google Drive Direct Link</label>
                            <input type="url" class="form-input" id="uploadURL" placeholder="https://drive.google.com/file/d/.../preview">
                            <small style="color: #6c757d; font-size: 12px;">Must end with /preview (not /view)</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Your Phone Number (for notification)</label>
                            <input type="tel" class="form-input" id="uploaderPhone" placeholder="07XXXXXXXX">
                        </div>

                        <button class="upload-btn" onclick="uploadMaterial()">
                            <i class="fas fa-upload"></i> SUBMIT FOR REVIEW
                        </button>

                        <div style="text-align: center; margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 10px;">
                            <p style="color: #92400e;">
                                <i class="fas fa-info-circle"></i> Note: All uploads are reviewed by admin. You'll be notified via WhatsApp when approved.
                            </p>
                        </div>
                    </div>

                    <!-- Upload Success Message -->
                    <div id="uploadSuccess" style="display: none; background: #d1fae5; border: 2px solid #10b981; border-radius: 10px; padding: 25px; text-align: center; margin-top: 20px;">
                        <div style="font-size: 48px; color: #10b981; margin-bottom: 15px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3 style="color: #065f46; margin-bottom: 10px;">Upload Submitted Successfully!</h3>
                        <p style="color: #047857; margin-bottom: 20px;">Your material has been submitted for admin review. You'll receive a WhatsApp notification once it's approved.</p>
                        <button class="upload-btn" onclick="showTab('materials')">
                            <i class="fas fa-book"></i> Browse Other Materials
                        </button>
                    </div>
                </div>

                <!-- Admin Tab -->
                <div id="admin" class="tab-content">
                    <div class="content-header">
                        <h1 class="main-title">Admin Control Panel</h1>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Admin Password</label>
                        <input type="password" class="form-input" id="adminPassword" placeholder="Enter admin password">
                    </div>

                    <button class="submit-btn" onclick="adminLogin()">
                        <i class="fas fa-sign-in-alt"></i> LOGIN AS ADMIN
                    </button>

                    <div id="adminPanel" style="display: none; margin-top: 30px;">
                        <!-- LOGOUT BUTTON -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: var(--primary);">Welcome, Admin!</h2>
                            <button class="reject-btn" onclick="adminLogout()" style="padding: 10px 20px;">
                                <i class="fas fa-sign-out-alt"></i> Logout Admin
                            </button>
                        </div>

                        <div class="admin-tabs">
                            <button class="nav-btn active" onclick="showAdminSection('pending')" style="flex: none; padding: 12px 20px;">
                                <i class="fas fa-clock"></i> Pending Approvals
                                <span id="pendingCountBadge" class="status-badge status-pending" style="margin-left: 5px; display: none;">0</span>
                            </button>
                            <button class="nav-btn" onclick="showAdminSection('students')" style="flex: none; padding: 12px 20px;">
                                <i class="fas fa-users"></i> All Students
                            </button>
                            <button class="nav-btn" onclick="showAdminSection('materials')" style="flex: none; padding: 12px 20px;">
                                <i class="fas fa-book"></i> Manage Materials
                            </button>
                            <button class="nav-btn" onclick="showAdminSection('uploads')" style="flex: none; padding: 12px 20px;">
                                <i class="fas fa-upload"></i> User Uploads
                            </button>
                            <button class="nav-btn" onclick="showAdminSection('documentManagement')" style="flex: none; padding: 12px 20px; background: #3b82f6; color: white;">
                                <i class="fas fa-file-alt"></i> Doc Management
                            </button>
                            <button class="nav-btn" onclick="showAdminSection('statistics')" style="flex: none; padding: 12px 20px; background: #10b981; color: white;">
                                <i class="fas fa-chart-bar"></i> Statistics
                            </button>
                            <button class="nav-btn" onclick="showAdminSection('backup')" style="flex: none; padding: 12px 20px; background: #8b5cf6; color: white;">
                                <i class="fas fa-database"></i> Backup
                            </button>
                            <button class="nav-btn" onclick="showAdminSection('jsonUpload')" style="flex: none; padding: 12px 20px; background: #7c3aed; color: white;">
                                <i class="fas fa-file-upload"></i> JSON Upload
                            </button>
                        </div>

                        <div id="pendingSection" class="admin-section">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">
                                <i class="fas fa-clock"></i>  Pending Subscriptions
                                <span class="status-badge status-pending" id="pendingCount">0 pending</span>
                            </h3>
                            <div class="admin-list" id="pendingList">
                                <div class="spinner"></div>
                            </div>
                        </div>

                        <div id="studentsSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> All Registered Students</h3>
                            <div class="admin-list" id="studentList">
                                <div class="spinner"></div>
                            </div>
                        </div>

                        <div id="materialsSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> Manage Study Materials</h3>
                            <div style="margin-bottom: 20px;">
                                <button class="submit-btn" onclick="addNewMaterial()" style="width: auto; padding: 12px 25px;">
                                    <i class="fas fa-plus"></i> Add New Material
                                </button>
                            </div>
                            <div class="admin-list" id="adminMaterialsList">
                                <div class="spinner"></div>
                            </div>
                        </div>

                        <div id="uploadsSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> User Uploads Pending Review</h3>
                            <div class="admin-list" id="userUploadsList">
                                <div class="spinner"></div>
                            </div>
                        </div>

                        <!-- Document Management Section -->
                        <div id="documentManagementSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> Document Management</h3>
                            
                            <div class="doc-management-section">
                                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-search"></i> Quick Document Search</h4>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <input type="text" class="form-input" id="docSearchInput" placeholder="Search by Unit Code, Title, or University..." onkeyup="searchDocumentsAdmin()">
                                </div>
                                
                                <div id="docManagementResults" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Documents will be populated here -->
                                </div>
                            </div>
                            
                            <div class="doc-management-section">
                                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-tools"></i> Bulk Actions</h4>
                                <div class="doc-action-buttons">
                                    <button class="doc-management-btn" onclick="markAllAsTrending()">
                                        <i class="fas fa-fire"></i> Mark All as Trending
                                    </button>
                                    <button class="doc-management-btn" style="background: linear-gradient(135deg, #f59e0b, #d97706);" onclick="updateDocumentYears()">
                                        <i class="fas fa-calendar-alt"></i> Update Years
                                    </button>
                                    <button class="doc-management-btn" style="background: linear-gradient(135deg, #10b981, #059669);" onclick="exportDocumentsCSV()">
                                        <i class="fas fa-download"></i> Export as CSV
                                    </button>
                                    <button class="doc-management-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626);" onclick="cleanDuplicateDocuments()">
                                        <i class="fas fa-trash"></i> Remove Duplicates
                                    </button>
                                </div>
                            </div>
                            
                            <div class="doc-management-section">
                                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Document Statistics</h4>
                                <div id="docManagementStats" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                                    <!-- Stats will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Statistics Section -->
                        <div id="statisticsSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> System Statistics</h3>
                            
                            <!-- Statistics Cards -->
                            <div class="stats-grid">
                                <div class="stats-card">
                                    <div class="stats-header">
                                        <div class="stats-title">
                                            <i class="fas fa-users"></i> Total Students
                                        </div>
                                        <div class="stats-value" id="totalStudents">0</div>
                                    </div>
                                    <div class="stats-details">
                                        <span id="activeStudents">0</span> active  <span id="pendingStudents">0</span> pending
                                    </div>
                                </div>
                                
                                <div class="stats-card">
                                    <div class="stats-header">
                                        <div class="stats-title">
                                            <i class="fas fa-file-alt"></i> Total Documents
                                        </div>
                                        <div class="stats-value" id="totalDocuments">0</div>
                                    </div>
                                    <div class="stats-details">
                                        <span id="trendingDocuments">0</span> trending  <span id="recentDocuments">0</span> recent
                                    </div>
                                </div>
                                
                                <div class="stats-card">
                                    <div class="stats-header">
                                        <div class="stats-title">
                                            <i class="fas fa-university"></i> Universities
                                        </div>
                                        <div class="stats-value" id="totalUniversities">0</div>
                                    </div>
                                    <div class="stats-details">
                                        With students: <span id="universitiesWithStudents">0</span>
                                    </div>
                                </div>
                                
                                <div class="stats-card">
                                    <div class="stats-header">
                                        <div class="stats-title">
                                            <i class="fas fa-upload"></i> User Uploads
                                        </div>
                                        <div class="stats-value" id="totalUploads">0</div>
                                    </div>
                                    <div class="stats-details">
                                        <span id="pendingUploads">0</span> pending  <span id="approvedUploads">0</span> approved
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Students Per University Chart -->
                            <div class="stats-chart">
                                <h4 style="color: var(--primary); margin-bottom: 15px;">
                                    <i class="fas fa-chart-bar"></i> Students per University
                                </h4>
                                <div id="studentsPerUniversityChart">
                                    <!-- Chart will be populated here -->
                                </div>
                            </div>
                            
                            <!-- University Statistics List -->
                            <h4 style="color: var(--primary); margin-bottom: 15px; margin-top: 25px;">
                                <i class="fas fa-list"></i> University Breakdown
                            </h4>
                            <div id="universityStatisticsList" style="max-height: 400px; overflow-y: auto;">
                                <!-- University stats will be populated here -->
                            </div>
                            
                            <!-- Quick Stats Export -->
                            <div style="margin-top: 20px; text-align: center;">
                                <button class="doc-management-btn" onclick="exportStatistics()" style="width: 100%;">
                                    <i class="fas fa-download"></i> Export Statistics Report
                                </button>
                            </div>
                        </div>

                        <!-- BACKUP SECTION -->
                        <div id="backupSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> Backup Documents Details</h3>
                            
                            <div style="background: #f0f9ff; border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Backup Instructions</h4>
                                <p style="color: #64748b; font-size: 14px; line-height: 1.5;">
                                    Click the button below to copy all recently uploaded documents details to clipboard. 
                                    You can then paste them into a text file for backup.
                                </p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <button class="backup-btn" onclick="backupRecentUploads()" style="padding: 12px 20px; font-size: 14px;">
                                    <i class="fas fa-copy"></i> Copy Recent Uploads Details
                                </button>
                                <button class="backup-btn" onclick="backupAllDocuments()" style="padding: 12px 20px; font-size: 14px; background: linear-gradient(135deg, #10b981, #059669);">
                                    <i class="fas fa-database"></i> Copy All Documents
                                </button>
                            </div>
                            
                            <div id="backupStatus" style="display: none; padding: 15px; border-radius: 8px; margin-top: 15px;"></div>
                            
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px; padding: 15px; margin-top: 20px;">
                                <h4 style="color: #92400e; margin-bottom: 10px;"><i class="fas fa-lightbulb"></i> Tip</h4>
                                <p style="color: #92400e; font-size: 13px;">
                                    For best backup practice, copy the details and paste into a Google Docs or text file after each upload session.
                                </p>
                            </div>
                        </div>

                        <!-- JSON UPLOAD SECTION -->
                        <div id="jsonUploadSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> JSON Bulk Upload</h3>
                            
                            <div style="background: #f0f9ff; border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-info-circle"></i> JSON Bulk Upload Instructions</h4>
                                <p style="color: #64748b; font-size: 14px; line-height: 1.5; margin-bottom: 15px;">
                                    Upload a JSON file containing multiple documents to automatically add them to the system. 
                                    All documents will be immediately available to all users.
                                </p>
                                
                                <div class="instruction-step">
                                    <div class="step-number">1</div>
                                    <div class="step-content">
                                        <h4>Prepare JSON File</h4>
                                        <p>Create a JSON file with an array of document objects. Each document should have this format:</p>
                                        <div class="code-block">
{
  "Title": "Plant Breeding notes",
  "Unit Code": "AGRO222",
  "University": "Egerton University",
  "Type": "pdf",
  "Subject": "Agronomy",
  "Year": "2",
  "Description": "lecture notes on plant Breeding",
  "URL": "https://drive.google.com/file/d/.../preview"
}
                                        </div>
                                        <button class="copy-btn" onclick="copyJSONTemplate()">
                                            <i class="fas fa-copy"></i> Copy Template
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="instruction-step">
                                    <div class="step-number">2</div>
                                    <div class="step-content">
                                        <h4>Download Current Documents</h4>
                                        <p>Download current documents as JSON to use as a template or backup:</p>
                                        <button class="backup-btn" onclick="downloadCurrentDocuments()" style="padding: 12px 20px; font-size: 14px; background: linear-gradient(135deg, #10b981, #059669);">
                                            <i class="fas fa-download"></i> Download Current Documents
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="instruction-step" style="border-bottom: none;">
                                    <div class="step-number">3</div>
                                    <div class="step-content">
                                        <h4>Upload JSON File</h4>
                                        <p>Select your JSON file below and upload. The system will automatically add all documents.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- JSON Upload Zone -->
                            <div class="json-upload-zone" id="jsonUploadZone" onclick="document.getElementById('jsonFileInput').click()">
                                <div style="font-size: 60px; color: #7c3aed; margin-bottom: 15px;">
                                    <i class="fas fa-file-upload"></i>
                                </div>
                                <h3 style="color: #7c3aed; margin-bottom: 10px;">Drop JSON File Here</h3>
                                <p style="color: #64748b; margin-bottom: 20px;">or click to select a JSON file</p>
                                
                                <div style="margin-bottom: 20px;">
                                    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleJSONFileSelect(event)">
                                    <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('jsonFileInput').click();" style="width: auto; padding: 15px 40px;">
                                        <i class="fas fa-folder-open"></i> SELECT JSON FILE
                                    </button>
                                </div>
                                
                                <div id="jsonFileInfo" style="display: none; background: #e9d5ff; border-radius: 10px; padding: 15px; margin-top: 15px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div style="text-align: left;">
                                            <div style="font-weight: bold; color: #7c3aed;" id="fileName"></div>
                                            <div style="font-size: 12px; color: #64748b;" id="fileSize"></div>
                                        </div>
                                        <button class="reject-btn" onclick="clearJSONFile()" style="padding: 5px 10px; font-size: 12px;">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upload Button -->
                            <button id="uploadJSONBtn" class="submit-btn" onclick="uploadJSONDocuments()" disabled style="margin-bottom: 20px; background: #7c3aed;">
                                <i class="fas fa-upload"></i> UPLOAD & PROCESS JSON DOCUMENTS
                            </button>
                            
                            <!-- Upload Status -->
                            <div id="jsonUploadStatus" style="margin-top: 20px; display: none;"></div>
                            
                            <!-- Preview Section -->
                            <div id="jsonPreviewSection" style="display: none;">
                                <h4 style="color: var(--primary); margin-bottom: 15px;"> Document Preview</h4>
                                <div id="jsonPreview" style="max-height: 300px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 10px; padding: 15px; background: #f8fafc;"></div>
                                <div id="jsonStats" style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar -->
            <aside class="sidebar-right">
                <div class="sidebar-section">
                    <h2 class="section-title">
                        <i class="fas fa-folder"></i>
                        Categories
                    </h2>
                    <ul class="category-list" id="categoryList"></ul>
                </div>

                <div class="sidebar-section">
                    <h2 class="section-title">
                        <i class="fas fa-university"></i>
                        Universities
                    </h2>
                    <div class="university-grid" id="universityGrid"></div>
                    <button class="university-browse-btn small" onclick="openUniversityListModal()" style="margin-top: 15px; width: 100%;">
                        <i class="fas fa-search"></i> Browse All Universities
                    </button>
                </div>

                <!-- Upload Button in Sidebar -->
                <div style="margin-top: 25px;">
                    <button class="upload-btn" onclick="showTab('upload')" style="width: 100%;">
                        <i class="fas fa-upload"></i> UPLOAD MATERIALS
                    </button>
                </div>

                <div class="premium-banner">
                    <div class="premium-title">
                        <i class="fas fa-crown"></i>
                        PREMIUM ACCESS
                    </div>
                    <p style="font-size: 13px;">Unlock all study materials for 5 months</p>
                    <div class="premium-price">Ksh 67</div>
                    <p style="font-size: 12px; opacity: 0.9;">One payment, full access to all resources</p>
                    <button class="premium-btn" onclick="showTab('register')">
                        <i class="fas fa-bolt"></i> SUBSCRIBE NOW
                    </button>
                </div>

                <div style="margin-top: 30px; text-align: center; color: #64748b; font-size: 13px; line-height: 1.6;">
                    <p><i class="fas fa-shield-alt"></i> Secure Payment</p>
                    <p><i class="fas fa-headset"></i> 24/7 Support</p>
                    <p><i class="fas fa-check-circle"></i> Money Back Guarantee</p>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2026 RevisionVault Pro  Developed by Walter Zauko</p>
            <p style="margin-top: 3px;">Contact: 0765 098 865  All rights reserved</p>
            <p style="margin-top: 3px; font-size: 11px; color: #94a3b8;">Live Sync: <span id="syncStatus">Connected</span></p>
        </footer>
    </div>

    <!-- RAISED Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="showTab('home')">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="nav-btn" onclick="showTab('materials')">
            <i class="fas fa-book"></i>
            <span>Materials</span>
        </button>
        <button class="nav-btn" onclick="showTab('upload')">
            <i class="fas fa-upload"></i>
            <span>Upload</span>
        </button>
        <button class="nav-btn" onclick="showTab('register')">
            <i class="fas fa-user-plus"></i>
            <span>Register</span>
        </button>
        <button class="nav-btn" onclick="showTab('admin')">
            <i class="fas fa-shield-alt"></i>
            <span>Admin</span>
        </button>
    </div>

    <!-- University List Modal -->
    <div class="university-list-modal" id="universityListModal">
        <div class="university-list-content">
            <div class="university-list-header">
                <h2 class="university-list-title">
                    <i class="fas fa-university"></i>
                    Browse University Materials
                </h2>
                <button class="close-modal" onclick="closeUniversityListModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="university-list-grid" id="universityListGrid">
                <!-- Universities will be populated here -->
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <p style="color: #64748b; font-size: 14px;">
                    Select a university to view materials from that institution
                </p>
            </div>
        </div>
    </div>

    <!-- SIMPLE FULLSCREEN DOCUMENT VIEWER MODAL -->
    <div class="modal" id="pdfModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="pdfModalTitle">
                    <i class="fas fa-file-pdf"></i>
                    <span>Document Viewer</span>
                </h2>
                <button class="close-modal" onclick="closeModal('pdfModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="pdf-viewer-container">
                    <!-- Loading State -->
                    <div class="pdf-loading" id="pdfLoading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>Loading Document...</h3>
                        <p>Please wait while we load your document.</p>
                    </div>
                    
                    <!-- Error State -->
                    <div class="pdf-error" id="pdfError" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Document Not Available</h3>
                        <p>The requested document could not be loaded. Please try again later or contact support.</p>
                        <button class="action-btn" onclick="closeModal('pdfModal')" style="width: auto; padding: 10px 20px; background: var(--primary); color: white;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                    
                    <!-- PDF Viewer -->
                    <iframe class="pdf-viewer-frame" id="pdfViewer" 
                            frameborder="0" 
                            scrolling="yes"
                            sandbox="allow-scripts allow-same-origin"
                            loading="eager">
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div class="modal" id="aiChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-robot"></i> AI Study Assistant</h2>
                <button class="close-modal" onclick="closeModal('aiChatModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p>AI Chat helps with essays, research, assignments, and study questions. Ask anything!</p>
                </div>
                
                <div id="aiChatMessages" style="height: 300px; overflow-y: auto; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <div style="background: #f1f5f9; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                        <strong><i class="fas fa-robot"></i> AI Assistant:</strong> Hello! I'm your AI study assistant. How can I help you today?
                    </div>
                </div>
                
                <div class="form-group">
                    <input type="text" class="form-input" id="aiQuestion" placeholder="Ask me anything about your studies...">
                </div>
                
                <button class="submit-btn" onclick="askAI()">
                    <i class="fas fa-paper-plane"></i> Ask AI Assistant
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <strong id="notificationTitle"></strong>
                <p id="notificationMessage" style="margin-top: 5px;"></p>
            </div>
            <button onclick="hideNotification()" style="background: none; border: none; color: #6c757d; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDX8T_hYJvyUq4QSAZTtCDAk_NlqZ8NVxE",
            authDomain: "revisionvault-pro-83002.firebaseapp.com",
            databaseURL: "https://revisionvault-pro-83002-default-rtdb.firebaseio.com",
            projectId: "revisionvault-pro-83002",
            storageBucket: "revisionvault-pro-83002.firebasestorage.app",
            messagingSenderId: "669675132541",
            appId: "1:669675132541:web:706cf06dc79eb5f36fc314"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Firebase references
        let usersRef = database.ref('users');
        let pendingRegistrationsRef = database.ref('pendingRegistrations');
        let documentsRef = database.ref('documents');
        let userUploadsRef = database.ref('userUploads');

        // ==================== ADVANCED APP DATA ====================
        const INITIAL_DOCUMENTS = [
            {
                "Title": "Plant Breeding notes",
                "Unit Code": "AGRO222",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Agronomy",
                "Year": "2",
                "Description": "lecture notes on plant Breeding",
                "URL": "https://drive.google.com/file/d/17CG_rb_ecvnkLfjTzNC31u55pBR_RW70/preview",
                "Trending": true,
                "Recent": true
            },
            {
                "Title": "Scope of production Economics",
                "Unit Code": "AGEC241",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Agricultural Economics",
                "Year": "2",
                "Description": "lecture notes on production Economics",
                "URL": "https://drive.google.com/file/d/1uSBqGCfeWPr-upLjKOu-cCkwQUVW7GOU/preview",
                "Trending": true
            },
            {
                "Title": "Production Economics",
                "Unit Code": "AGEC241",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Agricultural Economics",
                "Year": "2",
                "Description": "lecture notes on production Economics",
                "URL": "https://drive.google.com/file/d/1LZ5P_t9qRlxZq2AyAI8JoG-bZAdS6G_c/preview"
            },
            {
                "Title": "ICT Application in Agricultural Education and Extension",
                "Unit Code": "AGED113",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Agricultural Education and Extension",
                "Year": "2",
                "Description": "Examination paper on ICT Application in Agricultural Education and Extension",
                "URL": "https://drive.google.com/file/d/1MxYZpCMFoxTLI6ZR0w9rBBAWeZ1h_bg_/preview",
                "Recent": true
            },
            {
                "Title": "plant Breeding",
                "Unit Code": "AGRO222",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Agronomy",
                "Year": "2",
                "Description": "lecture notes on plant Breeding",
                "URL": "https://drive.google.com/file/d/1wFm3cb1YRR9yD9f5noK4tg0HeD0K0jtg/preview"
            },
            {
                "Title": "taxonomy of higher plants",
                "Unit Code": "BOTA241",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Botany",
                "Year": "2",
                "Description": "lecture notes on Taxonomy of higher plants",
                "URL": "https://drive.google.com/file/d/102toSTJ9WewkGSiBKx3IxWlbPoeKrGCU/preview"
            },
            {
                "Title": "plant physiology",
                "Unit Code": "BOTA271",
                "University": "Egerton University",
                Type: "pdf",
                Subject: "Botany",
                Year: "2",
                Description: "lecture notes on plant physiology",
                URL: "https://drive.google.com/file/d/1vSG6ErlBddO-dXBVu8Ice1ut297SiI5d/preview"
            },
            {
                Title: "Breeding practices",
                "Unit Code": "AGRO222",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Agronomy",
                Year: "2",
                Description: "lecture notes on breeding practices",
                URL: "https://drive.google.com/file/d/1nZfdRK6TTVLvR05-E70WPLBN51_m6G7C/preview",
                Recent: true
            },
            {
                Title: "Cell biology",
                "Unit Code": "ZOOL232",
                University: "Egerton University",
                Type: "pdf",
                Subject: "zoology",
                Year: "2",
                Description: "lecture notes on cell biology",
                URL: "https://drive.google.com/file/d/1LlFPeHK2DjZBhYh8C0LP9DZMX-etSZd7/preview"
            },
            {
                Title: "course outline",
                "Unit Code": "AGEC241",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Agricultural Economics",
                Year: "2",
                Description: "lecture notes on production Economics",
                URL: "https://drive.google.com/file/d/15D0aQg6hUX3v1pKwxnQ0Al0vRVIVCfsO/preview"
            },
            {
                Title: "Epistemology and Education",
                "Unit Code": "EDFO112",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Education Foundation",
                Year: "2",
                Description: "lecture notes on Epistemology and Education",
                URL: "https://drive.google.com/file/d/1Z9vZTucmGM_Vcp-cTvHfWwOxzNNLgPkj/preview"
            },
            {
                Title: "Environmental Science",
                "Unit Code": "ENSC104",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Environmental Science",
                Year: "2",
                Description: "lecture notes on Environmental Education",
                URL: "https://drive.google.com/file/d/1Rd_mPqrUik3mh9LX6GQEgD5XOjDfw1gB/preview"
            },
            {
                Title: "Environmental Education",
                "Unit Code": "ENSC104",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Environmental Science",
                Year: "2",
                Description: "lecture notes on Environmental Education",
                URL: "https://drive.google.com/file/d/1px1TN0icV_IlUjRm9DpgVyyPHmSfqBNz/preview"
            },
            {
                Title: "introduction to entrepreneurship",
                "Unit Code": "AGBM102",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Agro business management",
                Year: "2",
                Description: "lecture notes on introduction to Enterpreneurship",
                URL: "https://drive.google.com/file/d/18KKbBRI1zzReDAAKaQ3lgNmYUHKfc57B/preview"
            },
            {
                Title: "Ecology",
                "Unit Code": "ZOOL210",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Zoology",
                Year: "2",
                Description: "lecture notes on ecology",
                URL: "https://drive.google.com/file/d/146nlk4PihaeonVHslq3GClWqwu5xsbeX/preview",
                Trending: true
            },
            {
                Title: "SENV311",
                "Unit Code": "SENV311",
                University: "University of Eldoret",
                Type: "pdf",
                Subject: "Environmental Science",
                Year: "2",
                Description: "groupwork assignment",
                URL: "https://drive.google.com/file/d/1yPUYlgNepiDrG8RFIraiO5vA3iLLlS6D/preview",
                Recent: true
            },
            {
                Title: "Integral Calculus",
                "Unit Code": "MATH212",
                University: "University of Nairobi",
                Type: "pdf",
                Subject: "Mathematics",
                Year: "2",
                Description: "2024 Main exam paper on integral calculus",
                URL: "https://drive.google.com/file/d/1LZ5P_t9qRlxZq2AyAI8JoG-bZAdS6G_c/preview",
                Trending: true
            },
            {
                Title: "Analytical Geometry",
                "Unit Code": "MATH132",
                University: "University of Nairobi",
                Type: "pdf",
                Subject: "Mathematics",
                Year: "1",
                Description: "Complete notes on analytical geometry",
                URL: "https://drive.google.com/file/d/1wFm3cb1YRR9yD9f5noK4tg0HeD0K0jtg/preview"
            }
        ];

        const UNIVERSITIES = [
            "University of Nairobi",
            "Kenyatta University",
            "Moi University",
            "Egerton University",
            "Jomo Kenyatta University of Agriculture and Technology",
            "Maseno University",
            "Masinde Muliro University of Science and Technology",
            "Dedan Kimathi University of Technology",
            "Technical University of Kenya",
            "Technical University of Mombasa",
            "Murang'a University of Technology",
            "Meru University of Science and Technology",
            "Kirinyaga University",
            "Laikipia University",
            "University of Eldoret",
            "Chuka University",
            "Karatina University",
            "Rongo University",
            "Kisii University",
            "South Eastern Kenya University",
            "Pwani University",
            "Co-operative University of Kenya",
            "Kabarak University",
            "Strathmore University",
            "Mount Kenya University",
            "Africa Nazarene University",
            "Catholic University of Eastern Africa",
            "Daystar University",
            "United States International University Africa",
            "Zetech University"
        ];

        // ==================== ADVANCED APP STATE ====================
        let appState = {
            currentUser: JSON.parse(localStorage.getItem('currentUser')) || null,
            users: JSON.parse(localStorage.getItem('users')) || [],
            documents: JSON.parse(localStorage.getItem('documents')) || [],
            userUploads: JSON.parse(localStorage.getItem('userUploads')) || [],
            adminPassword: "walter.zauko23",
            adminWhatsApp: "254765098865",
            subscriptionPrice: "67",
            searchTimeout: null,
            allUnitCodes: [],
            recentlyRegisteredPhone: null,
            statistics: JSON.parse(localStorage.getItem('statistics')) || {
                totalDownloads: 0,
                activeSubscriptions: 0,
                totalMaterials: 0,
                universitiesWithMaterials: 0,
                userUploadsPending: 0,
                lastBackupDate: null,
                studentsPerUniversity: {}
            },
            firebaseConnected: false,
            pendingRegistrations: []
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Document loaded, initializing app...');
            
            // Initialize Firebase
            initializeFirebase();
            
            // Load data from localStorage
            loadAppData();
            
            // Initialize UI components
            initializeUniversities();
            initializeCategories();
            initializeUnitCodes();
            renderHomeContent();
            updateAccessStatus();
            updateStatistics();
            checkRegistrationSuccess();
            initializeUploadUniversities();
            
            // Setup search functionality
            setupSearch();
            
            // Setup event listeners
            setupEventListeners();
            
            // Show welcome message for new visitors
            if (!localStorage.getItem('hasVisited')) {
                setTimeout(() => {
                    showNotification('Welcome!', 'Browse universities instantly while waiting for approval', 'info');
                    localStorage.setItem('hasVisited', 'true');
                }, 2000);
            }
        });

        // ==================== FIREBASE FUNCTIONS ====================
        function initializeFirebase() {
            console.log('Initializing Firebase...');
            updateFirebaseStatus('Connecting to server...', 'disconnected');
            
            // Check Firebase connection
            database.ref('.info/connected').on('value', function(snapshot) {
                if (snapshot.val() === true) {
                    appState.firebaseConnected = true;
                    updateFirebaseStatus('Live Sync: Connected', 'connected');
                    document.getElementById('syncStatus').textContent = 'Connected';
                    
                    // Load initial data from Firebase
                    loadDataFromFirebase();
                    
                    // Set up real-time listeners
                    setupRealtimeListeners();
                } else {
                    appState.firebaseConnected = false;
                    updateFirebaseStatus('Live Sync: Disconnected', 'disconnected');
                    document.getElementById('syncStatus').textContent = 'Disconnected';
                }
            });
        }

        function updateFirebaseStatus(text, status) {
            const statusDiv = document.getElementById('firebaseStatus');
            const statusIcon = document.getElementById('firebaseStatusIcon');
            const statusText = document.getElementById('firebaseStatusText');
            
            statusText.textContent = text;
            
            if (status === 'connected') {
                statusDiv.classList.remove('disconnected');
                statusDiv.classList.add('connected');
                statusIcon.style.color = '#10b981';
            } else {
                statusDiv.classList.remove('connected');
                statusDiv.classList.add('disconnected');
                statusIcon.style.color = '#ef4444';
            }
        }

        function loadDataFromFirebase() {
            console.log('Loading data from Firebase...');
            
            // Load documents from Firebase
            documentsRef.once('value').then(snapshot => {
                const firebaseDocuments = snapshot.val();
                if (firebaseDocuments) {
                    // Convert object to array
                    const documentsArray = Object.values(firebaseDocuments);
                    appState.documents = documentsArray;
                    saveAppData();
                    
                    // Update UI
                    initializeCategories();
                    initializeUnitCodes();
                    renderHomeContent();
                    updateStatistics();
                    console.log('Documents loaded from Firebase:', appState.documents.length);
                } else {
                    console.log('No documents in Firebase, uploading initial data...');
                    // No documents in Firebase, upload initial data
                    uploadInitialDocuments();
                }
            }).catch(error => {
                console.error('Error loading documents from Firebase:', error);
                // Fallback to local data
                if (appState.documents.length === 0) {
                    appState.documents = [...INITIAL_DOCUMENTS];
                    saveAppData();
                    renderHomeContent();
                }
            });
            
            // Load users from Firebase
            usersRef.once('value').then(snapshot => {
                const firebaseUsers = snapshot.val();
                if (firebaseUsers) {
                    appState.users = Object.values(firebaseUsers);
                    saveAppData();
                    console.log('Users loaded from Firebase:', appState.users.length);
                }
            }).catch(error => {
                console.error('Error loading users from Firebase:', error);
            });
            
            // Load pending registrations from Firebase
            pendingRegistrationsRef.once('value').then(snapshot => {
                const firebasePending = snapshot.val();
                if (firebasePending) {
                    // Convert to array with pendingId
                    const pendingArray = [];
                    for (const key in firebasePending) {
                        if (firebasePending.hasOwnProperty(key)) {
                            pendingArray.push({
                                ...firebasePending[key],
                                pendingId: key
                            });
                        }
                    }
                    appState.pendingRegistrations = pendingArray;
                    saveAppData();
                    console.log('Pending registrations loaded from Firebase:', appState.pendingRegistrations.length);
                }
            }).catch(error => {
                console.error('Error loading pending registrations from Firebase:', error);
            });
            
            // Load user uploads from Firebase
            userUploadsRef.once('value').then(snapshot => {
                const firebaseUploads = snapshot.val();
                if (firebaseUploads) {
                    appState.userUploads = Object.values(firebaseUploads);
                    saveAppData();
                    console.log('User uploads loaded from Firebase:', appState.userUploads.length);
                }
            }).catch(error => {
                console.error('Error loading user uploads from Firebase:', error);
            });
        }

        function setupRealtimeListeners() {
            console.log('Setting up Firebase real-time listeners...');
            
            // Listen for new pending registrations (Admin only)
            pendingRegistrationsRef.on('value', function(snapshot) {
                const pendingData = snapshot.val();
                if (pendingData) {
                    // Convert to array with pendingId
                    const pendingArray = [];
                    for (const key in pendingData) {
                        if (pendingData.hasOwnProperty(key)) {
                            pendingArray.push({
                                ...pendingData[key],
                                pendingId: key
                            });
                        }
                    }
                    appState.pendingRegistrations = pendingArray;
                    
                    // Update pending count badge
                    const pendingCount = appState.pendingRegistrations.length;
                    const pendingCountElement = document.getElementById('pendingCount');
                    const pendingCountBadge = document.getElementById('pendingCountBadge');
                    
                    if (pendingCountElement) {
                        pendingCountElement.textContent = `${pendingCount} pending`;
                    }
                    
                    if (pendingCountBadge) {
                        if (pendingCount > 0) {
                            pendingCountBadge.textContent = pendingCount;
                            pendingCountBadge.style.display = 'inline-block';
                        } else {
                            pendingCountBadge.style.display = 'none';
                        }
                    }
                    
                    // If admin panel is open and showing pending section, update it
                    if (document.getElementById('pendingSection') && document.getElementById('pendingSection').style.display === 'block') {
                        loadPendingApprovals();
                    }
                } else {
                    appState.pendingRegistrations = [];
                    const pendingCountBadge = document.getElementById('pendingCountBadge');
                    if (pendingCountBadge) {
                        pendingCountBadge.style.display = 'none';
                    }
                }
            });
            
            // Listen for document changes
            documentsRef.on('value', function(snapshot) {
                const firebaseDocuments = snapshot.val();
                if (firebaseDocuments) {
                    appState.documents = Object.values(firebaseDocuments);
                    saveAppData();
                    
                    // Update UI if needed
                    if (document.getElementById('allMaterialsGrid')) {
                        document.getElementById('allMaterialsGrid').innerHTML = appState.documents.map(doc => createMaterialCard(doc)).join('');
                    }
                    initializeCategories();
                    initializeUnitCodes();
                }
            });
            
            // Listen for user uploads
            userUploadsRef.on('value', function(snapshot) {
                const firebaseUploads = snapshot.val();
                if (firebaseUploads) {
                    appState.userUploads = Object.values(firebaseUploads);
                    saveAppData();
                    
                    // Update UI if admin uploads section is open
                    if (document.getElementById('uploadsSection') && document.getElementById('uploadsSection').style.display === 'block') {
                        loadUserUploads();
                    }
                }
            });
            
            // Listen for user changes
            usersRef.on('value', function(snapshot) {
                const firebaseUsers = snapshot.val();
                if (firebaseUsers) {
                    appState.users = Object.values(firebaseUsers);
                    saveAppData();
                    console.log('Users updated from Firebase:', appState.users.length);
                }
            });
        }

        function uploadInitialDocuments() {
            console.log('Uploading initial documents to Firebase...');
            
            // Check if documents already exist in Firebase
            documentsRef.once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    // Upload initial documents
                    INITIAL_DOCUMENTS.forEach((doc, index) => {
                        const docId = `doc_${Date.now()}_${index}`;
                        documentsRef.child(docId).set(doc);
                    });
                    
                    console.log('Initial documents uploaded to Firebase');
                    showNotification('Initial Data Loaded', 'Study materials have been loaded successfully', 'success');
                }
            }).catch(error => {
                console.error('Error uploading initial documents:', error);
            });
        }

        // ==================== APP DATA MANAGEMENT ====================
        function loadAppData() {
            console.log('Loading app data from localStorage...');
            
            try {
                if (localStorage.getItem('users')) {
                    appState.users = JSON.parse(localStorage.getItem('users'));
                }
                if (localStorage.getItem('documents')) {
                    appState.documents = JSON.parse(localStorage.getItem('documents'));
                }
                if (localStorage.getItem('userUploads')) {
                    appState.userUploads = JSON.parse(localStorage.getItem('userUploads'));
                }
                if (localStorage.getItem('currentUser')) {
                    appState.currentUser = JSON.parse(localStorage.getItem('currentUser'));
                }
                appState.adminWhatsApp = localStorage.getItem('adminWhatsApp') || '254765098865';
                appState.subscriptionPrice = localStorage.getItem('subscriptionPrice') || '67';
                appState.recentlyRegisteredPhone = localStorage.getItem('recentlyRegisteredPhone');
                if (localStorage.getItem('statistics')) {
                    appState.statistics = JSON.parse(localStorage.getItem('statistics'));
                }
                if (localStorage.getItem('pendingRegistrations')) {
                    appState.pendingRegistrations = JSON.parse(localStorage.getItem('pendingRegistrations'));
                }
                
                console.log('App data loaded successfully');
            } catch (error) {
                console.error('Error loading app data:', error);
                // Reset to defaults if corrupted
                appState.users = [];
                appState.documents = [...INITIAL_DOCUMENTS];
                appState.userUploads = [];
                appState.currentUser = null;
                appState.pendingRegistrations = [];
                saveAppData();
            }
        }

        function saveAppData() {
            try {
                localStorage.setItem('users', JSON.stringify(appState.users));
                localStorage.setItem('documents', JSON.stringify(appState.documents));
                localStorage.setItem('userUploads', JSON.stringify(appState.userUploads));
                localStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
                localStorage.setItem('adminWhatsApp', appState.adminWhatsApp);
                localStorage.setItem('subscriptionPrice', appState.subscriptionPrice);
                localStorage.setItem('recentlyRegisteredPhone', appState.recentlyRegisteredPhone);
                localStorage.setItem('statistics', JSON.stringify(appState.statistics));
                localStorage.setItem('pendingRegistrations', JSON.stringify(appState.pendingRegistrations));
                console.log('App data saved to localStorage');
            } catch (error) {
                console.error('Error saving app data:', error);
            }
        }

        // ==================== UI INITIALIZATION ====================
        function initializeUniversities() {
            console.log('Initializing universities...');
            
            // Populate all university selects
            const universitySelects = [
                document.getElementById('universityFilter'),
                document.getElementById('allUniversityFilter'),
                document.getElementById('studentUniversity'),
                document.getElementById('uploadUniversity')
            ];
            
            universitySelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Select University</option>' +
                        UNIVERSITIES.map(uni => `<option value="${uni}">${uni}</option>`).join('');
                }
            });
            
            // Populate university grid in sidebar
            const grid = document.getElementById('universityGrid');
            if (grid) {
                const universitiesWithCounts = UNIVERSITIES.map(uni => {
                    const count = appState.documents.filter(doc => doc.University === uni).length;
                    return { name: uni, count };
                }).filter(uni => uni.count > 0);
                
                grid.innerHTML = universitiesWithCounts.slice(0, 6).map(uni => `
                    <div class="university-card" onclick="showUniversityMaterials('${uni.name}')">
                        <div class="university-logo">${uni.name.substring(0, 2).toUpperCase()}</div>
                        <div class="university-name">${uni.name.length > 20 ? uni.name.substring(0, 18) + '...' : uni.name}</div>
                        <div style="font-size: 10px; color: #64748b; margin-top: 5px;">${uni.count} materials</div>
                    </div>
                `).join('');
            }
            
            // Populate university list modal
            const universityListGrid = document.getElementById('universityListGrid');
            if (universityListGrid) {
                const universitiesWithCounts = UNIVERSITIES.map(uni => {
                    const count = appState.documents.filter(doc => doc.University === uni).length;
                    return { name: uni, count };
                });
                
                universityListGrid.innerHTML = universitiesWithCounts.map(uni => `
                    <div class="university-list-card" onclick="showUniversityMaterials('${uni.name}')">
                        <div class="university-list-logo">${uni.name.substring(0, 2).toUpperCase()}</div>
                        <div class="university-list-name">${uni.name}</div>
                        ${uni.count > 0 ? `<div class="university-list-count">${uni.count} materials</div>` : '<div style="font-size: 12px; color: #64748b;">No materials yet</div>'}
                    </div>
                `).join('');
            }
        }

        function initializeUploadUniversities() {
            const uploadSelect = document.getElementById('uploadUniversity');
            if (uploadSelect) {
                uploadSelect.innerHTML = '<option value="">Select University</option>' +
                    UNIVERSITIES.map(uni => `<option value="${uni}">${uni}</option>`).join('');
            }
        }

        function initializeCategories() {
            console.log('Initializing categories...');
            
            const categoryList = document.getElementById('categoryList');
            if (!categoryList) return;
            
            // Extract unique subjects from documents
            const subjects = [...new Set(appState.documents.map(doc => doc.Subject))].filter(Boolean);
            
            // Count documents per subject
            const subjectCounts = {};
            appState.documents.forEach(doc => {
                if (doc.Subject) {
                    subjectCounts[doc.Subject] = (subjectCounts[doc.Subject] || 0) + 1;
                }
            });
            
            // Sort by count descending
            const sortedSubjects = subjects.sort((a, b) => subjectCounts[b] - subjectCounts[a]);
            
            categoryList.innerHTML = sortedSubjects.slice(0, 8).map(subject => `
                <li class="category-item" onclick="showCategoryMaterials('${subject}')">
                    <span class="category-name">${subject}</span>
                    <span class="category-count">${subjectCounts[subject] || 0}</span>
                </li>
            `).join('');
        }

        function initializeUnitCodes() {
            console.log('Initializing unit codes...');
            
            // Extract unique unit codes from documents
            appState.allUnitCodes = [...new Set(appState.documents.map(doc => doc["Unit Code"]))].filter(Boolean);
            
            // Populate quick units
            const quickUnits = document.getElementById('quickUnits');
            if (quickUnits) {
                quickUnits.innerHTML = appState.allUnitCodes.slice(0, 10).map(code => `
                    <div class="unit-chip" onclick="searchByUnitCode('${code}')">${code}</div>
                `).join('');
            }
        }

        // ==================== EVENT LISTENERS SETUP ====================
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    clearTimeout(appState.searchTimeout);
                    
                    if (e.target.value.length > 0) {
                        showSearchSuggestions(e.target.value);
                    } else {
                        hideSearchSuggestions();
                    }
                    
                    appState.searchTimeout = setTimeout(() => {
                        searchByUnitCode(e.target.value);
                    }, 300);
                });
                
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchByUnitCode(this.value);
                    }
                });
            }
            
            // Close modals on outside click
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    hideSearchSuggestions();
                }
                if (e.target.classList.contains('university-list-modal')) {
                    closeUniversityListModal();
                }
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target.id);
                }
            });
            
            // Bottom navigation
            document.querySelectorAll('.bottom-nav .nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.bottom-nav .nav-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Drag and drop for JSON upload
            const jsonUploadZone = document.getElementById('jsonUploadZone');
            if (jsonUploadZone) {
                jsonUploadZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });
                
                jsonUploadZone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });
                
                jsonUploadZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.name.endsWith('.json')) {
                            // Simulate file input selection
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            document.getElementById('jsonFileInput').files = dataTransfer.files;
                            
                            // Trigger change event
                            const event = new Event('change', { bubbles: true });
                            document.getElementById('jsonFileInput').dispatchEvent(event);
                        } else {
                            showNotification('Invalid File', 'Please drop a JSON file (.json)', 'error');
                        }
                    }
                });
            }
        }

        // ==================== SEARCH FUNCTIONS ====================
        function setupSearch() {
            console.log('Setting up search...');
            
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    clearTimeout(appState.searchTimeout);
                    
                    if (e.target.value.length > 0) {
                        showSearchSuggestions(e.target.value);
                    } else {
                        hideSearchSuggestions();
                    }
                    
                    appState.searchTimeout = setTimeout(() => {
                        searchByUnitCode(e.target.value);
                    }, 300);
                });
                
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchByUnitCode(this.value);
                    }
                });
            }
        }

        function showSearchSuggestions(query) {
            const suggestions = document.getElementById('searchSuggestions');
            if (!suggestions || !query.trim()) {
                hideSearchSuggestions();
                return;
            }
            
            query = query.trim().toUpperCase();
            
            // Filter documents for suggestions
            const results = appState.documents.filter(doc => {
                const unitCode = (doc["Unit Code"] || "").toUpperCase();
                const title = (doc.Title || "").toUpperCase();
                const subject = (doc.Subject || "").toUpperCase();
                
                return unitCode.includes(query) || 
                       title.includes(query) ||
                       subject.includes(query);
            }).slice(0, 8); // Limit to 8 suggestions
            
            if (results.length > 0) {
                suggestions.innerHTML = results.map(doc => `
                    <div class="suggestion-item" onclick="selectSuggestion('${doc["Unit Code"]}')">
                        <div class="suggestion-code">${doc["Unit Code"]}</div>
                        <div class="suggestion-title">${doc.Title}</div>
                    </div>
                `).join('');
                suggestions.classList.add('active');
            } else {
                hideSearchSuggestions();
            }
        }

        function hideSearchSuggestions() {
            const suggestions = document.getElementById('searchSuggestions');
            if (suggestions) {
                suggestions.classList.remove('active');
            }
        }

        function selectSuggestion(unitCode) {
            document.getElementById('searchInput').value = unitCode;
            searchByUnitCode(unitCode);
            hideSearchSuggestions();
        }

        function searchByUnitCode(query) {
            if (!query.trim()) {
                document.getElementById('searchResults').classList.remove('active');
                document.getElementById('continueReading').style.display = 'block';
                hideSearchSuggestions();
                return;
            }
            
            query = query.trim().toUpperCase();
            
            const results = appState.documents.filter(doc => {
                const unitCode = (doc["Unit Code"] || "").toUpperCase();
                const title = (doc.Title || "").toUpperCase();
                const subject = (doc.Subject || "").toUpperCase();
                const description = (doc.Description || "").toUpperCase();
                const university = (doc.University || "").toUpperCase();
                
                return unitCode.includes(query) || 
                       title.includes(query) ||
                       subject.includes(query) ||
                       description.includes(query) ||
                       university.includes(query);
            });
            
            if (results.length > 0) {
                document.getElementById('continueReading').style.display = 'none';
                document.getElementById('searchResults').classList.add('active');
                document.getElementById('searchResultsTitle').textContent = `Search Results for "${query}" (${results.length} found)`;
                
                const grid = document.getElementById('searchResultsGrid');
                grid.innerHTML = results.map(doc => createMaterialCard(doc)).join('');
                
                setTimeout(() => {
                    document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
                }, 100);
                
                showNotification('Search Results', `Found ${results.length} materials for "${query}"`, 'success');
            } else {
                document.getElementById('continueReading').style.display = 'block';
                document.getElementById('searchResults').classList.remove('active');
                showNotification('No Results', `No materials found for "${query}"`, 'warning');
            }
            
            hideSearchSuggestions();
        }

        // ==================== USER REGISTRATION ====================
        function registerStudent() {
            console.log('Registering student...');
            
            const name = document.getElementById('studentName').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            const university = document.getElementById('studentUniversity').value;
            const course = document.getElementById('studentCourse').value.trim();
            const year = document.getElementById('studentYear').value;
            const paymentCode = document.getElementById('paymentCode').value.trim();
            
            // Validation
            if (!name || !phone || !university || !course || !year || !paymentCode) {
                showNotification('Error', 'Please fill in all fields', 'error');
                highlightEmptyFields();
                return;
            }
            
            if (phone.length !== 10 || !phone.startsWith('07')) {
                showNotification('Error', 'Please enter a valid Kenyan phone number (07XXXXXXXX)', 'error');
                document.getElementById('studentPhone').style.borderColor = 'var(--danger)';
                return;
            }
            
            if (paymentCode.length < 8) {
                showNotification('Error', 'Please enter a valid M-Pesa transaction code', 'error');
                document.getElementById('paymentCode').style.borderColor = 'var(--danger)';
                return;
            }
            
            // Check if user already exists (approved or pending)
            const existingUser = appState.users.find(u => u.phone === phone);
            const existingPending = appState.pendingRegistrations.find(u => u.phone === phone);
            
            if (existingUser || existingPending) {
                showNotification('Info', 'This phone number is already registered or pending approval', 'info');
                document.getElementById('studentPhone').value = phone;
                showTab('login');
                return;
            }
            
            // Create new pending registration
            const pendingRegistration = {
                id: Date.now().toString(),
                name: name,
                phone: phone,
                university: university,
                course: course,
                year: year,
                paymentCode: paymentCode,
                registrationDate: new Date().toISOString(),
                status: 'pending'
            };
            
            // Add to pending registrations
            appState.pendingRegistrations.push(pendingRegistration);
            saveAppData();
            
            // Store the phone for success banner
            appState.recentlyRegisteredPhone = phone;
            localStorage.setItem('recentlyRegisteredPhone', phone);
            
            // Save to Firebase
            if (appState.firebaseConnected) {
                const pendingId = `pending_${Date.now()}`;
                pendingRegistrationsRef.child(pendingId).set(pendingRegistration);
                
                console.log('Pending registration saved to Firebase:', pendingId);
            }
            
            // Show success banner
            showRegistrationSuccessBanner();
            showProgressSteps();
            
            // Send WhatsApp notification to admin
            sendWhatsAppNotification(pendingRegistration);
            
            showNotification('Registration Successful!', 'Admin will send you an unlock code via WhatsApp. Browse universities now!', 'success');
            
            // Clear form
            clearRegistrationForm();
            
            // Update statistics
            updateStatistics();
            
            console.log('Student registration pending:', phone);
        }

        function highlightEmptyFields() {
            const fields = [
                { id: 'studentName', value: document.getElementById('studentName').value.trim() },
                { id: 'studentPhone', value: document.getElementById('studentPhone').value.trim() },
                { id: 'studentUniversity', value: document.getElementById('studentUniversity').value },
                { id: 'studentCourse', value: document.getElementById('studentCourse').value.trim() },
                { id: 'studentYear', value: document.getElementById('studentYear').value },
                { id: 'paymentCode', value: document.getElementById('paymentCode').value.trim() }
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (!field.value && element) {
                    element.style.borderColor = 'var(--danger)';
                    element.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                }
            });
        }

        function clearRegistrationForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentUniversity').value = '';
            document.getElementById('studentCourse').value = '';
            document.getElementById('studentYear').value = '';
            document.getElementById('paymentCode').value = '';
            
            // Reset borders
            const fields = ['studentName', 'studentPhone', 'studentUniversity', 'studentCourse', 'studentYear', 'paymentCode'];
            fields.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.borderColor = '#e2e8f0';
                    element.style.boxShadow = 'none';
                }
            });
        }

        // ==================== USER LOGIN ====================
        function loginStudent() {
            console.log('Logging in student...');
            
            const phone = document.getElementById('loginPhone').value.trim();
            const unlockCode = document.getElementById('unlockCode').value.trim();
            
            if (!phone || !unlockCode) {
                showNotification('Error', 'Please enter both phone number and unlock code', 'error');
                return;
            }
            
            if (phone.length !== 10 || !phone.startsWith('07')) {
                showNotification('Error', 'Please enter a valid Kenyan phone number (07XXXXXXXX)', 'error');
                return;
            }
            
            const user = appState.users.find(u => u.phone === phone);
            
            if (user) {
                if (user.subscription.status === 'approved' && user.subscription.unlockCode === unlockCode) {
                    // Activate subscription
                    user.subscription.active = true;
                    user.subscription.startDate = new Date().toISOString();
                    user.subscription.endDate = new Date(Date.now() + 5 * 30 * 24 * 60 * 60 * 1000).toISOString();
                    user.activity.lastLogin = new Date().toISOString();
                    appState.currentUser = user;
                    
                    // Update in Firebase if connected
                    if (appState.firebaseConnected) {
                        usersRef.child(user.id).update({
                            'subscription.active': true,
                            'subscription.startDate': user.subscription.startDate,
                            'subscription.endDate': user.subscription.endDate,
                            'activity.lastLogin': user.activity.lastLogin
                        });
                    }
                    
                    saveAppData();
                    updateAccessStatus();
                    
                    // Show success message
                    const loginMessage = document.getElementById('loginMessage');
                    loginMessage.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 48px; color: #10b981; margin-bottom: 15px;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3 style="color: #065f46; margin-bottom: 10px;">Login Successful!</h3>
                            <p style="color: #047857; margin-bottom: 20px;">Welcome back, ${user.name}! Your subscription is now active.</p>
                            <button class="submit-btn" onclick="showTab('home')" style="width: auto; padding: 12px 30px;">
                                <i class="fas fa-home"></i> Go to Home
                            </button>
                        </div>
                    `;
                    loginMessage.className = 'login-message success';
                    loginMessage.style.display = 'block';
                    
                    showNotification('Login Successful', `Welcome back, ${user.name}!`, 'success');
                    console.log('User logged in successfully:', phone);
                    
                    // Update statistics
                    updateStatistics();
                } else if (user.subscription.status === 'pending') {
                    showNotification('Account Pending', 'Your registration is still pending approval from admin', 'warning');
                    const loginMessage = document.getElementById('loginMessage');
                    loginMessage.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 36px; color: #f59e0b; margin-bottom: 10px;">
                                <i class="fas fa-clock"></i>
                            </div>
                            <h3 style="color: #92400e; margin-bottom: 10px;">Account Pending Approval</h3>
                            <p style="color: #92400e; margin-bottom: 15px;">Your registration is being reviewed by admin. You'll receive an unlock code via WhatsApp once approved.</p>
                            <button class="university-browse-btn small" onclick="openUniversityListModal()">
                                <i class="fas fa-university"></i> Browse Universities While Waiting
                            </button>
                        </div>
                    `;
                    loginMessage.className = 'login-message error';
                    loginMessage.style.display = 'block';
                } else if (user.subscription.status === 'rejected') {
                    showNotification('Account Rejected', 'Your registration was rejected. Please contact admin.', 'error');
                } else {
                    showNotification('Login Failed', 'Invalid unlock code', 'error');
                }
            } else {
                // Check if user is in pending registrations
                const pendingUser = appState.pendingRegistrations.find(u => u.phone === phone);
                if (pendingUser) {
                    showNotification('Account Pending', 'Your registration is still pending approval from admin', 'warning');
                    const loginMessage = document.getElementById('loginMessage');
                    loginMessage.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 36px; color: #f59e0b; margin-bottom: 10px;">
                                <i class="fas fa-clock"></i>
                            </div>
                            <h3 style="color: #92400e; margin-bottom: 10px;">Account Pending Approval</h3>
                            <p style="color: #92400e; margin-bottom: 15px;">Your registration is being reviewed by admin. You'll receive an unlock code via WhatsApp once approved.</p>
                            <button class="university-browse-btn small" onclick="openUniversityListModal()">
                                <i class="fas fa-university"></i> Browse Universities While Waiting
                            </button>
                        </div>
                    `;
                    loginMessage.className = 'login-message error';
                    loginMessage.style.display = 'block';
                } else {
                    showNotification('User Not Found', 'Phone number not registered. Please register first.', 'error');
                    const loginMessage = document.getElementById('loginMessage');
                    loginMessage.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 36px; color: #ef4444; margin-bottom: 10px;">
                                <i class="fas fa-user-times"></i>
                            </div>
                            <h3 style="color: #991b1b; margin-bottom: 10px;">User Not Found</h3>
                            <p style="color: #991b1b; margin-bottom: 15px;">This phone number is not registered. Please register first.</p>
                            <button class="submit-btn" onclick="showTab('register')" style="width: auto; padding: 12px 30px;">
                                <i class="fas fa-user-plus"></i> Go to Registration
                            </button>
                        </div>
                    `;
                    loginMessage.className = 'login-message error';
                    loginMessage.style.display = 'block';
                }
            }
        }

        // ==================== DOCUMENT VIEWER ====================
        function openDocumentViewer(url, title, unitCode, university, year, subject) {
            console.log('Opening document viewer:', title);
            
            // Check if user has active subscription
            if (!appState.currentUser || !appState.currentUser.subscription.active) {
                showTab('register');
                showNotification('Access Denied', 'Please subscribe to view documents', 'warning');
                return;
            }
            
            // Check subscription expiry
            if (appState.currentUser && appState.currentUser.subscription.active) {
                const endDate = new Date(appState.currentUser.subscription.endDate);
                const now = new Date();
                
                if (endDate < now) {
                    appState.currentUser.subscription.active = false;
                    appState.currentUser.subscription.status = 'expired';
                    saveAppData();
                    updateAccessStatus();
                    
                    showTab('register');
                    showNotification('Subscription Expired', 'Your subscription has expired. Please subscribe again to continue accessing documents.', 'warning');
                    return;
                }
            }
            
            // Show loading state
            document.getElementById('pdfLoading').style.display = 'flex';
            document.getElementById('pdfError').style.display = 'none';
            document.getElementById('pdfViewer').style.display = 'none';
            document.getElementById('pdfViewer').classList.remove('active');
            
            // Update modal title
            document.getElementById('pdfModalTitle').innerHTML = `<i class="fas fa-file-pdf"></i><span>${title} (${unitCode})</span>`;
            
            // Convert URL to proper embed format if needed
            let embedUrl = url;
            if (url.includes('drive.google.com')) {
                if (!url.includes('/preview')) {
                    const match = url.match(/\/d\/([^\/]+)/) || url.match(/id=([^&]+)/);
                    if (match && match[1]) {
                        embedUrl = `https://drive.google.com/file/d/${match[1]}/preview`;
                    }
                }
                if (embedUrl.includes('preview')) {
                    embedUrl += (embedUrl.includes('?') ? '&' : '?') + 'rm=minimal';
                }
            }
            
            // Set viewer source
            const viewer = document.getElementById('pdfViewer');
            viewer.src = embedUrl;
            
            // Open modal
            openModal('pdfModal');
            
            // Preload document
            setTimeout(() => {
                if (viewer.src) {
                    document.getElementById('pdfLoading').style.display = 'none';
                    viewer.style.display = 'block';
                    viewer.classList.add('active');
                }
            }, 500);
            
            viewer.onerror = function() {
                document.getElementById('pdfLoading').style.display = 'none';
                document.getElementById('pdfError').style.display = 'flex';
                showNotification('Error', 'Could not load document. Please try again.', 'error');
            };
            
            // Set timeout for loading
            setTimeout(() => {
                if (document.getElementById('pdfLoading').style.display !== 'none') {
                    document.getElementById('pdfLoading').style.display = 'none';
                    viewer.style.display = 'block';
                    viewer.classList.add('active');
                }
            }, 2000);
            
            // Update user activity
            if (appState.currentUser) {
                appState.currentUser.activity.materialsViewed.push({
                    title: title,
                    unitCode: unitCode,
                    viewedAt: new Date().toISOString()
                });
                saveAppData();
            }
            
            // Update statistics
            appState.statistics.totalDownloads++;
            saveAppData();
            
            console.log('Document viewer opened for:', title);
        }

        // ==================== MODAL FUNCTIONS ====================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
            
            // Clear PDF viewer
            if (modalId === 'pdfModal') {
                const viewer = document.getElementById('pdfViewer');
                viewer.src = 'about:blank';
                
                // Reset loading states
                document.getElementById('pdfLoading').style.display = 'none';
                document.getElementById('pdfError').style.display = 'none';
            }
        }

        function openUniversityListModal() {
            console.log('Opening university list modal');
            document.getElementById('universityListModal').classList.add('active');
        }

        function closeUniversityListModal() {
            document.getElementById('universityListModal').classList.remove('active');
        }

        // ==================== TAB NAVIGATION ====================
        function showTab(tabName) {
            console.log('Showing tab:', tabName);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
            
            // Update bottom navigation
            document.querySelectorAll('.bottom-nav .nav-btn').forEach(btn => btn.classList.remove('active'));
            
            const buttons = {
                'home': 0,
                'materials': 1,
                'upload': 2,
                'register': 3,
                'admin': 4
            };
            
            if (buttons[tabName] !== undefined) {
                document.querySelectorAll('.bottom-nav .nav-btn')[buttons[tabName]].classList.add('active');
            }
            
            // For Login tab, don't highlight any bottom-nav button
            if (tabName === 'login') {
                document.querySelectorAll('.bottom-nav .nav-btn').forEach(btn => btn.classList.remove('active'));
            }
            
            // Clear search when switching tabs
            if (tabName !== 'home') {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) searchInput.value = '';
                const searchResults = document.getElementById('searchResults');
                if (searchResults) searchResults.classList.remove('active');
                const continueReading = document.getElementById('continueReading');
                if (continueReading) continueReading.style.display = 'block';
                hideSearchSuggestions();
            }
            
            // Execute tab-specific actions
            switch(tabName) {
                case 'home':
                    renderHomeContent();
                    break;
                case 'materials':
                    renderAllMaterials();
                    break;
                case 'upload':
                    const uploadForm = document.getElementById('uploadForm');
                    const uploadSuccess = document.getElementById('uploadSuccess');
                    if (uploadForm) uploadForm.style.display = 'block';
                    if (uploadSuccess) uploadSuccess.style.display = 'none';
                    break;
                case 'admin':
                    const adminPassword = document.getElementById('adminPassword');
                    if (adminPassword) adminPassword.value = '';
                    break;
            }
        }

        // ==================== RENDERING FUNCTIONS ====================
        function renderHomeContent() {
            console.log('Rendering home content...');
            
            renderContinueReading();
            renderTrendingMaterials();
            updateAccessStatus();
        }

        function renderContinueReading() {
            const grid = document.getElementById('continueReadingGrid');
            if (!grid) return;
            
            const recentMaterials = appState.documents.filter(doc => doc.Recent).slice(0, 6);
            
            grid.innerHTML = recentMaterials.map(doc => createMaterialCard(doc)).join('');
            console.log('Rendered continue reading:', recentMaterials.length, 'materials');
        }

        function renderAllMaterials() {
            const grid = document.getElementById('allMaterialsGrid');
            if (!grid) return;
            
            grid.innerHTML = appState.documents.map(doc => createMaterialCard(doc)).join('');
            console.log('Rendered all materials:', appState.documents.length, 'materials');
        }

        function renderTrendingMaterials() {
            const grid = document.getElementById('trendingGrid');
            if (!grid) return;
            
            const trendingMaterials = appState.documents.filter(doc => doc.Trending).slice(0, 4);
            
            grid.innerHTML = trendingMaterials.map(doc => createMaterialCard(doc)).join('');
            console.log('Rendered trending materials:', trendingMaterials.length, 'materials');
        }

        // ==================== MATERIAL CARD CREATION ====================
        function createMaterialCard(doc) {
            const hasAccess = appState.currentUser && appState.currentUser.subscription && 
                             appState.currentUser.subscription.active;
            
            const badges = [];
            if (doc.Trending) badges.push('<div class="material-badge trending">TRENDING</div>');
            if (doc.Recent) badges.push('<div class="material-badge recent">RECENT</div>');
            
            // Show material type
            const typeBadge = doc.Type ? 
                `<div class="material-type">${doc.Type.toUpperCase()}</div>` : 
                '<div class="material-type">PDF</div>';
            
            return `
                <div class="material-card">
                    ${badges.join('')}
                    ${typeBadge}
                    
                    <div class="material-image">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    
                    <div class="material-content">
                        <h3 class="material-title">${doc.Title}</h3>
                        
                        <div class="material-meta">
                            <span class="material-code">${doc["Unit Code"]}</span>
                            <span class="material-year">Year ${doc.Year}</span>
                        </div>
                        
                        <div class="material-info">
                            <i class="fas fa-university"></i>
                            <span>${doc.University}</span>
                            <span style="margin-left: auto; font-size: 11px;">
                                <i class="fas fa-book"></i> ${doc.Subject}
                            </span>
                        </div>
                        
                        <p class="material-description">${doc.Description}</p>
                        
                        <div class="material-actions">
                            ${hasAccess ? 
                                `<button class="action-btn view-btn" onclick="openDocumentViewer('${doc.URL}', '${doc.Title}', '${doc["Unit Code"]}', '${doc.University}', '${doc.Year}', '${doc.Subject}')">
                                    <i class="fas fa-eye"></i> View Document
                                </button>` :
                                `<button class="action-btn view-btn" onclick="showTab('register')">
                                    <i class="fas fa-lock"></i> Subscribe to View
                                </button>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== ACCESS STATUS ====================
        function updateAccessStatus() {
            const accessStatus = document.getElementById('accessStatus');
            if (!accessStatus) return;
            
            if (appState.currentUser && appState.currentUser.subscription && appState.currentUser.subscription.active) {
                const endDate = new Date(appState.currentUser.subscription.endDate);
                const now = new Date();
                
                // Check if subscription is expired
                if (endDate < now) {
                    appState.currentUser.subscription.active = false;
                    appState.currentUser.subscription.status = 'expired';
                    saveAppData();
                    
                    accessStatus.innerHTML = `
                        <div class="access-text">
                            <h3><i class="fas fa-lock"></i> Subscription Expired</h3>
                            <p>Your subscription has expired. Please renew to continue accessing materials</p>
                        </div>
                        <button class="view-btn" onclick="showTab('register')" style="width: auto; padding: 10px 20px;">
                            <i class="fas fa-sync-alt"></i> Renew Subscription
                        </button>
                    `;
                    accessStatus.classList.remove('access-granted');
                } else {
                    const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                    
                    accessStatus.innerHTML = `
                        <div class="access-text">
                            <h3><i class="fas fa-unlock"></i> Access Granted</h3>
                            <p>Full access to all study materials (${daysLeft} days remaining)</p>
                        </div>
                        <button class="view-btn" onclick="showTab('materials')" style="width: auto; padding: 10px 20px;">
                            <i class="fas fa-book"></i> Browse Materials
                        </button>
                    `;
                    accessStatus.classList.add('access-granted');
                }
            } else {
                accessStatus.innerHTML = `
                    <div class="access-text">
                        <h3><i class="fas fa-lock"></i> Access Locked</h3>
                        <p>Subscribe to unlock all study materials and features</p>
                    </div>
                    <button class="view-btn" onclick="showTab('register')" style="width: auto; padding: 10px 20px;">
                        <i class="fas fa-crown"></i> Subscribe Now
                    </button>
                `;
                accessStatus.classList.remove('access-granted');
            }
        }

        // ==================== REGISTRATION SUCCESS ====================
        function showRegistrationSuccessBanner() {
            const banner = document.getElementById('registrationSuccessBanner');
            if (banner) {
                banner.classList.add('active');
            }
        }

        function checkRegistrationSuccess() {
            if (appState.recentlyRegisteredPhone) {
                showRegistrationSuccessBanner();
                setTimeout(() => {
                    showNotification('Registration Complete', 'Admin will send you an unlock code via WhatsApp', 'success');
                }, 1000);
            }
        }

        function showProgressSteps() {
            const progressSteps = document.getElementById('progressSteps');
            if (progressSteps) {
                progressSteps.style.display = 'flex';
            }
        }

        // ==================== UNIVERSITY MATERIALS ====================
        function showUniversityMaterials(university) {
            console.log('Showing materials for university:', university);
            
            // Filter documents for the selected university
            const universityMaterials = appState.documents.filter(doc => doc.University === university);
            
            // Update search to show these materials
            document.getElementById('searchInput').value = university;
            searchByUnitCode(university);
            
            // Close the modal
            closeUniversityListModal();
            
            showNotification('University Filter', `Showing ${universityMaterials.length} materials from ${university}`, 'success');
        }

        function showCategoryMaterials(category) {
            console.log('Showing materials for category:', category);
            
            // Filter documents for the selected category
            const categoryMaterials = appState.documents.filter(doc => doc.Subject === category);
            
            // Update search to show these materials
            document.getElementById('searchInput').value = category;
            searchByUnitCode(category);
            
            showNotification('Category Filter', `Showing ${categoryMaterials.length} materials in ${category}`, 'success');
        }

        // ==================== FILTER FUNCTIONS ====================
        function filterMaterials() {
            const university = document.getElementById('universityFilter').value;
            const year = document.getElementById('yearFilter').value;
            
            let filtered = appState.documents;
            
            if (university !== 'all') {
                filtered = filtered.filter(doc => doc.University === university);
            }
            
            if (year !== 'all') {
                filtered = filtered.filter(doc => doc.Year === year);
            }
            
            // Update the continue reading grid
            const grid = document.getElementById('continueReadingGrid');
            if (grid) {
                grid.innerHTML = filtered.slice(0, 6).map(doc => createMaterialCard(doc)).join('');
            }
            
            // Update the trending grid
            const trendingGrid = document.getElementById('trendingGrid');
            if (trendingGrid) {
                const trendingFiltered = filtered.filter(doc => doc.Trending).slice(0, 4);
                trendingGrid.innerHTML = trendingFiltered.map(doc => createMaterialCard(doc)).join('');
            }
            
            showNotification('Filter Applied', `Showing ${filtered.length} materials`, 'success');
        }

        function filterAllMaterials() {
            const university = document.getElementById('allUniversityFilter').value;
            const subject = document.getElementById('allSubjectFilter').value;
            
            let filtered = appState.documents;
            
            if (university !== 'all') {
                filtered = filtered.filter(doc => doc.University === university);
            }
            
            if (subject !== 'all') {
                filtered = filtered.filter(doc => doc.Subject === subject);
            }
            
            // Update the all materials grid
            const grid = document.getElementById('allMaterialsGrid');
            if (grid) {
                grid.innerHTML = filtered.map(doc => createMaterialCard(doc)).join('');
            }
            
            showNotification('Filter Applied', `Showing ${filtered.length} materials`, 'success');
        }

        // ==================== NOTIFICATION SYSTEM ====================
        function showNotification(title, message, type = 'info') {
            console.log('Showing notification:', title, message, type);
            
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            
            if (!notification || !notificationTitle || !notificationMessage) {
                console.error('Notification elements not found');
                return;
            }
            
            // Set color based on type
            switch(type) {
                case 'success':
                    notification.style.borderLeftColor = '#10b981';
                    break;
                case 'error':
                    notification.style.borderLeftColor = '#ef4444';
                    break;
                case 'warning':
                    notification.style.borderLeftColor = '#f59e0b';
                    break;
                default:
                    notification.style.borderLeftColor = '#3b82f6';
            }
            
            // Set icon based on type
            const icon = type === 'success' ? 'fas fa-check-circle' :
                        type === 'error' ? 'fas fa-times-circle' :
                        type === 'warning' ? 'fas fa-exclamation-triangle' :
                        'fas fa-info-circle';
            
            notificationTitle.innerHTML = `<i class="${icon}"></i> ${title}`;
            notificationMessage.textContent = message;
            
            notification.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.classList.remove('show');
            }
        }

        // ==================== WHATSAPP NOTIFICATIONS ====================
        function sendWhatsAppNotification(pendingRegistration) {
            const adminNumber = appState.adminWhatsApp.replace(/^0/, '254').replace(/^\+/, '');
            const message = ` NEW PENDING REGISTRATION - RevisionVault Pro
            
 Name: ${pendingRegistration.name}
 Phone: ${pendingRegistration.phone}
 University: ${pendingRegistration.university}
 Course: ${pendingRegistration.course}
 Year: ${pendingRegistration.year}
 Payment Code: ${pendingRegistration.paymentCode}
 Date: ${new Date(pendingRegistration.registrationDate).toLocaleString()}
 Pending ID: ${pendingRegistration.id}

Please review and approve this registration.`;

            const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
            console.log('WhatsApp notification sent to admin for pending registration');
        }

        function sendUnlockCodeWhatsApp(phone, unlockCode) {
            const whatsappUrl = `https://wa.me/254${phone.substring(1)}?text=${encodeURIComponent(
                ` UNLOCK CODE - RevisionVault Pro\n\nYour account has been approved!\n\n Unlock Code: ${unlockCode}\n\n Login Steps:\n1. Go to RevisionVault Pro\n2. Click Login tab\n3. Enter your phone: ${phone}\n4. Enter unlock code: ${unlockCode}\n5. Click Login\n\n Welcome to RevisionVault Pro!`
            )}`;
            window.open(whatsappUrl, '_blank');
            
            showNotification('WhatsApp Sent', `Unlock code sent to ${phone}`, 'success');
            console.log('Unlock code sent via WhatsApp to:', phone);
        }

        // ==================== ADMIN FUNCTIONS ====================
        function adminLogin() {
            console.log('Admin login attempt...');
            
            const passwordInput = document.getElementById('adminPassword').value;
            const adminPanel = document.getElementById('adminPanel');

            if (passwordInput === appState.adminPassword) {
                // Hide the login form and show the admin panel
                document.querySelector('#admin .content-header').style.display = 'none';
                document.querySelector('#admin .form-group').style.display = 'none';
                document.querySelector('#admin .submit-btn').style.display = 'none';
                adminPanel.style.display = 'block';

                // Load the pending approvals and other admin data
                loadPendingApprovals();
                loadAllStudents();
                loadAdminMaterials();
                loadUserUploads();

                // Show the pending section by default
                showAdminSection('pending');

                showNotification('Admin Login', 'Welcome, Admin!', 'success');
                console.log('Admin login successful');
            } else {
                showNotification('Error', 'Incorrect admin password', 'error');
                document.getElementById('adminPassword').style.borderColor = 'var(--danger)';
                console.log('Admin login failed: incorrect password');
            }
        }

        function adminLogout() {
            console.log('Admin logout...');
            
            // Show the login form and hide the admin panel
            document.querySelector('#admin .content-header').style.display = 'block';
            document.querySelector('#admin .form-group').style.display = 'block';
            document.querySelector('#admin .submit-btn').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';

            // Clear the password field
            document.getElementById('adminPassword').value = '';

            showNotification('Admin Logout', 'You have been logged out', 'info');
        }

        function showAdminSection(sectionName) {
            console.log('Showing admin section:', sectionName);
            
            // Hide all admin sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show the selected section
            const section = document.getElementById(sectionName + 'Section');
            if (section) {
                section.style.display = 'block';
            }

            // Load section-specific data
            switch(sectionName) {
                case 'pending':
                    loadPendingApprovals();
                    break;
                case 'students':
                    loadAllStudents();
                    break;
                case 'materials':
                    loadAdminMaterials();
                    break;
                case 'uploads':
                    loadUserUploads();
                    break;
                case 'documentManagement':
                    loadDocumentManagement();
                    break;
                case 'statistics':
                    updateStatistics();
                    loadStatistics();
                    break;
                case 'backup':
                    // Nothing extra to load for backup
                    break;
                case 'jsonUpload':
                    // Nothing extra to load for JSON upload
                    break;
            }
        }

        function loadPendingApprovals() {
            console.log('Loading pending approvals...');
            
            const pendingList = document.getElementById('pendingList');
            if (!pendingList) return;
            
            const spinner = pendingList.querySelector('.spinner');
            spinner.style.display = 'block';
            
            if (appState.pendingRegistrations.length === 0) {
                pendingList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No pending approvals</p>';
                spinner.style.display = 'none';
                return;
            }
            
            pendingList.innerHTML = appState.pendingRegistrations.map(registration => `
                <div style="border: 2px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong>${registration.name}</strong>
                                <span class="status-badge status-pending">PENDING</span>
                            </div>
                            <div style="font-size: 12px; color: #64748b;">
                                ${new Date(registration.registrationDate).toLocaleDateString()}
                            </div>
                        </div>
                        
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
                            <div> ${registration.phone}</div>
                            <div> ${registration.university}</div>
                            <div> ${registration.course} (Year ${registration.year})</div>
                            <div style="color: #f59e0b; margin-top: 5px;">
                                 Payment Code: ${registration.paymentCode}
                            </div>
                        </div>
                        
                        <div class="admin-approval-buttons">
                            <button class="approve-btn" onclick="approveStudent('${registration.pendingId || registration.id}', '${registration.phone}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="reject-btn" onclick="rejectStudent('${registration.pendingId || registration.id}', '${registration.phone}')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            spinner.style.display = 'none';
            
            // Update count
            const pendingCount = document.getElementById('pendingCount');
            if (pendingCount) {
                pendingCount.textContent = `${appState.pendingRegistrations.length} pending`;
            }
            
            console.log('Loaded pending approvals:', appState.pendingRegistrations.length);
        }

        function approveStudent(pendingId, phone) {
            console.log('Approving student:', phone, 'pendingId:', pendingId);
            
            // Find the pending registration
            const pendingIndex = appState.pendingRegistrations.findIndex(p => 
                (p.pendingId === pendingId) || (p.id === pendingId)
            );
            
            if (pendingIndex === -1) {
                showNotification('Error', 'Pending registration not found', 'error');
                return;
            }
            
            const pendingRegistration = appState.pendingRegistrations[pendingIndex];
            const unlockCode = generateUnlockCode();
            
            // Create approved user object
            const approvedUser = {
                id: Date.now().toString(),
                name: pendingRegistration.name,
                phone: pendingRegistration.phone,
                university: pendingRegistration.university,
                course: pendingRegistration.course,
                year: pendingRegistration.year,
                registrationDate: new Date().toISOString(),
                subscription: {
                    active: false,
                    unlockCode: unlockCode,
                    status: 'approved',
                    approvedDate: new Date().toISOString(),
                    startDate: null,
                    endDate: null
                },
                activity: {
                    lastLogin: null,
                    materialsViewed: [],
                    universitiesBrowsed: []
                }
            };
            
            // Add to approved users
            appState.users.push(approvedUser);
            
            // Remove from pending registrations
            appState.pendingRegistrations.splice(pendingIndex, 1);
            
            // Update Firebase
            if (appState.firebaseConnected) {
                // Add to users collection
                usersRef.child(approvedUser.id).set(approvedUser);
                
                // Remove from pending registrations
                if (pendingId.startsWith('pending_')) {
                    pendingRegistrationsRef.child(pendingId).remove();
                } else {
                    // Find by phone if pendingId is not a Firebase key
                    pendingRegistrationsRef.orderByChild('phone').equalTo(phone).once('value').then(snapshot => {
                        snapshot.forEach(child => {
                            pendingRegistrationsRef.child(child.key).remove();
                        });
                    });
                }
            }
            
            saveAppData();
            
            // Send unlock code via WhatsApp
            sendUnlockCodeWhatsApp(phone, unlockCode);
            
            showNotification('Approved', `Unlock code sent to ${phone}`, 'success');
            
            // Update statistics
            updateStatistics();
            
            // Reload pending approvals
            loadPendingApprovals();
            
            console.log('Student approved and moved to users:', phone);
        }

        function rejectStudent(pendingId, phone) {
            console.log('Rejecting student:', phone, 'pendingId:', pendingId);
            
            if (confirm('Are you sure you want to reject this student?')) {
                // Find the pending registration
                const pendingIndex = appState.pendingRegistrations.findIndex(p => 
                    (p.pendingId === pendingId) || (p.id === pendingId)
                );
                
                if (pendingIndex === -1) {
                    showNotification('Error', 'Pending registration not found', 'error');
                    return;
                }
                
                // Remove from pending registrations
                appState.pendingRegistrations.splice(pendingIndex, 1);
                
                // Update Firebase
                if (appState.firebaseConnected) {
                    if (pendingId.startsWith('pending_')) {
                        pendingRegistrationsRef.child(pendingId).remove();
                    } else {
                        // Find by phone if pendingId is not a Firebase key
                        pendingRegistrationsRef.orderByChild('phone').equalTo(phone).once('value').then(snapshot => {
                            snapshot.forEach(child => {
                                pendingRegistrationsRef.child(child.key).remove();
                            });
                        });
                    }
                }
                
                saveAppData();
                
                showNotification('Rejected', 'Student registration rejected', 'success');
                
                // Update statistics
                updateStatistics();
                
                // Reload pending approvals
                loadPendingApprovals();
                
                console.log('Student rejected and removed:', phone);
            }
        }

        function loadAllStudents() {
            console.log('Loading all students...');
            
            const studentList = document.getElementById('studentList');
            if (!studentList) return;
            
            const spinner = studentList.querySelector('.spinner');
            spinner.style.display = 'block';
            
            studentList.innerHTML = appState.users.map(user => `
                <div style="border: 2px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <strong>${user.name}</strong>
                            <span class="status-badge ${user.subscription.status === 'approved' ? 'status-approved' : 
                                                         user.subscription.status === 'pending' ? 'status-pending' : 
                                                         'status-expired'}">
                                ${user.subscription.status.toUpperCase()}
                            </span>
                            ${user.subscription.active ? '<span class="status-badge status-active">ACTIVE</span>' : ''}
                        </div>
                        <div style="font-size: 12px; color: #64748b;">
                            ${new Date(user.registrationDate).toLocaleDateString()}
                        </div>
                    </div>
                    
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
                        <div> ${user.phone}</div>
                        <div> ${user.university}</div>
                        <div> ${user.course} (Year ${user.year})</div>
                        ${user.subscription.unlockCode ? 
                            `<div style="color: #10b981; margin-top: 5px;">
                                 Unlock Code: ${user.subscription.unlockCode}
                            </div>` : ''
                        }
                        ${user.subscription.active && user.subscription.endDate ? 
                            `<div style="color: #3b82f6; margin-top: 5px;">
                                 Expires: ${new Date(user.subscription.endDate).toLocaleDateString()}
                            </div>` : ''
                        }
                    </div>
                </div>
            `).join('');
            
            spinner.style.display = 'none';
            
            console.log('Loaded all students:', appState.users.length);
        }

        // ==================== DOCUMENT MANAGEMENT ====================
        function loadAdminMaterials() {
            console.log('Loading admin materials...');
            
            const adminMaterialsList = document.getElementById('adminMaterialsList');
            if (!adminMaterialsList) return;
            
            const spinner = adminMaterialsList.querySelector('.spinner');
            spinner.style.display = 'block';
            
            adminMaterialsList.innerHTML = appState.documents.map((doc, index) => `
                <div style="border: 2px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <strong>${doc.Title}</strong>
                            <span class="status-badge ${doc.Trending ? 'status-active' : 'status-pending'}">
                                ${doc.Trending ? 'TRENDING' : 'STANDARD'}
                            </span>
                            ${doc.Recent ? '<span class="status-badge status-approved">RECENT</span>' : ''}
                        </div>
                        <button class="reject-btn" onclick="deleteMaterial(${index})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                    
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
                        <div> ${doc["Unit Code"]}  Year ${doc.Year}</div>
                        <div> ${doc.University}</div>
                        <div> ${doc.Subject}</div>
                        <div style="margin-top: 5px;">${doc.Description}</div>
                        <div style="margin-top: 5px; font-size: 11px; color: #94a3b8;">
                            <i class="fas fa-link"></i> ${doc.URL.substring(0, 50)}...
                        </div>
                    </div>
                </div>
            `).join('');
            
            spinner.style.display = 'none';
            
            console.log('Loaded admin materials:', appState.documents.length);
        }

        function addNewMaterial() {
            console.log('Adding new material...');
            
            const title = prompt('Enter material title:');
            if (!title) return;
            
            const unitCode = prompt('Enter unit code:');
            if (!unitCode) return;
            
            const university = prompt('Enter university:');
            if (!university) return;
            
            const year = prompt('Enter year (1-4):');
            if (!year) return;
            
            const subject = prompt('Enter subject:');
            if (!subject) return;
            
            const description = prompt('Enter description:');
            if (!description) return;
            
            const url = prompt('Enter Google Drive URL (must end with /preview):');
            if (!url) return;
            
            const newMaterial = {
                "Title": title,
                "Unit Code": unitCode,
                "University": university,
                "Type": "pdf",
                "Subject": subject,
                "Year": year,
                "Description": description,
                "URL": url,
                "Trending": false,
                "Recent": true
            };
            
            // Add to Firebase
            if (appState.firebaseConnected) {
                const docId = `doc_${Date.now()}`;
                documentsRef.child(docId).set(newMaterial);
            }
            
            // Add to local state
            appState.documents.push(newMaterial);
            saveAppData();
            
            showNotification('Added', 'New material added successfully', 'success');
            
            // Update UI
            initializeCategories();
            initializeUnitCodes();
            renderHomeContent();
            updateStatistics();
            loadAdminMaterials();
            
            console.log('New material added:', title);
        }

        function deleteMaterial(index) {
            console.log('Deleting material at index:', index);
            
            if (confirm('Are you sure you want to delete this material? Only admin can delete.')) {
                const doc = appState.documents[index];
                
                // Remove from Firebase if connected
                if (appState.firebaseConnected) {
                    // We need to find the document ID in Firebase
                    documentsRef.once('value').then(snapshot => {
                        const docs = snapshot.val();
                        for (const key in docs) {
                            if (docs[key].Title === doc.Title && docs[key]["Unit Code"] === doc["Unit Code"]) {
                                documentsRef.child(key).remove();
                                break;
                            }
                        }
                    });
                }
                
                // Remove from local state
                appState.documents.splice(index, 1);
                saveAppData();
                
                showNotification('Deleted', 'Material deleted successfully', 'success');
                
                // Update UI
                if (document.getElementById('adminMaterialsList')) {
                    loadAdminMaterials();
                }
                initializeCategories();
                initializeUnitCodes();
                renderHomeContent();
                updateStatistics();
                
                console.log('Material deleted:', doc.Title);
            }
        }

        // ==================== UPLOAD FUNCTIONALITY ====================
        function uploadMaterial() {
            console.log('Uploading material...');
            
            const title = document.getElementById('uploadTitle').value.trim();
            const unitCode = document.getElementById('uploadUnitCode').value.trim();
            const university = document.getElementById('uploadUniversity').value;
            const subject = document.getElementById('uploadSubject').value.trim();
            const year = document.getElementById('uploadYear').value;
            const description = document.getElementById('uploadDescription').value.trim();
            const url = document.getElementById('uploadURL').value.trim();
            const phone = document.getElementById('uploaderPhone').value.trim();
            
            // Validation
            if (!title || !unitCode || !university || !subject || !year || !description || !url || !phone) {
                showNotification('Error', 'Please fill in all fields', 'error');
                return;
            }
            
            if (phone.length !== 10 || !phone.startsWith('07')) {
                showNotification('Error', 'Please enter a valid Kenyan phone number (07XXXXXXXX)', 'error');
                return;
            }
            
            if (!url.includes('/preview')) {
                showNotification('Error', 'URL must be a direct preview link ending with /preview', 'error');
                return;
            }
            
            // Create upload record
            const upload = {
                id: Date.now().toString(),
                title: title,
                unitCode: unitCode,
                university: university,
                subject: subject,
                year: year,
                description: description,
                url: url,
                uploaderPhone: phone,
                uploadDate: new Date().toISOString(),
                status: 'pending',
                reviewedBy: null,
                reviewDate: null
            };
            
            // Add to Firebase
            if (appState.firebaseConnected) {
                userUploadsRef.child(upload.id).set(upload);
            }
            
            // Add to local state
            appState.userUploads.push(upload);
            saveAppData();
            
            // Show success message
            document.getElementById('uploadForm').style.display = 'none';
            document.getElementById('uploadSuccess').style.display = 'block';
            
            // Send WhatsApp notification to admin
            sendUploadNotification(upload);
            
            showNotification('Upload Submitted', 'Your material has been submitted for review', 'success');
            
            // Clear form
            clearUploadForm();
            
            // Update statistics
            updateStatistics();
            
            console.log('Material uploaded for review:', title);
        }

        function sendUploadNotification(upload) {
            const adminNumber = appState.adminWhatsApp.replace(/^0/, '254').replace(/^\+/, '');
            const message = ` NEW UPLOAD - RevisionVault Pro
            
 Title: ${upload.title}
 Unit Code: ${upload.unitCode}
 University: ${upload.university}
 Subject: ${upload.subject}
 Year: ${upload.year}
 Uploader: ${upload.uploaderPhone}

Please review this upload.`;

            const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            console.log('Upload notification sent to admin');
        }

        function clearUploadForm() {
            document.getElementById('uploadTitle').value = '';
            document.getElementById('uploadUnitCode').value = '';
            document.getElementById('uploadUniversity').value = '';
            document.getElementById('uploadSubject').value = '';
            document.getElementById('uploadYear').value = '';
            document.getElementById('uploadDescription').value = '';
            document.getElementById('uploadURL').value = '';
            document.getElementById('uploaderPhone').value = '';
        }

        function loadUserUploads() {
            console.log('Loading user uploads...');
            
            const userUploadsList = document.getElementById('userUploadsList');
            if (!userUploadsList) return;
            
            const spinner = userUploadsList.querySelector('.spinner');
            spinner.style.display = 'block';
            
            const pendingUploads = appState.userUploads.filter(upload => upload.status === 'pending');
            
            if (pendingUploads.length === 0) {
                userUploadsList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No pending uploads</p>';
                spinner.style.display = 'none';
                return;
            }
            
            userUploadsList.innerHTML = pendingUploads.map(upload => `
                <div style="border: 2px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <strong>${upload.title}</strong>
                            <span class="status-badge status-pending">PENDING</span>
                        </div>
                        <div style="font-size: 12px; color: #64748b;">
                            ${new Date(upload.uploadDate).toLocaleDateString()}
                        </div>
                    </div>
                    
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
                        <div> Uploader: ${upload.uploaderPhone}</div>
                        <div> ${upload.unitCode}  Year ${upload.year}</div>
                        <div> ${upload.university}</div>
                        <div> ${upload.subject}</div>
                        <div style="margin-top: 5px;">${upload.description}</div>
                        <div style="margin-top: 5px; font-size: 11px; color: #94a3b8;">
                            <i class="fas fa-link"></i> ${upload.url.substring(0, 50)}...
                        </div>
                    </div>
                    
                    <div class="admin-approval-buttons">
                        <button class="approve-btn" onclick="approveUpload('${upload.id}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="reject-btn" onclick="rejectUpload('${upload.id}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        <button class="send-whatsapp-btn" onclick="notifyUploader('${upload.uploaderPhone}', '${upload.title}', 'pending')">
                            <i class="fab fa-whatsapp"></i> Notify
                        </button>
                    </div>
                </div>
            `).join('');
            
            spinner.style.display = 'none';
            
            console.log('Loaded user uploads:', pendingUploads.length);
        }

        function approveUpload(uploadId) {
            console.log('Approving upload:', uploadId);
            
            const upload = appState.userUploads.find(u => u.id === uploadId);
            if (upload) {
                // Add to main documents
                const newDoc = {
                    "Title": upload.title,
                    "Unit Code": upload.unitCode,
                    "University": upload.university,
                    "Type": "pdf",
                    "Subject": upload.subject,
                    "Year": upload.year,
                    "Description": upload.description,
                    "URL": upload.url,
                    "Trending": false,
                    "Recent": true
                };
                
                // Add to Firebase
                if (appState.firebaseConnected) {
                    const docId = `doc_${Date.now()}`;
                    documentsRef.child(docId).set(newDoc);
                }
                
                // Add to local state
                appState.documents.push(newDoc);
                
                // Update upload status
                upload.status = 'approved';
                upload.reviewedBy = 'admin';
                upload.reviewDate = new Date().toISOString();
                
                // Update in Firebase
                if (appState.firebaseConnected) {
                    userUploadsRef.child(upload.id).update({
                        status: 'approved',
                        reviewedBy: 'admin',
                        reviewDate: upload.reviewDate
                    });
                }
                
                saveAppData();
                updateStatistics();
                
                // Notify uploader
                notifyUploader(upload.uploaderPhone, upload.title, 'approved');
                
                showNotification('Upload Approved', 'Material added to library', 'success');
                loadUserUploads();
                
                // Update UI
                initializeCategories();
                initializeUnitCodes();
                renderHomeContent();
                
                console.log('Upload approved:', upload.title);
            }
        }

        function rejectUpload(uploadId) {
            console.log('Rejecting upload:', uploadId);
            
            if (confirm('Are you sure you want to reject this upload?')) {
                const upload = appState.userUploads.find(u => u.id === uploadId);
                if (upload) {
                    upload.status = 'rejected';
                    upload.reviewedBy = 'admin';
                    upload.reviewDate = new Date().toISOString();
                    
                    // Update in Firebase
                    if (appState.firebaseConnected) {
                        userUploadsRef.child(upload.id).update({
                            status: 'rejected',
                            reviewedBy: 'admin',
                            reviewDate: upload.reviewDate
                        });
                    }
                    
                    saveAppData();
                    
                    // Notify uploader
                    notifyUploader(upload.uploaderPhone, upload.title, 'rejected');
                    
                    showNotification('Upload Rejected', 'User has been notified', 'success');
                    loadUserUploads();
                    
                    console.log('Upload rejected:', upload.title);
                }
            }
        }

        function notifyUploader(phone, title, status) {
            const message = status === 'approved' ?
                ` Your upload "${title}" has been approved and is now available on RevisionVault Pro!` :
                ` Your upload "${title}" has been rejected. Please ensure it meets our guidelines.`;
            
            const whatsappUrl = `https://wa.me/254${phone.substring(1)}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            console.log('Uploader notified:', phone, status);
        }

        // ==================== STATISTICS ====================
        function updateStatistics() {
            console.log('Updating statistics...');
            
            // Update statistics in the state
            appState.statistics.totalStudents = appState.users.length;
            appState.statistics.activeStudents = appState.users.filter(u => u.subscription.active).length;
            appState.statistics.pendingStudents = appState.pendingRegistrations.length;
            appState.statistics.totalDocuments = appState.documents.length;
            appState.statistics.trendingDocuments = appState.documents.filter(d => d.Trending).length;
            appState.statistics.recentDocuments = appState.documents.filter(d => d.Recent).length;
            appState.statistics.totalUniversities = new Set(appState.documents.map(d => d.University)).size;
            appState.statistics.totalUploads = appState.userUploads.length;
            appState.statistics.pendingUploads = appState.userUploads.filter(u => u.status === 'pending').length;
            appState.statistics.approvedUploads = appState.userUploads.filter(u => u.status === 'approved').length;
            
            // Calculate students per university
            const studentsPerUniversity = {};
            appState.users.forEach(user => {
                if (!studentsPerUniversity[user.university]) {
                    studentsPerUniversity[user.university] = 0;
                }
                studentsPerUniversity[user.university]++;
            });
            appState.statistics.studentsPerUniversity = studentsPerUniversity;
            appState.statistics.universitiesWithStudents = Object.keys(studentsPerUniversity).length;
            
            saveAppData();
            console.log('Statistics updated');
        }

        function loadStatistics() {
            console.log('Loading statistics display...');
            
            // Update statistics cards
            document.getElementById('totalStudents').textContent = appState.statistics.totalStudents;
            document.getElementById('activeStudents').textContent = appState.statistics.activeStudents;
            document.getElementById('pendingStudents').textContent = appState.statistics.pendingStudents;
            document.getElementById('totalDocuments').textContent = appState.statistics.totalDocuments;
            document.getElementById('trendingDocuments').textContent = appState.statistics.trendingDocuments;
            document.getElementById('recentDocuments').textContent = appState.statistics.recentDocuments;
            document.getElementById('totalUniversities').textContent = appState.statistics.totalUniversities;
            document.getElementById('universitiesWithStudents').textContent = appState.statistics.universitiesWithStudents;
            document.getElementById('totalUploads').textContent = appState.statistics.totalUploads;
            document.getElementById('pendingUploads').textContent = appState.statistics.pendingUploads;
            document.getElementById('approvedUploads').textContent = appState.statistics.approvedUploads;
            
            // Load students per university chart
            loadStudentsPerUniversityChart();
            
            // Load university statistics list
            loadUniversityStatisticsList();
        }

        function loadStudentsPerUniversityChart() {
            const chartContainer = document.getElementById('studentsPerUniversityChart');
            if (!chartContainer) return;
            
            const universities = Object.keys(appState.statistics.studentsPerUniversity);
            const studentCounts = Object.values(appState.statistics.studentsPerUniversity);
            
            if (universities.length === 0) {
                chartContainer.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No student data available</p>';
                return;
            }
            
            // Sort by student count descending
            const sortedData = universities.map((uni, index) => ({
                university: uni,
                count: studentCounts[index]
            })).sort((a, b) => b.count - a.count).slice(0, 10); // Top 10
            
            const maxCount = Math.max(...sortedData.map(d => d.count));
            
            chartContainer.innerHTML = sortedData.map(data => `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--dark); margin-bottom: 5px; display: flex; justify-content: space-between;">
                        <span>${data.university.length > 20 ? data.university.substring(0, 20) + '...' : data.university}</span>
                        <span>${data.count}</span>
                    </div>
                    <div class="chart-bar" style="width: ${(data.count / maxCount) * 100}%">
                        <div class="chart-label">${data.university.length > 15 ? data.university.substring(0, 15) + '...' : data.university}</div>
                        <div class="chart-value">${data.count}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadUniversityStatisticsList() {
            const listContainer = document.getElementById('universityStatisticsList');
            if (!listContainer) return;
            
            // Get unique universities from documents
            const universities = [...new Set(appState.documents.map(doc => doc.University))];
            
            if (universities.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No university data available</p>';
                return;
            }
            
            // Calculate statistics for each university
            const universityStats = universities.map(uni => {
                const documents = appState.documents.filter(doc => doc.University === uni);
                const students = appState.users.filter(user => user.university === uni).length;
                
                return {
                    name: uni,
                    documentCount: documents.length,
                    studentCount: students,
                    trendingCount: documents.filter(doc => doc.Trending).length,
                    recentCount: documents.filter(doc => doc.Recent).length
                };
            }).sort((a, b) => b.documentCount - a.documentCount);
            
            listContainer.innerHTML = universityStats.map(stat => `
                <div class="university-stats-item">
                    <div class="university-stats-logo">${stat.name.substring(0, 2).toUpperCase()}</div>
                    <div class="university-stats-info">
                        <div class="university-stats-name">${stat.name.length > 25 ? stat.name.substring(0, 25) + '...' : stat.name}</div>
                        <div class="university-stats-count">
                            <span><i class="fas fa-file-alt"></i> ${stat.documentCount} docs</span>
                            <span style="margin-left: 10px;"><i class="fas fa-users"></i> ${stat.studentCount} students</span>
                            ${stat.trendingCount > 0 ? `<span style="margin-left: 10px;"><i class="fas fa-fire"></i> ${stat.trendingCount} trending</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== DOCUMENT MANAGEMENT SECTION ====================
        function loadDocumentManagement() {
            console.log('Loading document management...');
            
            // Load document search
            searchDocumentsAdmin();
            
            // Load document statistics
            loadDocumentManagementStats();
        }

        function searchDocumentsAdmin() {
            const searchInput = document.getElementById('docSearchInput');
            const resultsContainer = document.getElementById('docManagementResults');
            
            if (!searchInput || !resultsContainer) return;
            
            const query = searchInput.value.trim().toLowerCase();
            
            let filteredDocs = appState.documents;
            
            if (query) {
                filteredDocs = appState.documents.filter(doc => 
                    (doc["Unit Code"] && doc["Unit Code"].toLowerCase().includes(query)) ||
                    (doc.Title && doc.Title.toLowerCase().includes(query)) ||
                    (doc.University && doc.University.toLowerCase().includes(query)) ||
                    (doc.Subject && doc.Subject.toLowerCase().includes(query))
                );
            }
            
            resultsContainer.innerHTML = filteredDocs.slice(0, 20).map((doc, index) => `
                <div style="border: 2px solid #e2e8f0; padding: 12px; margin-bottom: 8px; border-radius: 8px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <strong style="font-size: 14px;">${doc.Title}</strong>
                            <span style="font-size: 11px; color: var(--primary); background: #e0f2fe; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">${doc["Unit Code"]}</span>
                            ${doc.Trending ? '<span style="font-size: 10px; background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 4px; margin-left: 5px;">TRENDING</span>' : ''}
                        </div>
                        <div style="font-size: 11px; color: #64748b;">
                            ${doc.University}
                        </div>
                    </div>
                    
                    <div style="font-size: 11px; color: #64748b; margin-bottom: 8px;">
                        <span><i class="fas fa-book"></i> ${doc.Subject}</span>
                        <span style="margin-left: 10px;"><i class="fas fa-calendar"></i> Year ${doc.Year}</span>
                    </div>
                    
                    <div class="doc-action-buttons">
                        <button class="doc-view-btn" onclick="openDocumentViewer('${doc.URL}', '${doc.Title}', '${doc["Unit Code"]}', '${doc.University}', '${doc.Year}', '${doc.Subject}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="doc-edit-btn" onclick="toggleDocumentTrending(${index})">
                            <i class="fas fa-fire"></i> ${doc.Trending ? 'Remove Trending' : 'Make Trending'}
                        </button>
                        <button class="reject-btn" onclick="deleteMaterial(${index})" style="padding: 6px 10px; font-size: 11px;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
            
            if (filteredDocs.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No documents found</p>';
            }
        }

        function loadDocumentManagementStats() {
            const statsContainer = document.getElementById('docManagementStats');
            if (!statsContainer) return;
            
            const totalDocs = appState.documents.length;
            const trendingDocs = appState.documents.filter(d => d.Trending).length;
            const recentDocs = appState.documents.filter(d => d.Recent).length;
            const uniqueUniversities = new Set(appState.documents.map(d => d.University)).size;
            const uniqueSubjects = new Set(appState.documents.map(d => d.Subject)).size;
            
            statsContainer.innerHTML = `
                <div class="json-stat-item">
                    <div class="json-stat-number">${totalDocs}</div>
                    <div class="json-stat-label">Total Docs</div>
                </div>
                <div class="json-stat-item">
                    <div class="json-stat-number">${trendingDocs}</div>
                    <div class="json-stat-label">Trending</div>
                </div>
                <div class="json-stat-item">
                    <div class="json-stat-number">${recentDocs}</div>
                    <div class="json-stat-label">Recent</div>
                </div>
                <div class="json-stat-item">
                    <div class="json-stat-number">${uniqueUniversities}</div>
                    <div class="json-stat-label">Universities</div>
                </div>
                <div class="json-stat-item">
                    <div class="json-stat-number">${uniqueSubjects}</div>
                    <div class="json-stat-label">Subjects</div>
                </div>
            `;
        }

        function toggleDocumentTrending(index) {
            if (index >= 0 && index < appState.documents.length) {
                appState.documents[index].Trending = !appState.documents[index].Trending;
                
                // Update in Firebase
                if (appState.firebaseConnected) {
                    // Find the document in Firebase and update it
                    documentsRef.once('value').then(snapshot => {
                        const docs = snapshot.val();
                        for (const key in docs) {
                            if (docs[key].Title === appState.documents[index].Title && 
                                docs[key]["Unit Code"] === appState.documents[index]["Unit Code"]) {
                                documentsRef.child(key).update({
                                    Trending: appState.documents[index].Trending
                                });
                                break;
                            }
                        }
                    });
                }
                
                saveAppData();
                searchDocumentsAdmin();
                loadDocumentManagementStats();
                
                showNotification('Updated', `Document ${appState.documents[index].Trending ? 'marked as trending' : 'removed from trending'}`, 'success');
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function generateUnlockCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function copyAccountNumber() {
            const accountNumber = '0330184468200';
            copyToClipboard(accountNumber);
            
            const btn = event.target.closest('.copy-btn');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('copied');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            }
            
            showNotification('Copied', 'Account number copied to clipboard', 'success');
        }

        function copyText(text) {
            copyToClipboard(text);
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            btn.classList.add('copied');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('copied');
            }, 2000);
            
            showNotification('Copied', 'Text copied to clipboard', 'success');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('Text copied to clipboard:', text);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                // Fallback method
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }

        // ==================== PLACEHOLDER FUNCTIONS FOR FUTURE FEATURES ====================
        function openAIChat() {
            showNotification('Coming Soon', 'AI Chat feature is coming soon!', 'info');
        }

        function askAI() {
            showNotification('Coming Soon', 'AI Assistant is coming soon!', 'info');
        }

        function markAllAsTrending() {
            showNotification('Coming Soon', 'Bulk actions coming soon!', 'info');
        }

        function updateDocumentYears() {
            showNotification('Coming Soon', 'Document year update coming soon!', 'info');
        }

        function exportDocumentsCSV() {
            showNotification('Coming Soon', 'Export feature coming soon!', 'info');
        }

        function cleanDuplicateDocuments() {
            showNotification('Coming Soon', 'Duplicate removal coming soon!', 'info');
        }

        function exportStatistics() {
            showNotification('Coming Soon', 'Statistics export coming soon!', 'info');
        }

        function backupRecentUploads() {
            showNotification('Coming Soon', 'Backup feature coming soon!', 'info');
        }

        function backupAllDocuments() {
            showNotification('Coming Soon', 'Full backup coming soon!', 'info');
        }

        function copyJSONTemplate() {
            const template = `[
  {
    "Title": "Plant Breeding notes",
    "Unit Code": "AGRO222",
    "University": "Egerton University",
    "Type": "pdf",
    "Subject": "Agronomy",
    "Year": "2",
    "Description": "lecture notes on plant Breeding",
    "URL": "https://drive.google.com/file/d/.../preview"
  }
]`;
            copyToClipboard(template);
            showNotification('Copied', 'JSON template copied to clipboard', 'success');
        }

        function downloadCurrentDocuments() {
            const dataStr = JSON.stringify(appState.documents, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'revisionvault-documents.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Downloaded', 'Documents downloaded as JSON', 'success');
        }

        function handleJSONFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showNotification('Invalid File', 'Please select a JSON file (.json)', 'error');
                return;
            }
            
            const fileInfo = document.getElementById('jsonFileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const uploadBtn = document.getElementById('uploadJSONBtn');
            const jsonPreviewSection = document.getElementById('jsonPreviewSection');
            
            if (fileName) fileName.textContent = file.name;
            if (fileSize) fileSize.textContent = `${(file.size / 1024).toFixed(2)} KB`;
            if (fileInfo) fileInfo.style.display = 'block';
            if (uploadBtn) uploadBtn.disabled = false;
            
            // Read and preview the file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    previewJSONData(jsonData);
                    if (jsonPreviewSection) jsonPreviewSection.style.display = 'block';
                } catch (error) {
                    showNotification('Invalid JSON', 'The file contains invalid JSON format', 'error');
                    console.error('JSON parse error:', error);
                }
            };
            reader.readAsText(file);
        }

        function previewJSONData(jsonData) {
            const previewContainer = document.getElementById('jsonPreview');
            const statsContainer = document.getElementById('jsonStats');
            
            if (!previewContainer || !statsContainer) return;
            
            if (!Array.isArray(jsonData)) {
                previewContainer.innerHTML = '<p style="color: #ef4444;">Error: JSON must be an array of documents</p>';
                return;
            }
            
            // Preview first 3 documents
            previewContainer.innerHTML = jsonData.slice(0, 3).map(doc => `
                <div style="border: 1px solid #e2e8f0; padding: 10px; margin-bottom: 10px; border-radius: 6px; background: white;">
                    <div style="font-weight: bold; color: var(--primary);">${doc.Title || 'No title'}</div>
                    <div style="font-size: 12px; color: #64748b;">
                        <span>${doc["Unit Code"] || 'No code'}</span>  
                        <span>${doc.University || 'No university'}</span>  
                        <span>Year ${doc.Year || 'N/A'}</span>
                    </div>
                </div>
            `).join('');
            
            if (jsonData.length > 3) {
                previewContainer.innerHTML += `<p style="text-align: center; color: #64748b; font-size: 12px;">... and ${jsonData.length - 3} more documents</p>`;
            }
            
            // Show statistics
            statsContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: var(--primary);">${jsonData.length}</div>
                        <div style="font-size: 11px; color: #64748b;">Documents</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: var(--primary);">${new Set(jsonData.map(d => d.University)).size}</div>
                        <div style="font-size: 11px; color: #64748b;">Universities</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: var(--primary);">${new Set(jsonData.map(d => d["Unit Code"])).size}</div>
                        <div style="font-size: 11px; color: #64748b;">Unit Codes</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: var(--primary);">${new Set(jsonData.map(d => d.Subject)).size}</div>
                        <div style="font-size: 11px; color: #64748b;">Subjects</div>
                    </div>
                </div>
            `;
        }

        function clearJSONFile() {
            document.getElementById('jsonFileInput').value = '';
            document.getElementById('jsonFileInfo').style.display = 'none';
            document.getElementById('uploadJSONBtn').disabled = true;
            document.getElementById('jsonPreviewSection').style.display = 'none';
        }

        function uploadJSONDocuments() {
            const fileInput = document.getElementById('jsonFileInput');
            if (!fileInput.files[0]) {
                showNotification('Error', 'No file selected', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(jsonData)) {
                        showNotification('Error', 'JSON must be an array of documents', 'error');
                        return;
                    }
                    
                    // Add each document
                    jsonData.forEach(doc => {
                        // Add required fields if missing
                        const newDoc = {
                            "Title": doc.Title || "Untitled Document",
                            "Unit Code": doc["Unit Code"] || "UNKNOWN",
                            "University": doc.University || "Unknown University",
                            "Type": doc.Type || "pdf",
                            "Subject": doc.Subject || "General",
                            "Year": doc.Year || "1",
                            "Description": doc.Description || "No description provided",
                            "URL": doc.URL || "",
                            "Trending": doc.Trending || false,
                            "Recent": doc.Recent || true
                        };
                        
                        // Add to Firebase
                        if (appState.firebaseConnected) {
                            const docId = `doc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                            documentsRef.child(docId).set(newDoc);
                        }
                        
                        // Add to local state
                        appState.documents.push(newDoc);
                    });
                    
                    saveAppData();
                    
                    // Update UI
                    initializeCategories();
                    initializeUnitCodes();
                    renderHomeContent();
                    updateStatistics();
                    
                    showNotification('Success', `${jsonData.length} documents uploaded successfully`, 'success');
                    
                    // Clear the file input
                    clearJSONFile();
                    
                } catch (error) {
                    showNotification('Error', 'Failed to parse JSON file: ' + error.message, 'error');
                    console.error('JSON upload error:', error);
                }
            };
            reader.readAsText(fileInput.files[0]);
        }

        console.log('App initialization complete!');
    </script>
</body>
</html>