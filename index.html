<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RevisionVault Pro - Enhanced with Google Sheet Sync</title>
    
    <!-- Enhanced Security Meta Tags -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src * data:;">
    <meta name="theme-color" content="#1a2980">
    
    <style>
        /* ... (keep all existing styles) ... */
        
        /* ========== ENHANCED SHEET MANAGER STYLES ========== */
        .sheet-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }
        
        .sheet-info-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid var(--primary-light);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .sheet-columns-display {
            background: white;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .column-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            margin: 3px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .auto-sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 20px;
            color: var(--success);
            font-size: 14px;
        }
        
        .sync-history-table {
            background: white;
            border-radius: var(--radius);
            border: 2px solid var(--border);
            overflow: hidden;
            margin-top: 20px;
        }
        
        .sync-history-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .sync-history-table th {
            background: var(--light);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
        }
        
        .sync-history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .sync-history-table tr:last-child td {
            border-bottom: none;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.success { background: var(--success); }
        .status-dot.error { background: var(--danger); }
        .status-dot.warning { background: var(--warning); }
        .status-dot.processing { 
            background: var(--primary);
            animation: pulse 1.5s infinite;
        }
        
        .column-mapping-section {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 20px;
        }
        
        .mapping-row {
            display: grid;
            grid-template-columns: 150px 1fr 200px;
            gap: 15px;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        
        .last-sync-info {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }
        
        /* ... (rest of existing styles remain the same) ... */
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
</head>
<body>
    <!-- Screenshot Protection -->
    <div id="securityOverlay"></div>
    <div class="watermark">RevisionVault Pro â€¢ Secure System</div>
    <div class="security-indicator">
        <i class="fas fa-shield-alt"></i>
        <span>Secure Connection</span>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <h3 style="color: var(--primary); margin-bottom: 10px;">RevisionVault Pro</h3>
        <p id="loadingMessage" style="color: var(--gray);">Starting system...</p>
        <div class="progress-bar" style="width: 200px; margin-top: 20px;">
            <div class="progress-fill" id="loadingProgress" style="width: 0%"></div>
        </div>
    </div>

    <!-- ... (keep all existing modals) ... -->

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-container">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="logo-text">
                    <h1>RevisionVault Pro</h1>
                    <p>Premium University Study Materials Platform</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <i class="fas fa-shield-alt"></i>
                    <span>Ksh 67 for 5 Months</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-user-check"></i>
                    <span>Admin Approval Required</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-unlock"></i>
                    <span>Full Document Access</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Device-Locked Security</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-sync"></i>
                    <span>Auto Sync: <span id="autoSyncStatus">ON</span></span>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('student')" id="studentTab">
                    <i class="fas fa-user-graduate"></i>
                    <span>Student Portal</span>
                </div>
                <div class="tab" onclick="switchTab('documents')" id="documentsTab">
                    <i class="fas fa-file-alt"></i>
                    <span>Study Materials</span>
                    <span class="tab-badge" id="documentsBadge">0</span>
                </div>
                <div class="tab" onclick="switchTab('favorites')" id="favoritesTab">
                    <i class="fas fa-heart"></i>
                    <span>My Favorites</span>
                    <span class="tab-badge" id="favoritesBadge">0</span>
                </div>
                <div class="tab" onclick="switchTab('admin')" id="adminTab">
                    <i class="fas fa-user-shield"></i>
                    <span>Admin Panel</span>
                    <span class="tab-badge" id="adminBadge">0</span>
                </div>
                <div class="tab" onclick="switchTab('sheet-manager')" id="sheetManagerTab">
                    <i class="fas fa-table"></i>
                    <span>Google Sheet Manager</span>
                    <span class="tab-badge" id="sheetSyncBadge" style="background: var(--success);">âœ“</span>
                </div>
            </div>
        </div>

        <!-- ==================== STUDENT PORTAL ==================== -->
        <div id="student" class="tab-content active">
            <!-- ... (keep existing student portal content) ... -->
        </div>

        <!-- ==================== STUDY MATERIALS ==================== -->
        <div id="documents" class="tab-content">
            <div class="form-section">
                <div class="sheet-manager-header">
                    <div class="form-title">
                        <i class="fas fa-file-alt"></i>
                        <span>University Study Materials</span>
                        <span class="tag tag-primary" id="documentCount">0 documents</span>
                    </div>
                    
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span class="last-sync-info" id="lastSyncTime">
                            <i class="fas fa-clock"></i> Last sync: Never
                        </span>
                        <button class="btn btn-primary btn-sm" onclick="forceSyncDocuments()">
                            <i class="fas fa-sync"></i> Sync Now
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="switchTab('sheet-manager')">
                            <i class="fas fa-cog"></i> Manage Sync
                        </button>
                    </div>
                </div>
                
                <!-- Google Sheet Status -->
                <div id="sheetStatus" class="sheet-status disconnected">
                    <i class="fas fa-sync fa-spin"></i>
                    <span>Connecting to Google Sheet...</span>
                </div>
                
                <!-- Sync Status Details -->
                <div id="syncDetails" class="sheet-info-card" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin-bottom: 5px; color: var(--primary);">
                                <i class="fas fa-sync-alt"></i> Sync Active
                            </h4>
                            <p style="color: var(--gray); font-size: 14px;">
                                <span id="syncSource">Connected to Google Sheet</span>
                                â€¢ Auto-refresh every <span id="syncInterval">10</span> minutes
                            </p>
                        </div>
                        <span class="auto-sync-indicator">
                            <i class="fas fa-circle-check"></i>
                            Auto-sync enabled
                        </span>
                    </div>
                </div>

                <!-- Access Status -->
                <div id="accessStatusBar" class="card border" style="margin-bottom: 30px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <div style="text-align: left;">
                            <h4 id="accessStatusText" style="color: var(--danger); margin-bottom: 5px;">
                                <i class="fas fa-lock"></i> Access Locked
                            </h4>
                            <p style="color: var(--gray); font-size: 14px;" id="accessStatusDetails">Subscribe to unlock all materials</p>
                        </div>
                        <button class="btn btn-primary" onclick="switchTab('student')" id="subscribeBtnDocs">
                            <i class="fas fa-crown"></i> Subscribe Now
                        </button>
                    </div>
                </div>

                <!-- Favorites Preview -->
                <div class="favorites-section" id="favoritesPreview" style="display: none;">
                    <div class="form-title" style="font-size: 20px;">
                        <i class="fas fa-heart" style="color: var(--danger);"></i>
                        <span>Your Favorite Documents</span>
                    </div>
                    <div class="grid-3" id="favoritesGridPreview">
                        <!-- Favorites will be loaded here -->
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="switchTab('favorites')">
                            <i class="fas fa-eye"></i> View All Favorites
                        </button>
                    </div>
                </div>

                <!-- University Filter -->
                <div class="university-filter">
                    <span style="font-weight: 600; color: var(--dark);">Filter by University:</span>
                    <button class="university-btn active" onclick="filterByUniversity('all')">All</button>
                    <!-- University buttons will be loaded here -->
                </div>

                <!-- Search and Filters -->
                <div class="grid-2" style="margin-bottom: 20px;">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search documents by title, unit code, subject, or description..." oninput="filterDocuments()">
                    </div>
                    <div style="display: flex; gap: 15px;">
                        <select id="yearFilter" class="form-control" onchange="filterDocuments()">
                            <option value="all">All Years</option>
                            <option value="1">Year 1</option>
                            <option value="2">Year 2</option>
                            <option value="3">Year 3</option>
                            <option value="4">Year 4</option>
                        </select>
                        <select id="typeFilter" class="form-control" onchange="filterDocuments()">
                            <option value="all">All Types</option>
                            <option value="pdf">PDF</option>
                            <option value="word">Word</option>
                            <option value="excel">Excel</option>
                            <option value="powerpoint">PowerPoint</option>
                            <option value="image">Image</option>
                        </select>
                    </div>
                </div>

                <!-- Documents Grid -->
                <div class="grid-3" id="documentsGrid">
                    <div class="empty-state">
                        <i class="fas fa-sync fa-spin empty-state-icon"></i>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Loading Documents</h3>
                        <p style="color: var(--gray);">Syncing with Google Sheet...</p>
                    </div>
                </div>
                
                <!-- No Documents Message -->
                <div id="noDocumentsMessage" class="empty-state" style="display: none;">
                    <i class="fas fa-file-alt empty-state-icon"></i>
                    <h3>No Documents Found</h3>
                    <p>Try adjusting your search filters or check back later for new materials.</p>
                    <button class="btn btn-primary mt-4" onclick="resetFilters()">
                        <i class="fas fa-redo"></i> Reset Filters
                    </button>
                    <button class="btn btn-success mt-2" onclick="forceSyncDocuments()">
                        <i class="fas fa-sync"></i> Sync Documents
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== FAVORITES ==================== -->
        <div id="favorites" class="tab-content">
            <!-- ... (keep existing favorites content) ... -->
        </div>

        <!-- ==================== ADMIN PANEL ==================== -->
        <div id="admin" class="tab-content">
            <!-- ... (keep existing admin content) ... -->
        </div>

        <!-- ==================== ENHANCED GOOGLE SHEET MANAGER ==================== -->
        <div id="sheet-manager" class="tab-content">
            <div class="form-section">
                <div class="form-title">
                    <i class="fas fa-table"></i>
                    <span>Google Sheet Document Manager</span>
                    <span class="tag tag-success" id="sheetStatusBadge">Not Connected</span>
                </div>
                
                <!-- Connection Status -->
                <div class="sheet-info-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">
                                <i class="fas fa-plug"></i> Connection Status
                            </h4>
                            <div class="status-indicator" id="connectionStatusIndicator">
                                <span class="status-dot error"></span>
                                <span style="color: var(--danger);">Not Connected</span>
                            </div>
                            <p id="connectionDetails" style="color: var(--gray); margin-top: 8px; font-size: 14px;">
                                Connect your Google Sheet to sync documents automatically
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn btn-success" onclick="connectGoogleSheet()" id="connectBtn">
                                <i class="fas fa-plug"></i> Connect Sheet
                            </button>
                            <button class="btn btn-outline" onclick="testSheetConnection()" style="margin-top: 10px; display: block; width: 100%;">
                                <i class="fas fa-test-tube"></i> Test Connection
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Connection Configuration -->
                <div class="form-section">
                    <div class="form-title">
                        <i class="fas fa-cog"></i>
                        <span>Connection Settings</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Google Sheet URL</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="url" id="googleSheetUrl" class="form-control" 
                                   placeholder="https://docs.google.com/spreadsheets/d/..." 
                                   value="https://docs.google.com/spreadsheets/d/1SVkc6bNx2nJrALP2pc6-LzOBsEzuTwv-bh5YFuGQcaI/edit">
                            <button class="btn btn-primary" onclick="validateSheetUrl()">
                                <i class="fas fa-check"></i> Validate
                            </button>
                        </div>
                        <div class="form-hint">
                            <i class="fas fa-info-circle"></i>
                            <span>Make sure the sheet is set to "Anyone with link can view"</span>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Sheet Name</label>
                            <input type="text" id="sheetName" class="form-control" placeholder="Sheet1" value="Sheet1">
                        </div>
                        
                        <div class="form-group">
                            <label>Auto Sync Interval</label>
                            <select id="autoSyncInterval" class="form-control" onchange="updateSyncInterval()">
                                <option value="0">Manual Only</option>
                                <option value="5">5 minutes</option>
                                <option value="10" selected>10 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="120">2 hours</option>
                                <option value="360">6 hours</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Column Mapping (Advanced) -->
                    <div class="column-mapping-section">
                        <div class="form-title" style="font-size: 18px; margin-bottom: 15px;">
                            <i class="fas fa-columns"></i>
                            <span>Column Mapping</span>
                        </div>
                        <div style="color: var(--gray); margin-bottom: 15px;">
                            Map your Google Sheet columns to document properties
                        </div>
                        
                        <div class="mapping-row">
                            <label style="font-weight: 600;">Document Title:</label>
                            <select id="mapTitle" class="form-control">
                                <option value="title">title</option>
                                <option value="Title">Title</option>
                                <option value="Document Title">Document Title</option>
                            </select>
                            <span class="tag tag-primary">Required</span>
                        </div>
                        
                        <div class="mapping-row">
                            <label>Document URL:</label>
                            <select id="mapUrl" class="form-control">
                                <option value="url">url</option>
                                <option value="URL">URL</option>
                                <option value="link">link</option>
                                <option value="Link">Link</option>
                            </select>
                            <span class="tag tag-primary">Required</span>
                        </div>
                        
                        <div class="mapping-row">
                            <label>University:</label>
                            <select id="mapUniversity" class="form-control">
                                <option value="university">university</option>
                                <option value="University">University</option>
                                <option value="institution">institution</option>
                            </select>
                            <span class="tag tag-success">Optional</span>
                        </div>
                        
                        <div class="mapping-row">
                            <label>Unit Code:</label>
                            <select id="mapUnitCode" class="form-control">
                                <option value="unitCode">unitCode</option>
                                <option value="unit_code">unit_code</option>
                                <option value="code">code</option>
                                <option value="Code">Code</option>
                            </select>
                            <span class="tag tag-success">Optional</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="connectGoogleSheet()">
                            <i class="fas fa-sync"></i> Connect & Sync Now
                        </button>
                        <button class="btn btn-primary" onclick="forceFullSync()">
                            <i class="fas fa-redo"></i> Force Full Sync
                        </button>
                        <button class="btn btn-outline" onclick="clearSheetCache()">
                            <i class="fas fa-trash"></i> Clear Cache
                        </button>
                        <button class="btn btn-danger" onclick="resetSheetSettings()">
                            <i class="fas fa-undo"></i> Reset Settings
                        </button>
                    </div>
                </div>
                
                <!-- Current Connection Info -->
                <div id="currentConnectionInfo" style="display: none;">
                    <div class="form-section">
                        <div class="form-title">
                            <i class="fas fa-info-circle"></i>
                            <span>Current Connection</span>
                        </div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Connected Sheet</label>
                                <div class="form-control" style="background: #f8fafc;" id="connectedSheetName">-</div>
                            </div>
                            <div class="form-group">
                                <label>Last Sync</label>
                                <div class="form-control" style="background: #f8fafc;" id="lastSyncStatus">-</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Detected Columns</label>
                            <div class="sheet-columns-display" id="detectedColumns">
                                No columns detected
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sync History -->
                <div class="form-section">
                    <div class="form-title">
                        <i class="fas fa-history"></i>
                        <span>Sync History</span>
                    </div>
                    
                    <div class="sync-history-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Documents</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="syncHistoryBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 30px; color: var(--gray);">
                                        No sync history available
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-outline btn-sm" onclick="clearSyncHistory()">
                            <i class="fas fa-trash"></i> Clear History
                        </button>
                    </div>
                </div>
                
                <!-- Troubleshooting -->
                <div class="form-section" style="background: var(--light);">
                    <div class="form-title">
                        <i class="fas fa-wrench"></i>
                        <span>Troubleshooting</span>
                    </div>
                    
                    <div class="grid-2">
                        <div>
                            <h5 style="color: var(--primary); margin-bottom: 10px;">Common Issues</h5>
                            <ul style="color: var(--gray); font-size: 14px; line-height: 1.6;">
                                <li>Ensure Google Sheet is set to "Anyone with link can view"</li>
                                <li>Check that the sheet has proper column headers</li>
                                <li>Verify document URLs are valid and accessible</li>
                                <li>Make sure you're connected to the internet</li>
                            </ul>
                        </div>
                        <div>
                            <h5 style="color: var(--primary); margin-bottom: 10px;">Quick Fixes</h5>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-outline btn-sm" onclick="forceClearCacheAndSync()">
                                    Clear & Resync
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="testSheetPermissions()">
                                    Test Permissions
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="checkSheetStructure()">
                                    Check Structure
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>&copy; 2025 RevisionVault Pro. Premium Document Management System</p>
            <p style="margin-top: 5px; font-size: 13px;">Contact: 0765 098 865 â€¢ Email: walterzauko23@gmail.com</p>
            <p style="margin-top: 5px; font-size: 12px; opacity: 0.8;">Secure System v2.0 â€¢ Device-Locked Access â€¢ Admin Approval Required</p>
            <p style="margin-top: 5px; font-size: 11px; opacity: 0.6;">Developer: Walter Zauko</p>
        </div>
    </div>

    <script>
        // ==================== ENHANCED SYSTEM VARIABLES ====================
        const SYSTEM_CONFIG = {
            version: '2.1.0',
            adminPhone: '254765098865',
            subscriptionAmount: 67,
            subscriptionDays: 150, // 5 months
            defaultSheetUrl: 'https://docs.google.com/spreadsheets/d/1SVkc6bNx2nJrALP2pc6-LzOBsEzuTwv-bh5YFuGQcaI/edit',
            
            // Enhanced Google Sheet Configuration
            sheetConfig: {
                requiredColumns: ['title', 'url'],
                optionalColumns: ['university', 'unitCode', 'subject', 'year', 'description', 'type'],
                maxRetries: 3,
                timeout: 15000,
                cacheDuration: 300000, // 5 minutes
                backupSheets: [
                    'https://docs.google.com/spreadsheets/d/1SVkc6bNx2nJrALP2pc6-LzOBsEzuTwv-bh5YFuGQcaI/edit',
                    'https://docs.google.com/spreadsheets/d/1YOUR_BACKUP_SHEET_ID/edit'
                ]
            },
            
            whatsappFormat: {
                admin: `ðŸŽ‰ *NEW PAYMENT SUBMISSION* ðŸŽ‰

ðŸ“ *Student:* {name}
ðŸ“§ *Email:* {email}
ðŸ“± *Phone:* {phone}
ðŸŽ“ *University:* {university}
ðŸ’° *Amount:* Ksh {amount}
ðŸ”¢ *Transaction Code:* {code}
ðŸ“… *Date:* {date}

Please review and approve at: https://walterzauko23.github.io/Revisionvault/`,
                
                student: `ðŸŽ‰ *PAYMENT APPROVED!* ðŸŽ‰

Dear {name},

Your payment has been approved! Here is your unlock code:

ðŸ”‘ *Unlock Code:* {code}

Go to RevisionVault Pro and enter this code to unlock full access to all study materials.

ðŸ“š Access: https://walterzauko23.github.io/Revisionvault/

Thank you for subscribing!
- RevisionVault Pro Team`
            }
        };

        // Enhanced global state management
        let appState = {
            // User data
            currentStudent: null,
            allStudents: [],
            allPayments: [],
            universities: [],
            currentUserFavorites: [],
            
            // Enhanced Document data
            allDocuments: [],
            filteredDocuments: [],
            documentCategories: {},
            
            // Enhanced Admin state
            adminLoggedIn: false,
            adminPassword: null,
            
            // Enhanced Sheet connection
            googleSheetUrl: SYSTEM_CONFIG.defaultSheetUrl,
            sheetConnected: false,
            sheetData: null,
            sheetMetadata: {
                lastSync: null,
                syncCount: 0,
                lastError: null,
                columns: [],
                rowCount: 0,
                cacheExpiry: null
            },
            
            // Sync state
            autoSyncEnabled: true,
            syncInterval: 10, // minutes
            syncIntervalId: null,
            syncHistory: [],
            isSyncing: false,
            
            // Viewer state
            currentViewingDocument: null,
            pdfDoc: null,
            currentPDFPage: 1,
            scale: 1.0,
            rotation: 0,
            
            // Filter state
            currentUniversityFilter: 'all',
            currentSearchTerm: '',
            currentYearFilter: 'all',
            currentTypeFilter: 'all',
            
            // Admin section
            currentAdminSection: 'approvals',
            
            // Selection state
            selectedPayments: [],
            selectedUsers: [],
            selectedDocuments: [],
            
            // Pagination
            currentPage: 1,
            itemsPerPage: 12
        };

        // ==================== ENHANCED INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('Starting RevisionVault Pro...');
            updateLoadingProgress(10);
            
            try {
                // Load all data with enhanced error handling
                await loadAllData();
                updateLoadingProgress(30);
                
                // Set admin password to walter.zauko23 by default
                if (!appState.adminPassword) {
                    appState.adminPassword = 'walter.zauko23';
                    localStorage.setItem('admin_password', 'walter.zauko23');
                }
                
                // Initialize universities
                await initializeUniversities();
                updateLoadingProgress(50);
                
                // Initialize Google Sheet connection
                await initializeGoogleSheetConnection();
                updateLoadingProgress(70);
                
                // Check user session
                checkUserSession();
                
                // Update UI
                updateAllUI();
                updateLoadingProgress(90);
                
                // Setup auto-sync
                setupAutoSync();
                
                // Complete initialization
                setTimeout(() => {
                    hideLoading();
                    showNotification('RevisionVault Pro loaded successfully!', 'success');
                }, 500);
                
            } catch (error) {
                console.error('Initialization error:', error);
                hideLoading();
                showNotification('System loaded. Some features may be limited.', 'warning');
            }
        });

        function updateLoadingProgress(percent) {
            const progressBar = document.getElementById('loadingProgress');
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
            document.getElementById('loadingMessage').textContent = 
                `Loading system... ${percent}%`;
        }

        // ==================== ENHANCED DATA MANAGEMENT ====================
        async function loadAllData() {
            try {
                // Load from localStorage with enhanced validation
                const studentsData = localStorage.getItem('revisionvault_students');
                const paymentsData = localStorage.getItem('revisionvault_payments');
                const documentsData = localStorage.getItem('cached_documents');
                const universitiesData = localStorage.getItem('revisionvault_universities');
                const currentStudentData = localStorage.getItem('current_student');
                const adminPassword = localStorage.getItem('admin_password');
                const sheetMetadata = localStorage.getItem('sheet_metadata');
                const syncHistory = localStorage.getItem('sync_history');
                
                // Parse and validate data
                appState.allStudents = studentsData ? JSON.parse(studentsData) : [];
                appState.allPayments = paymentsData ? JSON.parse(paymentsData) : [];
                appState.allDocuments = documentsData ? JSON.parse(documentsData) : [];
                appState.universities = universitiesData ? JSON.parse(universitiesData) : getDefaultUniversities();
                appState.currentStudent = currentStudentData ? JSON.parse(currentStudentData) : null;
                appState.adminPassword = adminPassword || 'walter.zauko23';
                appState.sheetMetadata = sheetMetadata ? JSON.parse(sheetMetadata) : appState.sheetMetadata;
                appState.syncHistory = syncHistory ? JSON.parse(syncHistory) : [];
                
                // Enhanced data validation
                validateAndCleanData();
                
                // Initialize favorites
                if (appState.currentStudent) {
                    appState.currentUserFavorites = appState.currentStudent.favorites || [];
                }
                
                return true;
                
            } catch (error) {
                console.error('Data loading error:', error);
                
                // Enhanced error recovery
                resetToDefaults();
                saveAllData();
                
                return false;
            }
        }

        function resetToDefaults() {
            appState.allStudents = [];
            appState.allPayments = [];
            appState.allDocuments = [];
            appState.universities = getDefaultUniversities();
            appState.currentStudent = null;
            appState.currentUserFavorites = [];
            appState.adminPassword = 'walter.zauko23';
            appState.sheetMetadata = {
                lastSync: null,
                syncCount: 0,
                lastError: null,
                columns: [],
                rowCount: 0,
                cacheExpiry: null
            };
            appState.syncHistory = [];
        }

        function validateAndCleanData() {
            try {
                // Clean students
                appState.allStudents = appState.allStudents.filter(student => 
                    student && student.id && student.name && student.phone
                ).map(student => ({
                    ...student,
                    favorites: student.favorites || [],
                    documentsAccessed: student.documentsAccessed || []
                }));
                
                // Clean payments
                appState.allPayments = appState.allPayments.filter(payment => 
                    payment && payment.id && payment.studentId && payment.paymentCode
                );
                
                // Enhanced document cleaning
                appState.allDocuments = appState.allDocuments.filter(doc => 
                    doc && doc.id && doc.title && doc.url
                ).map(doc => ({
                    ...doc,
                    views: doc.views || 0,
                    downloads: doc.downloads || 0,
                    favorites: doc.favorites || 0,
                    type: doc.type || detectFileTypeFromUrl(doc.url)
                }));
                
                // Clean universities
                appState.universities = appState.universities.filter(uni => 
                    uni && uni.name
                );
                
                // Clean sync history
                appState.syncHistory = appState.syncHistory.filter(record => 
                    record && record.timestamp
                ).slice(-50); // Keep only last 50 records
                
            } catch (error) {
                console.error('Data validation error:', error);
            }
        }

        function saveAllData() {
            try {
                // Save all data to localStorage
                localStorage.setItem('revisionvault_students', JSON.stringify(appState.allStudents));
                localStorage.setItem('revisionvault_payments', JSON.stringify(appState.allPayments));
                localStorage.setItem('cached_documents', JSON.stringify(appState.allDocuments));
                localStorage.setItem('revisionvault_universities', JSON.stringify(appState.universities));
                localStorage.setItem('sheet_metadata', JSON.stringify(appState.sheetMetadata));
                localStorage.setItem('sync_history', JSON.stringify(appState.syncHistory));
                
                if (appState.currentStudent) {
                    localStorage.setItem('current_student', JSON.stringify(appState.currentStudent));
                }
                
                if (appState.adminPassword) {
                    localStorage.setItem('admin_password', appState.adminPassword);
                }
                
                return true;
                
            } catch (error) {
                console.error('Data saving error:', error);
                showNotification('Failed to save data', 'error');
                return false;
            }
        }

        // ==================== ENHANCED GOOGLE SHEET INTEGRATION ====================
        async function initializeGoogleSheetConnection() {
            try {
                // Check if we have cached data that's still valid
                if (appState.sheetMetadata.cacheExpiry && 
                    new Date(appState.sheetMetadata.cacheExpiry) > new Date()) {
                    
                    appState.sheetConnected = true;
                    updateSheetStatus(`Using cached data (${appState.allDocuments.length} documents)`, 'connected');
                    return true;
                }
                
                // Try to connect to Google Sheet
                if (appState.googleSheetUrl) {
                    const success = await connectGoogleSheet(true);
                    if (success) {
                        updateSheetStatus(`Connected: ${appState.allDocuments.length} documents loaded`, 'connected');
                    } else {
                        // Try backup sheets
                        for (const backupSheet of SYSTEM_CONFIG.sheetConfig.backupSheets) {
                            if (backupSheet !== appState.googleSheetUrl) {
                                appState.googleSheetUrl = backupSheet;
                                const backupSuccess = await connectGoogleSheet(true);
                                if (backupSuccess) {
                                    showNotification('Connected to backup sheet', 'warning');
                                    break;
                                }
                            }
                        }
                    }
                }
                
                return appState.sheetConnected;
                
            } catch (error) {
                console.error('Sheet initialization error:', error);
                return false;
            }
        }

        async function connectGoogleSheet(initialLoad = false) {
            const urlInput = document.getElementById('googleSheetUrl');
            if (urlInput && urlInput.value) {
                appState.googleSheetUrl = urlInput.value;
            }
            
            if (!appState.googleSheetUrl) {
                showNotification('Please enter Google Sheet URL', 'error');
                return false;
            }
            
            if (!initialLoad) {
                showLoading('Connecting to Google Sheet...');
            }
            
            try {
                // Update status
                updateConnectionStatus('processing', 'Connecting...');
                appState.isSyncing = true;
                
                // Extract sheet ID with enhanced validation
                const sheetId = extractSheetId(appState.googleSheetUrl);
                if (!sheetId) {
                    throw new Error('Invalid Google Sheet URL format');
                }
                
                // Get sheet name
                const sheetName = document.getElementById('sheetName')?.value || 'Sheet1';
                
                // Construct JSON endpoint with multiple fallbacks
                const endpoints = [
                    `https://opensheet.elk.sh/${sheetId}/${sheetName}`,
                    `https://opensheet.vercel.app/${sheetId}/${sheetName}`,
                    `https://api.sheetdb.io/sheet/${sheetId}/${sheetName}`
                ];
                
                let data = null;
                let lastError = null;
                
                // Try multiple endpoints
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetchWithTimeout(endpoint, SYSTEM_CONFIG.sheetConfig.timeout);
                        if (response.ok) {
                            data = await response.json();
                            console.log(`Connected via: ${endpoint}`);
                            break;
                        }
                    } catch (err) {
                        lastError = err;
                        console.warn(`Failed to connect via ${endpoint}:`, err);
                    }
                }
                
                if (!data) {
                    throw lastError || new Error('Failed to connect to any endpoint');
                }
                
                // Enhanced data processing
                const processedData = processSheetDataWithValidation(data);
                
                if (processedData.documents.length === 0) {
                    throw new Error('No valid documents found in sheet');
                }
                
                // Update state
                appState.allDocuments = processedData.documents;
                appState.sheetConnected = true;
                appState.sheetData = data;
                
                // Update metadata
                appState.sheetMetadata = {
                    lastSync: new Date().toISOString(),
                    syncCount: appState.sheetMetadata.syncCount + 1,
                    lastError: null,
                    columns: processedData.columns,
                    rowCount: processedData.documents.length,
                    cacheExpiry: new Date(Date.now() + SYSTEM_CONFIG.sheetConfig.cacheDuration).toISOString()
                };
                
                // Add to sync history
                addSyncHistory({
                    timestamp: new Date().toISOString(),
                    status: 'success',
                    documents: processedData.documents.length,
                    newDocuments: processedData.newDocuments,
                    updatedDocuments: processedData.updatedDocuments,
                    source: appState.googleSheetUrl
                });
                
                // Save to cache
                saveAllData();
                
                // Update status
                updateConnectionStatus('success', `Connected: ${processedData.documents.length} documents`);
                updateSheetStatus(`Synced: ${processedData.documents.length} documents loaded`, 'connected');
                
                // Update UI
                updateDocumentCount();
                loadDocumentsGrid();
                updateAdminDocumentCount();
                loadSheetDocumentsList();
                updateSyncHistoryDisplay();
                updateCurrentConnectionInfo();
                
                showNotification(`Successfully synced ${processedData.documents.length} documents`, 'success');
                
                return true;
                
            } catch (error) {
                console.error('Google Sheet connection error:', error);
                
                // Update metadata
                appState.sheetMetadata.lastError = error.message;
                appState.sheetConnected = false;
                
                // Add to sync history
                addSyncHistory({
                    timestamp: new Date().toISOString(),
                    status: 'error',
                    error: error.message,
                    source: appState.googleSheetUrl
                });
                
                // Update status
                updateConnectionStatus('error', `Failed: ${error.message}`);
                updateSheetStatus(`Connection failed: ${error.message}`, 'error');
                
                // Try to load cached data
                if (appState.allDocuments.length > 0) {
                    showNotification(`Using ${appState.allDocuments.length} cached documents`, 'warning');
                    updateSheetStatus(`Using cached data: ${appState.allDocuments.length} documents`, 'disconnected');
                    loadDocumentsGrid();
                    updateAdminDocumentCount();
                } else {
                    showNotification('Failed to load documents. Please check connection.', 'error');
                }
                
                return false;
                
            } finally {
                appState.isSyncing = false;
                if (!initialLoad) {
                    hideLoading();
                }
            }
        }

        function extractSheetId(url) {
            if (!url) return null;
            
            // Clean URL
            url = url.trim();
            
            // Remove trailing slash
            if (url.endsWith('/')) {
                url = url.slice(0, -1);
            }
            
            // Try multiple patterns
            const patterns = [
                /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)(?:\/|$)/,
                /\/d\/([a-zA-Z0-9-_]+)(?:\/|$)/,
                /id=([a-zA-Z0-9-_]+)/,
                /key=([a-zA-Z0-9-_]+)/,
                /([a-zA-Z0-9-_]{44})/ // Standard Google Sheet ID length
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        function processSheetDataWithValidation(data) {
            if (!Array.isArray(data) || data.length === 0) {
                return { documents: [], columns: [], newDocuments: 0, updatedDocuments: 0 };
            }
            
            const documents = [];
            const columnNames = data.length > 0 ? Object.keys(data[0]) : [];
            let newDocuments = 0;
            let updatedDocuments = 0;
            
            // Get mapping from UI
            const titleColumn = document.getElementById('mapTitle')?.value || 'title';
            const urlColumn = document.getElementById('mapUrl')?.value || 'url';
            const universityColumn = document.getElementById('mapUniversity')?.value || 'university';
            const unitCodeColumn = document.getElementById('mapUnitCode')?.value || 'unitCode';
            
            data.forEach((row, index) => {
                try {
                    // Get values with fallback to multiple column names
                    const title = row[titleColumn] || row['Title'] || row['title'] || row['Document Title'] || '';
                    const url = row[urlColumn] || row['URL'] || row['url'] || row['link'] || row['Link'] || '';
                    const university = row[universityColumn] || row['University'] || row['university'] || row['institution'] || 'General';
                    const unitCode = row[unitCodeColumn] || row['unitCode'] || row['unit_code'] || row['Code'] || row['code'] || '';
                    
                    // Validate required fields
                    if (!title.trim() || !url.trim()) {
                        return; // Skip invalid rows
                    }
                    
                    // Validate URL
                    if (!isValidUrl(url)) {
                        console.warn(`Invalid URL in row ${index}: ${url}`);
                        return;
                    }
                    
                    // Check if document already exists
                    const existingDoc = appState.allDocuments.find(doc => 
                        doc.url === url.trim() || doc.title === title.trim()
                    );
                    
                    let docId;
                    let isNew = false;
                    
                    if (existingDoc) {
                        // Update existing document
                        docId = existingDoc.id;
                        existingDoc.title = title.trim();
                        existingDoc.university = university.trim();
                        existingDoc.unitCode = unitCode.trim().toUpperCase();
                        existingDoc.subject = row['subject'] || row['Subject'] || existingDoc.subject || '';
                        existingDoc.year = row['year'] || row['Year'] || existingDoc.year || '';
                        existingDoc.description = row['description'] || row['Description'] || existingDoc.description || '';
                        existingDoc.type = detectFileTypeFromUrl(url);
                        existingDoc.lastUpdated = new Date().toISOString();
                        updatedDocuments++;
                    } else {
                        // Create new document
                        docId = `doc_${Date.now()}_${index}_${Math.random().toString(36).substr(2, 9)}`;
                        isNew = true;
                        newDocuments++;
                    }
                    
                    const document = {
                        id: docId,
                        title: title.trim(),
                        url: url.trim(),
                        university: university.trim(),
                        unitCode: unitCode.trim().toUpperCase(),
                        subject: row['subject'] || row['Subject'] || '',
                        year: row['year'] || row['Year'] || '',
                        description: row['description'] || row['Description'] || '',
                        type: detectFileTypeFromUrl(url),
                        uploadDate: existingDoc ? existingDoc.uploadDate : new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        views: existingDoc ? existingDoc.views || 0 : 0,
                        downloads: existingDoc ? existingDoc.downloads || 0 : 0,
                        favorites: existingDoc ? existingDoc.favorites || 0 : 0,
                        source: 'google-sheet',
                        isNew: isNew
                    };
                    
                    if (isNew) {
                        documents.push(document);
                    }
                    
                } catch (error) {
                    console.warn(`Error processing row ${index}:`, error);
                }
            });
            
            return {
                documents: existingDocs ? [...appState.allDocuments, ...documents] : documents,
                columns: columnNames,
                newDocuments,
                updatedDocuments
            };
        }

        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }

        function detectFileTypeFromUrl(url) {
            if (!url) return 'other';
            
            const extension = url.split('.').pop().toLowerCase().split('?')[0];
            
            const typeMap = {
                'pdf': 'pdf',
                'jpg': 'image', 'jpeg': 'image', 'png': 'image', 'gif': 'image', 
                'webp': 'image', 'bmp': 'image', 'svg': 'image',
                'doc': 'word', 'docx': 'word',
                'xls': 'excel', 'xlsx': 'excel', 'csv': 'excel',
                'ppt': 'powerpoint', 'pptx': 'powerpoint',
                'txt': 'text', 'text': 'text',
                'zip': 'archive', 'rar': 'archive', '7z': 'archive'
            };
            
            return typeMap[extension] || 'other';
        }

        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('connectionStatusIndicator');
            const details = document.getElementById('connectionDetails');
            
            if (!indicator || !details) return;
            
            const statusMap = {
                'processing': { color: 'var(--primary)', text: 'Processing...', icon: 'fa-sync fa-spin' },
                'success': { color: 'var(--success)', text: 'Connected', icon: 'fa-check-circle' },
                'error': { color: 'var(--danger)', text: 'Error', icon: 'fa-exclamation-circle' },
                'disconnected': { color: 'var(--warning)', text: 'Disconnected', icon: 'fa-unlink' }
            };
            
            const statusInfo = statusMap[status] || statusMap.disconnected;
            
            indicator.innerHTML = `
                <span class="status-dot ${status}" style="background: ${statusInfo.color};"></span>
                <span style="color: ${statusInfo.color}; font-weight: 600;">${statusInfo.text}</span>
            `;
            
            details.textContent = message;
            details.style.color = statusInfo.color;
        }

        function updateSheetStatus(message, status) {
            const element = document.getElementById('sheetStatus');
            if (!element) return;
            
            const icon = status === 'connected' ? 'fa-check-circle' :
                        status === 'disconnected' ? 'fa-unlink' : 'fa-exclamation-circle';
            const color = status === 'connected' ? 'var(--success)' :
                         status === 'disconnected' ? 'var(--warning)' : 'var(--danger)';
            
            element.innerHTML = `
                <i class="fas ${icon}" style="color: ${color};"></i>
                <span>${message}</span>
            `;
            element.className = `sheet-status ${status}`;
            
            // Update badge
            const badge = document.getElementById('sheetSyncBadge');
            if (badge) {
                badge.textContent = status === 'connected' ? 'âœ“' : '!';
                badge.style.background = status === 'connected' ? 'var(--success)' : 'var(--danger)';
            }
        }

        // ==================== AUTO SYNC SYSTEM ====================
        function setupAutoSync() {
            // Clear any existing interval
            if (appState.syncIntervalId) {
                clearInterval(appState.syncIntervalId);
            }
            
            // Get interval from settings
            const intervalSelect = document.getElementById('autoSyncInterval');
            const intervalMinutes = intervalSelect ? parseInt(intervalSelect.value) : appState.syncInterval;
            
            if (intervalMinutes > 0) {
                appState.syncInterval = intervalMinutes;
                appState.autoSyncEnabled = true;
                
                // Set up interval
                appState.syncIntervalId = setInterval(async () => {
                    if (!appState.isSyncing && appState.sheetConnected) {
                        await autoSyncDocuments();
                    }
                }, intervalMinutes * 60 * 1000);
                
                // Update UI
                document.getElementById('autoSyncStatus').textContent = 'ON';
                document.getElementById('syncInterval').textContent = intervalMinutes;
                
                // Show sync details
                document.getElementById('syncDetails').style.display = 'block';
                document.getElementById('syncSource').textContent = 
                    `Connected to: ${appState.googleSheetUrl.substring(0, 50)}...`;
                
            } else {
                appState.autoSyncEnabled = false;
                document.getElementById('autoSyncStatus').textContent = 'OFF';
                document.getElementById('syncDetails').style.display = 'none';
            }
        }

        async function autoSyncDocuments() {
            try {
                if (!appState.sheetConnected || appState.isSyncing) {
                    return;
                }
                
                appState.isSyncing = true;
                
                // Update status
                updateSheetStatus('Auto-syncing documents...', 'connected');
                
                // Connect to sheet
                const success = await connectGoogleSheet(true);
                
                if (success) {
                    // Update last sync time
                    updateLastSyncTime();
                    
                    // Show notification if there are new documents
                    const lastSync = appState.syncHistory[appState.syncHistory.length - 1];
                    if (lastSync && lastSync.newDocuments > 0) {
                        showNotification(`${lastSync.newDocuments} new documents synced`, 'success');
                    }
                }
                
            } catch (error) {
                console.error('Auto-sync error:', error);
            } finally {
                appState.isSyncing = false;
            }
        }

        function forceSyncDocuments() {
            if (appState.isSyncing) {
                showNotification('Sync already in progress', 'warning');
                return;
            }
            
            showLoading('Syncing documents...');
            connectGoogleSheet(false);
        }

        function forceFullSync() {
            if (confirm('Force full sync will clear cache and reload all documents. Continue?')) {
                // Clear cache
                appState.allDocuments = [];
                appState.sheetMetadata.cacheExpiry = null;
                
                // Force sync
                forceSyncDocuments();
            }
        }

        // ==================== SYNC HISTORY MANAGEMENT ====================
        function addSyncHistory(record) {
            record.id = `sync_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            appState.syncHistory.unshift(record);
            
            // Keep only last 50 records
            if (appState.syncHistory.length > 50) {
                appState.syncHistory = appState.syncHistory.slice(0, 50);
            }
            
            // Save to storage
            localStorage.setItem('sync_history', JSON.stringify(appState.syncHistory));
            
            // Update display
            updateSyncHistoryDisplay();
        }

        function updateSyncHistoryDisplay() {
            const tableBody = document.getElementById('syncHistoryBody');
            if (!tableBody) return;
            
            if (appState.syncHistory.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px; color: var(--gray);">
                            No sync history available
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = appState.syncHistory.map(record => `
                <tr>
                    <td>
                        <div style="font-weight: 500;">${formatDateTime(record.timestamp)}</div>
                        <div style="font-size: 11px; color: var(--gray);">${formatDate(record.timestamp)}</div>
                    </td>
                    <td>
                        <div class="status-indicator">
                            <span class="status-dot ${record.status}"></span>
                            <span style="font-weight: 500; text-transform: capitalize;">${record.status}</span>
                        </div>
                    </td>
                    <td>
                        ${record.documents ? `
                            <div style="font-weight: 500;">${record.documents} docs</div>
                            ${record.newDocuments > 0 ? 
                                `<div style="font-size: 11px; color: var(--success);">+${record.newDocuments} new</div>` : ''}
                            ${record.updatedDocuments > 0 ? 
                                `<div style="font-size: 11px; color: var(--info);">${record.updatedDocuments} updated</div>` : ''}
                        ` : '-'}
                    </td>
                    <td>
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${record.error ? 
                                `<span style="color: var(--danger);">${record.error}</span>` : 
                                `<span style="color: var(--success);">Sync successful</span>`
                            }
                        </div>
                        ${record.source ? 
                            `<div style="font-size: 11px; color: var(--gray); margin-top: 2px;">
                                ${record.source.substring(0, 40)}...
                            </div>` : ''
                        }
                    </td>
                </tr>
            `).join('');
        }

        function clearSyncHistory() {
            if (confirm('Clear all sync history?')) {
                appState.syncHistory = [];
                localStorage.removeItem('sync_history');
                updateSyncHistoryDisplay();
                showNotification('Sync history cleared', 'success');
            }
        }

        // ==================== ENHANCED UI UPDATES ====================
        function updateAllUI() {
            updateUniversitySelect();
            updateUniversityFilter();
            updateDocumentCount();
            updateAccessStatus();
            updateSubscriptionStatus();
            loadDocumentsGrid();
            loadFavorites();
            updateLastSyncTime();
            updateCurrentConnectionInfo();
        }

        function updateLastSyncTime() {
            const lastSyncElement = document.getElementById('lastSyncTime');
            if (!lastSyncElement) return;
            
            if (appState.sheetMetadata.lastSync) {
                const lastSync = new Date(appState.sheetMetadata.lastSync);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastSync) / (1000 * 60));
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Just now';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes} minutes ago`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)} hours ago`;
                } else {
                    timeText = `${Math.floor(diffMinutes / 1440)} days ago`;
                }
                
                lastSyncElement.innerHTML = `
                    <i class="fas fa-clock"></i> Last sync: ${timeText}
                `;
            } else {
                lastSyncElement.innerHTML = `
                    <i class="fas fa-clock"></i> Last sync: Never
                `;
            }
        }

        function updateCurrentConnectionInfo() {
            const container = document.getElementById('currentConnectionInfo');
            if (!container) return;
            
            if (appState.sheetConnected && appState.sheetMetadata.columns.length > 0) {
                container.style.display = 'block';
                
                // Update sheet name
                document.getElementById('connectedSheetName').textContent = 
                    appState.googleSheetUrl.substring(0, 60) + '...';
                
                // Update last sync
                if (appState.sheetMetadata.lastSync) {
                    document.getElementById('lastSyncStatus').textContent = 
                        `${formatDateTime(appState.sheetMetadata.lastSync)} (${appState.sheetMetadata.syncCount} syncs)`;
                }
                
                // Update detected columns
                const columnsContainer = document.getElementById('detectedColumns');
                columnsContainer.innerHTML = appState.sheetMetadata.columns.map(col => 
                    `<span class="column-tag">${col}</span>`
                ).join('');
                
            } else {
                container.style.display = 'none';
            }
        }

        // ==================== TROUBLESHOOTING FUNCTIONS ====================
        async function testSheetConnection() {
            showLoading('Testing connection...');
            
            try {
                const sheetId = extractSheetId(appState.googleSheetUrl);
                if (!sheetId) {
                    throw new Error('Invalid sheet URL');
                }
                
                // Test multiple endpoints
                const endpoints = [
                    `https://opensheet.elk.sh/${sheetId}/Sheet1`,
                    `https://opensheet.vercel.app/${sheetId}/Sheet1`
                ];
                
                let success = false;
                let testResults = [];
                
                for (const endpoint of endpoints) {
                    try {
                        const startTime = Date.now();
                        const response = await fetchWithTimeout(endpoint, 5000);
                        const endTime = Date.now();
                        
                        if (response.ok) {
                            const data = await response.json();
                            testResults.push({
                                endpoint,
                                status: 'success',
                                time: endTime - startTime,
                                rows: data.length
                            });
                            success = true;
                        } else {
                            testResults.push({
                                endpoint,
                                status: 'failed',
                                error: `HTTP ${response.status}`
                            });
                        }
                    } catch (error) {
                        testResults.push({
                            endpoint,
                            status: 'error',
                            error: error.message
                        });
                    }
                }
                
                if (success) {
                    showNotification('Connection test successful!', 'success');
                    
                    // Show detailed results
                    let message = 'Connection Test Results:\n\n';
                    testResults.forEach(result => {
                        message += `${result.endpoint}\n`;
                        message += `Status: ${result.status.toUpperCase()}\n`;
                        if (result.time) message += `Response time: ${result.time}ms\n`;
                        if (result.rows) message += `Rows found: ${result.rows}\n`;
                        if (result.error) message += `Error: ${result.error}\n`;
                        message += '\n';
                    });
                    
                    alert(message);
                    
                } else {
                    throw new Error('All connection tests failed');
                }
                
            } catch (error) {
                showNotification(`Connection test failed: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function testSheetPermissions() {
            const url = `https://docs.google.com/spreadsheets/d/${extractSheetId(appState.googleSheetUrl)}/preview`;
            window.open(url, '_blank');
            showNotification('Opening sheet preview to check permissions', 'info');
        }

        function checkSheetStructure() {
            if (!appState.sheetMetadata.columns || appState.sheetMetadata.columns.length === 0) {
                showNotification('No sheet structure information available. Connect first.', 'error');
                return;
            }
            
            const required = SYSTEM_CONFIG.sheetConfig.requiredColumns;
            const missing = required.filter(col => !appState.sheetMetadata.columns.includes(col));
            
            if (missing.length > 0) {
                showNotification(`Missing required columns: ${missing.join(', ')}`, 'error');
            } else {
                showNotification('Sheet structure looks good!', 'success');
            }
        }

        function validateSheetUrl() {
            const urlInput = document.getElementById('googleSheetUrl');
            const url = urlInput.value.trim();
            
            if (!url) {
                showNotification('Please enter a URL', 'error');
                return;
            }
            
            const sheetId = extractSheetId(url);
            if (sheetId) {
                showNotification('Valid Google Sheet URL detected', 'success');
                
                // Enable connect button
                const connectBtn = document.getElementById('connectBtn');
                if (connectBtn) {
                    connectBtn.disabled = false;
                }
            } else {
                showNotification('Invalid Google Sheet URL format', 'error');
                
                // Disable connect button
                const connectBtn = document.getElementById('connectBtn');
                if (connectBtn) {
                    connectBtn.disabled = true;
                }
            }
        }

        function resetSheetSettings() {
            if (confirm('Reset all Google Sheet settings to defaults?')) {
                // Reset URL to default
                document.getElementById('googleSheetUrl').value = SYSTEM_CONFIG.defaultSheetUrl;
                
                // Reset sheet name
                document.getElementById('sheetName').value = 'Sheet1';
                
                // Reset auto sync
                document.getElementById('autoSyncInterval').value = '10';
                
                // Reset column mappings
                document.getElementById('mapTitle').value = 'title';
                document.getElementById('mapUrl').value = 'url';
                document.getElementById('mapUniversity').value = 'university';
                document.getElementById('mapUnitCode').value = 'unitCode';
                
                showNotification('Settings reset to defaults', 'success');
            }
        }

        function forceClearCacheAndSync() {
            if (confirm('Clear cache and force resync? This will reload all documents.')) {
                // Clear cache
                localStorage.removeItem('cached_documents');
                localStorage.removeItem('sheet_metadata');
                
                // Reset state
                appState.allDocuments = [];
                appState.sheetMetadata = {
                    lastSync: null,
                    syncCount: 0,
                    lastError: null,
                    columns: [],
                    rowCount: 0,
                    cacheExpiry: null
                };
                
                // Force sync
                forceSyncDocuments();
            }
        }

        // ==================== ENHANCED DOCUMENT MANAGEMENT ====================
        function loadDocumentsGrid() {
            const grid = document.getElementById('documentsGrid');
            const noDocs = document.getElementById('noDocumentsMessage');
            
            if (!appState.allDocuments || appState.allDocuments.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sync fa-spin empty-state-icon"></i>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Loading Documents</h3>
                        <p style="color: var(--gray);">No documents loaded yet. Connect Google Sheet to load documents.</p>
                        <button class="btn btn-primary mt-4" onclick="switchTab('sheet-manager')">
                            <i class="fas fa-plug"></i> Connect Google Sheet
                        </button>
                        <button class="btn btn-success mt-2" onclick="forceSyncDocuments()">
                            <i class="fas fa-sync"></i> Sync Documents
                        </button>
                    </div>
                `;
                if (noDocs) noDocs.style.display = 'none';
                return;
            }
            
            if (noDocs) noDocs.style.display = 'none';
            
            // Apply enhanced filters
            let filteredDocs = [...appState.allDocuments];
            
            // University filter
            if (appState.currentUniversityFilter !== 'all') {
                filteredDocs = filteredDocs.filter(doc => 
                    doc.university === appState.currentUniversityFilter
                );
            }
            
            // Year filter
            if (appState.currentYearFilter !== 'all') {
                filteredDocs = filteredDocs.filter(doc => doc.year === appState.currentYearFilter);
            }
            
            // Type filter
            if (appState.currentTypeFilter !== 'all') {
                filteredDocs = filteredDocs.filter(doc => doc.type === appState.currentTypeFilter);
            }
            
            // Search filter with enhanced matching
            if (appState.currentSearchTerm) {
                const searchTerm = appState.currentSearchTerm.toLowerCase();
                filteredDocs = filteredDocs.filter(doc => {
                    const searchFields = [
                        doc.title,
                        doc.unitCode,
                        doc.subject,
                        doc.description,
                        doc.university
                    ].filter(field => field).map(field => field.toLowerCase());
                    
                    return searchFields.some(field => field.includes(searchTerm));
                });
            }
            
            // Store filtered docs
            appState.filteredDocuments = filteredDocs;
            
            if (filteredDocs.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-search empty-state-icon"></i>
                        <h3>No Documents Found</h3>
                        <p>Try changing your search filters or check sync status</p>
                        <button class="btn btn-primary mt-4" onclick="resetFilters()">
                            <i class="fas fa-redo"></i> Reset Filters
                        </button>
                    </div>
                `;
                return;
            }
            
            // Enhanced sorting: new documents first, then by title
            filteredDocs.sort((a, b) => {
                if (a.isNew && !b.isNew) return -1;
                if (!a.isNew && b.isNew) return 1;
                return a.title.localeCompare(b.title);
            });
            
            // Display documents with enhanced cards
            const hasAccess = hasDocumentAccess();
            grid.innerHTML = filteredDocs.map(doc => createDocumentCard(doc, hasAccess)).join('');
        }

        function createDocumentCard(doc, hasAccess) {
            const isFavorite = appState.currentUserFavorites.includes(doc.id);
            const icon = getDocumentIcon(doc.type);
            const isNew = doc.isNew;
            
            return `
                <div class="document-card fade-in ${!hasAccess ? 'premium' : ''}">
                    ${isNew ? `
                        <div style="position: absolute; top: 10px; left: 10px;">
                            <span class="badge badge-success" style="font-size: 10px; padding: 2px 8px;">
                                <i class="fas fa-star"></i> NEW
                            </span>
                        </div>
                    ` : ''}
                    
                    <button class="favorite-btn ${isFavorite ? 'active' : ''}" 
                            onclick="toggleFavorite('${doc.id}')" 
                            data-tooltip="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                        <i class="fas fa-heart"></i>
                    </button>
                    
                    <div class="doc-icon" style="${getDocumentIconColor(doc.type)}">
                        <i class="${icon}"></i>
                    </div>
                    
                    <div class="doc-title">${doc.title}</div>
                    
                    <div class="doc-meta">
                        ${doc.unitCode ? `<div class="doc-meta-item"><i class="fas fa-hashtag"></i>${doc.unitCode}</div>` : ''}
                        <div class="doc-meta-item"><i class="fas fa-university"></i>${doc.university}</div>
                        ${doc.year ? `<div class="doc-meta-item"><i class="fas fa-calendar"></i>Year ${doc.year}</div>` : ''}
                    </div>
                    
                    <div class="doc-description">
                        ${doc.description || 'Study material document'}
                    </div>
                    
                    <div class="doc-stats">
                        <div class="doc-stat">
                            <i class="fas fa-eye"></i>
                            <span>${doc.views || 0}</span>
                        </div>
                        <div class="doc-stat">
                            <i class="fas fa-download"></i>
                            <span>${doc.downloads || 0}</span>
                        </div>
                        <div class="doc-stat">
                            <i class="fas fa-heart"></i>
                            <span>${doc.favorites || 0}</span>
                        </div>
                    </div>
                    
                    <div class="doc-actions">
                        ${hasAccess || appState.adminLoggedIn ? 
                            `<button class="btn btn-primary" onclick="openDocumentViewer('${doc.id}')">
                                <i class="fas fa-eye"></i> View Document
                            </button>
                            <button class="btn btn-outline" onclick="downloadDocumentDirect('${doc.id}')" data-tooltip="Download">
                                <i class="fas fa-download"></i>
                            </button>` :
                            `<button class="btn btn-primary" onclick="switchTab('student')">
                                <i class="fas fa-lock"></i> Subscribe to View
                            </button>`
                        }
                    </div>
                </div>
            `;
        }

        function getDocumentIconColor(type) {
            const colorMap = {
                'pdf': 'background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%); color: white;',
                'word': 'background: linear-gradient(135deg, #2B579A 0%, #2B579A 100%); color: white;',
                'excel': 'background: linear-gradient(135deg, #217346 0%, #217346 100%); color: white;',
                'powerpoint': 'background: linear-gradient(135deg, #D24726 0%, #D24726 100%); color: white;',
                'image': 'background: linear-gradient(135deg, #9C27B0 0%, #9C27B0 100%); color: white;',
                'text': 'background: linear-gradient(135deg, #607D8B 0%, #607D8B 100%); color: white;',
                'other': 'background: linear-gradient(135deg, #795548 0%, #795548 100%); color: white;'
            };
            
            return colorMap[type] || colorMap.other;
        }

        function downloadDocumentDirect(docId) {
            const doc = appState.allDocuments.find(d => d.id === docId);
            if (!doc) return;
            
            // Create download link
            const link = document.createElement('a');
            link.href = doc.url;
            link.download = `${doc.title.replace(/[^a-z0-9]/gi, '_')}.${doc.type || 'file'}`;
            link.click();
            
            // Update download count
            doc.downloads = (doc.downloads || 0) + 1;
            saveAllData();
            
            showNotification('Download started', 'success');
        }

        // ==================== ENHANCED UTILITY FUNCTIONS ====================
        function fetchWithTimeout(url, timeout = 15000) {
            return Promise.race([
                fetch(url),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Request timeout')), timeout)
                )
            ]);
        }

        function updateSyncInterval() {
            const intervalSelect = document.getElementById('autoSyncInterval');
            if (intervalSelect) {
                appState.syncInterval = parseInt(intervalSelect.value);
                setupAutoSync();
                showNotification(`Auto-sync interval set to ${appState.syncInterval} minutes`, 'success');
            }
        }

        // ==================== MAKE FUNCTIONS GLOBAL ====================
        // Keep all existing window function assignments and add new ones
        
        window.connectGoogleSheet = connectGoogleSheet;
        window.forceSyncDocuments = forceSyncDocuments;
        window.forceFullSync = forceFullSync;
        window.testSheetConnection = testSheetConnection;
        window.validateSheetUrl = validateSheetUrl;
        window.resetSheetSettings = resetSheetSettings;
        window.testSheetPermissions = testSheetPermissions;
        window.checkSheetStructure = checkSheetStructure;
        window.forceClearCacheAndSync = forceClearCacheAndSync;
        window.clearSyncHistory = clearSyncHistory;
        window.updateSyncInterval = updateSyncInterval;
        window.downloadDocumentDirect = downloadDocumentDirect;

        // ... (keep all other existing window function assignments)

    </script>
</body>
</html>