<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RevisionVault Pro - University Study Materials</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a2980;
            --secondary: #26d0ce;
            --accent: #ff4081;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            padding-bottom: 100px;
        }

        /* Fixed Header Container */
        .header-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        /* Logo Section */
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .logo-icon {
            background: rgba(255, 255, 255, 0.9);
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 22px;
            box-shadow: var(--shadow);
        }

        .logo-text h1 {
            font-size: 22px;
            margin-bottom: 2px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: white;
        }

        .logo-text p {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Search Bar */
        .search-container {
            flex: 1;
            max-width: 600px;
            position: relative;
        }

        .search-box {
            width: 100%;
            padding: 14px 20px;
            padding-left: 45px;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.8);
        }

        .search-box:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
        }

        /* Search Suggestions */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
            border: 2px solid #e2e8f0;
        }

        .search-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #e2e8f0;
        }

        .suggestion-item:hover {
            background: #f1f5f9;
        }

        .suggestion-code {
            font-weight: 700;
            color: var(--primary);
            font-size: 14px;
        }

        .suggestion-title {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Main Container */
        .main-container {
            margin-top: 100px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            min-height: calc(100vh - 180px);
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            min-height: 600px;
        }

        /* Left Sidebar */
        .sidebar-left {
            background: var(--light);
            padding: 25px 20px;
            border-right: 1px solid #e2e8f0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 700;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .tool-card {
            background: var(--card-bg);
            padding: 18px 12px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tool-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .tool-icon {
            font-size: 22px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .tool-name {
            font-size: 12px;
            font-weight: 700;
            color: var(--dark);
        }

        .timetable {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
        }

        .week-display {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            margin-bottom: 5px;
        }

        .date-range {
            color: #64748b;
            text-align: center;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }

        .schedule-item {
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
        }

        .time {
            font-weight: 700;
            color: var(--primary);
            font-size: 12px;
        }

        .subject {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .ai-chat-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent), #f50057);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        /* Main Content */
        .main-content {
            padding: 25px;
            background: white;
            overflow-y: auto;
            height: calc(100vh - 180px);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .main-title {
            font-size: 24px;
            color: var(--primary);
            font-weight: 800;
        }

        .filters {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-select {
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            color: var(--dark);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 140px;
        }

        /* Registration Success Banner */
        .registration-success-banner {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border: 3px solid var(--success);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        .registration-success-banner.active {
            display: flex;
        }

        .registration-success-banner h3 {
            color: #065f46;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .registration-success-banner p {
            color: #047857;
            margin-bottom: 20px;
            max-width: 500px;
        }

        /* Access Status */
        .access-status {
            background: linear-gradient(135deg, #ffeaea, #ffc9c9);
            border: 3px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .access-granted {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-color: var(--success);
        }

        /* Quick Unit Codes */
        .quick-units {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .unit-chip {
            background: #e0f2fe;
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        /* Search Results */
        .search-results {
            display: none;
            margin-top: 20px;
        }

        .search-results.active {
            display: block;
        }

        /* Materials Grid */
        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }

        .material-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            position: relative;
        }

        .material-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: linear-gradient(135deg, var(--accent), #f50057);
            color: white;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 1px;
            z-index: 1;
        }

        .material-badge.trending {
            background: linear-gradient(135deg, var(--warning), #f97316);
        }

        .material-badge.recent {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .material-image {
            height: 160px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.2);
            font-size: 60px;
            position: relative;
        }

        .material-content {
            padding: 20px;
        }

        .material-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .material-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .material-code {
            background: #e0f2fe;
            padding: 5px 12px;
            border-radius: 50px;
            color: var(--primary);
            font-weight: 800;
            font-size: 12px;
        }

        .material-year {
            background: #fee2e2;
            padding: 5px 12px;
            border-radius: 50px;
            color: var(--danger);
            font-weight: 800;
            font-size: 12px;
        }

        .material-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .material-description {
            color: #64748b;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 18px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .material-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .view-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .preview-btn {
            background: #f1f5f9;
            color: var(--dark);
            border: 2px solid #e2e8f0;
        }

        /* Right Sidebar */
        .sidebar-right {
            background: var(--light);
            padding: 25px 20px;
            border-left: 1px solid #e2e8f0;
            height: calc(100vh - 180px);
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--card-bg);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }

        .category-name {
            font-weight: 700;
            color: var(--dark);
            font-size: 13px;
        }

        .category-count {
            background: #e0f2fe;
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 800;
            color: var(--primary);
        }

        .university-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .university-card {
            background: var(--card-bg);
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .university-logo {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: 800;
            font-size: 14px;
        }

        .premium-banner {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            margin-top: 25px;
            box-shadow: var(--shadow);
        }

        /* RAISED Bottom Navigation - MODIFIED: Only 5 buttons */
        .bottom-nav {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 50px;
            padding: 12px 25px;
            display: flex;
            gap: 10px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            border: 2px solid #e2e8f0;
            min-width: 580px; /* Adjusted for 5 buttons */
            justify-content: space-around;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 12px 18px;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 13px;
            color: #64748b;
            transition: all 0.3s;
            min-width: 90px; /* Adjusted for 5 buttons */
            justify-content: center;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 8px 20px rgba(26, 41, 128, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 15px;
            color: #64748b;
            border-top: 1px solid #e2e8f0;
            background: var(--light);
            font-size: 13px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            color: #495057;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* University Button - NEW STYLE */
        .university-browse-btn {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.3);
            margin-top: 20px;
        }

        .university-browse-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.4);
            background: linear-gradient(135deg, #6d28d9, #5b21b6);
        }

        .university-browse-btn.small {
            padding: 10px 20px;
            font-size: 14px;
        }

        /* Upload Button */
        .upload-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669, #047857);
        }

        /* Admin Panel Styles */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-section {
            display: none;
        }

        .admin-list {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* FIXED PDF VIEWER MODAL - SIMPLIFIED */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 2000;
            padding: 0;
        }

        .modal.active {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: transparent;
            border-radius: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            box-shadow: none;
        }

        .modal-header {
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            height: 60px;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .close-modal {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .modal-body {
            padding: 0;
            margin: 0;
            height: 100vh;
            position: relative;
            padding-top: 60px;
        }

        /* SIMPLE PDF VIEWER - Fullscreen with touch gestures */
        .pdf-viewer-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #000;
        }

        .pdf-viewer-frame {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
            background: white;
        }

        .pdf-viewer-frame.active {
            display: block;
        }

        /* PDF Loading State */
        .pdf-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #000;
            color: white;
            text-align: center;
            padding: 40px;
        }

        .pdf-loading i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.8;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .pdf-loading h3 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .pdf-loading p {
            opacity: 0.8;
            max-width: 400px;
            line-height: 1.6;
        }

        .pdf-error {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #000;
            color: white;
            text-align: center;
            padding: 40px;
        }

        .pdf-error i {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .pdf-error h3 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .pdf-error p {
            opacity: 0.9;
            max-width: 400px;
            line-height: 1.6;
        }

        /* University List Modal */
        .university-list-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2002;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }

        .university-list-modal.active {
            display: block;
        }

        .university-list-content {
            background: white;
            border-radius: var(--radius);
            max-width: 800px;
            margin: 50px auto;
            padding: 25px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .university-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .university-list-title {
            font-size: 24px;
            color: var(--primary);
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .university-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .university-list-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .university-list-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .university-list-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-weight: 800;
            font-size: 18px;
        }

        .university-list-name {
            font-weight: 700;
            color: var(--dark);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .university-list-count {
            background: #e0f2fe;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 800;
            color: var(--primary);
            display: inline-block;
        }

        /* Admin Approval Styles */
        .admin-approval-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .approve-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .approve-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .reject-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .reject-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        .send-whatsapp-btn {
            background: linear-gradient(135deg, #25d366, #128C7E);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 5px;
        }

        .send-whatsapp-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            margin-left: 10px;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-active {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-expired {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .quick-action-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            color: var(--dark);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 3px;
            background: #e2e8f0;
            z-index: 1;
        }

        .progress-step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            color: #64748b;
        }

        .step-circle.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 120px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: none;
            z-index: 2001;
            max-width: 300px;
            border-left: 5px solid var(--success);
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .notification.show {
            display: block;
            transform: translateX(0);
        }

        /* Upload Instructions */
        .upload-instructions {
            background: #f0f9ff;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .upload-instructions h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instruction-step {
            display: flex;
            align-items: start;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content h4 {
            color: var(--dark);
            margin-bottom: 5px;
        }

        .step-content p {
            color: #64748b;
            font-size: 14px;
            line-height: 1.5;
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            margin: 10px 0;
            overflow-x: auto;
        }

        /* Copy Button */
        .copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .copy-btn.copied {
            background: #10b981;
        }

        /* Account Number Display - MOVED TO REGISTRATION */
        .account-number-display {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 3px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .account-number {
            font-size: 24px;
            font-weight: bold;
            color: #92400e;
            letter-spacing: 2px;
            margin: 10px 0;
        }

        /* Backup Button Styles */
        .backup-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .backup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        /* JSON Upload Styles */
        .json-upload-zone {
            border: 3px dashed #7c3aed;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(124, 58, 237, 0.05);
        }

        .json-upload-zone:hover {
            background: rgba(124, 58, 237, 0.1);
            border-color: #6d28d9;
        }

        .json-upload-zone.dragover {
            background: rgba(124, 58, 237, 0.2);
            border-color: #5b21b6;
            transform: scale(1.02);
        }

        .json-document-preview {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            background: #f8fafc;
        }

        .json-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .json-stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .json-stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .json-stat-label {
            font-size: 12px;
            color: #64748b;
        }

        /* Drag and drop animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .json-upload-zone.dragover {
            animation: pulse 1s infinite;
        }

        /* NEW: Statistics Card Styles */
        .stats-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .stats-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stats-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--dark);
        }

        .stats-change {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 20px;
            margin-left: 10px;
        }

        .stats-change.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .stats-change.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .stats-details {
            font-size: 13px;
            color: #64748b;
            margin-top: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .university-stats-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .university-stats-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .university-stats-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            flex-shrink: 0;
        }

        .university-stats-info {
            flex: 1;
        }

        .university-stats-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .university-stats-count {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stats-chart {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .chart-bar {
            height: 30px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 5px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            transition: width 1s ease-in-out;
        }

        .chart-label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: 600;
            font-size: 12px;
            z-index: 1;
        }

        .chart-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: 600;
            font-size: 12px;
            z-index: 1;
        }

        /* NEW: Document Management Button Styles */
        .doc-management-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .doc-management-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
        }

        /* NEW: Admin Document Management Section */
        .doc-management-section {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8fafc;
        }

        .doc-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .doc-edit-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .doc-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }

        .doc-view-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .doc-view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .sidebar-left, .sidebar-right {
                display: none;
            }
            .main-content {
                height: auto;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .search-container {
                width: 100%;
                max-width: 100%;
            }
            
            .main-container {
                margin-top: 140px;
            }
            
            /* Mobile Bottom Navigation */
            .bottom-nav {
                bottom: 30px;
                min-width: 95%;
                padding: 10px 15px;
                gap: 5px;
            }
            
            .nav-btn {
                min-width: auto;
                padding: 10px 12px;
                font-size: 11px;
            }
            
            .nav-btn span {
                display: none;
            }
            
            .materials-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                width: 100%;
            }
            
            .filter-select {
                width: 100%;
            }
            
            .main-content {
                height: auto;
                padding: 15px;
            }
            
            .sidebar-right {
                height: auto;
            }
            
            /* Mobile Document Viewer */
            .modal-header {
                padding: 12px 15px;
                height: 55px;
            }
            
            .modal-title {
                font-size: 16px;
                max-width: 65%;
            }
            
            .close-modal {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .modal-body {
                padding-top: 55px;
            }
            
            .pdf-loading i,
            .pdf-error i {
                font-size: 50px;
            }
            
            .pdf-loading h3,
            .pdf-error h3 {
                font-size: 20px;
            }
            
            .progress-steps {
                flex-direction: column;
                gap: 20px;
            }
            
            .progress-steps::before {
                display: none;
            }
            
            .progress-step {
                width: 100%;
                text-align: left;
                display: flex;
                align-items: center;
                gap: 15px;
            }
            
            .step-circle {
                margin: 0;
                flex-shrink: 0;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Small Mobile */
        @media (max-width: 480px) {
            .bottom-nav {
                bottom: 25px;
                padding: 8px 10px;
                min-width: 98%;
            }
            
            .nav-btn {
                padding: 8px 10px;
                min-width: 50px;
            }
            
            .nav-btn i {
                font-size: 14px;
            }
            
            .modal-header {
                padding: 10px 12px;
                height: 50px;
            }
            
            .modal-title {
                font-size: 14px;
                max-width: 60%;
            }
            
            .close-modal {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .modal-body {
                padding-top: 50px;
            }
            
            .university-list-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
            
            .doc-action-buttons {
                flex-direction: column;
            }
        }

        /* Animation for cards */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .material-card {
            animation: slideUp 0.3s ease-out;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Material Type Badge */
        .material-type {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <div class="header-container">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="logo-text">
                    <h1>RevisionVault Pro</h1>
                    <p>University Study Materials Platform</p>
                </div>
            </div>
            
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-box" placeholder="Search by Unit Code e.g AGRO222" id="searchInput">
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
            
            <div class="header-actions">
                <div class="price-tag">
                    <i class="fas fa-crown"></i>
                    <span>Ksh 67 for 5 Months</span>
                </div>
                <div class="contact-number">
                    <i class="fas fa-phone-alt"></i>
                    <span>0765 098 865</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <div class="main-layout">
            <!-- Left Sidebar -->
            <aside class="sidebar-left">
                <div class="section-title">
                    <i class="fas fa-tools"></i>
                    <span>POWERFUL Study Tools</span>
                </div>
                <div class="tools-grid">
                    <div class="tool-card" onclick="showNotification('StudyList', 'StudyList feature coming soon!')">
                        <div class="tool-icon"><i class="fas fa-list"></i></div>
                        <div class="tool-name">STUDYLIST</div>
                    </div>
                    <div class="tool-card" onclick="showNotification('Reminders', 'Reminders feature coming soon!')">
                        <div class="tool-icon"><i class="fas fa-bell"></i></div>
                        <div class="tool-name">REMINDERS</div>
                    </div>
                    <div class="tool-card" onclick="showNotification('Notes', 'Notes feature coming soon!')">
                        <div class="tool-icon"><i class="fas fa-sticky-note"></i></div>
                        <div class="tool-name">NOTES</div>
                    </div>
                    <div class="tool-card" onclick="showNotification('Tests', 'Tests feature coming soon!')">
                        <div class="tool-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="tool-name">TESTS</div>
                    </div>
                    <div class="tool-card" onclick="showNotification('Downloads', 'Downloads feature coming soon!')">
                        <div class="tool-icon"><i class="fas fa-download"></i></div>
                        <div class="tool-name">DOWNLOADS</div>
                    </div>
                    <div class="tool-card" onclick="showNotification('Progress', 'Progress tracking coming soon!')">
                        <div class="tool-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="tool-name">PROGRESS</div>
                    </div>
                </div>

                <div class="timetable">
                    <div class="section-title">
                        <i class="fas fa-calendar-alt"></i>
                        <span>My Timetable</span>
                    </div>
                    <div class="week-display">Week 24</div>
                    <div class="date-range">Mon, June 10 - Fri, June 14</div>
                    <div class="schedule-grid">
                        <div class="schedule-item">
                            <div class="time">9:00 AM</div>
                            <div class="subject">AGRO222</div>
                        </div>
                        <div class="schedule-item">
                            <div class="time">11:00 AM</div>
                            <div class="subject">BOTA241</div>
                        </div>
                        <div class="schedule-item">
                            <div class="time">2:00 PM</div>
                            <div class="subject">ZOOL210</div>
                        </div>
                    </div>
                </div>

                <button class="ai-chat-btn" onclick="openAIChat()">
                    <i class="fas fa-robot"></i>
                    AI CHAT
                    <span>ESSAYS | RESEARCH | ASSIGNMENTS</span>
                </button>

                <!-- Quick Actions for Universities -->
                <div class="quick-actions" style="margin-top: 20px;">
                    <button class="quick-action-btn" onclick="openUniversityListModal()">
                        <i class="fas fa-university"></i> Browse Universities
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Home Tab -->
                <div id="home" class="tab-content active">
                    <div class="content-header">
                        <h1 class="main-title">Continue Reading</h1>
                        <div class="filters">
                            <select class="filter-select" onchange="filterMaterials()" id="universityFilter">
                                <option value="all">All Universities</option>
                            </select>
                            <select class="filter-select" onchange="filterMaterials()" id="yearFilter">
                                <option value="all">All Years</option>
                                <option value="1">Year 1</option>
                                <option value="2">Year 2</option>
                                <option value="3">Year 3</option>
                                <option value="4">Year 4</option>
                            </select>
                        </div>
                    </div>

                    <!-- Progress Steps for New Users -->
                    <div class="progress-steps" id="progressSteps" style="display: none;">
                        <div class="progress-step">
                            <div class="step-circle">1</div>
                            <div class="step-label">Register</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">2</div>
                            <div class="step-label">Get Code</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">3</div>
                            <div class="step-label">Activate</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle active">4</div>
                            <div class="step-label">Browse</div>
                        </div>
                    </div>

                    <div class="quick-units" id="quickUnits"></div>

                    <div id="accessStatus" class="access-status">
                        <div class="access-text">
                            <h3><i class="fas fa-lock"></i> Access Locked</h3>
                            <p>Subscribe to unlock all study materials and features</p>
                        </div>
                        <button class="view-btn" onclick="showTab('register')" style="width: auto; padding: 10px 20px;">
                            <i class="fas fa-crown"></i> Subscribe Now
                        </button>
                    </div>

                    <!-- Registration Success Banner -->
                    <div id="registrationSuccessBanner" class="registration-success-banner">
                        <div style="text-align: center; width: 100%;">
                            <h3><i class="fas fa-check-circle"></i> Registration Successful!</h3>
                            <p>Your registration has been submitted. Admin will send you an unlock code via WhatsApp.</p>
                            <p style="margin-bottom: 20px; font-weight: 600;">You can browse universities while waiting:</p>
                            
                            <div class="quick-actions">
                                <button class="quick-action-btn" onclick="openUniversityListModal()">
                                    <i class="fas fa-university"></i> Browse Universities
                                </button>
                                <button class="quick-action-btn" onclick="showTab('login')">
                                    <i class="fas fa-sign-in-alt"></i> Go to Login
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="search-results" id="searchResults">
                        <h2 class="search-results-title" id="searchResultsTitle"></h2>
                        <div class="materials-grid" id="searchResultsGrid"></div>
                    </div>

                    <div id="continueReading">
                        <div class="materials-grid" id="continueReadingGrid"></div>

                        <div class="section-divider" style="margin: 30px 0 25px; display: flex; align-items: center; gap: 15px;">
                            <div class="divider-line" style="flex: 1; height: 2px; background: linear-gradient(90deg, transparent, #e2e8f0, transparent);"></div>
                            <h2 style="font-size: 20px; color: var(--primary); font-weight: 800; white-space: nowrap;">Trending Materials</h2>
                            <div class="divider-line" style="flex: 1; height: 2px; background: linear-gradient(90deg, transparent, #e2e8f0, transparent);"></div>
                        </div>

                        <div class="materials-grid" id="trendingGrid"></div>
                    </div>
                </div>

                <!-- Materials Tab -->
                <div id="materials" class="tab-content">
                    <div class="content-header">
                        <h1 class="main-title">All Study Materials</h1>
                        <div class="filters">
                            <select class="filter-select" onchange="filterAllMaterials()" id="allUniversityFilter">
                                <option value="all">All Universities</option>
                            </select>
                            <select class="filter-select" onchange="filterAllMaterials()" id="allSubjectFilter">
                                <option value="all">All Subjects</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- University Browse Button -->
                    <div style="margin-bottom: 25px;">
                        <button class="university-browse-btn" onclick="openUniversityListModal()">
                            <i class="fas fa-university"></i> BROWSE BY UNIVERSITY
                        </button>
                    </div>
                    
                    <div class="materials-grid" id="allMaterialsGrid"></div>
                </div>

                <!-- Register Tab -->
                <div id="register" class="tab-content">
                    <div class="content-header">
                        <h1 class="main-title">Student Registration</h1>
                    </div>
                    
                    <!-- Progress Steps -->
                    <div class="progress-steps">
                        <div class="progress-step">
                            <div class="step-circle active">1</div>
                            <div class="step-label">Fill Form</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">2</div>
                            <div class="step-label">Make Payment</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">3</div>
                            <div class="step-label">Get Code</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">4</div>
                            <div class="step-label">Browse</div>
                        </div>
                    </div>

                    <!-- Registration Form -->
                    <div id="registrationForm">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="studentName" placeholder="Enter your full name">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Phone Number (WhatsApp)</label>
                            <input type="tel" class="form-input" id="studentPhone" placeholder="07XXXXXXXX">
                            <small style="color: #6c757d; font-size: 12px;">This number will be used for WhatsApp verification</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">University</label>
                            <select class="form-select" id="studentUniversity">
                                <option value="">Select University</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Course/Program</label>
                            <input type="text" class="form-input" id="studentCourse" placeholder="e.g., BSc Agriculture">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Year of Study</label>
                            <select class="form-select" id="studentYear">
                                <option value="">Select Year</option>
                                <option value="1">Year 1</option>
                                <option value="2">Year 2</option>
                                <option value="3">Year 3</option>
                                <option value="4">Year 4</option>
                            </select>
                        </div>

                        <!-- Payment Instructions -->
                        <div class="payment-instructions" style="background: #e8f5e9; border: 3px solid #4caf50; border-radius: 15px; padding: 20px; margin: 20px 0;">
                            <h3 style="color: #4caf50; margin-bottom: 15px;"> M-Pesa Payment Instructions</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">Step 1</div>
                                    <p style="font-size: 13px;">Go to <strong>M-Pesa</strong></p>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">Step 2</div>
                                    <p style="font-size: 13px;">Select <strong>Lipa Na M-Pesa</strong></p>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">Step 3</div>
                                    <p style="font-size: 13px;">Select <strong>Pay Bill</strong></p>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">Step 4</div>
                                    <p style="font-size: 13px;">Business No: <strong>247247</strong></p>
                                </div>
                            </div>
                            
                            <!-- FIXED PAYMENT ACCOUNT NUMBER - MOVED HERE between step 4 and amount -->
                            <div class="account-number-display" style="margin: 20px 0;">
                                <h3 style="color: #92400e; margin-bottom: 10px;">
                                    <i class="fas fa-copy"></i> Fixed Payment Account Number
                                </h3>
                                <div class="account-number">0330184468200</div>
                                <button class="copy-btn" onclick="copyAccountNumber()" style="margin: 10px auto; display: block;">
                                    <i class="fas fa-copy"></i> Copy Account Number
                                </button>
                                <p style="font-size: 12px; color: #92400e; margin-top: 10px;">
                                    Copy this account number for M-Pesa payment
                                </p>
                            </div>
                            
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Amount</div>
                                <div style="font-size: 32px; font-weight: bold; color: #4caf50;">Ksh 67</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">M-Pesa Transaction Code</label>
                            <input type="text" class="form-input" id="paymentCode" placeholder="Enter transaction code (e.g., SDF45G7H)">
                        </div>

                        <div class="whatsapp-notice" style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 15px; text-align: center; margin: 20px 0;">
                            <i class="fab fa-whatsapp" style="color: #25d366; font-size: 24px; margin-bottom: 10px;"></i>
                            <p><strong>WhatsApp Verification</strong></p>
                            <p style="font-size: 13px;">After submitting, your phone will send a WhatsApp message to admin automatically</p>
                        </div>

                        <button class="submit-btn" onclick="registerStudent()">
                            <i class="fas fa-paper-plane"></i> SUBMIT REGISTRATION & PAYMENT
                        </button>

                        <!-- UNLOCK CODE BUTTON - ADDED HERE: Just after submit verification and payment -->
                        <div style="text-align: center; margin-top: 25px; padding: 20px; border: 2px dashed #e2e8f0; border-radius: 10px;">
                            <h3 style="color: var(--primary); margin-bottom: 10px;">
                                <i class="fas fa-key"></i> Already Have an Unlock Code?
                            </h3>
                            <p style="color: #64748b; margin-bottom: 15px;">If you've already received your unlock code from admin, click below to activate your account</p>
                            <button class="university-browse-btn small" onclick="showTab('login')" style="width: 100%;">
                                <i class="fas fa-unlock"></i> ENTER UNLOCK CODE & ACTIVATE
                            </button>
                        </div>

                        <!-- Quick Browse Option -->
                        <div style="text-align: center; margin-top: 25px;">
                            <p style="color: #64748b; margin-bottom: 15px;">Want to see what's available first?</p>
                            <button class="university-browse-btn small" onclick="openUniversityListModal()">
                                <i class="fas fa-university"></i> BROWSE UNIVERSITIES
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Login Tab -->
                <div id="login" class="tab-content">
                    <div class="content-header">
                        <h1 class="main-title">Student Login</h1>
                    </div>
                    
                    <!-- University Browse Button at Top -->
                    <div style="margin-bottom: 25px;">
                        <button class="university-browse-btn small" onclick="openUniversityListModal()">
                            <i class="fas fa-university"></i> BROWSE UNIVERSITIES
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="loginPhone" placeholder="07XXXXXXXX">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Unlock Code (From Admin)</label>
                        <input type="text" class="form-input" id="unlockCode" placeholder="Enter unlock code from WhatsApp">
                        <small style="color: #6c757d; font-size: 12px;">Required for first-time activation only</small>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="submit-btn" onclick="loginStudent()" style="flex: 2;">
                            <i class="fas fa-sign-in-alt"></i> LOGIN & ACTIVATE
                        </button>
                        <button class="university-browse-btn small" onclick="openUniversityListModal()" style="flex: 1;">
                            <i class="fas fa-university"></i> Browse
                        </button>
                    </div>

                    <!-- Quick Guide -->
                    <div style="background: #f0f9ff; border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-info-circle"></i> How It Works
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; color: var(--primary); margin-bottom: 8px;">1</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--dark);">Register & Pay</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; color: var(--primary); margin-bottom: 8px;">2</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--dark);">Get WhatsApp Code</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; color: var(--primary); margin-bottom: 8px;">3</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--dark);">Login & Activate</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; color: var(--primary); margin-bottom: 8px;">4</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--dark);">Browse Materials</div>
                            </div>
                        </div>
                    </div>

                    <div id="loginMessage" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>
                </div>

                <!-- Upload Tab - NEW -->
                <div id="upload" class="tab-content">
                    <div class="content-header">
                        <h1 class="main-title">Upload Study Materials</h1>
                    </div>

                    <!-- Upload Instructions -->
                    <div class="upload-instructions">
                        <h3><i class="fas fa-info-circle"></i> How to Upload Materials</h3>
                        
                        <div class="instruction-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Prepare Your Document</h4>
                                <p>Make sure your document is in PDF format. Upload it to Google Drive.</p>
                            </div>
                        </div>
                        
                        <div class="instruction-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Get Shareable Link</h4>
                                <p>Right-click on the file in Google Drive  "Share"  Change to "Anyone with the link"  Copy link</p>
                            </div>
                        </div>
                        
                        <div class="instruction-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Convert to Direct Link</h4>
                                <p>Change the link format to direct preview link:</p>
                                <div class="code-block">
                                    Original: https://drive.google.com/file/d/FILE_ID/view?usp=sharing<br>
                                    Change to: https://drive.google.com/file/d/FILE_ID/preview
                                </div>
                                <button class="copy-btn" onclick="copyText('https://drive.google.com/file/d/FILE_ID/preview')">
                                    <i class="fas fa-copy"></i> Copy Format
                                </button>
                            </div>
                        </div>
                        
                        <div class="instruction-step" style="border-bottom: none;">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>Fill Upload Form</h4>
                                <p>Complete the form below with all details. Your upload will be reviewed by admin.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Form -->
                    <div id="uploadForm">
                        <div class="form-group">
                            <label class="form-label">Document Title</label>
                            <input type="text" class="form-input" id="uploadTitle" placeholder="e.g., Plant Breeding Notes">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Unit Code</label>
                            <input type="text" class="form-input" id="uploadUnitCode" placeholder="e.g., AGRO222">
                        </div>

                        <div class="form-group">
                            <label class="form-label">University</label>
                            <select class="form-select" id="uploadUniversity">
                                <option value="">Select University</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Subject/Category</label>
                            <input type="text" class="form-input" id="uploadSubject" placeholder="e.g., Agronomy">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Year of Study</label>
                            <select class="form-select" id="uploadYear">
                                <option value="">Select Year</option>
                                <option value="1">Year 1</option>
                                <option value="2">Year 2</option>
                                <option value="3">Year 3</option>
                                <option value="4">Year 4</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-input" id="uploadDescription" placeholder="Brief description of the material" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Google Drive Direct Link</label>
                            <input type="url" class="form-input" id="uploadURL" placeholder="https://drive.google.com/file/d/.../preview">
                            <small style="color: #6c757d; font-size: 12px;">Must end with /preview (not /view)</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Your Phone Number (for notification)</label>
                            <input type="tel" class="form-input" id="uploaderPhone" placeholder="07XXXXXXXX">
                        </div>

                        <button class="upload-btn" onclick="uploadMaterial()">
                            <i class="fas fa-upload"></i> SUBMIT FOR REVIEW
                        </button>

                        <div style="text-align: center; margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 10px;">
                            <p style="color: #92400e;">
                                <i class="fas fa-info-circle"></i> Note: All uploads are reviewed by admin. You'll be notified via WhatsApp when approved.
                            </p>
                        </div>
                    </div>

                    <!-- Upload Success Message -->
                    <div id="uploadSuccess" style="display: none; background: #d1fae5; border: 2px solid #10b981; border-radius: 10px; padding: 25px; text-align: center; margin-top: 20px;">
                        <div style="font-size: 48px; color: #10b981; margin-bottom: 15px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3 style="color: #065f46; margin-bottom: 10px;">Upload Submitted Successfully!</h3>
                        <p style="color: #047857; margin-bottom: 20px;">Your material has been submitted for admin review. You'll receive a WhatsApp notification once it's approved.</p>
                        <button class="upload-btn" onclick="showTab('materials')">
                            <i class="fas fa-book"></i> Browse Other Materials
                        </button>
                    </div>
                </div>

                <!-- Admin Tab -->
                <div id="admin" class="tab-content">
                    <div class="content-header">
                        <h1 class="main-title">Admin Control Panel</h1>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Admin Password</label>
                        <input type="password" class="form-input" id="adminPassword" placeholder="Enter admin password">
                        <!-- ADMIN PASSWORD SECRET - REMOVED FROM DISPLAY -->
                    </div>

                    <button class="submit-btn" onclick="adminLogin()">
                        <i class="fas fa-sign-in-alt"></i> LOGIN AS ADMIN
                    </button>

                    <div id="adminPanel" style="display: none; margin-top: 30px;">
                        <!-- LOGOUT BUTTON ADDED HERE -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: var(--primary);">Welcome, Admin!</h2>
                            <button class="reject-btn" onclick="adminLogout()" style="padding: 10px 20px;">
                                <i class="fas fa-sign-out-alt"></i> Logout Admin
                            </button>
                        </div>

                        <div class="admin-tabs">
                            <button class="nav-btn" onclick="showAdminSection('pending')" style="flex: none; padding: 12px 20px;">Pending Approvals</button>
                            <button class="nav-btn" onclick="showAdminSection('students')" style="flex: none; padding: 12px 20px;">All Students</button>
                            <button class="nav-btn" onclick="showAdminSection('materials')" style="flex: none; padding: 12px 20px;">Manage Materials</button>
                            <button class="nav-btn" onclick="showAdminSection('uploads')" style="flex: none; padding: 12px 20px;">User Uploads</button>
                            <!-- NEW: Document Management Button -->
                            <button class="nav-btn" onclick="showAdminSection('documentManagement')" style="flex: none; padding: 12px 20px; background: #3b82f6; color: white;">
                                <i class="fas fa-file-alt"></i> Doc Management
                            </button>
                            <!-- NEW: Statistics Button -->
                            <button class="nav-btn" onclick="showAdminSection('statistics')" style="flex: none; padding: 12px 20px; background: #10b981; color: white;">
                                <i class="fas fa-chart-bar"></i> Statistics
                            </button>
                            <button class="nav-btn" onclick="showAdminSection('backup')" style="flex: none; padding: 12px 20px; background: #8b5cf6; color: white;">Backup</button>
                            <!-- NEW JSON UPLOAD BUTTON -->
                            <button class="nav-btn" onclick="showAdminSection('jsonUpload')" style="flex: none; padding: 12px 20px; background: #7c3aed; color: white;">
                                <i class="fas fa-file-upload"></i> JSON Upload
                            </button>
                        </div>

                        <div id="pendingSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> Pending Subscriptions</h3>
                            <div class="admin-list" id="pendingList"></div>
                        </div>

                        <div id="studentsSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> All Registered Students</h3>
                            <div class="admin-list" id="studentList"></div>
                        </div>

                        <div id="materialsSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> Manage Study Materials</h3>
                            <div style="margin-bottom: 20px;">
                                <button class="submit-btn" onclick="addNewMaterial()" style="width: auto; padding: 12px 25px;">
                                    <i class="fas fa-plus"></i> Add New Material
                                </button>
                            </div>
                            <div class="admin-list" id="adminMaterialsList"></div>
                        </div>

                        <div id="uploadsSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> User Uploads Pending Review</h3>
                            <div class="admin-list" id="userUploadsList"></div>
                        </div>

                        <!-- NEW: Document Management Section -->
                        <div id="documentManagementSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> Document Management</h3>
                            
                            <div class="doc-management-section">
                                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-search"></i> Quick Document Search</h4>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <input type="text" class="form-input" id="docSearchInput" placeholder="Search by Unit Code, Title, or University..." onkeyup="searchDocumentsAdmin()">
                                </div>
                                
                                <div id="docManagementResults" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Documents will be populated here -->
                                </div>
                            </div>
                            
                            <div class="doc-management-section">
                                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-tools"></i> Bulk Actions</h4>
                                <div class="doc-action-buttons">
                                    <button class="doc-management-btn" onclick="markAllAsTrending()">
                                        <i class="fas fa-fire"></i> Mark All as Trending
                                    </button>
                                    <button class="doc-management-btn" style="background: linear-gradient(135deg, #f59e0b, #d97706);" onclick="updateDocumentYears()">
                                        <i class="fas fa-calendar-alt"></i> Update Years
                                    </button>
                                    <button class="doc-management-btn" style="background: linear-gradient(135deg, #10b981, #059669);" onclick="exportDocumentsCSV()">
                                        <i class="fas fa-download"></i> Export as CSV
                                    </button>
                                    <button class="doc-management-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626);" onclick="cleanDuplicateDocuments()">
                                        <i class="fas fa-trash"></i> Remove Duplicates
                                    </button>
                                </div>
                            </div>
                            
                            <div class="doc-management-section">
                                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Document Statistics</h4>
                                <div id="docManagementStats" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                                    <!-- Stats will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- NEW: Statistics Section -->
                        <div id="statisticsSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> System Statistics</h3>
                            
                            <!-- Statistics Cards -->
                            <div class="stats-grid">
                                <div class="stats-card">
                                    <div class="stats-header">
                                        <div class="stats-title">
                                            <i class="fas fa-users"></i> Total Students
                                        </div>
                                        <div class="stats-value" id="totalStudents">0</div>
                                    </div>
                                    <div class="stats-details">
                                        <span id="activeStudents">0</span> active  <span id="pendingStudents">0</span> pending
                                    </div>
                                </div>
                                
                                <div class="stats-card">
                                    <div class="stats-header">
                                        <div class="stats-title">
                                            <i class="fas fa-file-alt"></i> Total Documents
                                        </div>
                                        <div class="stats-value" id="totalDocuments">0</div>
                                    </div>
                                    <div class="stats-details">
                                        <span id="trendingDocuments">0</span> trending  <span id="recentDocuments">0</span> recent
                                    </div>
                                </div>
                                
                                <div class="stats-card">
                                    <div class="stats-header">
                                        <div class="stats-title">
                                            <i class="fas fa-university"></i> Universities
                                        </div>
                                        <div class="stats-value" id="totalUniversities">0</div>
                                    </div>
                                    <div class="stats-details">
                                        With students: <span id="universitiesWithStudents">0</span>
                                    </div>
                                </div>
                                
                                <div class="stats-card">
                                    <div class="stats-header">
                                        <div class="stats-title">
                                            <i class="fas fa-upload"></i> User Uploads
                                        </div>
                                        <div class="stats-value" id="totalUploads">0</div>
                                    </div>
                                    <div class="stats-details">
                                        <span id="pendingUploads">0</span> pending  <span id="approvedUploads">0</span> approved
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Students Per University Chart -->
                            <div class="stats-chart">
                                <h4 style="color: var(--primary); margin-bottom: 15px;">
                                    <i class="fas fa-chart-bar"></i> Students per University
                                </h4>
                                <div id="studentsPerUniversityChart">
                                    <!-- Chart will be populated here -->
                                </div>
                            </div>
                            
                            <!-- University Statistics List -->
                            <h4 style="color: var(--primary); margin-bottom: 15px; margin-top: 25px;">
                                <i class="fas fa-list"></i> University Breakdown
                            </h4>
                            <div id="universityStatisticsList" style="max-height: 400px; overflow-y: auto;">
                                <!-- University stats will be populated here -->
                            </div>
                            
                            <!-- Quick Stats Export -->
                            <div style="margin-top: 20px; text-align: center;">
                                <button class="doc-management-btn" onclick="exportStatistics()" style="width: 100%;">
                                    <i class="fas fa-download"></i> Export Statistics Report
                                </button>
                            </div>
                        </div>

                        <!-- BACKUP SECTION -->
                        <div id="backupSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> Backup Documents Details</h3>
                            
                            <div style="background: #f0f9ff; border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Backup Instructions</h4>
                                <p style="color: #64748b; font-size: 14px; line-height: 1.5;">
                                    Click the button below to copy all recently uploaded documents details to clipboard. 
                                    You can then paste them into a text file for backup.
                                </p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <button class="backup-btn" onclick="backupRecentUploads()" style="padding: 12px 20px; font-size: 14px;">
                                    <i class="fas fa-copy"></i> Copy Recent Uploads Details
                                </button>
                                <button class="backup-btn" onclick="backupAllDocuments()" style="padding: 12px 20px; font-size: 14px; background: linear-gradient(135deg, #10b981, #059669);">
                                    <i class="fas fa-database"></i> Copy All Documents
                                </button>
                            </div>
                            
                            <div id="backupStatus" style="display: none; padding: 15px; border-radius: 8px; margin-top: 15px;"></div>
                            
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px; padding: 15px; margin-top: 20px;">
                                <h4 style="color: #92400e; margin-bottom: 10px;"><i class="fas fa-lightbulb"></i> Tip</h4>
                                <p style="color: #92400e; font-size: 13px;">
                                    For best backup practice, copy the details and paste into a Google Docs or text file after each upload session.
                                </p>
                            </div>
                        </div>

                        <!-- NEW JSON UPLOAD SECTION -->
                        <div id="jsonUploadSection" class="admin-section" style="display: none;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;"> JSON Bulk Upload</h3>
                            
                            <div style="background: #f0f9ff; border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-info-circle"></i> JSON Bulk Upload Instructions</h4>
                                <p style="color: #64748b; font-size: 14px; line-height: 1.5; margin-bottom: 15px;">
                                    Upload a JSON file containing multiple documents to automatically add them to the system. 
                                    All documents will be immediately available to all users.
                                </p>
                                
                                <div class="instruction-step">
                                    <div class="step-number">1</div>
                                    <div class="step-content">
                                        <h4>Prepare JSON File</h4>
                                        <p>Create a JSON file with an array of document objects. Each document should have this format:</p>
                                        <div class="code-block">
{
  "Title": "Plant Breeding notes",
  "Unit Code": "AGRO222",
  "University": "Egerton University",
  "Type": "pdf",
  "Subject": "Agronomy",
  "Year": "2",
  "Description": "lecture notes on plant Breeding",
  "URL": "https://drive.google.com/file/d/.../preview"
}
                                        </div>
                                        <button class="copy-btn" onclick="copyJSONTemplate()">
                                            <i class="fas fa-copy"></i> Copy Template
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="instruction-step">
                                    <div class="step-number">2</div>
                                    <div class="step-content">
                                        <h4>Download Current Documents</h4>
                                        <p>Download current documents as JSON to use as a template or backup:</p>
                                        <button class="backup-btn" onclick="downloadCurrentDocuments()" style="padding: 12px 20px; font-size: 14px; background: linear-gradient(135deg, #10b981, #059669);">
                                            <i class="fas fa-download"></i> Download Current Documents
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="instruction-step" style="border-bottom: none;">
                                    <div class="step-number">3</div>
                                    <div class="step-content">
                                        <h4>Upload JSON File</h4>
                                        <p>Select your JSON file below and upload. The system will automatically add all documents.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- JSON Upload Zone -->
                            <div class="json-upload-zone" id="jsonUploadZone" onclick="document.getElementById('jsonFileInput').click()">
                                <div style="font-size: 60px; color: #7c3aed; margin-bottom: 15px;">
                                    <i class="fas fa-file-upload"></i>
                                </div>
                                <h3 style="color: #7c3aed; margin-bottom: 10px;">Drop JSON File Here</h3>
                                <p style="color: #64748b; margin-bottom: 20px;">or click to select a JSON file</p>
                                
                                <div style="margin-bottom: 20px;">
                                    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleJSONFileSelect(event)">
                                    <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('jsonFileInput').click();" style="width: auto; padding: 15px 40px;">
                                        <i class="fas fa-folder-open"></i> SELECT JSON FILE
                                    </button>
                                </div>
                                
                                <div id="jsonFileInfo" style="display: none; background: #e9d5ff; border-radius: 10px; padding: 15px; margin-top: 15px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div style="text-align: left;">
                                            <div style="font-weight: bold; color: #7c3aed;" id="fileName"></div>
                                            <div style="font-size: 12px; color: #64748b;" id="fileSize"></div>
                                        </div>
                                        <button class="reject-btn" onclick="clearJSONFile()" style="padding: 5px 10px; font-size: 12px;">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upload Button -->
                            <button id="uploadJSONBtn" class="submit-btn" onclick="uploadJSONDocuments()" disabled style="margin-bottom: 20px; background: #7c3aed;">
                                <i class="fas fa-upload"></i> UPLOAD & PROCESS JSON DOCUMENTS
                            </button>
                            
                            <!-- Upload Status -->
                            <div id="jsonUploadStatus" style="margin-top: 20px; display: none;"></div>
                            
                            <!-- Preview Section -->
                            <div id="jsonPreviewSection" style="display: none;">
                                <h4 style="color: var(--primary); margin-bottom: 15px;"> Document Preview</h4>
                                <div id="jsonPreview" style="max-height: 300px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 10px; padding: 15px; background: #f8fafc;"></div>
                                <div id="jsonStats" style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar -->
            <aside class="sidebar-right">
                <div class="sidebar-section">
                    <h2 class="section-title">
                        <i class="fas fa-folder"></i>
                        Categories
                    </h2>
                    <ul class="category-list" id="categoryList"></ul>
                </div>

                <div class="sidebar-section">
                    <h2 class="section-title">
                        <i class="fas fa-university"></i>
                        Universities
                    </h2>
                    <div class="university-grid" id="universityGrid"></div>
                    <button class="university-browse-btn small" onclick="openUniversityListModal()" style="margin-top: 15px; width: 100%;">
                        <i class="fas fa-search"></i> Browse All Universities
                    </button>
                </div>

                <!-- Upload Button in Sidebar -->
                <div style="margin-top: 25px;">
                    <button class="upload-btn" onclick="showTab('upload')" style="width: 100%;">
                        <i class="fas fa-upload"></i> UPLOAD MATERIALS
                    </button>
                </div>

                <div class="premium-banner">
                    <div class="premium-title">
                        <i class="fas fa-crown"></i>
                        PREMIUM ACCESS
                    </div>
                    <p style="font-size: 13px;">Unlock all study materials for 5 months</p>
                    <div class="premium-price">Ksh 67</div>
                    <p style="font-size: 12px; opacity: 0.9;">One payment, full access to all resources</p>
                    <button class="premium-btn" onclick="showTab('register')">
                        <i class="fas fa-bolt"></i> SUBSCRIBE NOW
                    </button>
                </div>

                <div style="margin-top: 30px; text-align: center; color: #64748b; font-size: 13px; line-height: 1.6;">
                    <p><i class="fas fa-shield-alt"></i> Secure Payment</p>
                    <p><i class="fas fa-headset"></i> 24/7 Support</p>
                    <p><i class="fas fa-check-circle"></i> Money Back Guarantee</p>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <!-- CHANGED: Copyright updated to 2026 -->
            <p>&copy; 2026 RevisionVault Pro  Developed by Walter Zauko</p>
            <p style="margin-top: 3px;">Contact: 0765 098 865  All rights reserved</p>
        </footer>
    </div>

    <!-- RAISED Bottom Navigation - MODIFIED: Only 5 buttons -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="showTab('home')">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="nav-btn" onclick="showTab('materials')">
            <i class="fas fa-book"></i>
            <span>Materials</span>
        </button>
        <button class="nav-btn" onclick="showTab('upload')">
            <i class="fas fa-upload"></i>
            <span>Upload</span>
        </button>
        <button class="nav-btn" onclick="showTab('register')">
            <i class="fas fa-user-plus"></i>
            <span>Register</span>
        </button>
        <button class="nav-btn" onclick="showTab('admin')">
            <i class="fas fa-shield-alt"></i>
            <span>Admin</span>
        </button>
    </div>

    <!-- University List Modal -->
    <div class="university-list-modal" id="universityListModal">
        <div class="university-list-content">
            <div class="university-list-header">
                <h2 class="university-list-title">
                    <i class="fas fa-university"></i>
                    Browse University Materials
                </h2>
                <button class="close-modal" onclick="closeUniversityListModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="university-list-grid" id="universityListGrid">
                <!-- Universities will be populated here -->
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <p style="color: #64748b; font-size: 14px;">
                    Select a university to view materials from that institution
                </p>
            </div>
        </div>
    </div>

    <!-- SIMPLE FULLSCREEN DOCUMENT VIEWER MODAL -->
    <div class="modal" id="pdfModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="pdfModalTitle">
                    <i class="fas fa-file-pdf"></i>
                    <span>Document Viewer</span>
                </h2>
                <button class="close-modal" onclick="closeModal('pdfModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="pdf-viewer-container">
                    <!-- Loading State -->
                    <div class="pdf-loading" id="pdfLoading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>Loading Document...</h3>
                        <p>Please wait while we load your document.</p>
                    </div>
                    
                    <!-- Error State -->
                    <div class="pdf-error" id="pdfError" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Document Not Available</h3>
                        <p>The requested document could not be loaded. Please try again later or contact support.</p>
                        <button class="action-btn" onclick="closeModal('pdfModal')" style="width: auto; padding: 10px 20px; background: var(--primary); color: white;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                    
                    <!-- PDF Viewer - Fast loading with no controls -->
                    <iframe class="pdf-viewer-frame" id="pdfViewer" 
                            frameborder="0" 
                            scrolling="yes"
                            sandbox="allow-scripts allow-same-origin"
                            loading="eager">
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div class="modal" id="aiChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-robot"></i> AI Study Assistant</h2>
                <button class="close-modal" onclick="closeModal('aiChatModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p>AI Chat helps with essays, research, assignments, and study questions. Ask anything!</p>
                </div>
                
                <div id="aiChatMessages" style="height: 300px; overflow-y: auto; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <div style="background: #f1f5f9; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                        <strong><i class="fas fa-robot"></i> AI Assistant:</strong> Hello! I'm your AI study assistant. How can I help you today?
                    </div>
                </div>
                
                <div class="form-group">
                    <input type="text" class="form-input" id="aiQuestion" placeholder="Ask me anything about your studies...">
                </div>
                
                <button class="submit-btn" onclick="askAI()">
                    <i class="fas fa-paper-plane"></i> Ask AI Assistant
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <strong id="notificationTitle"></strong>
                <p id="notificationMessage" style="margin-top: 5px;"></p>
            </div>
            <button onclick="hideNotification()" style="background: none; border: none; color: #6c757d; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // ==================== ADVANCED APP DATA ====================
        const DOCUMENTS_DATA = [
            {
                "Title": "Plant Breeding notes",
                "Unit Code": "AGRO222",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Agronomy",
                "Year": "2",
                "Description": "lecture notes on plant Breeding",
                "URL": "https://drive.google.com/file/d/17CG_rb_ecvnkLfjTzNC31u55pBR_RW70/preview",
                "Trending": true,
                "Recent": true
            },
            {
                "Title": "Scope of production Economics",
                "Unit Code": "AGEC241",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Agricultural Economics",
                "Year": "2",
                "Description": "lecture notes on production Economics",
                "URL": "https://drive.google.com/file/d/1uSBqGCfeWPr-upLjKOu-cCkwQUVW7GOU/preview",
                "Trending": true
            },
            {
                "Title": "Production Economics",
                "Unit Code": "AGEC241",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Agricultural Economics",
                "Year": "2",
                "Description": "lecture notes on production Economics",
                "URL": "https://drive.google.com/file/d/1LZ5P_t9qRlxZq2AyAI8JoG-bZAdS6G_c/preview"
            },
            {
                "Title": "ICT Application in Agricultural Education and Extension",
                "Unit Code": "AGED113",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Agricultural Education and Extension",
                "Year": "2",
                "Description": "Examination paper on ICT Application in Agricultural Education and Extension",
                "URL": "https://drive.google.com/file/d/1MxYZpCMFoxTLI6ZR0w9rBBAWeZ1h_bg_/preview",
                "Recent": true
            },
            {
                "Title": "plant Breeding",
                "Unit Code": "AGRO222",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Agronomy",
                "Year": "2",
                "Description": "lecture notes on plant Breeding",
                "URL": "https://drive.google.com/file/d/1wFm3cb1YRR9yD9f5noK4tg0HeD0K0jtg/preview"
            },
            {
                "Title": "taxonomy of higher plants",
                "Unit Code": "BOTA241",
                "University": "Egerton University",
                "Type": "pdf",
                "Subject": "Botany",
                "Year": "2",
                "Description": "lecture notes on Taxonomy of higher plants",
                "URL": "https://drive.google.com/file/d/102toSTJ9WewkGSiBKx3IxWlbPoeKrGCU/preview"
            },
            {
                "Title": "plant physiology",
                "Unit Code": "BOTA271",
                "University": "Egerton University",
                Type: "pdf",
                Subject: "Botany",
                Year: "2",
                Description: "lecture notes on plant physiology",
                URL: "https://drive.google.com/file/d/1vSG6ErlBddO-dXBVu8Ice1ut297SiI5d/preview"
            },
            {
                Title: "Breeding practices",
                "Unit Code": "AGRO222",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Agronomy",
                Year: "2",
                Description: "lecture notes on breeding practices",
                URL: "https://drive.google.com/file/d/1nZfdRK6TTVLvR05-E70WPLBN51_m6G7C/preview",
                Recent: true
            },
            {
                Title: "Cell biology",
                "Unit Code": "ZOOL232",
                University: "Egerton University",
                Type: "pdf",
                Subject: "zoology",
                Year: "2",
                Description: "lecture notes on cell biology",
                URL: "https://drive.google.com/file/d/1LlFPeHK2DjZBhYh8C0LP9DZMX-etSZd7/preview"
            },
            {
                Title: "course outline",
                "Unit Code": "AGEC241",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Agricultural Economics",
                Year: "2",
                Description: "lecture notes on production Economics",
                URL: "https://drive.google.com/file/d/15D0aQg6hUX3v1pKwxnQ0Al0vRVIVCfsO/preview"
            },
            {
                Title: "Epistemology and Education",
                "Unit Code": "EDFO112",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Education Foundation",
                Year: "2",
                Description: "lecture notes on Epistemology and Education",
                URL: "https://drive.google.com/file/d/1Z9vZTucmGM_Vcp-cTvHfWwOxzNNLgPkj/preview"
            },
            {
                Title: "Environmental Science",
                "Unit Code": "ENSC104",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Environmental Science",
                Year: "2",
                Description: "lecture notes on Environmental Education",
                URL: "https://drive.google.com/file/d/1Rd_mPqrUik3mh9LX6GQEgD5XOjDfw1gB/preview"
            },
            {
                Title: "Environmental Education",
                "Unit Code": "ENSC104",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Environmental Science",
                Year: "2",
                Description: "lecture notes on Environmental Education",
                URL: "https://drive.google.com/file/d/1px1TN0icV_IlUjRm9DpgVyyPHmSfqBNz/preview"
            },
            {
                Title: "introduction to entrepreneurship",
                "Unit Code": "AGBM102",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Agro business management",
                Year: "2",
                Description: "lecture notes on introduction to Enterpreneurship",
                URL: "https://drive.google.com/file/d/18KKbBRI1zzReDAAKaQ3lgNmYUHKfc57B/preview"
            },
            {
                Title: "Ecology",
                "Unit Code": "ZOOL210",
                University: "Egerton University",
                Type: "pdf",
                Subject: "Zoology",
                Year: "2",
                Description: "lecture notes on ecology",
                URL: "https://drive.google.com/file/d/146nlk4PihaeonVHslq3GClWqwu5xsbeX/preview",
                Trending: true
            },
            {
                Title: "SENV311",
                "Unit Code": "SENV311",
                University: "University of Eldoret",
                Type: "pdf",
                Subject: "Environmental Science",
                Year: "2",
                Description: "groupwork assignment",
                URL: "https://drive.google.com/file/d/1yPUYlgNepiDrG8RFIraiO5vA3iLLlS6D/preview",
                Recent: true
            },
            {
                Title: "Integral Calculus",
                "Unit Code": "MATH212",
                University: "University of Nairobi",
                Type: "pdf",
                Subject: "Mathematics",
                Year: "2",
                Description: "2024 Main exam paper on integral calculus",
                URL: "https://drive.google.com/file/d/1LZ5P_t9qRlxZq2AyAI8JoG-bZAdS6G_c/preview",
                Trending: true
            },
            {
                Title: "Analytical Geometry",
                "Unit Code": "MATH132",
                University: "University of Nairobi",
                Type: "pdf",
                Subject: "Mathematics",
                Year: "1",
                Description: "Complete notes on analytical geometry",
                URL: "https://drive.google.com/file/d/1wFm3cb1YRR9yD9f5noK4tg0HeD0K0jtg/preview"
            }
        ];

        const UNIVERSITIES = [
            "University of Nairobi",
            "Kenyatta University",
            "Moi University",
            "Egerton University",
            "Jomo Kenyatta University of Agriculture and Technology",
            "Maseno University",
            "Masinde Muliro University of Science and Technology",
            "Dedan Kimathi University of Technology",
            "Technical University of Kenya",
            "Technical University of Mombasa",
            "Murang'a University of Technology",
            "Meru University of Science and Technology",
            "Kirinyaga University",
            "Laikipia University",
            "University of Eldoret",
            "Chuka University",
            "Karatina University",
            "Rongo University",
            "Kisii University",
            "South Eastern Kenya University",
            "Pwani University",
            "Co-operative University of Kenya",
            "Kabarak University",
            "Strathmore University",
            "Mount Kenya University",
            "Africa Nazarene University",
            "Catholic University of Eastern Africa",
            "Daystar University",
            "United States International University Africa",
            "Zetech University"
        ];

        // ==================== ADVANCED APP STATE ====================
        let appState = {
            currentUser: JSON.parse(localStorage.getItem('currentUser')) || null,
            users: JSON.parse(localStorage.getItem('users')) || [],
            documents: JSON.parse(localStorage.getItem('documents')) || DOCUMENTS_DATA,
            userUploads: JSON.parse(localStorage.getItem('userUploads')) || [],
            // ADMIN PASSWORD IS NOW HIDDEN FROM USERS
            adminPassword: "walter.zauko23", // Secret - only admin knows this
            adminWhatsApp: "254765098865",
            subscriptionPrice: "67",
            searchTimeout: null,
            allUnitCodes: [],
            recentlyRegisteredPhone: null,
            statistics: JSON.parse(localStorage.getItem('statistics')) || {
                totalDownloads: 0,
                activeSubscriptions: 0,
                totalMaterials: DOCUMENTS_DATA.length,
                universitiesWithMaterials: 0,
                userUploadsPending: 0,
                lastBackupDate: null,
                studentsPerUniversity: {}
            }
        };

        // ==================== NEW FEATURES FUNCTIONS ====================

        // NEW: Document Management Functions
        function searchDocumentsAdmin() {
            const searchTerm = document.getElementById('docSearchInput').value.toLowerCase();
            const resultsDiv = document.getElementById('docManagementResults');
            
            if (!searchTerm) {
                resultsDiv.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">Enter search term to find documents</p>';
                return;
            }
            
            const filteredDocs = appState.documents.filter(doc => 
                doc.Title.toLowerCase().includes(searchTerm) ||
                doc["Unit Code"].toLowerCase().includes(searchTerm) ||
                doc.University.toLowerCase().includes(searchTerm) ||
                doc.Subject.toLowerCase().includes(searchTerm)
            );
            
            if (filteredDocs.length === 0) {
                resultsDiv.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No documents found matching your search</p>';
                return;
            }
            
            resultsDiv.innerHTML = filteredDocs.map((doc, index) => `
                <div style="border: 2px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${doc.Title}</strong>
                            <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                                 ${doc["Unit Code"]} |  ${doc.University} |  Year ${doc.Year}
                            </div>
                            <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
                                ${doc.Description}
                            </div>
                            <div style="display: flex; gap: 5px; margin-top: 10px;">
                                ${doc.Trending ? '<span class="status-badge" style="background: #fef3c7; color: #92400e;">Trending</span>' : ''}
                                ${doc.Recent ? '<span class="status-badge" style="background: #d1fae5; color: #065f46;">Recent</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px; margin-left: 10px;">
                            <button onclick="editDocument(${index})" class="doc-edit-btn">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="toggleDocumentTrending(${index})" class="doc-view-btn" style="${doc.Trending ? 'background: linear-gradient(135deg, #f59e0b, #d97706);' : ''}">
                                <i class="fas fa-fire"></i> ${doc.Trending ? 'Untrend' : 'Trend'}
                            </button>
                            <button onclick="deleteMaterial(${index})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateDocManagementStats();
        }

        function editDocument(index) {
            const doc = appState.documents[index];
            if (!doc) return;
            
            const newTitle = prompt('Edit document title:', doc.Title);
            if (newTitle !== null) doc.Title = newTitle;
            
            const newUnitCode = prompt('Edit unit code:', doc["Unit Code"]);
            if (newUnitCode !== null) doc["Unit Code"] = newUnitCode;
            
            const newUniversity = prompt('Edit university:', doc.University);
            if (newUniversity !== null) doc.University = newUniversity;
            
            const newYear = prompt('Edit year:', doc.Year);
            if (newYear !== null) doc.Year = newYear;
            
            saveAppData();
            showNotification('Document Updated', 'Document information has been updated', 'success');
            searchDocumentsAdmin();
            updateStatistics();
        }

        function toggleDocumentTrending(index) {
            const doc = appState.documents[index];
            if (doc) {
                doc.Trending = !doc.Trending;
                saveAppData();
                showNotification(doc.Trending ? 'Marked as Trending' : 'Removed from Trending', 
                    `Document "${doc.Title}" ${doc.Trending ? 'is now trending' : 'is no longer trending'}`, 
                    'success');
                searchDocumentsAdmin();
                updateStatistics();
            }
        }

        function markAllAsTrending() {
            if (confirm('Mark ALL documents as trending? This will affect all documents in the system.')) {
                appState.documents.forEach(doc => {
                    doc.Trending = true;
                });
                saveAppData();
                showNotification('All Documents Trending', 'All documents have been marked as trending', 'success');
                searchDocumentsAdmin();
                updateStatistics();
            }
        }

        function updateDocumentYears() {
            const yearMap = {
                '1': '1',
                '2': '2', 
                '3': '3',
                '4': '4'
            };
            
            let updatedCount = 0;
            appState.documents.forEach(doc => {
                if (!doc.Year || !yearMap[doc.Year]) {
                    doc.Year = '2'; // Default to year 2
                    updatedCount++;
                }
            });
            
            saveAppData();
            showNotification('Years Updated', `${updatedCount} documents had their year updated`, 'success');
            searchDocumentsAdmin();
        }

        function exportDocumentsCSV() {
            let csvContent = "Title,Unit Code,University,Subject,Year,Description,URL,Trending,Recent\n";
            
            appState.documents.forEach(doc => {
                const row = [
                    `"${doc.Title}"`,
                    `"${doc["Unit Code"]}"`,
                    `"${doc.University}"`,
                    `"${doc.Subject}"`,
                    `"${doc.Year}"`,
                    `"${doc.Description}"`,
                    `"${doc.URL}"`,
                    doc.Trending ? 'Yes' : 'No',
                    doc.Recent ? 'Yes' : 'No'
                ].join(',');
                csvContent += row + "\n";
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `revisionvault_documents_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('CSV Exported', 'Documents exported as CSV file', 'success');
        }

        function cleanDuplicateDocuments() {
            const uniqueDocs = [];
            const seen = new Set();
            let duplicatesRemoved = 0;
            
            appState.documents.forEach(doc => {
                const key = `${doc.Title}-${doc["Unit Code"]}-${doc.University}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueDocs.push(doc);
                } else {
                    duplicatesRemoved++;
                }
            });
            
            if (duplicatesRemoved > 0) {
                appState.documents = uniqueDocs;
                saveAppData();
                showNotification('Duplicates Removed', `${duplicatesRemoved} duplicate documents removed`, 'success');
                searchDocumentsAdmin();
                updateStatistics();
            } else {
                showNotification('No Duplicates', 'No duplicate documents found', 'info');
            }
        }

        function updateDocManagementStats() {
            const statsDiv = document.getElementById('docManagementStats');
            if (!statsDiv) return;
            
            const total = appState.documents.length;
            const trending = appState.documents.filter(d => d.Trending).length;
            const recent = appState.documents.filter(d => d.Recent).length;
            const universities = new Set(appState.documents.map(d => d.University)).size;
            
            statsDiv.innerHTML = `
                <div style="background: #dbeafe; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #1e40af;">${total}</div>
                    <div style="font-size: 12px; color: #64748b;">Total Documents</div>
                </div>
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #92400e;">${trending}</div>
                    <div style="font-size: 12px; color: #64748b;">Trending</div>
                </div>
                <div style="background: #d1fae5; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #065f46;">${recent}</div>
                    <div style="font-size: 12px; color: #64748b;">Recent</div>
                </div>
                <div style="background: #f3e8ff; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #7c3aed;">${universities}</div>
                    <div style="font-size: 12px; color: #64748b;">Universities</div>
                </div>
            `;
        }

        // NEW: Statistics Functions
        function loadStatistics() {
            // Calculate statistics
            const totalStudents = appState.users.length;
            const activeStudents = appState.users.filter(u => u.subscription.active).length;
            const pendingStudents = appState.users.filter(u => u.subscription.status === 'pending').length;
            
            const totalDocuments = appState.documents.length;
            const trendingDocuments = appState.documents.filter(d => d.Trending).length;
            const recentDocuments = appState.documents.filter(d => d.Recent).length;
            
            const universities = new Set(appState.documents.map(d => d.University));
            const totalUniversities = universities.size;
            
            // Calculate students per university
            const studentsPerUniversity = {};
            appState.users.forEach(user => {
                if (user.university) {
                    studentsPerUniversity[user.university] = (studentsPerUniversity[user.university] || 0) + 1;
                }
            });
            const universitiesWithStudents = Object.keys(studentsPerUniversity).length;
            
            const totalUploads = appState.userUploads.length;
            const pendingUploads = appState.userUploads.filter(u => u.status === 'pending').length;
            const approvedUploads = appState.userUploads.filter(u => u.status === 'approved').length;
            
            // Update statistics cards
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('activeStudents').textContent = activeStudents;
            document.getElementById('pendingStudents').textContent = pendingStudents;
            
            document.getElementById('totalDocuments').textContent = totalDocuments;
            document.getElementById('trendingDocuments').textContent = trendingDocuments;
            document.getElementById('recentDocuments').textContent = recentDocuments;
            
            document.getElementById('totalUniversities').textContent = totalUniversities;
            document.getElementById('universitiesWithStudents').textContent = universitiesWithStudents;
            
            document.getElementById('totalUploads').textContent = totalUploads;
            document.getElementById('pendingUploads').textContent = pendingUploads;
            document.getElementById('approvedUploads').textContent = approvedUploads;
            
            // Update students per university chart
            updateStudentsPerUniversityChart(studentsPerUniversity);
            
            // Update university statistics list
            updateUniversityStatisticsList(studentsPerUniversity);
        }

        function updateStudentsPerUniversityChart(studentsPerUniversity) {
            const chartDiv = document.getElementById('studentsPerUniversityChart');
            if (!chartDiv) return;
            
            // Sort universities by student count
            const sortedUniversities = Object.entries(studentsPerUniversity)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Top 10 universities
            
            if (sortedUniversities.length === 0) {
                chartDiv.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No student data available</p>';
                return;
            }
            
            const maxStudents = Math.max(...sortedUniversities.map(u => u[1]));
            
            let chartHTML = '';
            sortedUniversities.forEach(([university, count]) => {
                const percentage = (count / maxStudents) * 100;
                const shortName = university.length > 20 ? university.substring(0, 18) + '...' : university;
                
                chartHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 12px; font-weight: 600;">${shortName}</span>
                            <span style="font-size: 12px; color: var(--primary);">${count} students</span>
                        </div>
                        <div class="chart-bar" style="width: ${percentage}%;">
                            <div class="chart-label">${shortName}</div>
                            <div class="chart-value">${count}</div>
                        </div>
                    </div>
                `;
            });
            
            chartDiv.innerHTML = chartHTML;
        }

        function updateUniversityStatisticsList(studentsPerUniversity) {
            const listDiv = document.getElementById('universityStatisticsList');
            if (!listDiv) return;
            
            // Sort universities by student count
            const sortedUniversities = Object.entries(studentsPerUniversity)
                .sort((a, b) => b[1] - a[1]);
            
            if (sortedUniversities.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No university statistics available</p>';
                return;
            }
            
            let listHTML = '';
            sortedUniversities.forEach(([university, count]) => {
                const documentsCount = appState.documents.filter(d => d.University === university).length;
                const initials = university.substring(0, 2).toUpperCase();
                
                listHTML += `
                    <div class="university-stats-item">
                        <div class="university-stats-logo">${initials}</div>
                        <div class="university-stats-info">
                            <div class="university-stats-name">${university}</div>
                            <div class="university-stats-count">
                                <span><i class="fas fa-users"></i> ${count} students</span>
                                <span style="margin-left: 15px;"><i class="fas fa-file-alt"></i> ${documentsCount} documents</span>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary);">
                            ${count}
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = listHTML;
        }

        function exportStatistics() {
            const stats = {
                generated: new Date().toISOString(),
                totalStudents: appState.users.length,
                activeStudents: appState.users.filter(u => u.subscription.active).length,
                pendingStudents: appState.users.filter(u => u.subscription.status === 'pending').length,
                totalDocuments: appState.documents.length,
                trendingDocuments: appState.documents.filter(d => d.Trending).length,
                recentDocuments: appState.documents.filter(d => d.Recent).length,
                totalUniversities: new Set(appState.documents.map(d => d.University)).size,
                totalUploads: appState.userUploads.length,
                pendingUploads: appState.userUploads.filter(u => u.status === 'pending').length,
                approvedUploads: appState.userUploads.filter(u => u.status === 'approved').length,
                studentsPerUniversity: {}
            };
            
            // Calculate students per university
            appState.users.forEach(user => {
                if (user.university) {
                    stats.studentsPerUniversity[user.university] = (stats.studentsPerUniversity[user.university] || 0) + 1;
                }
            });
            
            const statsText = JSON.stringify(stats, null, 2);
            const blob = new Blob([statsText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `revisionvault_statistics_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Statistics Exported', 'Statistics report downloaded as JSON file', 'success');
        }

        // ==================== NEW JSON UPLOAD FUNCTIONS ====================
        function copyJSONTemplate() {
            const template = `[
  {
    "Title": "Plant Breeding notes",
    "Unit Code": "AGRO222",
    "University": "Egerton University",
    "Type": "pdf",
    "Subject": "Agronomy",
    "Year": "2",
    "Description": "lecture notes on plant Breeding",
    "URL": "https://drive.google.com/file/d/.../preview",
    "Trending": false,
    "Recent": true
  },
  {
    "Title": "Another Document",
    "Unit Code": "MATH101",
    "University": "University of Nairobi",
    "Type": "pdf",
    "Subject": "Mathematics",
    "Year": "1",
    "Description": "Basic mathematics notes",
    "URL": "https://drive.google.com/file/d/.../preview",
    "Trending": true,
    "Recent": false
  }
]`;
            
            copyToClipboard(template);
            showNotification('Template Copied', 'JSON template copied to clipboard. Paste in a text editor and edit.', 'success');
        }

        function downloadCurrentDocuments() {
            const documentsJSON = JSON.stringify(appState.documents, null, 2);
            const blob = new Blob([documentsJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `revisionvault_documents_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            
            showNotification('Download Started', 'Current documents downloaded as JSON file.', 'success');
        }

        let selectedJSONFile = null;
        let jsonData = null;

        function handleJSONFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file type
            if (!file.name.endsWith('.json')) {
                showNotification('Invalid File', 'Please select a JSON file (.json)', 'error');
                return;
            }
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('File Too Large', 'JSON file must be less than 10MB', 'error');
                return;
            }
            
            selectedJSONFile = file;
            
            // Show file info
            document.getElementById('jsonFileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = `Size: ${(file.size / 1024).toFixed(2)} KB`;
            
            // Enable upload button
            document.getElementById('uploadJSONBtn').disabled = false;
            
            // Read and parse JSON
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    jsonData = JSON.parse(e.target.result);
                    validateAndPreviewJSON(jsonData);
                } catch (error) {
                    showNotification('Invalid JSON', 'The selected file contains invalid JSON. Please check the format.', 'error');
                    console.error('JSON parse error:', error);
                    clearJSONFile();
                }
            };
            reader.readAsText(file);
        }

        function validateAndPreviewJSON(data) {
            // Check if data is an array
            if (!Array.isArray(data)) {
                showNotification('Invalid Format', 'JSON must contain an array of documents', 'error');
                clearJSONFile();
                return;
            }
            
            // Validate each document
            const validDocuments = [];
            const invalidDocuments = [];
            
            data.forEach((doc, index) => {
                // Check required fields
                const requiredFields = ['Title', 'Unit Code', 'University', 'Subject', 'Year', 'URL'];
                const missingFields = requiredFields.filter(field => !doc[field]);
                
                if (missingFields.length > 0) {
                    invalidDocuments.push({
                        index: index + 1,
                        title: doc.Title || 'Untitled',
                        missingFields: missingFields
                    });
                } else {
                    validDocuments.push({
                        ...doc,
                        Type: doc.Type || 'pdf',
                        Trending: doc.Trending || false,
                        Recent: doc.Recent || false
                    });
                }
            });
            
            // Show preview
            if (validDocuments.length > 0) {
                document.getElementById('jsonPreviewSection').style.display = 'block';
                
                // Show document preview
                const previewHTML = validDocuments.slice(0, 5).map(doc => `
                    <div style="border-bottom: 1px solid #e2e8f0; padding: 10px; margin-bottom: 10px;">
                        <div style="font-weight: bold; color: var(--primary);">${doc.Title}</div>
                        <div style="font-size: 12px; color: #64748b;">
                            ${doc["Unit Code"]} | ${doc.University} | Year ${doc.Year}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('jsonPreview').innerHTML = previewHTML + 
                    (validDocuments.length > 5 ? 
                        `<div style="text-align: center; color: #64748b; padding: 10px;">
                            ... and ${validDocuments.length - 5} more documents
                        </div>` : '');
                
                // Show statistics
                document.getElementById('jsonStats').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
                        <div style="background: #d1fae5; padding: 10px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #065f46;">${validDocuments.length}</div>
                            <div style="font-size: 12px;">Valid Docs</div>
                        </div>
                        <div style="background: ${invalidDocuments.length > 0 ? '#fef3c7' : '#d1fae5'}; padding: 10px; border-radius: 8px;">
                            <div style="font-weight: bold; color: ${invalidDocuments.length > 0 ? '#92400e' : '#065f46'};">${invalidDocuments.length}</div>
                            <div style="font-size: 12px;">Invalid Docs</div>
                        </div>
                        <div style="background: #dbeafe; padding: 10px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #1e40af;">${data.length}</div>
                            <div style="font-size: 12px;">Total in File</div>
                        </div>
                        <div style="background: #f3e8ff; padding: 10px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #7c3aed;">${appState.documents.length}</div>
                            <div style="font-size: 12px;">Current Total</div>
                        </div>
                    </div>
                `;
                
                // Show warning for invalid documents
                if (invalidDocuments.length > 0) {
                    const warningMsg = document.createElement('div');
                    warningMsg.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 15px; margin-top: 15px;';
                    warningMsg.innerHTML = `
                        <div style="color: #92400e; font-weight: bold; margin-bottom: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> ${invalidDocuments.length} invalid document(s) found
                        </div>
                        <div style="font-size: 12px; color: #92400e;">
                            Invalid documents will be skipped. Missing required fields:
                            ${invalidDocuments.slice(0, 3).map(doc => 
                                `<div style="margin-top: 5px;"> ${doc.title}: ${doc.missingFields.join(', ')}</div>`
                            ).join('')}
                        </div>
                    `;
                    document.getElementById('jsonStats').appendChild(warningMsg);
                }
            }
            
            // Store valid documents for upload
            window.validDocumentsForUpload = validDocuments;
        }

        function clearJSONFile() {
            document.getElementById('jsonFileInput').value = '';
            document.getElementById('jsonFileInfo').style.display = 'none';
            document.getElementById('jsonPreviewSection').style.display = 'none';
            document.getElementById('uploadJSONBtn').disabled = true;
            selectedJSONFile = null;
            jsonData = null;
            window.validDocumentsForUpload = null;
            
            // Clear upload status
            const statusDiv = document.getElementById('jsonUploadStatus');
            statusDiv.style.display = 'none';
            statusDiv.innerHTML = '';
        }

        function uploadJSONDocuments() {
            if (!window.validDocumentsForUpload || window.validDocumentsForUpload.length === 0) {
                showNotification('No Valid Documents', 'Please select a valid JSON file with documents', 'error');
                return;
            }
            
            const statusDiv = document.getElementById('jsonUploadStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <div style="text-align: center;">
                    <div class="spinner" style="margin: 10px auto;"></div>
                    <p style="color: #64748b;">Processing ${window.validDocumentsForUpload.length} documents...</p>
                </div>
            `;
            
            // Disable upload button during processing
            document.getElementById('uploadJSONBtn').disabled = true;
            
            // Process documents with delay to show progress
            let processed = 0;
            let duplicates = 0;
            let added = 0;
            const total = window.validDocumentsForUpload.length;
            
            // Function to process next document
            function processNextDocument() {
                if (processed >= total) {
                    // All documents processed
                    completeUpload(added, duplicates, total);
                    return;
                }
                
                const doc = window.validDocumentsForUpload[processed];
                
                // Check for duplicates (by Title and Unit Code)
                const isDuplicate = appState.documents.some(existingDoc => 
                    existingDoc.Title === doc.Title && 
                    existingDoc["Unit Code"] === doc["Unit Code"]
                );
                
                if (!isDuplicate) {
                    // Add document to state
                    appState.documents.push(doc);
                    added++;
                } else {
                    duplicates++;
                }
                
                processed++;
                
                // Update progress
                const progress = Math.round((processed / total) * 100);
                statusDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px;">
                            Processing: ${progress}%
                        </div>
                        <div style="background: #e2e8f0; border-radius: 10px; height: 10px; margin: 0 auto 15px; width: 80%;">
                            <div style="background: linear-gradient(90deg, var(--primary), var(--secondary)); width: ${progress}%; height: 100%; border-radius: 10px; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 12px; color: #64748b;">
                            ${processed}/${total} documents processed  ${added} added  ${duplicates} duplicates skipped
                        </div>
                    </div>
                `;
                
                // Process next document with slight delay to show progress
                setTimeout(processNextDocument, 50);
            }
            
            // Start processing
            setTimeout(processNextDocument, 500);
        }

        function completeUpload(added, duplicates, total) {
            // Save to localStorage
            saveAppData();
            
            // Update statistics
            updateStatistics();
            
            // Update UI components
            initializeCategories();
            initializeUnitCodes();
            
            // Show success message
            const statusDiv = document.getElementById('jsonUploadStatus');
            statusDiv.innerHTML = `
                <div style="background: #d1fae5; border: 2px solid #10b981; border-radius: 10px; padding: 20px; text-align: center;">
                    <div style="font-size: 48px; color: #10b981; margin-bottom: 10px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 style="color: #065f46; margin-bottom: 10px;">Upload Successful!</h3>
                    <p style="color: #047857; margin-bottom: 15px;">
                        Processed ${total} documents from ${selectedJSONFile.name}
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0;">
                        <div style="background: white; padding: 10px; border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: var(--primary);">${added}</div>
                            <div style="font-size: 12px;">New Documents</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: ${duplicates > 0 ? '#f59e0b' : '#10b981'};">${duplicates}</div>
                            <div style="font-size: 12px;">Duplicates</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: #7c3aed;">${appState.documents.length}</div>
                            <div style="font-size: 12px;">Total Now</div>
                        </div>
                    </div>
                    <button class="upload-btn" onclick="showAdminSection('materials')" style="width: auto; padding: 10px 20px; margin-top: 10px;">
                        <i class="fas fa-eye"></i> View All Materials
                    </button>
                </div>
            `;
            
            // Clear file input
            clearJSONFile();
            
            // Show notification
            showNotification('Bulk Upload Complete', `${added} new documents added successfully!`, 'success');
            
            // Force refresh materials display
            if (document.getElementById('allMaterialsGrid')) {
                document.getElementById('allMaterialsGrid').innerHTML = appState.documents.map(doc => createMaterialCard(doc)).join('');
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            loadAppData();
            initializeUniversities();
            initializeCategories();
            initializeUnitCodes();
            renderHomeContent();
            updateAccessStatus();
            updateStatistics();
            checkRegistrationSuccess();
            initializeUploadUniversities();
            
            // Setup search
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function(e) {
                clearTimeout(appState.searchTimeout);
                
                if (e.target.value.length > 0) {
                    showSearchSuggestions(e.target.value);
                } else {
                    hideSearchSuggestions();
                }
                
                appState.searchTimeout = setTimeout(() => {
                    searchByUnitCode(e.target.value);
                }, 300);
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchByUnitCode(this.value);
                }
            });
            
            // Set up drag and drop for JSON upload
            const jsonUploadZone = document.getElementById('jsonUploadZone');
            if (jsonUploadZone) {
                jsonUploadZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });
                
                jsonUploadZone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });
                
                jsonUploadZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.name.endsWith('.json')) {
                            // Simulate file input selection
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            document.getElementById('jsonFileInput').files = dataTransfer.files;
                            
                            // Trigger change event
                            const event = new Event('change', { bubbles: true });
                            document.getElementById('jsonFileInput').dispatchEvent(event);
                        } else {
                            showNotification('Invalid File', 'Please drop a JSON file (.json)', 'error');
                        }
                    }
                });
            }
            
            // Close modals on outside click
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    hideSearchSuggestions();
                }
                if (e.target.classList.contains('university-list-modal')) {
                    closeUniversityListModal();
                }
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target.id);
                }
            });
            
            // Initialize bottom navigation - Updated for 5 buttons
            document.querySelectorAll('.bottom-nav .nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.bottom-nav .nav-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Initialize sample data
            initializeSampleData();
            
            // Show welcome message for new visitors
            if (!localStorage.getItem('hasVisited')) {
                setTimeout(() => {
                    showNotification('Welcome!', 'Browse universities instantly while waiting for approval', 'info');
                    localStorage.setItem('hasVisited', 'true');
                }, 2000);
            }
        });

        function loadAppData() {
            if (localStorage.getItem('users')) {
                appState.users = JSON.parse(localStorage.getItem('users'));
            }
            if (localStorage.getItem('documents')) {
                appState.documents = JSON.parse(localStorage.getItem('documents'));
            }
            if (localStorage.getItem('userUploads')) {
                appState.userUploads = JSON.parse(localStorage.getItem('userUploads'));
            }
            appState.adminWhatsApp = localStorage.getItem('adminWhatsApp') || '254765098865';
            appState.subscriptionPrice = localStorage.getItem('subscriptionPrice') || '67';
            appState.recentlyRegisteredPhone = localStorage.getItem('recentlyRegisteredPhone');
            if (localStorage.getItem('statistics')) {
                appState.statistics = JSON.parse(localStorage.getItem('statistics'));
            }
        }

        function saveAppData() {
            localStorage.setItem('users', JSON.stringify(appState.users));
            localStorage.setItem('documents', JSON.stringify(appState.documents));
            localStorage.setItem('userUploads', JSON.stringify(appState.userUploads));
            localStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
            localStorage.setItem('adminWhatsApp', appState.adminWhatsApp);
            localStorage.setItem('subscriptionPrice', appState.subscriptionPrice);
            localStorage.setItem('recentlyRegisteredPhone', appState.recentlyRegisteredPhone);
            localStorage.setItem('statistics', JSON.stringify(appState.statistics));
        }

        // ==================== SIMPLE FULLSCREEN DOCUMENT VIEWER ====================
        function openDocumentViewer(url, title, unitCode, university, year, subject) {
            // ENHANCED SUBSCRIPTION EXPIRY CHECK
            if (appState.currentUser && appState.currentUser.subscription.active) {
                const endDate = new Date(appState.currentUser.subscription.endDate);
                const now = new Date();
                
                // Check if subscription has expired
                if (endDate < now) {
                    appState.currentUser.subscription.active = false;
                    appState.currentUser.subscription.status = 'expired';
                    saveAppData();
                    updateAccessStatus();
                    
                    showTab('register');
                    showNotification('Subscription Expired', 'Your subscription has expired. Please subscribe again to continue accessing documents.', 'warning');
                    return;
                }
            }
            
            if (!appState.currentUser || !appState.currentUser.subscription.active) {
                showTab('register');
                showNotification('Access Denied', 'Please subscribe to view documents', 'warning');
                return;
            }
            
            // Show loading state
            document.getElementById('pdfLoading').style.display = 'flex';
            document.getElementById('pdfError').style.display = 'none';
            document.getElementById('pdfViewer').style.display = 'none';
            document.getElementById('pdfViewer').classList.remove('active');
            
            // Update modal title (show only document title)
            document.getElementById('pdfModalTitle').innerHTML = `<i class="fas fa-file-pdf"></i><span>${title}</span>`;
            
            // Convert URL to proper embed format if needed
            let embedUrl = url;
            if (url.includes('drive.google.com')) {
                // Check if it's already a preview URL
                if (!url.includes('/preview')) {
                    // Convert to preview URL
                    const match = url.match(/\/d\/([^\/]+)/) || url.match(/id=([^&]+)/);
                    if (match && match[1]) {
                        embedUrl = `https://drive.google.com/file/d/${match[1]}/preview`;
                    }
                }
                // Add minimal parameter to remove buttons
                if (embedUrl.includes('preview')) {
                    embedUrl += (embedUrl.includes('?') ? '&' : '?') + 'rm=minimal';
                }
            }
            
            // Set viewer source
            const viewer = document.getElementById('pdfViewer');
            viewer.src = embedUrl;
            
            // Open modal
            openModal('pdfModal');
            
            // Preload document for faster opening
            setTimeout(() => {
                if (viewer.src) {
                    document.getElementById('pdfLoading').style.display = 'none';
                    document.getElementById('pdfViewer').style.display = 'block';
                    document.getElementById('pdfViewer').classList.add('active');
                }
            }, 500);
            
            viewer.onerror = function() {
                document.getElementById('pdfLoading').style.display = 'none';
                document.getElementById('pdfError').style.display = 'flex';
                showNotification('Error', 'Could not load document. Please try again.', 'error');
            };
            
            // Set timeout for loading
            setTimeout(() => {
                if (document.getElementById('pdfLoading').style.display !== 'none') {
                    document.getElementById('pdfLoading').style.display = 'none';
                    document.getElementById('pdfViewer').style.display = 'block';
                    document.getElementById('pdfViewer').classList.add('active');
                }
            }, 2000);
            
            // Update statistics
            appState.statistics.totalDownloads++;
            saveAppData();
        }

        // ==================== MODAL FUNCTIONS ====================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
            
            // Clear PDF viewer
            const viewer = document.getElementById('pdfViewer');
            viewer.src = 'about:blank';
            
            // Reset loading states
            document.getElementById('pdfLoading').style.display = 'none';
            document.getElementById('pdfError').style.display = 'none';
        }

        // ==================== UTILITY FUNCTIONS ====================
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('Text copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                // Fallback method
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }

        // ==================== REST OF THE FUNCTIONS ====================
        // (All other functions remain exactly the same as in your original code)
        // I'm including the rest of the functions but they are identical to your original code
        // Only the new features functions above are added

        function updateStatistics() {
            appState.statistics.totalMaterials = appState.documents.length;
            
            // Update active subscriptions count - checking expiry
            let activeCount = 0;
            appState.users.forEach(user => {
                if (user.subscription.active && user.subscription.endDate) {
                    const endDate = new Date(user.subscription.endDate);
                    const now = new Date();
                    if (endDate > now) {
                        activeCount++;
                    } else {
                        // Auto-expire subscription
                        user.subscription.active = false;
                        user.subscription.status = 'expired';
                    }
                }
            });
            appState.statistics.activeSubscriptions = activeCount;
            
            appState.statistics.userUploadsPending = appState.userUploads.filter(u => u.status === 'pending').length;
            
            const uniqueUniversities = new Set(appState.documents.map(doc => doc.University));
            appState.statistics.universitiesWithMaterials = uniqueUniversities.size;
            
            // Update students per university statistics
            const studentsPerUniversity = {};
            appState.users.forEach(user => {
                if (user.university) {
                    studentsPerUniversity[user.university] = (studentsPerUniversity[user.university] || 0) + 1;
                }
            });
            appState.statistics.studentsPerUniversity = studentsPerUniversity;
            
            saveAppData();
        }

        function checkRegistrationSuccess() {
            if (appState.recentlyRegisteredPhone) {
                const user = appState.users.find(u => u.phone === appState.recentlyRegisteredPhone);
                if (user && user.subscription.status === 'pending') {
                    showRegistrationSuccessBanner();
                    showProgressSteps();
                }
            }
        }

        function backupRecentUploads() {
            const recentUploads = appState.userUploads.filter(u => {
                const uploadDate = new Date(u.uploadDate);
                const now = new Date();
                const daysDiff = (now - uploadDate) / (1000 * 60 * 60 * 24);
                return daysDiff <= 7; // Last 7 days
            });
            
            if (recentUploads.length === 0) {
                showBackupStatus('No recent uploads found in the last 7 days.', 'warning');
                return;
            }
            
            let backupText = `=== REVISIONVAULT PRO - RECENT UPLOADS BACKUP ===\n`;
            backupText += `Backup Date: ${new Date().toLocaleString()}\n`;
            backupText += `Total Recent Uploads: ${recentUploads.length}\n\n`;
            
            recentUploads.forEach((upload, index) => {
                backupText += `=== UPLOAD ${index + 1} ===\n`;
                backupText += `Title: ${upload.title}\n`;
                backupText += `Unit Code: ${upload.unitCode}\n`;
                backupText += `University: ${upload.university}\n`;
                backupText += `Subject: ${upload.subject}\n`;
                backupText += `Year: ${upload.year}\n`;
                backupText += `Description: ${upload.description}\n`;
                backupText += `URL: ${upload.url}\n`;
                backupText += `Uploader Phone: ${upload.uploaderPhone}\n`;
                backupText += `Upload Date: ${upload.uploadDate}\n`;
                backupText += `Status: ${upload.status}\n\n`;
            });
            
            copyToClipboard(backupText);
            showBackupStatus(`Copied ${recentUploads.length} recent uploads to clipboard!`, 'success');
            
            // Update backup date
            appState.statistics.lastBackupDate = new Date().toISOString();
            saveAppData();
        }

        function backupAllDocuments() {
            let backupText = `=== REVISIONVAULT PRO - ALL DOCUMENTS BACKUP ===\n`;
            backupText += `Backup Date: ${new Date().toLocaleString()}\n`;
            backupText += `Total Documents: ${appState.documents.length}\n`;
            backupText += `Total Users: ${appState.users.length}\n`;
            backupText += `Total Uploads Pending: ${appState.userUploads.filter(u => u.status === 'pending').length}\n\n`;
            
            backupText += `=== ALL STUDY MATERIALS ===\n`;
            appState.documents.forEach((doc, index) => {
                backupText += `=== DOCUMENT ${index + 1} ===\n`;
                backupText += `Title: ${doc.Title}\n`;
                backupText += `Unit Code: ${doc["Unit Code"]}\n`;
                backupText += `University: ${doc.University}\n`;
                backupText += `Subject: ${doc.Subject}\n`;
                backupText += `Year: ${doc.Year}\n`;
                backupText += `Description: ${doc.Description}\n`;
                backupText += `URL: ${doc.URL}\n`;
                backupText += `Type: ${doc.Type}\n`;
                backupText += `Trending: ${doc.Trending || false}\n`;
                backupText += `Recent: ${doc.Recent || false}\n\n`;
            });
            
            backupText += `=== USER UPLOADS ===\n`;
            appState.userUploads.forEach((upload, index) => {
                backupText += `=== UPLOAD ${index + 1} ===\n`;
                backupText += `Title: ${upload.title}\n`;
                backupText += `Unit Code: ${upload.unitCode}\n`;
                backupText += `University: ${upload.university}\n`;
                backupText += `Subject: ${upload.subject}\n`;
                backupText += `Year: ${upload.year}\n`;
                backupText += `Description: ${upload.description}\n`;
                backupText += `URL: ${upload.url}\n`;
                backupText += `Uploader Phone: ${upload.uploaderPhone}\n`;
                backupText += `Upload Date: ${upload.uploadDate}\n`;
                backupText += `Status: ${upload.status}\n\n`;
            });
            
            copyToClipboard(backupText);
            showBackupStatus(`Copied ${appState.documents.length} documents and ${appState.userUploads.length} uploads to clipboard!`, 'success');
            
            // Update backup date
            appState.statistics.lastBackupDate = new Date().toISOString();
            saveAppData();
        }

        function showBackupStatus(message, type) {
            const backupStatus = document.getElementById('backupStatus');
            backupStatus.style.display = 'block';
            
            switch(type) {
                case 'success':
                    backupStatus.style.backgroundColor = '#d1fae5';
                    backupStatus.style.color = '#065f46';
                    backupStatus.style.border = '2px solid #10b981';
                    break;
                case 'warning':
                    backupStatus.style.backgroundColor = '#fef3c7';
                    backupStatus.style.color = '#92400e';
                    backupStatus.style.border = '2px solid #f59e0b';
                    break;
                case 'error':
                    backupStatus.style.backgroundColor = '#fee2e2';
                    backupStatus.style.color = '#991b1b';
                    backupStatus.style.border = '2px solid #ef4444';
                    break;
            }
            
            backupStatus.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    ${type === 'success' ? '<i class="fas fa-check-circle" style="color: #10b981;"></i>' : ''}
                    ${type === 'warning' ? '<i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>' : ''}
                    ${type === 'error' ? '<i class="fas fa-times-circle" style="color: #ef4444;"></i>' : ''}
                    <span>${message}</span>
                </div>
            `;
            
            setTimeout(() => {
                backupStatus.style.display = 'none';
            }, 5000);
        }

        // ==================== UNIVERSITY FUNCTIONS ====================
        function initializeUniversities() {
            // Populate all university selects
            const universitySelects = [
                document.getElementById('universityFilter'),
                document.getElementById('allUniversityFilter'),
                document.getElementById('studentUniversity')
            ];
            
            universitySelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Select University</option>' +
                        UNIVERSITIES.map(uni => `<option value="${uni}">${uni}</option>`).join('');
                }
            });
            
            // Populate university grid in sidebar
            const grid = document.getElementById('universityGrid');
            if (grid) {
                const universitiesWithCounts = UNIVERSITIES.map(uni => {
                    const count = appState.documents.filter(doc => doc.University === uni).length;
                    return { name: uni, count };
                }).filter(uni => uni.count > 0);
                
                grid.innerHTML = universitiesWithCounts.slice(0, 6).map(uni => `
                    <div class="university-card" onclick="showUniversityMaterials('${uni.name}')">
                        <div class="university-logo">${uni.name.substring(0, 2).toUpperCase()}</div>
                        <div class="university-name">${uni.name.length > 20 ? uni.name.substring(0, 18) + '...' : uni.name}</div>
                        <div style="font-size: 10px; color: #64748b; margin-top: 5px;">${uni.count} materials</div>
                    </div>
                `).join('');
            }
        }

        function initializeUploadUniversities() {
            const uploadSelect = document.getElementById('uploadUniversity');
            if (uploadSelect) {
                uploadSelect.innerHTML = '<option value="">Select University</option>' +
                    UNIVERSITIES.map(uni => `<option value="${uni}">${uni}</option>`).join('');
            }
        }

        function openUniversityListModal() {
            document.getElementById('universityListModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            populateUniversityList();
        }

        function closeUniversityListModal() {
            document.getElementById('universityListModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function populateUniversityList() {
            const universityListGrid = document.getElementById('universityListGrid');
            
            const universityCounts = {};
            appState.documents.forEach(doc => {
                if (doc.University) {
                    universityCounts[doc.University] = (universityCounts[doc.University] || 0) + 1;
                }
            });
            
            const sortedUniversities = Object.entries(universityCounts)
                .sort((a, b) => b[1] - a[1]);
            
            let universitiesHTML = '';
            
            sortedUniversities.forEach(([uni, count]) => {
                const initials = uni.substring(0, 2).toUpperCase();
                
                universitiesHTML += `
                    <div class="university-list-card" onclick="showUniversityMaterials('${uni}')">
                        <div class="university-list-logo">${initials}</div>
                        <div class="university-list-name">${uni}</div>
                        <div class="university-list-count">${count} materials</div>
                        <button class="quick-action-btn" onclick="showUniversityMaterials('${uni}'); event.stopPropagation();" style="margin-top: 10px; padding: 8px; font-size: 12px;">
                            <i class="fas fa-eye"></i> View Materials
                        </button>
                    </div>
                `;
            });
            
            universityListGrid.innerHTML = universitiesHTML;
        }

        function showUniversityMaterials(university) {
            closeUniversityListModal();
            showTab('materials');
            document.getElementById('allUniversityFilter').value = university;
            filterAllMaterials();
            
            showNotification('University Selected', `Showing materials from ${university}`, 'success');
        }

        // ==================== UPLOAD FUNCTIONALITY ====================
        function uploadMaterial() {
            const title = document.getElementById('uploadTitle').value.trim();
            const unitCode = document.getElementById('uploadUnitCode').value.trim();
            const university = document.getElementById('uploadUniversity').value;
            const subject = document.getElementById('uploadSubject').value.trim();
            const year = document.getElementById('uploadYear').value;
            const description = document.getElementById('uploadDescription').value.trim();
            const url = document.getElementById('uploadURL').value.trim();
            const phone = document.getElementById('uploaderPhone').value.trim();
            
            // Validation
            if (!title || !unitCode || !university || !subject || !year || !description || !url || !phone) {
                showNotification('Error', 'Please fill in all fields', 'error');
                return;
            }
            
            if (phone.length !== 10 || !phone.startsWith('07')) {
                showNotification('Error', 'Please enter a valid Kenyan phone number (07XXXXXXXX)', 'error');
                return;
            }
            
            if (!url.includes('/preview')) {
                showNotification('Error', 'URL must be a direct preview link ending with /preview', 'error');
                return;
            }
            
            // Create upload record
            const upload = {
                id: Date.now(),
                title: title,
                unitCode: unitCode,
                university: university,
                subject: subject,
                year: year,
                description: description,
                url: url,
                uploaderPhone: phone,
                uploadDate: new Date().toISOString(),
                status: 'pending',
                reviewedBy: null,
                reviewDate: null
            };
            
            // Add to user uploads
            appState.userUploads.push(upload);
            saveAppData();
            updateStatistics();
            
            // Show success message
            document.getElementById('uploadForm').style.display = 'none';
            document.getElementById('uploadSuccess').style.display = 'block';
            
            // Send WhatsApp notification to admin
            sendUploadNotification(upload);
            
            showNotification('Upload Submitted', 'Your material has been submitted for review', 'success');
            
            // Clear form
            clearUploadForm();
        }

        function sendUploadNotification(upload) {
            const adminNumber = appState.adminWhatsApp.replace(/^0/, '254').replace(/^\+/, '');
            const message = ` NEW MATERIAL UPLOAD - RevisionVault Pro
            
 Title: ${upload.title}
 Unit Code: ${upload.unitCode}
 University: ${upload.university}
 Subject: ${upload.subject}
 Year: ${upload.year}
 Uploader: ${upload.uploaderPhone}
 Date: ${new Date(upload.uploadDate).toLocaleString()}
 URL: ${upload.url}

Please review this upload in the admin panel.`;

            const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
        }

        function clearUploadForm() {
            document.getElementById('uploadTitle').value = '';
            document.getElementById('uploadUnitCode').value = '';
            document.getElementById('uploadUniversity').value = '';
            document.getElementById('uploadSubject').value = '';
            document.getElementById('uploadYear').value = '';
            document.getElementById('uploadDescription').value = '';
            document.getElementById('uploadURL').value = '';
            document.getElementById('uploaderPhone').value = '';
        }

        // ==================== REGISTRATION ====================
        function registerStudent() {
            const name = document.getElementById('studentName').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            const university = document.getElementById('studentUniversity').value;
            const course = document.getElementById('studentCourse').value.trim();
            const year = document.getElementById('studentYear').value;
            const paymentCode = document.getElementById('paymentCode').value.trim();
            
            // Validation
            if (!name || !phone || !university || !course || !year || !paymentCode) {
                showNotification('Error', 'Please fill in all fields', 'error');
                highlightEmptyFields();
                return;
            }
            
            if (phone.length !== 10 || !phone.startsWith('07')) {
                showNotification('Error', 'Please enter a valid Kenyan phone number (07XXXXXXXX)', 'error');
                document.getElementById('studentPhone').style.borderColor = 'var(--danger)';
                return;
            }
            
            if (paymentCode.length < 8) {
                showNotification('Error', 'Please enter a valid M-Pesa transaction code', 'error');
                document.getElementById('paymentCode').style.borderColor = 'var(--danger)';
                return;
            }
            
            // Check if user already exists
            const existingUser = appState.users.find(u => u.phone === phone);
            if (existingUser) {
                showNotification('Info', 'This phone number is already registered', 'info');
                document.getElementById('studentPhone').value = phone;
                showTab('login');
                return;
            }
            
            // Create new user
            const newUser = {
                id: Date.now(),
                name: name,
                phone: phone,
                university: university,
                course: course,
                year: year,
                registrationDate: new Date().toISOString(),
                subscription: {
                    active: false,
                    paymentCode: paymentCode,
                    unlockCode: '',
                    status: 'pending',
                    startDate: null,
                    endDate: null,
                    approvedDate: null
                },
                activity: {
                    lastLogin: null,
                    materialsViewed: [],
                    universitiesBrowsed: []
                }
            };
            
            // Add to users array
            appState.users.push(newUser);
            saveAppData();
            
            // Store the phone for success banner
            appState.recentlyRegisteredPhone = phone;
            localStorage.setItem('recentlyRegisteredPhone', phone);
            
            // Show success banner
            showRegistrationSuccessBanner();
            showProgressSteps();
            
            // Send WhatsApp notification to admin
            sendWhatsAppNotification(newUser);
            
            showNotification('Registration Successful!', 'Admin will send you an unlock code via WhatsApp. Browse universities now!', 'success');
            
            // Clear form
            clearRegistrationForm();
            
            // Update statistics
            updateStatistics();
        }

        function highlightEmptyFields() {
            const fields = ['studentName', 'studentPhone', 'studentUniversity', 'studentCourse', 'studentYear', 'paymentCode'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.style.borderColor = 'var(--danger)';
                    field.style.backgroundColor = '#fee2e2';
                }
            });
            
            setTimeout(() => {
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    field.style.borderColor = '#e2e8f0';
                    field.style.backgroundColor = 'white';
                });
            }, 3000);
        }

        function clearRegistrationForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentUniversity').value = '';
            document.getElementById('studentCourse').value = '';
            document.getElementById('studentYear').value = '';
            document.getElementById('paymentCode').value = '';
        }

        function showRegistrationSuccessBanner() {
            const banner = document.getElementById('registrationSuccessBanner');
            banner.classList.add('active');
            
            setTimeout(() => {
                banner.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
        }

        function showProgressSteps() {
            const steps = document.getElementById('progressSteps');
            steps.style.display = 'flex';
            
            const stepCircles = steps.querySelectorAll('.step-circle');
            stepCircles.forEach((circle, index) => {
                setTimeout(() => {
                    circle.classList.add('active');
                }, index * 500);
            });
        }

        // ==================== LOGIN FUNCTION ====================
        function loginStudent() {
            const phone = document.getElementById('loginPhone').value.trim();
            const unlockCode = document.getElementById('unlockCode').value.trim();
            
            if (!phone) {
                showLoginMessage('Please enter your phone number', 'error');
                return;
            }
            
            const user = appState.users.find(u => u.phone === phone);
            
            if (!user) {
                showLoginMessage('Phone number not found. Please register first.', 'error');
                return;
            }
            
            // Update user activity
            user.activity.lastLogin = new Date().toISOString();
            
            // ENHANCED SUBSCRIPTION EXPIRY CHECK
            if (user.subscription.active) {
                const endDate = new Date(user.subscription.endDate);
                const now = new Date();
                
                if (endDate < now) {
                    user.subscription.active = false;
                    user.subscription.status = 'expired';
                    saveAppData();
                    showLoginMessage('Your subscription has expired. Please subscribe again.', 'warning');
                    return;
                }
                
                // Login successful
                appState.currentUser = user;
                saveAppData();
                updateAccessStatus();
                
                showLoginMessage('Login successful! Welcome back.', 'success');
                
                setTimeout(() => {
                    showTab('home');
                    openUniversityListModal();
                    showNotification('Welcome Back', `Welcome back, ${user.name}!`, 'success');
                }, 1000);
                return;
            }
            
            // If pending, show universities button option
            if (user.subscription.status === 'pending') {
                showLoginMessage('Your account is pending approval. Browse universities while waiting.', 'info');
                openUniversityListModal();
                return;
            }
            
            // If approved but not active, check unlock code
            if (user.subscription.status === 'approved' && !user.subscription.active) {
                if (!unlockCode) {
                    showLoginMessage('Enter unlock code to activate. Check your WhatsApp.', 'warning');
                    return;
                }
                
                if (user.subscription.unlockCode !== unlockCode) {
                    showLoginMessage('Invalid unlock code. Please check and try again.', 'error');
                    return;
                }
                
                // Activate account
                const now = new Date();
                user.subscription.active = true;
                user.subscription.startDate = now.toISOString();
                user.subscription.endDate = new Date(now.getTime() + 5 * 30 * 24 * 60 * 60 * 1000).toISOString();
                
                appState.currentUser = user;
                saveAppData();
                updateAccessStatus();
                updateStatistics();
                
                // Clear recently registered phone
                appState.recentlyRegisteredPhone = null;
                localStorage.removeItem('recentlyRegisteredPhone');
                
                showLoginMessage('Account activated! Full access granted.', 'success');
                
                setTimeout(() => {
                    showTab('home');
                    openUniversityListModal();
                    showNotification('Welcome!', `Welcome to RevisionVault Pro, ${user.name}!`, 'success');
                }, 1000);
                return;
            }
            
            // For other cases
            showLoginMessage('Unable to login. Please contact admin.', 'error');
        }

        // ==================== UI FUNCTIONS ====================
        function updateAccessStatus() {
            const accessStatus = document.getElementById('accessStatus');
            const registrationBanner = document.getElementById('registrationSuccessBanner');
            
            if (!accessStatus) return;
            
            if (appState.currentUser) {
                registrationBanner.style.display = 'none';
            }
            
            if (appState.currentUser && appState.currentUser.subscription.active) {
                const endDate = new Date(appState.currentUser.subscription.endDate);
                const daysLeft = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
                
                accessStatus.innerHTML = `
                    <div class="access-text">
                        <h3><i class="fas fa-unlock"></i> Access Granted</h3>
                        <p>Welcome, ${appState.currentUser.name}! Subscription valid for ${daysLeft} more days</p>
                    </div>
                    <button class="view-btn" onclick="logout()" style="width: auto; padding: 10px 20px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                `;
                accessStatus.classList.remove('access-status');
                accessStatus.classList.add('access-status', 'access-granted');
            } else {
                accessStatus.innerHTML = `
                    <div class="access-text">
                        <h3><i class="fas fa-lock"></i> Access Locked</h3>
                        <p>Subscribe to unlock all study materials and features</p>
                    </div>
                    <button class="view-btn" onclick="showTab('register')" style="width: auto; padding: 10px 20px;">
                        <i class="fas fa-crown"></i> Subscribe Now
                    </button>
                `;
                accessStatus.classList.remove('access-granted');
                accessStatus.classList.add('access-status');
            }
        }

        function showLoginMessage(message, type) {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    ${type === 'success' ? '<i class="fas fa-check-circle" style="color: #10b981;"></i>' : ''}
                    ${type === 'error' ? '<i class="fas fa-times-circle" style="color: #ef4444;"></i>' : ''}
                    ${type === 'warning' ? '<i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>' : ''}
                    ${type === 'info' ? '<i class="fas fa-info-circle" style="color: #3b82f6;"></i>' : ''}
                    <span>${message}</span>
                </div>
            `;
            messageDiv.style.display = 'block';
            
            switch(type) {
                case 'success':
                    messageDiv.style.backgroundColor = '#d1fae5';
                    messageDiv.style.color = '#065f46';
                    messageDiv.style.border = '2px solid #10b981';
                    break;
                case 'error':
                    messageDiv.style.backgroundColor = '#fee2e2';
                    messageDiv.style.color = '#991b1b';
                    messageDiv.style.border = '2px solid #ef4444';
                    break;
                case 'warning':
                    messageDiv.style.backgroundColor = '#fef3c7';
                    messageDiv.style.color = '#92400e';
                    messageDiv.style.border = '2px solid #f59e0b';
                    break;
                case 'info':
                    messageDiv.style.backgroundColor = '#dbeafe';
                    messageDiv.style.color = '#1e40af';
                    messageDiv.style.border = '2px solid #3b82f6';
                    break;
            }
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // ==================== MATERIAL CARD ====================
        function createMaterialCard(doc) {
            const hasAccess = appState.currentUser && appState.currentUser.subscription && 
                             appState.currentUser.subscription.active;
            
            const badges = [];
            if (doc.Trending) badges.push('<div class="material-badge trending">TRENDING</div>');
            if (doc.Recent) badges.push('<div class="material-badge recent">RECENT</div>');
            
            // Show material type
            const typeBadge = doc.Type ? 
                `<div class="material-type">${doc.Type.toUpperCase()}</div>` : 
                '<div class="material-type">PDF</div>';
            
            return `
                <div class="material-card">
                    ${badges.join('')}
                    ${typeBadge}
                    
                    <div class="material-image">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    
                    <div class="material-content">
                        <h3 class="material-title">${doc.Title}</h3>
                        
                        <div class="material-meta">
                            <span class="material-code">${doc["Unit Code"]}</span>
                            <span class="material-year">Year ${doc.Year}</span>
                        </div>
                        
                        <div class="material-info">
                            <i class="fas fa-university"></i>
                            <span>${doc.University}</span>
                            <span style="margin-left: auto; font-size: 11px;">
                                <i class="fas fa-book"></i> ${doc.Subject}
                            </span>
                        </div>
                        
                        <p class="material-description">${doc.Description}</p>
                        
                        <div class="material-actions">
                            ${hasAccess ? 
                                `<button class="action-btn view-btn" onclick="openDocumentViewer('${doc.URL}', '${doc.Title}', '${doc["Unit Code"]}', '${doc.University}', '${doc.Year}', '${doc.Subject}')">
                                    <i class="fas fa-eye"></i> View Document
                                </button>` :
                                `<button class="action-btn view-btn" onclick="showTab('register')">
                                    <i class="fas fa-lock"></i> Subscribe to View
                                </button>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== ADMIN FUNCTIONS ====================
        function showAdminSection(sectionName) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });
            
            document.getElementById(`${sectionName}Section`).style.display = 'block';
            
            // Load data for the section
            switch(sectionName) {
                case 'pending':
                    loadPendingApprovals();
                    break;
                case 'students':
                    loadAllStudents();
                    break;
                case 'materials':
                    loadAdminMaterials();
                    break;
                case 'uploads':
                    loadUserUploads();
                    break;
                case 'documentManagement':
                    // Initialize document management section
                    document.getElementById('docSearchInput').value = '';
                    searchDocumentsAdmin();
                    break;
                case 'statistics':
                    // Load statistics
                    loadStatistics();
                    break;
                case 'backup':
                    // Show backup info
                    const backupStatus = document.getElementById('backupStatus');
                    if (appState.statistics.lastBackupDate) {
                        const lastBackup = new Date(appState.statistics.lastBackupDate);
                        backupStatus.innerHTML = `
                            <div style="color: #065f46;">
                                <i class="fas fa-check-circle"></i> Last backup: ${lastBackup.toLocaleString()}
                            </div>
                        `;
                        backupStatus.style.display = 'block';
                    }
                    break;
                case 'jsonUpload':
                    // Clear any previous file selection
                    clearJSONFile();
                    break;
            }
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            
            // ADMIN PASSWORD IS SECRET - walter.zauko23
            if (password === appState.adminPassword) {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                showNotification('Admin Access', 'Welcome to Admin Panel', 'success');
                
                // Load pending approvals
                loadPendingApprovals();
                loadUserUploads();
            } else {
                showNotification('Error', 'Invalid admin password', 'error');
            }
        }

        function adminLogout() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });
            showNotification('Logged Out', 'Admin logged out successfully', 'success');
        }

        function loadPendingApprovals() {
            const pendingList = document.getElementById('pendingList');
            const pendingUsers = appState.users.filter(u => u.subscription.status === 'pending');
            
            if (pendingUsers.length === 0) {
                pendingList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No pending approvals</p>';
                return;
            }
            
            pendingList.innerHTML = pendingUsers.map(user => `
                <div style="border: 2px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong>${user.name}</strong>
                                <span class="status-badge status-pending">PENDING</span>
                            </div>
                            <div style="font-size: 12px; color: #64748b;">
                                ${new Date(user.registrationDate).toLocaleDateString()}
                            </div>
                        </div>
                        
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
                            <div> ${user.phone}</div>
                            <div> ${user.university}</div>
                            <div> ${user.course} (Year ${user.year})</div>
                            <div style="color: #f59e0b; margin-top: 5px;">
                                 Payment Code: ${user.subscription.paymentCode}
                            </div>
                        </div>
                        
                        <div class="admin-approval-buttons">
                            <button class="approve-btn" onclick="approveStudent('${user.phone}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="reject-btn" onclick="rejectStudent('${user.phone}')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadUserUploads() {
            const uploadsList = document.getElementById('userUploadsList');
            const pendingUploads = appState.userUploads.filter(u => u.status === 'pending');
            
            if (pendingUploads.length === 0) {
                uploadsList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No pending uploads</p>';
                return;
            }
            
            uploadsList.innerHTML = pendingUploads.map(upload => `
                <div style="border: 2px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong>${upload.title}</strong>
                                <span class="status-badge status-pending">PENDING</span>
                            </div>
                            <div style="font-size: 12px; color: #64748b;">
                                ${new Date(upload.uploadDate).toLocaleDateString()}
                            </div>
                        </div>
                        
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
                            <div> ${upload.unitCode} |  ${upload.university}</div>
                            <div> ${upload.subject} |  Year ${upload.year}</div>
                            <div> Uploader: ${upload.uploaderPhone}</div>
                            <div style="margin-top: 5px;">
                                <strong>Description:</strong> ${upload.description}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <a href="${upload.url}" target="_blank" style="color: #3b82f6; font-size: 12px; word-break: break-all;">
                                <i class="fas fa-link"></i> View Document
                            </a>
                        </div>
                        
                        <div class="admin-approval-buttons">
                            <button class="approve-btn" onclick="approveUpload(${upload.id})">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="reject-btn" onclick="rejectUpload(${upload.id})">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            <button class="send-whatsapp-btn" onclick="notifyUploader('${upload.uploaderPhone}', '${upload.title}', 'approved')">
                                <i class="fab fa-whatsapp"></i> Notify
                            </button>
                            <button class="backup-btn" onclick="backupSingleUpload(${upload.id})">
                                <i class="fas fa-copy"></i> Copy Details
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function backupSingleUpload(uploadId) {
            const upload = appState.userUploads.find(u => u.id === uploadId);
            if (!upload) return;
            
            let backupText = `=== UPLOAD DETAILS ===\n`;
            backupText += `Title: ${upload.title}\n`;
            backupText += `Unit Code: ${upload.unitCode}\n`;
            backupText += `University: ${upload.university}\n`;
            backupText += `Subject: ${upload.subject}\n`;
            backupText += `Year: ${upload.year}\n`;
            backupText += `Description: ${upload.description}\n`;
            backupText += `URL: ${upload.url}\n`;
            backupText += `Uploader Phone: ${upload.uploaderPhone}\n`;
            backupText += `Upload Date: ${upload.uploadDate}\n`;
            backupText += `Status: ${upload.status}\n`;
            
            copyToClipboard(backupText);
            showNotification('Copied', 'Upload details copied to clipboard', 'success');
        }

        function approveUpload(uploadId) {
            const upload = appState.userUploads.find(u => u.id === uploadId);
            if (upload) {
                // Add to main documents
                const newDoc = {
                    "Title": upload.title,
                    "Unit Code": upload.unitCode,
                    "University": upload.university,
                    "Type": "pdf",
                    "Subject": upload.subject,
                    "Year": upload.year,
                    "Description": upload.description,
                    "URL": upload.url,
                    "Trending": false,
                    "Recent": true
                };
                
                appState.documents.push(newDoc);
                upload.status = 'approved';
                upload.reviewedBy = 'admin';
                upload.reviewDate = new Date().toISOString();
                
                saveAppData();
                updateStatistics();
                
                // Notify uploader
                notifyUploader(upload.uploaderPhone, upload.title, 'approved');
                
                showNotification('Upload Approved', 'Material added to library', 'success');
                loadUserUploads();
            }
        }

        function rejectUpload(uploadId) {
            if (confirm('Are you sure you want to reject this upload?')) {
                const upload = appState.userUploads.find(u => u.id === uploadId);
                if (upload) {
                    upload.status = 'rejected';
                    upload.reviewedBy = 'admin';
                    upload.reviewDate = new Date().toISOString();
                    
                    saveAppData();
                    updateStatistics();
                    
                    // Notify uploader
                    notifyUploader(upload.uploaderPhone, upload.title, 'rejected');
                    
                    showNotification('Upload Rejected', 'Material rejected', 'success');
                    loadUserUploads();
                }
            }
        }

        function notifyUploader(phone, title, status) {
            const message = status === 'approved' ?
                ` MATERIAL APPROVED - RevisionVault Pro\n\nYour upload "${title}" has been approved and added to the library!` :
                ` MATERIAL REJECTED - RevisionVault Pro\n\nYour upload "${title}" has been rejected. Please check the requirements and try again.`;
            
            const whatsappUrl = `https://wa.me/254${phone.substring(1)}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            showNotification('WhatsApp Sent', `Notification sent to ${phone}`, 'success');
        }

        function loadAllStudents() {
            const studentList = document.getElementById('studentList');
            
            if (appState.users.length === 0) {
                studentList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No registered students</p>';
                return;
            }
            
            const sortedUsers = [...appState.users].sort((a, b) => 
                new Date(b.registrationDate) - new Date(a.registrationDate)
            );
            
            studentList.innerHTML = sortedUsers.map(user => {
                let statusBadge = '';
                let statusText = '';
                
                if (user.subscription.active) {
                    statusBadge = 'status-active';
                    statusText = 'ACTIVE';
                } else if (user.subscription.status === 'approved') {
                    statusBadge = 'status-approved';
                    statusText = 'APPROVED';
                } else if (user.subscription.status === 'pending') {
                    statusBadge = 'status-pending';
                    statusText = 'PENDING';
                } else if (user.subscription.status === 'rejected') {
                    statusBadge = 'status-expired';
                    statusText = 'REJECTED';
                } else if (user.subscription.status === 'expired') {
                    statusBadge = 'status-expired';
                    statusText = 'EXPIRED';
                }
                
                let daysLeft = '';
                if (user.subscription.active && user.subscription.endDate) {
                    const endDate = new Date(user.subscription.endDate);
                    const now = new Date();
                    const days = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                    if (days > 0) {
                        daysLeft = `(${days} days left)`;
                    } else {
                        daysLeft = '(Expired)';
                    }
                }
                
                return `
                    <div style="border: 2px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong>${user.name}</strong>
                                <span class="status-badge ${statusBadge}">${statusText}</span>
                                ${daysLeft ? `<span style="font-size: 12px; color: #64748b;">${daysLeft}</span>` : ''}
                            </div>
                            <button onclick="deleteStudent('${user.phone}')" class="reject-btn" style="padding: 6px 12px; font-size: 12px;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                        
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
                            <div> ${user.phone}</div>
                            <div> ${user.university} |  ${user.course} (Year ${user.year})</div>
                            <div style="margin-top: 5px;">
                                ${user.subscription.unlockCode ? 
                                    `<strong>Unlock Code:</strong> ${user.subscription.unlockCode}` : 
                                    'No unlock code generated'
                                }
                            </div>
                            ${user.subscription.approvedDate ? 
                                `<div><strong>Approved:</strong> ${new Date(user.subscription.approvedDate).toLocaleDateString()}</div>` : 
                                ''
                            }
                            ${user.subscription.endDate ? 
                                `<div><strong>Expires:</strong> ${new Date(user.subscription.endDate).toLocaleDateString()}</div>` : 
                                ''
                            }
                        </div>
                        
                        ${user.subscription.status === 'approved' && !user.subscription.active ? 
                            `<button class="send-whatsapp-btn" onclick="sendUnlockCodeWhatsApp('${user.phone}')">
                                <i class="fab fa-whatsapp"></i> Resend Unlock Code
                            </button>` : 
                            ''
                        }
                    </div>
                `;
            }).join('');
        }

        function approveStudent(phone) {
            const user = appState.users.find(u => u.phone === phone);
            if (user) {
                const unlockCode = generateUnlockCode();
                user.subscription.unlockCode = unlockCode;
                user.subscription.status = 'approved';
                user.subscription.approvedDate = new Date().toISOString();
                saveAppData();
                
                sendUnlockCodeWhatsApp(phone);
                
                showNotification('Approved', `Unlock code sent to ${phone}`, 'success');
                loadPendingApprovals();
                updateStatistics();
            }
        }

        function rejectStudent(phone) {
            if (confirm('Are you sure you want to reject this student?')) {
                const user = appState.users.find(u => u.phone === phone);
                if (user) {
                    user.subscription.status = 'rejected';
                    saveAppData();
                    
                    showNotification('Rejected', 'Student registration rejected', 'success');
                    loadPendingApprovals();
                }
            }
        }

        function sendUnlockCodeWhatsApp(phone) {
            const user = appState.users.find(u => u.phone === phone);
            if (!user || !user.subscription.unlockCode) {
                showNotification('Error', 'No unlock code found for this user', 'error');
                return;
            }
            
            const whatsappUrl = `https://wa.me/254${phone.substring(1)}?text=${encodeURIComponent(
                ` UNLOCK CODE - RevisionVault Pro\n\nYour account has been approved!\n\n Unlock Code: ${user.subscription.unlockCode}\n\n Login Steps:\n1. Go to RevisionVault Pro\n2. Click Login tab\n3. Enter your phone: ${phone}\n4. Enter unlock code: ${user.subscription.unlockCode}\n5. Click Login\n\n Welcome to RevisionVault Pro!`
            )}`;
            window.open(whatsappUrl, '_blank');
            
            showNotification('WhatsApp Sent', `Unlock code sent to ${phone}`, 'success');
        }

        function deleteStudent(phone) {
            if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                appState.users = appState.users.filter(u => u.phone !== phone);
                saveAppData();
                showNotification('Deleted', 'Student deleted successfully', 'success');
                loadAllStudents();
                updateStatistics();
            }
        }

        function loadAdminMaterials() {
            const materialsList = document.getElementById('adminMaterialsList');
            
            if (appState.documents.length === 0) {
                materialsList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No materials available</p>';
                return;
            }
            
            const sortedDocuments = [...appState.documents].sort((a, b) => {
                if (a.University !== b.University) {
                    return a.University.localeCompare(b.University);
                }
                return (a["Unit Code"] || "").localeCompare(b["Unit Code"] || "");
            });
            
            materialsList.innerHTML = sortedDocuments.map((doc, index) => `
                <div style="border: 2px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${doc.Title}</strong>
                            <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                                 ${doc["Unit Code"]} |  ${doc.University} |  Year ${doc.Year}
                            </div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                ${doc.Description}
                            </div>
                            <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                                <i class="fas fa-link"></i> ${doc.URL.substring(0, 50)}...
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px; margin-left: 10px;">
                            <button onclick="backupSingleDocument(${index})" class="backup-btn">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button onclick="deleteMaterial(${index})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function backupSingleDocument(index) {
            const doc = appState.documents[index];
            if (!doc) return;
            
            let backupText = `=== DOCUMENT DETAILS ===\n`;
            backupText += `Title: ${doc.Title}\n`;
            backupText += `Unit Code: ${doc["Unit Code"]}\n`;
            backupText += `University: ${doc.University}\n`;
            backupText += `Subject: ${doc.Subject}\n`;
            backupText += `Year: ${doc.Year}\n`;
            backupText += `Description: ${doc.Description}\n`;
            backupText += `URL: ${doc.URL}\n`;
            backupText += `Type: ${doc.Type}\n`;
            backupText += `Trending: ${doc.Trending || false}\n`;
            backupText += `Recent: ${doc.Recent || false}\n`;
            
            copyToClipboard(backupText);
            showNotification('Copied', 'Document details copied to clipboard', 'success');
        }

        function deleteMaterial(index) {
            if (confirm('Are you sure you want to delete this material? Only admin can delete.')) {
                appState.documents.splice(index, 1);
                saveAppData();
                showNotification('Deleted', 'Material deleted successfully', 'success');
                loadAdminMaterials();
                initializeCategories();
                initializeUnitCodes();
                renderHomeContent();
                updateStatistics();
            }
        }

        function addNewMaterial() {
            const title = prompt('Enter material title:');
            if (!title) return;
            
            const unitCode = prompt('Enter unit code:');
            if (!unitCode) return;
            
            const university = prompt('Enter university:');
            if (!university) return;
            
            const year = prompt('Enter year (1-4):');
            if (!year) return;
            
            const subject = prompt('Enter subject:');
            if (!subject) return;
            
            const description = prompt('Enter description:');
            if (!description) return;
            
            const url = prompt('Enter Google Drive URL (must end with /preview):');
            if (!url) return;
            
            const newMaterial = {
                "Title": title,
                "Unit Code": unitCode,
                "University": university,
                "Type": "pdf",
                "Subject": subject,
                "Year": year,
                "Description": description,
                "URL": url,
                "Trending": false,
                "Recent": true
            };
            
            appState.documents.push(newMaterial);
            saveAppData();
            showNotification('Added', 'New material added successfully', 'success');
            loadAdminMaterials();
            initializeCategories();
            initializeUnitCodes();
            renderHomeContent();
            updateStatistics();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function generateUnlockCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function copyAccountNumber() {
            const accountNumber = '0330184468200';
            navigator.clipboard.writeText(accountNumber).then(() => {
                const btn = event.target.closest('.copy-btn');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    btn.classList.add('copied');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('copied');
                    }, 2000);
                }
                showNotification('Copied', 'Account number copied to clipboard', 'success');
            });
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('copied');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('copied');
                }, 2000);
                
                showNotification('Copied', 'Text copied to clipboard', 'success');
            });
        }

        // ==================== TAB NAVIGATION ====================
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            document.getElementById(tabName).style.display = 'block';
            
            document.querySelectorAll('.bottom-nav .nav-btn').forEach(btn => btn.classList.remove('active'));
            
            const buttons = {
                'home': 0,
                'materials': 1,
                'upload': 2,
                'register': 3,
                'admin': 4
            };
            
            if (buttons[tabName] !== undefined) {
                document.querySelectorAll('.bottom-nav .nav-btn')[buttons[tabName]].classList.add('active');
            }
            
            // For Login tab, don't highlight any bottom-nav button
            if (tabName === 'login') {
                document.querySelectorAll('.bottom-nav .nav-btn').forEach(btn => btn.classList.remove('active'));
            }
            
            // Clear search when switching tabs
            if (tabName !== 'home') {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').classList.remove('active');
                document.getElementById('continueReading').style.display = 'block';
                hideSearchSuggestions();
            }
            
            // Execute tab-specific actions
            switch(tabName) {
                case 'home':
                    renderHomeContent();
                    break;
                case 'materials':
                    renderAllMaterials();
                    break;
                case 'upload':
                    document.getElementById('uploadForm').style.display = 'block';
                    document.getElementById('uploadSuccess').style.display = 'none';
                    break;
                case 'admin':
                    document.getElementById('adminPassword').value = '';
                    break;
            }
        }

        // ==================== RENDERING FUNCTIONS ====================
        function renderHomeContent() {
            renderContinueReading();
            renderTrendingMaterials();
        }

        function renderContinueReading() {
            const grid = document.getElementById('continueReadingGrid');
            const recentMaterials = appState.documents.filter(doc => doc.Recent).slice(0, 6);
            
            grid.innerHTML = recentMaterials.map(doc => createMaterialCard(doc)).join('');
        }

        function renderAllMaterials() {
            const grid = document.getElementById('allMaterialsGrid');
            grid.innerHTML = appState.documents.map(doc => createMaterialCard(doc)).join('');
        }

        function renderTrendingMaterials() {
            const grid = document.getElementById('trendingGrid');
            const trendingMaterials = appState.documents.filter(doc => doc.Trending).slice(0, 4);
            
            grid.innerHTML = trendingMaterials.map(doc => createMaterialCard(doc)).join('');
        }

        // ==================== SAMPLE DATA INITIALIZATION ====================
        function initializeSampleData() {
            if (appState.users.length === 0) {
                // Add a sample approved user
                appState.users.push({
                    id: 1,
                    name: "John Doe",
                    phone: "0712345678",
                    university: "Egerton University",
                    course: "BSc Agriculture",
                    year: "2",
                    registrationDate: new Date().toISOString(),
                    subscription: {
                        active: true,
                        paymentCode: "ABC123XYZ",
                        unlockCode: "RVP7X9Y2",
                        status: 'approved',
                        startDate: new Date().toISOString(),
                        endDate: new Date(Date.now() + 5 * 30 * 24 * 60 * 60 * 1000).toISOString(),
                        approvedDate: new Date().toISOString()
                    },
                    activity: {
                        lastLogin: new Date().toISOString(),
                        materialsViewed: [],
                        universitiesBrowsed: ["Egerton University", "University of Nairobi"]
                    }
                });
                
                // Add a sample pending user
                appState.users.push({
                    id: 2,
                    name: "Jane Smith",
                    phone: "0723456789",
                    university: "University of Nairobi",
                    course: "BSc Computer Science",
                    year: "3",
                    registrationDate: new Date().toISOString(),
                    subscription: {
                        active: false,
                        paymentCode: "XYZ789ABC",
                        unlockCode: "",
                        status: 'pending',
                        startDate: null,
                        endDate: null,
                        approvedDate: null
                    },
                    activity: {
                        lastLogin: null,
                        materialsViewed: [],
                        universitiesBrowsed: []
                    }
                });
                
                saveAppData();
            }
        }

        // ==================== NOTIFICATION SYSTEM ====================
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            
            // Set color based on type
            switch(type) {
                case 'success':
                    notification.style.borderLeftColor = '#10b981';
                    break;
                case 'error':
                    notification.style.borderLeftColor = '#ef4444';
                    break;
                case 'warning':
                    notification.style.borderLeftColor = '#f59e0b';
                    break;
                default:
                    notification.style.borderLeftColor = '#3b82f6';
            }
            
            // Set icon based on type
            const icon = type === 'success' ? 'fas fa-check-circle' :
                        type === 'error' ? 'fas fa-times-circle' :
                        type === 'warning' ? 'fas fa-exclamation-triangle' :
                        'fas fa-info-circle';
            
            notificationTitle.innerHTML = `<i class="${icon}"></i> ${title}`;
            notificationMessage.textContent = message;
            
            notification.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        // ==================== LOGOUT FUNCTION ====================
        function logout() {
            appState.currentUser = null;
            saveAppData();
            updateAccessStatus();
            showTab('home');
            showNotification('Logged Out', 'You have been logged out successfully', 'success');
        }

        // ==================== REST OF THE FUNCTIONS ====================
        function initializeCategories() {
            const categories = {};
            appState.documents.forEach(doc => {
                if (doc.Subject) {
                    categories[doc.Subject] = (categories[doc.Subject] || 0) + 1;
                }
            });
            
            const categoryList = document.getElementById('categoryList');
            if (categoryList) {
                const sortedCategories = Object.entries(categories)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 8);
                
                categoryList.innerHTML = sortedCategories.map(([category, count]) => `
                    <li class="category-item" onclick="filterByCategory('${category}')">
                        <span class="category-name">${category}</span>
                        <span class="category-count">${count}</span>
                    </li>
                `).join('');
            }
            
            const subjectFilter = document.getElementById('allSubjectFilter');
            if (subjectFilter) {
                subjectFilter.innerHTML = '<option value="all">All Subjects</option>' +
                    Object.keys(categories).map(subject => 
                        `<option value="${subject}">${subject}</option>`
                    ).join('');
            }
        }

        function initializeUnitCodes() {
            const unitCodes = [...new Set(appState.documents.map(doc => doc["Unit Code"]))];
            appState.allUnitCodes = unitCodes;
            
            const quickUnits = document.getElementById('quickUnits');
            if (quickUnits) {
                const popularUnits = unitCodes.slice(0, 8);
                quickUnits.innerHTML = popularUnits.map(code => `
                    <div class="unit-chip" onclick="quickSearch('${code}')">
                        ${code}
                    </div>
                `).join('');
            }
        }

        function searchByUnitCode(query) {
            if (!query.trim()) {
                document.getElementById('searchResults').classList.remove('active');
                document.getElementById('continueReading').style.display = 'block';
                hideSearchSuggestions();
                return;
            }
            
            query = query.trim().toUpperCase();
            
            const results = appState.documents.filter(doc => {
                const unitCode = (doc["Unit Code"] || "").toUpperCase();
                const title = (doc.Title || "").toUpperCase();
                const subject = (doc.Subject || "").toUpperCase();
                const description = (doc.Description || "").toUpperCase();
                const university = (doc.University || "").toUpperCase();
                
                return unitCode.includes(query) || 
                       title.includes(query) ||
                       subject.includes(query) ||
                       description.includes(query) ||
                       university.includes(query);
            });
            
            if (results.length > 0) {
                document.getElementById('continueReading').style.display = 'none';
                document.getElementById('searchResults').classList.add('active');
                document.getElementById('searchResultsTitle').textContent = `Search Results for "${query}" (${results.length} found)`;
                
                const grid = document.getElementById('searchResultsGrid');
                grid.innerHTML = results.map(doc => createMaterialCard(doc)).join('');
                
                setTimeout(() => {
                    document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
                }, 100);
                
                showNotification('Search Results', `Found ${results.length} materials for "${query}"`, 'success');
            } else {
                document.getElementById('continueReading').style.display = 'block';
                document.getElementById('searchResults').classList.remove('active');
                showNotification('No Results', `No materials found for "${query}"`, 'warning');
            }
            
            hideSearchSuggestions();
        }

        function showSearchSuggestions(query) {
            if (!query || query.length < 1) {
                hideSearchSuggestions();
                return;
            }
            
            query = query.trim().toUpperCase();
            
            const unitCodeMatches = appState.allUnitCodes.filter(code => 
                code.toUpperCase().includes(query)
            ).slice(0, 5);
            
            const titleMatches = appState.documents.filter(doc => 
                doc.Title.toUpperCase().includes(query)
            ).slice(0, 3);
            
            const universityMatches = UNIVERSITIES.filter(uni => 
                uni.toUpperCase().includes(query)
            ).slice(0, 2);
            
            if (unitCodeMatches.length === 0 && titleMatches.length === 0 && universityMatches.length === 0) {
                hideSearchSuggestions();
                return;
            }
            
            const suggestionsContainer = document.getElementById('searchSuggestions');
            let suggestionsHTML = '';
            
            if (unitCodeMatches.length > 0) {
                suggestionsHTML += '<div style="padding: 10px 20px; background: #f1f5f9; color: #64748b; font-size: 12px; font-weight: 600;">Unit Codes</div>';
                
                unitCodeMatches.forEach(code => {
                    const doc = appState.documents.find(d => d["Unit Code"] === code);
                    suggestionsHTML += `
                        <div class="suggestion-item" onclick="selectSuggestion('${code}')">
                            <div class="suggestion-code">${code}</div>
                            ${doc ? `<div class="suggestion-title">${doc.Title}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            if (titleMatches.length > 0) {
                suggestionsHTML += '<div style="padding: 10px 20px; background: #f1f5f9; color: #64748b; font-size: 12px; font-weight: 600; border-top: 1px solid #e2e8f0;">Titles</div>';
                
                titleMatches.forEach(doc => {
                    suggestionsHTML += `
                        <div class="suggestion-item" onclick="selectSuggestion('${doc["Unit Code"]}')">
                            <div class="suggestion-code">${doc["Unit Code"]}</div>
                            <div class="suggestion-title">${doc.Title}</div>
                        </div>
                    `;
                });
            }
            
            if (universityMatches.length > 0) {
                suggestionsHTML += '<div style="padding: 10px 20px; background: #f1f5f9; color: #64748b; font-size: 12px; font-weight: 600; border-top: 1px solid #e2e8f0;">Universities</div>';
                
                universityMatches.forEach(uni => {
                    suggestionsHTML += `
                        <div class="suggestion-item" onclick="selectUniversitySuggestion('${uni}')">
                            <div class="suggestion-code">${uni.substring(0, 3).toUpperCase()}</div>
                            <div class="suggestion-title">${uni}</div>
                        </div>
                    `;
                });
            }
            
            suggestionsContainer.innerHTML = suggestionsHTML;
            suggestionsContainer.classList.add('active');
        }

        function selectUniversitySuggestion(university) {
            showUniversityMaterials(university);
            document.getElementById('searchInput').value = '';
            hideSearchSuggestions();
        }

        function hideSearchSuggestions() {
            document.getElementById('searchSuggestions').classList.remove('active');
        }

        function selectSuggestion(unitCode) {
            document.getElementById('searchInput').value = unitCode;
            searchByUnitCode(unitCode);
            hideSearchSuggestions();
        }

        function quickSearch(unitCode) {
            document.getElementById('searchInput').value = unitCode;
            searchByUnitCode(unitCode);
        }

        function filterMaterials() {
            const university = document.getElementById('universityFilter').value;
            const year = document.getElementById('yearFilter').value;
            
            let filtered = appState.documents;
            
            if (university && university !== 'all') {
                filtered = filtered.filter(doc => doc.University === university);
            }
            
            if (year && year !== 'all') {
                filtered = filtered.filter(doc => doc.Year === year);
            }
            
            document.getElementById('continueReadingGrid').innerHTML = 
                filtered.slice(0, 6).map(doc => createMaterialCard(doc)).join('');
        }

        function filterAllMaterials() {
            const university = document.getElementById('allUniversityFilter').value;
            const subject = document.getElementById('allSubjectFilter').value;
            
            let filtered = appState.documents;
            
            if (university && university !== 'all') {
                filtered = filtered.filter(doc => doc.University === university);
            }
            
            if (subject && subject !== 'all') {
                filtered = filtered.filter(doc => doc.Subject === subject);
            }
            
            document.getElementById('allMaterialsGrid').innerHTML = 
                filtered.map(doc => createMaterialCard(doc)).join('');
        }

        function filterByCategory(category) {
            document.getElementById('allSubjectFilter').value = category;
            showTab('materials');
            filterAllMaterials();
        }

        function sendWhatsAppNotification(user) {
            const adminNumber = appState.adminWhatsApp.replace(/^0/, '254').replace(/^\+/, '');
            const message = ` NEW REGISTRATION - RevisionVault Pro
            
 Name: ${user.name}
 Phone: ${user.phone}
 University: ${user.university}
 Course: ${user.course}
 Year: ${user.year}
 Payment Code: ${user.subscription.paymentCode}
 Date: ${new Date().toLocaleString()}

Please review and approve this registration.`;

            const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // ==================== AI CHAT FUNCTIONS ====================
        function openAIChat() {
            if (!appState.currentUser || !appState.currentUser.subscription.active) {
                showTab('register');
                showNotification('Access Denied', 'Please subscribe to use AI Chat', 'warning');
                return;
            }
            openModal('aiChatModal');
        }

        function askAI() {
            const question = document.getElementById('aiQuestion').value.trim();
            if (!question) return;
            
            const messagesDiv = document.getElementById('aiChatMessages');
            
            // Add user message
            messagesDiv.innerHTML += `
                <div style="background: #dbeafe; padding: 10px; border-radius: 10px; margin-bottom: 10px; text-align: right;">
                    <strong>You:</strong> ${question}
                </div>
            `;
            
            // Clear input
            document.getElementById('aiQuestion').value = '';
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Simulate AI thinking
            setTimeout(() => {
                const responses = [
                    "Based on my knowledge, that's an excellent question! In academic terms, this relates to...",
                    "I'd recommend studying this topic from multiple angles. Start with the fundamentals and then move to advanced concepts.",
                    "For your assignment, I suggest structuring it with an introduction, three main points, and a conclusion.",
                    "This is a common topic in university studies. The key points to remember are...",
                    "I can help you break this down into manageable sections for better understanding."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                
                messagesDiv.innerHTML += `
                    <div style="background: #f1f5f9; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                        <strong><i class="fas fa-robot"></i> AI Assistant:</strong> ${randomResponse}
                        <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                            <i class="fas fa-lightbulb"></i> Tip: Always cite your sources in academic work.
                        </div>
                    </div>
                `;
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 1000);
        }
    </script>
</body>
</html>