<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RevisionVault Pro - Ultimate Document Management</title>
    
    <!-- Enhanced Security Meta Tags -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://apis.google.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src * data:;">
    <meta name="theme-color" content="#1a2980">
    
    <!-- Google Sheets API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- Firebase for real-time sync -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* ====== ENHANCED STYLES WITH DARK MODE ====== */
        :root {
            --primary: #1a2980;
            --primary-dark: #0f1a5c;
            --primary-light: #2d3ba8;
            --secondary: #26d0ce;
            --secondary-dark: #1ba8a6;
            --success: #10b981;
            --success-dark: #0a8b62;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --info: #3b82f6;
            --info-dark: #2563eb;
            --dark: #1f2937;
            --darker: #111827;
            --dark-light: #374151;
            --light: #f8fafc;
            --lighter: #ffffff;
            --gray: #6b7280;
            --gray-light: #9ca3af;
            --border: #e5e7eb;
            --border-dark: #d1d5db;
            
            /* Dark mode variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            
            --radius: 12px;
            --radius-lg: 16px;
            --radius-sm: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 6px 10px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --light: #1e293b;
            --lighter: #334155;
            --border: #334155;
            --border-dark: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, border-color 0.3s;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            position: relative;
            min-height: 90vh;
        }

        /* ====== HEADER ====== */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 30px;
            position: relative;
            overflow: hidden;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .logo-text h1 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .logo-text p {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* ====== TABS ====== */
        .tabs-container {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tabs {
            display: flex;
            min-width: max-content;
        }

        .tab {
            padding: 18px 30px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            min-width: 200px;
            text-align: center;
            user-select: none;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: transparent;
        }

        .tab:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: var(--bg-card);
        }

        .tab-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* ====== GOOGLE SHEET MANAGER ====== */
        .sheet-manager-container {
            padding: 30px;
        }

        .sheet-connection-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 30px;
            border: 2px solid var(--border-color);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .sheet-url-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .sheet-url-input input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .sheet-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sheet-status {
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 500;
        }

        .sheet-status.connected {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid var(--success);
            color: var(--success-dark);
        }

        .sheet-status.syncing {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid var(--warning);
            color: var(--warning-dark);
        }

        .sheet-status.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid var(--danger);
            color: var(--danger-dark);
        }

        .sheet-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-card .label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ====== DOCUMENT CARDS ====== */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }

        .document-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            border: 2px solid var(--border-color);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .document-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .doc-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .doc-actions {
            display: flex;
            gap: 8px;
        }

        .doc-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .doc-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .doc-tag {
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }

        .doc-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            flex: 1;
            margin-bottom: 15px;
        }

        .doc-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .doc-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ====== LOADING & EMPTY STATES ====== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            grid-column: 1 / -1;
        }

        /* ====== BUTTONS ====== */
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #34d399 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #f87171 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #fbbf24 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* ====== MODALS ====== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-xl);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--danger);
        }

        /* ====== FORM CONTROLS ====== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 41, 128, 0.1);
        }

        /* ====== NOTIFICATIONS ====== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--success);
            color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 10001;
            animation: slideInRight 0.3s ease-out;
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.error { background: var(--danger); }
        .notification.warning { background: var(--warning); }
        .notification.info { background: var(--info); }
        .notification.success { background: var(--success); }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ====== RESPONSIVE DESIGN ====== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 16px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .tabs {
                flex-direction: column;
                min-width: 100%;
            }
            
            .tab {
                min-width: 100%;
                padding: 15px;
                justify-content: flex-start;
            }
            
            .documents-grid {
                grid-template-columns: 1fr;
            }
            
            .sheet-manager-container {
                padding: 15px;
            }
        }

        /* ====== UTILITY CLASSES ====== */
        .d-flex { display: flex; }
        .d-none { display: none; }
        .gap-3 { gap: 15px; }
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .w-100 { width: 100%; }
        .text-center { text-align: center; }
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <h3 style="color: var(--primary); margin-bottom: 10px;">Loading RevisionVault Pro</h3>
        <p id="loadingMessage" style="color: var(--gray);">Initializing system...</p>
    </div>

    <!-- Google OAuth Modal -->
    <div class="modal" id="googleAuthModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('googleAuthModal')">&times;</button>
            <div style="text-align: center; margin-bottom: 30px;">
                <div class="logo-icon" style="margin: 0 auto 20px;">
                    <i class="fab fa-google"></i>
                </div>
                <h3 style="color: var(--text-primary); margin-bottom: 10px;">Connect Google Account</h3>
                <p style="color: var(--text-secondary);">Authorize access to your Google Sheets for real-time document sync</p>
            </div>
            <button class="btn btn-primary w-100" onclick="initGoogleAuth()">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
            <p style="color: var(--text-secondary); font-size: 12px; text-align: center; margin-top: 15px;">
                We only request access to your Google Sheets. Your data remains private.
            </p>
        </div>
    </div>

    <!-- Sheet Settings Modal -->
    <div class="modal" id="sheetSettingsModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('sheetSettingsModal')">&times;</button>
            <h3 style="color: var(--text-primary); margin-bottom: 20px;">Google Sheet Settings</h3>
            
            <div class="form-group">
                <label class="form-label">Sheet Name</label>
                <input type="text" id="sheetName" class="form-control" value="Sheet1" placeholder="Sheet name">
            </div>
            
            <div class="form-group">
                <label class="form-label">Auto Sync Interval</label>
                <select id="syncInterval" class="form-control">
                    <option value="0">Manual Only</option>
                    <option value="5">Every 5 minutes</option>
                    <option value="15" selected>Every 15 minutes</option>
                    <option value="30">Every 30 minutes</option>
                    <option value="60">Every hour</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Column Mapping</label>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: var(--radius-sm);">
                    <small style="color: var(--text-secondary); display: block; margin-bottom: 10px;">Map your sheet columns:</small>
                    <div class="d-flex gap-3 mb-3">
                        <input type="text" class="form-control" placeholder="Title Column" value="Title" id="colTitle">
                        <input type="text" class="form-control" placeholder="URL Column" value="URL" id="colUrl">
                    </div>
                    <div class="d-flex gap-3">
                        <input type="text" class="form-control" placeholder="University Column" value="University" id="colUniversity">
                        <input type="text" class="form-control" placeholder="Type Column" value="Type" id="colType">
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary w-100 mt-3" onclick="saveSheetSettings()">
                <i class="fas fa-save"></i> Save Settings
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="logo-text">
                        <h1>RevisionVault Pro</h1>
                        <p>Advanced Document Management System</p>
                    </div>
                </div>
                <div class="header-controls">
                    <button class="btn btn-outline" onclick="toggleTheme()" id="themeToggle">
                        <i class="fas fa-moon"></i> Theme
                    </button>
                    <button class="btn btn-outline" onclick="exportData()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('documents')">
                    <i class="fas fa-file-alt"></i>
                    <span>Study Materials</span>
                    <span class="tab-badge" id="docCount">0</span>
                </div>
                <div class="tab" onclick="switchTab('sheet-manager')">
                    <i class="fas fa-table"></i>
                    <span>Google Sheet Manager</span>
                </div>
                <div class="tab" onclick="switchTab('upload')">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Upload Documents</span>
                </div>
                <div class="tab" onclick="switchTab('analytics')">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </div>
                <div class="tab" onclick="switchTab('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </div>
        </div>

        <!-- ==================== STUDY MATERIALS TAB ==================== -->
        <div id="documents" class="tab-content" style="display: block;">
            <div class="sheet-manager-container">
                <div class="sheet-connection-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--text-primary);">Study Materials</h3>
                        <div class="d-flex gap-3">
                            <button class="btn btn-primary" onclick="refreshDocuments()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button class="btn btn-outline" onclick="openModal('sheetSettingsModal')">
                                <i class="fas fa-cog"></i> Settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- Status Display -->
                    <div id="sheetStatus" class="sheet-status">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <span>Connecting to Google Sheet...</span>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div>
                            <input type="text" id="searchInput" class="form-control" placeholder="Search documents..." oninput="filterDocuments()">
                        </div>
                        <select id="universityFilter" class="form-control" onchange="filterDocuments()">
                            <option value="">All Universities</option>
                        </select>
                        <select id="typeFilter" class="form-control" onchange="filterDocuments()">
                            <option value="">All Types</option>
                            <option value="pdf">PDF</option>
                            <option value="doc">Word</option>
                            <option value="xls">Excel</option>
                            <option value="ppt">PowerPoint</option>
                            <option value="image">Images</option>
                        </select>
                    </div>
                    
                    <!-- Documents Grid -->
                    <div id="documentsGrid" class="documents-grid">
                        <div class="empty-state">
                            <i class="fas fa-sync fa-spin" style="font-size: 48px; margin-bottom: 20px; color: var(--primary);"></i>
                            <h3 style="color: var(--text-primary); margin-bottom: 10px;">Loading Documents</h3>
                            <p style="color: var(--text-secondary);">Fetching study materials from Google Sheet...</p>
                        </div>
                    </div>
                    
                    <!-- No Documents Message -->
                    <div id="noDocumentsMessage" class="empty-state" style="display: none;">
                        <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 20px; color: var(--gray-light);"></i>
                        <h3>No Documents Found</h3>
                        <p>Connect a Google Sheet to load documents, or adjust your search filters.</p>
                        <button class="btn btn-primary mt-3" onclick="switchTab('sheet-manager')">
                            <i class="fas fa-plug"></i> Connect Google Sheet
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== GOOGLE SHEET MANAGER TAB ==================== -->
        <div id="sheet-manager" class="tab-content">
            <div class="sheet-manager-container">
                <!-- Connection Section -->
                <div class="sheet-connection-card">
                    <h3 style="color: var(--text-primary); margin-bottom: 20px;">
                        <i class="fas fa-table"></i> Google Sheet Connection
                    </h3>
                    
                    <div class="sheet-url-input">
                        <input type="url" id="googleSheetUrl" class="form-control" 
                               placeholder="https://docs.google.com/spreadsheets/d/..." 
                               value="https://docs.google.com/spreadsheets/d/1SVkc6bNx2nJrALP2pc6-LzOBsEzuTwv-bh5YFuGQcaI/edit">
                        <button class="btn btn-primary" onclick="connectGoogleSheet()">
                            <i class="fas fa-plug"></i> Connect
                        </button>
                    </div>
                    
                    <div class="d-flex gap-3 mt-3">
                        <button class="btn btn-outline" onclick="openModal('googleAuthModal')">
                            <i class="fab fa-google"></i> Sign in with Google
                        </button>
                        <button class="btn btn-outline" onclick="testSheetConnection()">
                            <i class="fas fa-test"></i> Test Connection
                        </button>
                    </div>
                    
                    <div id="sheetConnectionStatus" class="sheet-status mt-3">
                        <i class="fas fa-info-circle"></i>
                        <span>Not connected to Google Sheet</span>
                    </div>
                </div>
                
                <!-- Statistics Section -->
                <div class="sheet-stats">
                    <div class="stat-card">
                        <div class="label">Total Documents</div>
                        <div class="value" id="totalDocs">0</div>
                        <div style="font-size: 11px; color: var(--success);">
                            <i class="fas fa-arrow-up"></i> <span id="newDocs">0</span> new
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Last Updated</div>
                        <div class="value" id="lastUpdated">Never</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            <i class="fas fa-clock"></i> Auto-sync: <span id="syncStatus">Off</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Sheet Status</div>
                        <div class="value" id="sheetStatusText">Inactive</div>
                        <div style="font-size: 11px; color: var(--warning);">
                            <i class="fas fa-circle"></i> <span id="connectionStatus">Disconnected</span>
                        </div>
                    </div>
                </div>
                
                <!-- Sheet Preview -->
                <div class="sheet-connection-card mt-3">
                    <h4 style="color: var(--text-primary); margin-bottom: 15px;">
                        <i class="fas fa-list"></i> Sheet Preview
                    </h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: var(--bg-secondary); position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">Title</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">Type</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">University</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">Status</th>
                                </tr>
                            </thead>
                            <tbody id="sheetPreview">
                                <tr>
                                    <td colspan="4" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                                        No sheet data loaded
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Advanced Controls -->
                <div class="sheet-connection-card mt-3">
                    <h4 style="color: var(--text-primary); margin-bottom: 15px;">
                        <i class="fas fa-sliders-h"></i> Advanced Controls
                    </h4>
                    <div class="sheet-actions">
                        <button class="btn btn-success" onclick="syncNow()">
                            <i class="fas fa-sync"></i> Sync Now
                        </button>
                        <button class="btn btn-warning" onclick="clearCache()">
                            <i class="fas fa-trash"></i> Clear Cache
                        </button>
                        <button class="btn btn-outline" onclick="validateSheet()">
                            <i class="fas fa-check-circle"></i> Validate Sheet
                        </button>
                        <button class="btn btn-outline" onclick="exportToCSV()">
                            <i class="fas fa-file-export"></i> Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== UPLOAD TAB ==================== -->
        <div id="upload" class="tab-content">
            <div class="sheet-manager-container">
                <div class="sheet-connection-card">
                    <h3 style="color: var(--text-primary); margin-bottom: 20px;">
                        <i class="fas fa-cloud-upload-alt"></i> Upload Documents
                    </h3>
                    
                    <!-- Direct Upload -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">Direct Document Upload</h4>
                        <div style="border: 2px dashed var(--border-color); border-radius: var(--radius); padding: 40px; text-align: center;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">Drag and drop files here, or click to browse</p>
                            <input type="file" id="fileUpload" multiple style="display: none;" onchange="handleFileUpload(event)">
                            <button class="btn btn-primary" onclick="document.getElementById('fileUpload').click()">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </button>
                            <div id="uploadProgress" style="display: none; margin-top: 20px;">
                                <div style="background: var(--bg-secondary); height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div id="uploadProgressBar" style="height: 100%; background: var(--primary); width: 0%; transition: width 0.3s;"></div>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 12px; margin-top: 5px;">
                                    Uploading: <span id="uploadFileName"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Google Drive Integration -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">Google Drive Integration</h4>
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: var(--radius);">
                            <div class="d-flex gap-3 align-items-center mb-3">
                                <i class="fab fa-google-drive" style="font-size: 32px; color: var(--primary);"></i>
                                <div>
                                    <h5 style="color: var(--text-primary); margin: 0;">Connect Google Drive</h5>
                                    <p style="color: var(--text-secondary); font-size: 12px; margin: 0;">Import documents directly from your Google Drive</p>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100" onclick="connectGoogleDrive()">
                                <i class="fab fa-google-drive"></i> Connect Google Drive
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bulk URL Import -->
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">Bulk URL Import</h4>
                        <div class="form-group">
                            <label class="form-label">Paste Document URLs (one per line)</label>
                            <textarea id="bulkUrls" class="form-control" rows="5" placeholder="https://drive.google.com/file/d/...&#10;https://drive.google.com/file/d/..."></textarea>
                        </div>
                        <div class="d-flex gap-3">
                            <button class="btn btn-primary" onclick="importBulkUrls()">
                                <i class="fas fa-import"></i> Import URLs
                            </button>
                            <button class="btn btn-outline" onclick="validateUrls()">
                                <i class="fas fa-check"></i> Validate URLs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ANALYTICS TAB ==================== -->
        <div id="analytics" class="tab-content">
            <div class="sheet-manager-container">
                <div class="sheet-connection-card">
                    <h3 style="color: var(--text-primary); margin-bottom: 20px;">
                        <i class="fas fa-chart-line"></i> System Analytics
                    </h3>
                    
                    <!-- Stats Grid -->
                    <div class="sheet-stats">
                        <div class="stat-card">
                            <div class="label">Total Views</div>
                            <div class="value" id="totalViews">0</div>
                            <div style="font-size: 11px; color: var(--success);">
                                <i class="fas fa-eye"></i> Last 24h: <span id="dailyViews">0</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Total Downloads</div>
                            <div class="value" id="totalDownloads">0</div>
                            <div style="font-size: 11px; color: var(--primary);">
                                <i class="fas fa-download"></i> Popular: <span id="popularDoc">-</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Storage Used</div>
                            <div class="value" id="storageUsed">0 MB</div>
                            <div style="font-size: 11px; color: var(--warning);">
                                <i class="fas fa-database"></i> Available: <span id="storageAvailable">Unlimited</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Sync Health</div>
                            <div class="value" id="syncHealth">100%</div>
                            <div style="font-size: 11px; color: var(--success);">
                                <i class="fas fa-heartbeat"></i> Status: <span id="healthStatus">Good</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: var(--radius);">
                            <h5 style="color: var(--text-primary); margin-bottom: 15px;">Document Types</h5>
                            <div id="typeChart" style="height: 200px; display: flex; align-items: flex-end; gap: 10px;">
                                <!-- Chart bars will be generated here -->
                            </div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: var(--radius);">
                            <h5 style="color: var(--text-primary); margin-bottom: 15px;">University Distribution</h5>
                            <div id="universityChart" style="height: 200px;">
                                <!-- University distribution will be shown here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div style="margin-top: 30px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">Recent Activity</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <div id="activityFeed" style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="padding: 15px; background: var(--bg-secondary); border-radius: var(--radius); border-left: 4px solid var(--primary);">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-primary); font-weight: 500;">System Started</span>
                                        <span style="color: var(--text-secondary); font-size: 12px;">Just now</span>
                                    </div>
                                    <p style="color: var(--text-secondary); font-size: 13px; margin: 5px 0 0 0;">
                                        RevisionVault Pro initialized successfully
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== SETTINGS TAB ==================== -->
        <div id="settings" class="tab-content">
            <div class="sheet-manager-container">
                <div class="sheet-connection-card">
                    <h3 style="color: var(--text-primary); margin-bottom: 20px;">
                        <i class="fas fa-cog"></i> System Settings
                    </h3>
                    
                    <!-- General Settings -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">General Settings</h4>
                        <div class="d-flex gap-3 align-items-center mb-3">
                            <div style="flex: 1;">
                                <label class="form-label">Default University</label>
                                <select id="defaultUniversity" class="form-control">
                                    <option value="">Select default university</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label class="form-label">Items Per Page</label>
                                <select id="itemsPerPage" class="form-control">
                                    <option value="12">12 items</option>
                                    <option value="24">24 items</option>
                                    <option value="48">48 items</option>
                                    <option value="96">96 items</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <input type="checkbox" id="autoRefresh" checked>
                            <label for="autoRefresh" style="color: var(--text-primary);">Auto-refresh documents</label>
                        </div>
                        
                        <div class="d-flex align-items-center gap-3">
                            <input type="checkbox" id="notifications" checked>
                            <label for="notifications" style="color: var(--text-primary);">Enable notifications</label>
                        </div>
                    </div>
                    
                    <!-- Backup & Restore -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">Backup & Restore</h4>
                        <div class="d-flex gap-3">
                            <button class="btn btn-outline" onclick="backupData()">
                                <i class="fas fa-download"></i> Backup Data
                            </button>
                            <button class="btn btn-outline" onclick="restoreData()">
                                <i class="fas fa-upload"></i> Restore Data
                            </button>
                            <button class="btn btn-outline" onclick="resetSystem()">
                                <i class="fas fa-redo"></i> Reset System
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced Settings -->
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">Advanced Settings</h4>
                        <div class="form-group">
                            <label class="form-label">API Endpoint</label>
                            <input type="text" id="apiEndpoint" class="form-control" value="https://opensheet.elk.sh/" placeholder="API endpoint">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Cache Duration (hours)</label>
                            <input type="number" id="cacheDuration" class="form-control" value="24" min="1" max="168">
                        </div>
                        
                        <div class="d-flex gap-3 mt-3">
                            <button class="btn btn-primary" onclick="saveSettings()">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                            <button class="btn btn-outline" onclick="loadDefaultSettings()">
                                <i class="fas fa-undo"></i> Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ENHANCED CONFIGURATION ====================
        const CONFIG = {
            version: '3.0.0',
            defaultSheetUrl: 'https://docs.google.com/spreadsheets/d/1SVkc6bNx2nJrALP2pc6-LzOBsEzuTwv-bh5YFuGQcaI/edit',
            apiEndpoint: 'https://opensheet.elk.sh/',
            maxFileSize: 50 * 1024 * 1024, // 50MB
            cacheDuration: 24 * 60 * 60 * 1000, // 24 hours
            google: {
                clientId: '', // Add your Google Client ID here
                apiKey: '',   // Add your Google API Key here
                scopes: 'https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/drive.readonly'
            }
        };

        // ==================== STATE MANAGEMENT ====================
        class AppState {
            constructor() {
                this.documents = [];
                this.filteredDocuments = [];
                this.universities = new Set();
                this.currentSheetUrl = CONFIG.defaultSheetUrl;
                this.sheetConnected = false;
                this.sheetData = null;
                this.lastSync = null;
                this.syncInterval = null;
                this.analytics = {
                    views: 0,
                    downloads: 0,
                    uploads: 0,
                    syncs: 0,
                    errors: 0
                };
                this.settings = this.loadSettings();
                this.isDarkMode = localStorage.getItem('darkMode') === 'true';
                this.googleAuth = null;
            }
            
            loadSettings() {
                const defaults = {
                    autoRefresh: true,
                    itemsPerPage: 24,
                    notifications: true,
                    syncInterval: 15,
                    defaultUniversity: '',
                    cacheDuration: 24,
                    columnMapping: {
                        title: 'Title',
                        url: 'URL',
                        university: 'University',
                        type: 'Type',
                        description: 'Description',
                        unitCode: 'Unit Code',
                        year: 'Year'
                    }
                };
                
                const saved = JSON.parse(localStorage.getItem('appSettings') || '{}');
                return { ...defaults, ...saved };
            }
            
            saveSettings() {
                localStorage.setItem('appSettings', JSON.stringify(this.settings));
            }
            
            addDocument(doc) {
                const existingIndex = this.documents.findIndex(d => d.url === doc.url);
                if (existingIndex >= 0) {
                    // Update existing document
                    this.documents[existingIndex] = { 
                        ...this.documents[existingIndex], 
                        ...doc,
                        updatedAt: new Date().toISOString()
                    };
                } else {
                    // Add new document
                    this.documents.push({
                        id: `doc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        views: 0,
                        downloads: 0,
                        ...doc
                    });
                }
                
                this.saveDocuments();
                this.updateUniversities();
            }
            
            saveDocuments() {
                localStorage.setItem('documents', JSON.stringify(this.documents));
                localStorage.setItem('lastSync', new Date().toISOString());
            }
            
            loadDocuments() {
                const saved = localStorage.getItem('documents');
                if (saved) {
                    this.documents = JSON.parse(saved);
                    this.updateUniversities();
                    return true;
                }
                return false;
            }
            
            updateUniversities() {
                this.universities = new Set(this.documents.map(doc => doc.university).filter(Boolean));
            }
            
            filterDocuments(searchTerm = '', university = '', type = '') {
                this.filteredDocuments = this.documents.filter(doc => {
                    const matchesSearch = !searchTerm || 
                        doc.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (doc.description && doc.description.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (doc.unitCode && doc.unitCode.toLowerCase().includes(searchTerm.toLowerCase()));
                    
                    const matchesUniversity = !university || doc.university === university;
                    const matchesType = !type || doc.type === type;
                    
                    return matchesSearch && matchesUniversity && matchesType;
                });
            }
            
            trackView(docId) {
                const doc = this.documents.find(d => d.id === docId);
                if (doc) {
                    doc.views = (doc.views || 0) + 1;
                    this.analytics.views++;
                    this.saveDocuments();
                    this.updateAnalytics();
                }
            }
            
            trackDownload(docId) {
                const doc = this.documents.find(d => d.id === docId);
                if (doc) {
                    doc.downloads = (doc.downloads || 0) + 1;
                    this.analytics.downloads++;
                    this.saveDocuments();
                    this.updateAnalytics();
                }
            }
            
            updateAnalytics() {
                localStorage.setItem('analytics', JSON.stringify(this.analytics));
            }
            
            loadAnalytics() {
                const saved = localStorage.getItem('analytics');
                if (saved) {
                    this.analytics = JSON.parse(saved);
                }
            }
        }

        // Initialize app state
        const app = new AppState();

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('Initializing RevisionVault Pro...');
            
            try {
                // Apply theme
                if (app.isDarkMode) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i> Theme';
                }
                
                // Load saved data
                app.loadDocuments();
                app.loadAnalytics();
                
                // Initialize Google API
                await loadGoogleAPI();
                
                // Update UI
                updateDocumentCount();
                updateUniversityFilter();
                updateAnalytics();
                
                // Try to connect to default sheet
                setTimeout(() => {
                    connectGoogleSheet(true); // Initial load
                }, 1000);
                
                // Set up auto-sync if enabled
                if (app.settings.syncInterval > 0) {
                    setupAutoSync();
                }
                
                hideLoading();
                showNotification('System loaded successfully!', 'success');
                logActivity('System initialized successfully');
                
            } catch (error) {
                console.error('Initialization error:', error);
                hideLoading();
                showNotification('System loaded with limited functionality', 'warning');
            }
        });

        // ==================== GOOGLE SHEET INTEGRATION ====================
        async function loadGoogleAPI() {
            return new Promise((resolve) => {
                gapi.load('client:auth2', () => {
                    // Initialize with minimal config
                    gapi.client.init({
                        apiKey: CONFIG.google.apiKey,
                        clientId: CONFIG.google.clientId,
                        scope: CONFIG.google.scopes,
                        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                    }).then(() => {
                        resolve();
                    }).catch(() => {
                        // Silently fail - we can still use public sheets
                        resolve();
                    });
                });
            });
        }

        async function connectGoogleSheet(initialLoad = false) {
            const urlInput = document.getElementById('googleSheetUrl');
            if (urlInput && urlInput.value) {
                app.currentSheetUrl = urlInput.value;
            }
            
            if (!initialLoad) {
                showLoading('Connecting to Google Sheet...');
            }
            
            try {
                const sheetId = extractSheetId(app.currentSheetUrl);
                if (!sheetId) {
                    throw new Error('Invalid Google Sheet URL format');
                }
                
                const sheetName = document.getElementById('sheetName')?.value || app.settings.sheetName || 'Sheet1';
                const jsonUrl = `${CONFIG.apiEndpoint}${sheetId}/${sheetName}`;
                
                // Update status
                updateSheetStatus('Fetching data from Google Sheet...', 'syncing');
                
                const response = await fetchWithTimeout(jsonUrl, 15000);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('No data found in sheet');
                }
                
                // Process documents
                const newDocuments = processSheetData(data);
                const previousCount = app.documents.length;
                
                // Merge with existing documents
                newDocuments.forEach(doc => app.addDocument(doc));
                
                // Update status
                app.sheetConnected = true;
                app.sheetData = data;
                app.lastSync = new Date();
                
                // Save to localStorage
                app.saveDocuments();
                
                // Update UI
                updateDocumentCount();
                updateUniversityFilter();
                loadDocumentsGrid();
                updateSheetPreview(data);
                updateAnalytics();
                
                const newCount = app.documents.length - previousCount;
                
                updateSheetStatus(`Connected: ${app.documents.length} documents loaded (${newCount} new)`, 'connected');
                showNotification(`Successfully loaded ${newDocuments.length} documents from Google Sheet`, 'success');
                logActivity(`Synced ${newDocuments.length} documents from Google Sheet`);
                
                return true;
                
            } catch (error) {
                console.error('Google Sheet connection error:', error);
                
                // Try to load cached data
                if (app.documents.length > 0) {
                    updateSheetStatus(`Using cached data: ${app.documents.length} documents`, 'syncing');
                    loadDocumentsGrid();
                    showNotification(`Loaded ${app.documents.length} cached documents`, 'warning');
                } else {
                    updateSheetStatus(`Connection failed: ${error.message}`, 'error');
                    showNotification('Failed to load documents. Please check your connection.', 'error');
                }
                
                logActivity(`Sheet connection failed: ${error.message}`);
                return false;
                
            } finally {
                if (!initialLoad) {
                    hideLoading();
                }
            }
        }

        function extractSheetId(url) {
            // Enhanced URL parsing for various Google Sheets formats
            const patterns = [
                /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/,
                /\/d\/([a-zA-Z0-9-_]+)(?:\/|$)/,
                /key=([a-zA-Z0-9-_]+)/,
                /id=([a-zA-Z0-9-_]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            // Try to extract ID from path
            const urlParts = url.split('/');
            for (const part of urlParts) {
                if (part.length >= 40 && part.length <= 50 && /^[a-zA-Z0-9-_]+$/.test(part)) {
                    return part;
                }
            }
            
            return null;
        }

        function processSheetData(data) {
            const documents = [];
            const columnMap = app.settings.columnMapping;
            
            data.forEach((row, index) => {
                try {
                    // Extract data using column mapping
                    const title = row[columnMap.title] || row['Title'] || row['title'] || '';
                    const url = row[columnMap.url] || row['URL'] || row['url'] || '';
                    
                    // Skip if required fields are missing
                    if (!title || !url) {
                        return;
                    }
                    
                    // Get other fields with fallbacks
                    const university = row[columnMap.university] || row['University'] || row['university'] || 'General';
                    const type = (row[columnMap.type] || row['Type'] || row['type'] || detectFileTypeFromUrl(url)).toLowerCase();
                    const description = row[columnMap.description] || row['Description'] || row['description'] || '';
                    const unitCode = row[columnMap.unitCode] || row['Unit Code'] || row['unitCode'] || row['UnitCode'] || '';
                    const year = row[columnMap.year] || row['Year'] || row['year'] || '';
                    
                    documents.push({
                        title: title.trim(),
                        url: url.trim(),
                        university: university.trim(),
                        type: type,
                        description: description.trim(),
                        unitCode: unitCode.trim(),
                        year: year.toString().trim(),
                        source: 'google-sheet',
                        indexedAt: new Date().toISOString()
                    });
                    
                } catch (error) {
                    console.warn(`Error processing row ${index}:`, error);
                }
            });
            
            return documents;
        }

        function detectFileTypeFromUrl(url) {
            if (!url) return 'other';
            
            const urlObj = new URL(url);
            const pathname = urlObj.pathname.toLowerCase();
            const extension = pathname.split('.').pop().split('?')[0];
            
            const typeMap = {
                // PDF
                'pdf': 'pdf',
                
                // Word Documents
                'doc': 'doc',
                'docx': 'doc',
                
                // Excel
                'xls': 'xls',
                'xlsx': 'xls',
                'csv': 'xls',
                
                // PowerPoint
                'ppt': 'ppt',
                'pptx': 'ppt',
                
                // Images
                'jpg': 'image',
                'jpeg': 'image',
                'png': 'image',
                'gif': 'image',
                'webp': 'image',
                'bmp': 'image',
                'svg': 'image',
                
                // Text
                'txt': 'text',
                'text': 'text',
                
                // Archives
                'zip': 'archive',
                'rar': 'archive',
                '7z': 'archive',
                
                // Video
                'mp4': 'video',
                'avi': 'video',
                'mov': 'video',
                'wmv': 'video',
                
                // Audio
                'mp3': 'audio',
                'wav': 'audio',
                'ogg': 'audio'
            };
            
            return typeMap[extension] || 'other';
        }

        // ==================== UI UPDATES ====================
        function updateDocumentCount() {
            const count = app.documents.length;
            document.getElementById('docCount').textContent = count;
            document.getElementById('totalDocs').textContent = count;
        }

        function updateUniversityFilter() {
            const select = document.getElementById('universityFilter');
            if (!select) return;
            
            // Clear existing options except first
            select.innerHTML = '<option value="">All Universities</option>';
            
            // Add universities
            Array.from(app.universities).sort().forEach(uni => {
                const option = document.createElement('option');
                option.value = uni;
                option.textContent = uni;
                select.appendChild(option);
            });
        }

        function loadDocumentsGrid() {
            const grid = document.getElementById('documentsGrid');
            const noDocs = document.getElementById('noDocumentsMessage');
            
            if (app.documents.length === 0) {
                grid.innerHTML = '';
                noDocs.style.display = 'block';
                return;
            }
            
            noDocs.style.display = 'none';
            
            // Apply filters
            const searchTerm = document.getElementById('searchInput')?.value || '';
            const university = document.getElementById('universityFilter')?.value || '';
            const type = document.getElementById('typeFilter')?.value || '';
            
            app.filterDocuments(searchTerm, university, type);
            
            if (app.filteredDocuments.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; color: var(--gray-light);"></i>
                        <h3>No Documents Found</h3>
                        <p>Try adjusting your search filters</p>
                        <button class="btn btn-primary mt-3" onclick="resetFilters()">
                            <i class="fas fa-redo"></i> Reset Filters
                        </button>
                    </div>
                `;
                return;
            }
            
            // Display documents
            grid.innerHTML = app.filteredDocuments.map(doc => createDocumentCard(doc)).join('');
        }

        function createDocumentCard(doc) {
            const icon = getDocumentIcon(doc.type);
            const formattedDate = formatDate(doc.updatedAt || doc.createdAt);
            
            return `
                <div class="document-card">
                    <div class="document-header">
                        <div class="doc-icon">
                            <i class="${icon}"></i>
                        </div>
                        <div class="doc-actions">
                            <button class="btn btn-sm btn-outline" onclick="viewDocument('${doc.id}')" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="downloadDocument('${doc.id}')" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="shareDocument('${doc.id}')" title="Share">
                                <i class="fas fa-share"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="doc-title">${doc.title}</div>
                    
                    <div class="doc-meta">
                        ${doc.unitCode ? `<span class="doc-tag">${doc.unitCode}</span>` : ''}
                        <span class="doc-tag">${doc.university}</span>
                        ${doc.year ? `<span class="doc-tag">Year ${doc.year}</span>` : ''}
                        <span class="doc-tag">${doc.type.toUpperCase()}</span>
                    </div>
                    
                    ${doc.description ? `<div class="doc-description">${doc.description}</div>` : ''}
                    
                    <div class="doc-stats">
                        <div class="doc-stat" title="Views">
                            <i class="fas fa-eye"></i>
                            <span>${doc.views || 0}</span>
                        </div>
                        <div class="doc-stat" title="Downloads">
                            <i class="fas fa-download"></i>
                            <span>${doc.downloads || 0}</span>
                        </div>
                        <div class="doc-stat" title="Last Updated">
                            <i class="fas fa-calendar"></i>
                            <span>${formattedDate}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getDocumentIcon(type) {
            const icons = {
                'pdf': 'fas fa-file-pdf',
                'doc': 'fas fa-file-word',
                'xls': 'fas fa-file-excel',
                'ppt': 'fas fa-file-powerpoint',
                'image': 'fas fa-file-image',
                'text': 'fas fa-file-alt',
                'video': 'fas fa-file-video',
                'audio': 'fas fa-file-audio',
                'archive': 'fas fa-file-archive',
                'other': 'fas fa-file'
            };
            
            return icons[type] || icons.other;
        }

        function updateSheetPreview(data) {
            const tbody = document.getElementById('sheetPreview');
            if (!tbody || !data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                            No sheet data loaded
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Show first 10 rows
            const previewData = data.slice(0, 10);
            
            tbody.innerHTML = previewData.map((row, index) => {
                const title = row[app.settings.columnMapping.title] || row['Title'] || '';
                const type = row[app.settings.columnMapping.type] || row['Type'] || '';
                const university = row[app.settings.columnMapping.university] || row['University'] || '';
                
                return `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                            ${title || '<span style="color: var(--text-secondary);">No title</span>'}
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                            <span class="doc-tag">${type || 'unknown'}</span>
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                            ${university || 'General'}
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                            <span style="color: var(--success); font-size: 12px;">
                                <i class="fas fa-check-circle"></i> Valid
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            if (data.length > 10) {
                tbody.innerHTML += `
                    <tr>
                        <td colspan="4" style="padding: 15px; text-align: center; color: var(--text-secondary); font-style: italic;">
                            <i class="fas fa-ellipsis-h"></i>
                            Showing 10 of ${data.length} rows
                        </td>
                    </tr>
                `;
            }
        }

        function updateSheetStatus(message, status) {
            const element = document.getElementById('sheetStatus') || document.getElementById('sheetConnectionStatus');
            if (!element) return;
            
            const icons = {
                'connected': 'fa-check-circle',
                'syncing': 'fa-sync-alt fa-spin',
                'error': 'fa-exclamation-circle',
                'default': 'fa-info-circle'
            };
            
            element.innerHTML = `
                <i class="fas ${icons[status] || icons.default}" 
                   style="color: ${status === 'connected' ? 'var(--success)' : 
                                 status === 'syncing' ? 'var(--warning)' : 
                                 status === 'error' ? 'var(--danger)' : 'var(--text-secondary)'};"></i>
                <span>${message}</span>
            `;
            element.className = `sheet-status ${status}`;
            
            // Update status text
            const statusText = document.getElementById('sheetStatusText');
            const connectionStatus = document.getElementById('connectionStatus');
            if (statusText) statusText.textContent = status === 'connected' ? 'Active' : 'Inactive';
            if (connectionStatus) {
                connectionStatus.textContent = status === 'connected' ? 'Connected' : 'Disconnected';
                connectionStatus.style.color = status === 'connected' ? 'var(--success)' : 'var(--warning)';
            }
        }

        function updateAnalytics() {
            // Update stats
            document.getElementById('totalViews').textContent = app.analytics.views.toLocaleString();
            document.getElementById('totalDownloads').textContent = app.analytics.downloads.toLocaleString();
            
            // Calculate daily views (simplified)
            const dailyViews = Math.floor(app.analytics.views / 30);
            document.getElementById('dailyViews').textContent = dailyViews.toLocaleString();
            
            // Find most popular document
            const popularDoc = app.documents.sort((a, b) => (b.views || 0) - (a.views || 0))[0];
            document.getElementById('popularDoc').textContent = popularDoc ? popularDoc.title.substring(0, 15) + '...' : '-';
            
            // Update last updated
            const lastUpdated = document.getElementById('lastUpdated');
            if (app.lastSync) {
                lastUpdated.textContent = formatRelativeTime(app.lastSync);
            }
            
            // Update sync status
            document.getElementById('syncStatus').textContent = 
                app.settings.syncInterval > 0 ? `${app.settings.syncInterval}m` : 'Off';
            
            // Update charts
            updateTypeChart();
            updateUniversityChart();
        }

        function updateTypeChart() {
            const typeCounts = {};
            app.documents.forEach(doc => {
                typeCounts[doc.type] = (typeCounts[doc.type] || 0) + 1;
            });
            
            const container = document.getElementById('typeChart');
            const types = Object.keys(typeCounts);
            const maxCount = Math.max(...Object.values(typeCounts));
            
            container.innerHTML = types.map(type => {
                const count = typeCounts[type];
                const height = (count / maxCount) * 180;
                const percentage = ((count / app.documents.length) * 100).toFixed(1);
                
                return `
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="width: 30px; height: ${height}px; background: var(--primary); border-radius: 4px 4px 0 0;"></div>
                        <div style="font-size: 10px; margin-top: 5px; color: var(--text-secondary); text-align: center;">
                            <div>${type}</div>
                            <div style="font-weight: bold; color: var(--text-primary);">${percentage}%</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateUniversityChart() {
            const container = document.getElementById('universityChart');
            const universityCounts = {};
            
            app.documents.forEach(doc => {
                universityCounts[doc.university] = (universityCounts[doc.university] || 0) + 1;
            });
            
            const sorted = Object.entries(universityCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            container.innerHTML = sorted.map(([uni, count]) => {
                const percentage = ((count / app.documents.length) * 100).toFixed(1);
                return `
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 12px; color: var(--text-primary);">${uni}</span>
                            <span style="font-size: 12px; color: var(--text-secondary);">${count} (${percentage}%)</span>
                        </div>
                        <div style="height: 6px; background: var(--bg-primary); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; background: var(--primary); width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== DOCUMENT OPERATIONS ====================
        function viewDocument(docId) {
            const doc = app.documents.find(d => d.id === docId);
            if (!doc) return;
            
            app.trackView(docId);
            
            // Open in new tab
            window.open(doc.url, '_blank');
            
            showNotification(`Opening ${doc.title}`, 'info');
            logActivity(`Viewed document: ${doc.title}`);
        }

        function downloadDocument(docId) {
            const doc = app.documents.find(d => d.id === docId);
            if (!doc) return;
            
            app.trackDownload(docId);
            
            // Create download link
            const link = document.createElement('a');
            link.href = doc.url;
            link.download = doc.title.replace(/[^a-z0-9]/gi, '_') + '.' + doc.type;
            link.click();
            
            showNotification(`Downloading ${doc.title}`, 'success');
            logActivity(`Downloaded document: ${doc.title}`);
        }

        function shareDocument(docId) {
            const doc = app.documents.find(d => d.id === docId);
            if (!doc) return;
            
            if (navigator.share) {
                navigator.share({
                    title: doc.title,
                    text: `Check out this study material: ${doc.title}`,
                    url: doc.url
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(`${doc.title}\n${doc.url}`)
                    .then(() => showNotification('Link copied to clipboard!', 'success'))
                    .catch(() => showNotification('Failed to copy link', 'error'));
            }
            
            logActivity(`Shared document: ${doc.title}`);
        }

        // ==================== FILE UPLOAD ====================
        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            const progressBar = document.getElementById('uploadProgressBar');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadFileName = document.getElementById('uploadFileName');
            
            uploadProgress.style.display = 'block';
            
            Array.from(files).forEach((file, index) => {
                if (file.size > CONFIG.maxFileSize) {
                    showNotification(`File ${file.name} is too large (max 50MB)`, 'error');
                    return;
                }
                
                uploadFileName.textContent = file.name;
                progressBar.style.width = '0%';
                
                // Simulate upload progress
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    progressBar.style.width = `${progress}%`;
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        
                        // Create document entry
                        const doc = {
                            title: file.name,
                            url: URL.createObjectURL(file),
                            type: detectFileTypeFromUrl(file.name),
                            university: app.settings.defaultUniversity || 'General',
                            description: `Uploaded file: ${file.name}`,
                            source: 'upload',
                            fileSize: formatFileSize(file.size)
                        };
                        
                        app.addDocument(doc);
                        app.analytics.uploads++;
                        
                        updateDocumentCount();
                        loadDocumentsGrid();
                        
                        showNotification(`Uploaded ${file.name}`, 'success');
                        logActivity(`Uploaded file: ${file.name}`);
                        
                        // Reset for next file
                        if (index === files.length - 1) {
                            setTimeout(() => {
                                uploadProgress.style.display = 'none';
                                event.target.value = '';
                            }, 1000);
                        }
                    }
                }, 100);
            });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showLoading(message) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            if (message) {
                document.getElementById('loadingMessage').textContent = message;
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                               type === 'error' ? 'fa-exclamation-circle' : 
                               type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 3000);
        }

        function logActivity(message) {
            const activityFeed = document.getElementById('activityFeed');
            if (!activityFeed) return;
            
            const activity = document.createElement('div');
            activity.innerHTML = `
                <div style="padding: 15px; background: var(--bg-secondary); border-radius: var(--radius); border-left: 4px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-primary); font-weight: 500;">System Activity</span>
                        <span style="color: var(--text-secondary); font-size: 12px;">Just now</span>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 13px; margin: 5px 0 0 0;">
                        ${message}
                    </p>
                </div>
            `;
            
            activityFeed.insertBefore(activity, activityFeed.firstChild);
            
            // Keep only last 10 activities
            while (activityFeed.children.length > 10) {
                activityFeed.removeChild(activityFeed.lastChild);
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - new Date(date);
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minutes ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays === 1) return 'Yesterday';
            return `${diffDays} days ago`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function fetchWithTimeout(url, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        // ==================== SYSTEM CONTROLS ====================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).style.display = 'block';
            
            // Activate tab button
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(tabName)) {
                    tab.classList.add('active');
                }
            });
            
            // Load content for specific tabs
            switch(tabName) {
                case 'documents':
                    loadDocumentsGrid();
                    break;
                case 'analytics':
                    updateAnalytics();
                    break;
                case 'settings':
                    loadSettingsUI();
                    break;
            }
        }

        function toggleTheme() {
            app.isDarkMode = !app.isDarkMode;
            localStorage.setItem('darkMode', app.isDarkMode);
            
            if (app.isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i> Theme';
            } else {
                document.documentElement.removeAttribute('data-theme');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i> Theme';
            }
        }

        function filterDocuments() {
            loadDocumentsGrid();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('universityFilter').value = '';
            document.getElementById('typeFilter').value = '';
            loadDocumentsGrid();
        }

        function refreshDocuments() {
            connectGoogleSheet();
        }

        function syncNow() {
            connectGoogleSheet();
        }

        function setupAutoSync() {
            if (app.syncInterval) {
                clearInterval(app.syncInterval);
            }
            
            if (app.settings.syncInterval > 0) {
                const intervalMs = app.settings.syncInterval * 60 * 1000;
                app.syncInterval = setInterval(() => {
                    if (app.sheetConnected) {
                        connectGoogleSheet();
                    }
                }, intervalMs);
                
                logActivity(`Auto-sync enabled (every ${app.settings.syncInterval} minutes)`);
            }
        }

        function testSheetConnection() {
            showLoading('Testing connection...');
            
            setTimeout(() => {
                if (app.sheetConnected) {
                    showNotification('Connection test successful!', 'success');
                } else {
                    showNotification('Connection test failed', 'error');
                }
                hideLoading();
            }, 1500);
        }

        function clearCache() {
            if (confirm('Clear all cached documents? This will not delete your Google Sheet connection.')) {
                app.documents = [];
                app.saveDocuments();
                updateDocumentCount();
                loadDocumentsGrid();
                showNotification('Cache cleared successfully', 'success');
                logActivity('Cleared document cache');
            }
        }

        function validateSheet() {
            showLoading('Validating sheet structure...');
            
            setTimeout(() => {
                if (app.sheetData && app.sheetData.length > 0) {
                    const sampleRow = app.sheetData[0];
                    const columns = Object.keys(sampleRow);
                    
                    showNotification(`Sheet validated: ${columns.length} columns found`, 'success');
                    logActivity(`Validated sheet with ${columns.length} columns`);
                } else {
                    showNotification('No sheet data to validate', 'warning');
                }
                hideLoading();
            }, 1000);
        }

        function exportToCSV() {
            if (app.documents.length === 0) {
                showNotification('No documents to export', 'warning');
                return;
            }
            
            const csvContent = [
                ['Title', 'URL', 'University', 'Type', 'Description', 'Unit Code', 'Year', 'Views', 'Downloads'],
                ...app.documents.map(doc => [
                    doc.title,
                    doc.url,
                    doc.university,
                    doc.type,
                    doc.description || '',
                    doc.unitCode || '',
                    doc.year || '',
                    doc.views || 0,
                    doc.downloads || 0
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `documents_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification(`Exported ${app.documents.length} documents to CSV`, 'success');
            logActivity('Exported documents to CSV');
        }

        function exportData() {
            const data = {
                documents: app.documents,
                settings: app.settings,
                analytics: app.analytics,
                exportDate: new Date().toISOString(),
                version: CONFIG.version
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `revisionvault_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Backup created successfully', 'success');
            logActivity('Created system backup');
        }

        function backupData() {
            exportData();
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (event) => {
                const file = event.target.files[0];
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.version) {
                            // Restore data
                            app.documents = data.documents || [];
                            app.settings = { ...app.settings, ...data.settings };
                            app.analytics = data.analytics || app.analytics;
                            
                            app.saveDocuments();
                            app.saveSettings();
                            
                            updateDocumentCount();
                            loadDocumentsGrid();
                            updateUniversityFilter();
                            updateAnalytics();
                            
                            showNotification('Data restored successfully', 'success');
                            logActivity('Restored system data from backup');
                        } else {
                            showNotification('Invalid backup file', 'error');
                        }
                    } catch (error) {
                        showNotification('Failed to restore backup', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function resetSystem() {
            if (confirm('Are you sure you want to reset the system? This will delete all local data.')) {
                localStorage.clear();
                location.reload();
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function initGoogleAuth() {
            if (!gapi.auth2) {
                showNotification('Google API not loaded. Please check your connection.', 'error');
                return;
            }
            
            const auth2 = gapi.auth2.getAuthInstance();
            auth2.signIn().then(() => {
                showNotification('Google account connected successfully!', 'success');
                closeModal('googleAuthModal');
                logActivity('Connected Google account');
            }).catch(error => {
                showNotification('Failed to connect Google account', 'error');
                console.error('Google auth error:', error);
            });
        }

        function connectGoogleDrive() {
            openModal('googleAuthModal');
        }

        function importBulkUrls() {
            const urlsText = document.getElementById('bulkUrls').value;
            const urls = urlsText.split('\n').filter(url => url.trim());
            
            if (urls.length === 0) {
                showNotification('Please enter some URLs', 'warning');
                return;
            }
            
            showLoading(`Importing ${urls.length} URLs...`);
            
            setTimeout(() => {
                urls.forEach((url, index) => {
                    const doc = {
                        title: `Imported Document ${index + 1}`,
                        url: url.trim(),
                        type: detectFileTypeFromUrl(url),
                        university: app.settings.defaultUniversity || 'General',
                        description: 'Imported from bulk URL import',
                        source: 'bulk-import'
                    };
                    
                    app.addDocument(doc);
                });
                
                hideLoading();
                updateDocumentCount();
                loadDocumentsGrid();
                
                showNotification(`Imported ${urls.length} documents`, 'success');
                logActivity(`Bulk imported ${urls.length} URLs`);
                
                document.getElementById('bulkUrls').value = '';
            }, 1000);
        }

        function validateUrls() {
            const urlsText = document.getElementById('bulkUrls').value;
            const urls = urlsText.split('\n').filter(url => url.trim());
            
            const validUrls = urls.filter(url => {
                try {
                    new URL(url);
                    return true;
                } catch {
                    return false;
                }
            });
            
            showNotification(`Validated: ${validUrls.length} valid URLs out of ${urls.length}`, 
                           validUrls.length === urls.length ? 'success' : 'warning');
        }

        function saveSheetSettings() {
            app.settings.sheetName = document.getElementById('sheetName').value;
            app.settings.syncInterval = parseInt(document.getElementById('syncInterval').value);
            
            // Column mapping
            app.settings.columnMapping.title = document.getElementById('colTitle').value;
            app.settings.columnMapping.url = document.getElementById('colUrl').value;
            app.settings.columnMapping.university = document.getElementById('colUniversity').value;
            app.settings.columnMapping.type = document.getElementById('colType').value;
            
            app.saveSettings();
            closeModal('sheetSettingsModal');
            
            showNotification('Settings saved successfully', 'success');
            logActivity('Updated sheet settings');
            
            // Restart auto-sync if needed
            setupAutoSync();
        }

        function loadSettingsUI() {
            // Load current settings into UI
            document.getElementById('defaultUniversity').value = app.settings.defaultUniversity;
            document.getElementById('itemsPerPage').value = app.settings.itemsPerPage;
            document.getElementById('autoRefresh').checked = app.settings.autoRefresh;
            document.getElementById('notifications').checked = app.settings.notifications;
            document.getElementById('apiEndpoint').value = CONFIG.apiEndpoint;
            document.getElementById('cacheDuration').value = app.settings.cacheDuration;
            
            // Populate default university dropdown
            const defaultUniSelect = document.getElementById('defaultUniversity');
            defaultUniSelect.innerHTML = '<option value="">Select default university</option>';
            Array.from(app.universities).sort().forEach(uni => {
                const option = document.createElement('option');
                option.value = uni;
                option.textContent = uni;
                defaultUniSelect.appendChild(option);
            });
            defaultUniSelect.value = app.settings.defaultUniversity;
        }

        function saveSettings() {
            app.settings.defaultUniversity = document.getElementById('defaultUniversity').value;
            app.settings.itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            app.settings.autoRefresh = document.getElementById('autoRefresh').checked;
            app.settings.notifications = document.getElementById('notifications').checked;
            app.settings.cacheDuration = parseInt(document.getElementById('cacheDuration').value);
            
            // Update API endpoint
            CONFIG.apiEndpoint = document.getElementById('apiEndpoint').value;
            
            app.saveSettings();
            
            showNotification('Settings saved successfully', 'success');
            logActivity('Updated system settings');
        }

        function loadDefaultSettings() {
            if (confirm('Reset all settings to defaults?')) {
                localStorage.removeItem('appSettings');
                app.settings = app.loadSettings();
                loadSettingsUI();
                showNotification('Settings reset to defaults', 'success');
                logActivity('Reset settings to defaults');
            }
        }

        // ==================== MAKE FUNCTIONS GLOBAL ====================
        window.switchTab = switchTab;
        window.connectGoogleSheet = connectGoogleSheet;
        window.refreshDocuments = refreshDocuments;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.initGoogleAuth = initGoogleAuth;
        window.connectGoogleDrive = connectGoogleDrive;
        window.importBulkUrls = importBulkUrls;
        window.validateUrls = validateUrls;
        window.viewDocument = viewDocument;
        window.downloadDocument = downloadDocument;
        window.shareDocument = shareDocument;
        window.filterDocuments = filterDocuments;
        window.resetFilters = resetFilters;
        window.syncNow = syncNow;
        window.testSheetConnection = testSheetConnection;
        window.clearCache = clearCache;
        window.validateSheet = validateSheet;
        window.exportToCSV = exportToCSV;
        window.exportData = exportData;
        window.backupData = backupData;
        window.restoreData = restoreData;
        window.resetSystem = resetSystem;
        window.toggleTheme = toggleTheme;
        window.saveSheetSettings = saveSheetSettings;
        window.saveSettings = saveSettings;
        window.loadDefaultSettings = loadDefaultSettings;
        window.handleFileUpload = handleFileUpload;

    </script>
</body>
</html>