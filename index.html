<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RevisionVault Pro - Premium University Materials</title>
    <style>
        :root {
            --primary: #1a2980;
            --secondary: #26d0ce;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f8fafc;
            --gray: #6b7280;
            --border: #e5e7eb;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #26d0ce 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        /* Tabs */
        .tabs-container {
            background: #f8fafc;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .tabs {
            display: flex;
            min-width: max-content;
        }

        .tab {
            padding: 20px 30px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            min-width: 200px;
            text-align: center;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Styles */
        .form-section {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            border: 2px solid var(--border);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .form-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 41, 128, 0.1);
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #34d399 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #f87171 100%);
            color: white;
        }

        /* Grid Layout */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Document Card */
        .document-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border);
            transition: var(--transition);
            height: 320px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .doc-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .doc-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .doc-meta {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .doc-description {
            font-size: 14px;
            color: var(--dark);
            line-height: 1.5;
            margin-bottom: 15px;
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .doc-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .doc-actions .btn {
            flex: 1;
            padding: 10px 15px;
            font-size: 14px;
        }

        /* University Filter */
        .university-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: var(--radius);
        }

        .university-btn {
            padding: 10px 20px;
            border-radius: 50px;
            background: white;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--border);
            white-space: nowrap;
            font-weight: 500;
        }

        .university-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-color: var(--primary);
        }

        /* ADVANCED DOCUMENT VIEWER */
        .advanced-viewer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            flex-direction: column;
        }

        .viewer-header {
            background: rgba(26, 41, 128, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            backdrop-filter: blur(10px);
        }

        .viewer-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .viewer-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        .viewer-toolbar {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .viewer-toolbar .btn {
            padding: 8px 15px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .viewer-toolbar .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .document-display-area {
            flex: 1;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        /* PDF Viewer Container */
        .pdf-viewer-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            background: #525659;
        }

        .pdf-canvas-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .pdf-page {
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            background: white;
        }

        .pdf-page canvas {
            display: block;
        }

        /* Image Viewer */
        .image-viewer-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            padding: 20px;
        }

        .image-viewer-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        /* Office Document Viewer */
        .office-viewer-container {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }

        /* Admin Panel */
        .admin-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            border: 2px solid var(--border);
            text-align: center;
        }

        .student-details-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
                min-width: 100%;
            }
            
            .tab {
                min-width: 100%;
                padding: 15px;
                text-align: left;
            }
            
            .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .university-filter {
                justify-content: center;
            }
            
            .viewer-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .viewer-toolbar .btn {
                flex: 1;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner" style="width: 60px; height: 60px; border: 5px solid #f3f4f6; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
        <h3 style="color: var(--primary); margin-bottom: 10px;">Loading RevisionVault Pro</h3>
    </div>

    <!-- Advanced Document Viewer -->
    <div class="advanced-viewer-overlay" id="advancedViewer">
        <div class="viewer-header">
            <h3 id="viewerDocTitle">Document Viewer</h3>
            <div class="viewer-controls">
                <button class="btn btn-primary" onclick="downloadCurrentDocument()">
                    <i class="fas fa-download"></i> Download
                </button>
                <button class="btn btn-danger" onclick="closeAdvancedViewer()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        
        <div class="viewer-content">
            <div class="viewer-toolbar">
                <button class="btn" onclick="zoomIn()">
                    <i class="fas fa-search-plus"></i> Zoom In
                </button>
                <button class="btn" onclick="zoomOut()">
                    <i class="fas fa-search-minus"></i> Zoom Out
                </button>
                <button class="btn" onclick="resetZoom()">
                    <i class="fas fa-expand-arrows-alt"></i> Fit to Width
                </button>
                <button class="btn" onclick="prevPage()">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span style="color: white; padding: 5px 15px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                    Page: <span id="currentPageNum">1</span> / <span id="totalPagesNum">1</span>
                </span>
                <button class="btn" onclick="nextPage()">
                    <i class="fas fa-chevron-right"></i> Next
                </button>
                <button class="btn" onclick="rotateDocument()">
                    <i class="fas fa-redo"></i> Rotate
                </button>
                <button class="btn" onclick="printDocument()">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn" onclick="toggleFullscreen()">
                    <i class="fas fa-expand"></i> Fullscreen
                </button>
            </div>
            
            <div class="document-display-area" id="documentDisplayArea">
                <!-- Content will be loaded here based on document type -->
                <div id="pdfViewer" class="pdf-viewer-container" style="display: none;">
                    <div class="pdf-canvas-container" id="pdfCanvasContainer"></div>
                </div>
                
                <div id="imageViewer" class="image-viewer-container" style="display: none;">
                    <img id="imageDisplay" src="" alt="">
                </div>
                
                <iframe id="officeViewer" class="office-viewer-container" style="display: none;" frameborder="0"></iframe>
                
                <div id="fallbackViewer" style="display: none; padding: 40px; text-align: center; color: white;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
                    <h3>Document Preview Not Available</h3>
                    <p>This document type cannot be previewed directly.</p>
                    <button class="btn btn-primary" onclick="downloadCurrentDocument()" style="margin-top: 20px;">
                        <i class="fas fa-download"></i> Download to View
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay"></div>

    <!-- Student Details Modal -->
    <div class="student-details-modal" id="studentDetailsModal">
        <div class="form-title">
            <i class="fas fa-user"></i>
            <span>Student Details</span>
            <button onclick="closeStudentModal()" style="margin-left: auto; background: none; border: none; color: var(--gray); cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="studentDetailsContent"></div>
        <div class="admin-controls" style="margin-top: 20px;">
            <button class="btn btn-success" onclick="unlockStudentFromModal()">
                <i class="fas fa-unlock"></i> Unlock Access
            </button>
            <button class="btn btn-danger" onclick="forceLogoutStudent()">
                <i class="fas fa-sign-out-alt"></i> Force Logout
            </button>
            <button class="btn" onclick="closeStudentModal()" style="background: #e5e7eb;">
                Close
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                <div style="width: 60px; height: 60px; border-radius: 16px; background: rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: center; font-size: 28px;">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div>
                    <h1>RevisionVault Pro</h1>
                    <p>Premium University Study Materials Platform</p>
                </div>
            </div>
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 10px;">
                <span><i class="fas fa-shield-alt"></i> Ksh 67 for 5 Months</span>
                <span><i class="fas fa-user-check"></i> Admin Approval Required</span>
                <span><i class="fas fa-unlock"></i> Full Document Access</span>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('student')">
                    <i class="fas fa-user-graduate"></i>
                    <span>Student Portal</span>
                </div>
                <div class="tab" onclick="switchTab('documents')" id="documentsTab">
                    <i class="fas fa-file-alt"></i>
                    <span>Study Materials</span>
                </div>
                <div class="tab" onclick="switchTab('admin')" id="adminTab">
                    <i class="fas fa-user-shield"></i>
                    <span>Admin Panel</span>
                </div>
            </div>
        </div>

        <!-- ==================== STUDENT PORTAL ==================== -->
        <div id="student" class="tab-content active">
            <div class="registration-flow">
                <!-- Step 1: Registration -->
                <div id="step1" class="form-section">
                    <div class="form-title">
                        <i class="fas fa-user-plus"></i>
                        <span>Student Registration</span>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="regFullName" class="form-control" placeholder="Enter your full name" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address *</label>
                            <input type="email" id="regEmail" class="form-control" placeholder="Enter your email" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Number *</label>
                            <input type="tel" id="regPhone" class="form-control" placeholder="07XXXXXXXX" maxlength="10" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Select University *</label>
                            <select id="regUniversity" class="form-control" required>
                                <option value="">-- Select Your University --</option>
                                <option value="University of Nairobi">University of Nairobi (UoN)</option>
                                <option value="Kenyatta University">Kenyatta University (KU)</option>
                                <option value="Jomo Kenyatta University of Agriculture and Technology">JKUAT</option>
                                <option value="Moi University">Moi University</option>
                                <option value="Egerton University">Egerton University</option>
                                <option value="Maseno University">Maseno University</option>
                                <option value="Technical University of Kenya">Technical University of Kenya</option>
                                <option value="University of Eldoret">University of Eldoret (UoE)</option>
                                <option value="Strathmore University">Strathmore University</option>
                                <option value="Mount Kenya University">Mount Kenya University</option>
                                <option value="Daystar University">Daystar University</option>
                                <option value="Catholic University of Eastern Africa">Catholic University of Eastern Africa</option>
                                <option value="Other">Other University</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Course/Program *</label>
                            <input type="text" id="regCourse" class="form-control" placeholder="e.g., Bachelor of Computer Science" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Year of Study *</label>
                            <select id="regYear" class="form-control" required>
                                <option value="">Select year</option>
                                <option value="1">Year 1</option>
                                <option value="2">Year 2</option>
                                <option value="3">Year 3</option>
                                <option value="4">Year 4</option>
                                <option value="5">Year 5</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="registerStudent()" style="width: 100%; padding: 16px; margin-top: 10px;">
                        <i class="fas fa-user-plus"></i> Register Account
                    </button>
                </div>

                <!-- Step 2: Account Dashboard -->
                <div id="step2" class="form-section" style="display: none;">
                    <div class="form-title">
                        <i class="fas fa-user-check"></i>
                        <span>Your Account Dashboard</span>
                    </div>
                    
                    <div class="grid-2">
                        <div class="card" style="background: white; border-radius: var(--radius); padding: 20px; border: 2px solid var(--border);">
                            <div class="form-title" style="font-size: 18px; margin-bottom: 15px;">
                                <i class="fas fa-user"></i>
                                <span>Personal Information</span>
                            </div>
                            <div class="form-group">
                                <label>Full Name</label>
                                <div class="form-control" style="background: #f8fafc;" id="accountName"></div>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <div class="form-control" style="background: #f8fafc;" id="accountEmail"></div>
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <div class="form-control" style="background: #f8fafc;" id="accountPhone"></div>
                            </div>
                        </div>
                        
                        <div class="card" style="background: white; border-radius: var(--radius); padding: 20px; border: 2px solid var(--border);">
                            <div class="form-title" style="font-size: 18px; margin-bottom: 15px;">
                                <i class="fas fa-graduation-cap"></i>
                                <span>Academic Information</span>
                            </div>
                            <div class="form-group">
                                <label>University</label>
                                <div class="form-control" style="background: #f8fafc;" id="accountUniversity"></div>
                            </div>
                            <div class="form-group">
                                <label>Course</label>
                                <div class="form-control" style="background: #f8fafc;" id="accountCourse"></div>
                            </div>
                            <div class="form-group">
                                <label>Year of Study</label>
                                <div class="form-control" style="background: #f8fafc;" id="accountYear"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px; text-align: center; background: white; border-radius: var(--radius); padding: 20px; border: 2px solid var(--border);">
                        <div class="form-title" style="font-size: 18px; margin-bottom: 15px;">
                            <i class="fas fa-unlock-alt"></i>
                            <span>Subscription Status</span>
                        </div>
                        <div id="subscriptionStatus">
                            <div style="padding: 15px; background: #fee2e2; border-radius: 8px; display: inline-block;">
                                <i class="fas fa-lock" style="color: var(--danger);"></i>
                                <span style="color: var(--danger); font-weight: 600;">Not Subscribed</span>
                            </div>
                            <p style="color: var(--gray); margin-top: 10px;">
                                Subscribe to unlock access to all study materials
                            </p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="goToPayment()" id="paymentBtn" style="padding: 16px 40px;">
                            <i class="fas fa-credit-card"></i> Subscribe Now (Ksh 67)
                        </button>
                    </div>
                </div>

                <!-- Step 3: Payment -->
                <div id="step3" class="form-section" style="display: none;">
                    <div class="form-title">
                        <i class="fas fa-credit-card"></i>
                        <span>Subscribe & Pay</span>
                    </div>
                    
                    <div class="card" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 3px solid var(--success); padding: 20px; border-radius: var(--radius);">
                        <div class="form-title" style="font-size: 18px; color: var(--success);">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Payment Instructions</span>
                        </div>
                        <p>Send <strong>Ksh 67</strong> to:</p>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary); margin: 15px 0;">0765 098 865</div>
                        <p>via <strong>M-Pesa</strong> then submit your transaction details below.</p>
                    </div>
                    
                    <div class="grid-2" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>M-Pesa Transaction Code *</label>
                            <input type="text" id="paymentCode" class="form-control" placeholder="Enter transaction code" required>
                            <small style="color: var(--gray);">e.g., RCG8H9W2X</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Date *</label>
                            <input type="date" id="paymentDate" class="form-control" required>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-success" onclick="submitPayment()" style="flex: 1; padding: 16px;">
                            <i class="fas fa-paper-plane"></i> Submit Payment for Approval
                        </button>
                        <button class="btn" onclick="goToAccount()" style="padding: 16px; background: #e5e7eb;">
                            <i class="fas fa-arrow-left"></i> Back to Account
                        </button>
                    </div>
                </div>

                <!-- Step 4: Unlock Code -->
                <div id="step4" class="form-section" style="display: none;">
                    <div class="form-title">
                        <i class="fas fa-unlock-alt"></i>
                        <span>Unlock Your Account</span>
                    </div>
                    
                    <div id="pendingApproval" class="card" style="text-align: center; padding: 40px; background: white; border-radius: var(--radius); border: 2px solid var(--border);">
                        <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, var(--warning) 0%, #fbbf24 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 36px;">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3 style="color: var(--warning); margin-bottom: 15px;">Waiting for Admin Approval</h3>
                        <p style="color: var(--gray); margin-bottom: 20px;">
                            Your payment is being reviewed by the admin. You'll receive an unlock code via WhatsApp once approved.
                        </p>
                    </div>
                    
                    <div id="readyForUnlock" style="display: none;">
                        <div class="card" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 3px solid var(--success); text-align: center; padding: 30px; border-radius: var(--radius);">
                            <div style="width: 60px; height: 60px; margin: 0 auto 15px; border-radius: 50%; background: var(--success); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                <i class="fas fa-check"></i>
                            </div>
                            <h3 style="color: var(--success); margin-bottom: 15px;">Payment Approved!</h3>
                            <p style="color: var(--gray); margin-bottom: 20px;">
                                Enter your unlock code below to access all study materials:
                            </p>
                            
                            <div style="max-width: 400px; margin: 20px auto;">
                                <input type="text" id="unlockCodeInput" class="form-control" placeholder="Enter unlock code from admin" style="text-align: center; font-size: 18px; letter-spacing: 2px; padding: 15px;">
                            </div>
                            
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                                <button class="btn btn-success" onclick="verifyUnlockCode()" style="padding: 15px 30px;">
                                    <i class="fas fa-unlock"></i> Unlock Account
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="accessGranted" style="display: none; text-align: center; padding: 40px;">
                        <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, var(--success) 0%, #34d399 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 36px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3 style="color: var(--success); margin-bottom: 15px;">Access Granted!</h3>
                        <p style="color: var(--gray); margin-bottom: 20px; font-size: 18px;">
                            ðŸŽ‰ Congratulations! You now have full access to all study materials for 5 months.
                        </p>
                        <button class="btn btn-primary" onclick="switchTab('documents')" style="padding: 15px 40px;">
                            <i class="fas fa-book"></i> Access Study Materials
                        </button>
                    </div>
                </div>
            </div>

            <!-- Login Section -->
            <div id="loginSection" class="form-section" style="margin-top: 30px; background: #f8fafc; border: 2px solid #e5e7eb;">
                <h3 style="color: var(--primary); margin-bottom: 20px; text-align: center;">Already have an account?</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: center;">
                    <input type="text" id="loginPhone" placeholder="Phone Number" class="form-control" style="max-width: 200px;">
                    <button class="btn btn-primary" onclick="loginStudent()" style="padding: 12px 30px;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== DOCUMENTS SECTION ==================== -->
        <div id="documents" class="tab-content">
            <div class="form-section">
                <div class="form-title">
                    <i class="fas fa-file-alt"></i>
                    <span>University Study Materials</span>
                </div>
                
                <!-- Access Status -->
                <div id="accessStatusBar" class="card" style="margin-bottom: 30px; text-align: center; background: white; border-radius: var(--radius); padding: 20px; border: 2px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <div style="text-align: left;">
                            <h4 id="accessStatusText" style="color: var(--danger); margin-bottom: 5px;">
                                <i class="fas fa-lock"></i> Access Locked
                            </h4>
                            <p style="color: var(--gray); font-size: 14px;">Subscribe to unlock all materials</p>
                        </div>
                        <button class="btn btn-primary" onclick="switchTab('student')" id="subscribeBtnDocs">
                            <i class="fas fa-crown"></i> Subscribe Now
                        </button>
                    </div>
                </div>

                <!-- University Filter -->
                <div class="university-filter">
                    <span style="font-weight: 600; color: var(--primary);">Filter by University:</span>
                    <button class="university-btn active" onclick="filterByUniversity('all')">All Universities</button>
                    <button class="university-btn" onclick="filterByUniversity('University of Nairobi')">UoN</button>
                    <button class="university-btn" onclick="filterByUniversity('Kenyatta University')">KU</button>
                    <button class="university-btn" onclick="filterByUniversity('Jomo Kenyatta University of Agriculture and Technology')">JKUAT</button>
                    <button class="university-btn" onclick="filterByUniversity('Moi University')">Moi</button>
                    <button class="university-btn" onclick="filterByUniversity('Egerton University')">Egerton</button>
                    <button class="university-btn" onclick="filterByUniversity('Maseno University')">Maseno</button>
                    <button class="university-btn" onclick="filterByUniversity('Technical University of Kenya')">TUK</button>
                    <button class="university-btn" onclick="filterByUniversity('University of Eldoret')">UoE</button>
                    <button class="university-btn" onclick="filterByUniversity('Strathmore University')">Strathmore</button>
                    <button class="university-btn" onclick="filterByUniversity('Other')">Other</button>
                </div>

                <!-- Search -->
                <div style="position: relative; margin-bottom: 20px;">
                    <i class="fas fa-search" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: var(--gray);"></i>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by unit code, title, or subject..." style="padding-left: 50px;">
                </div>

                <!-- Documents Grid -->
                <div class="grid-3" id="documentsGrid">
                    <!-- Documents will be loaded here -->
                </div>
                
                <!-- Pagination -->
                <div id="pagination" style="display: none; text-align: center; margin-top: 40px;">
                    <div style="display: flex; justify-content: center; gap: 10px; align-items: center;">
                        <button class="btn" onclick="changePage(-1)" style="background: #e5e7eb;">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span style="padding: 10px 20px; background: #f8fafc; border-radius: 8px;">
                            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                        </span>
                        <button class="btn" onclick="changePage(1)" style="background: #e5e7eb;">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ADMIN PANEL ==================== -->
        <div id="admin" class="tab-content">
            <!-- Admin Login -->
            <div id="adminLogin" class="form-section" style="max-width: 500px; margin: 0 auto;">
                <div class="form-title">
                    <i class="fas fa-user-shield"></i>
                    <span>Admin Panel Access</span>
                </div>
                
                <div class="form-group">
                    <label>Admin Password</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password" value="admin123">
                </div>
                
                <button class="btn btn-primary" onclick="adminLogin()" style="width: 100%; padding: 16px; margin-top: 10px;">
                    <i class="fas fa-sign-in-alt"></i> Access Admin Dashboard
                </button>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" style="display: none;">
                <!-- Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="font-size: 32px; font-weight: 800; margin: 10px 0;" id="totalUsers">0</div>
                        <div>Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 32px; font-weight: 800; margin: 10px 0;" id="pendingApprovals">0</div>
                        <div>Pending Approvals</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 32px; font-weight: 800; margin: 10px 0;" id="totalDocuments">0</div>
                        <div>Total Documents</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 32px; font-weight: 800; margin: 10px 0;" id="totalRevenue">Ksh 0</div>
                        <div>Total Revenue</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="admin-controls">
                    <button class="btn btn-primary" onclick="switchAdminTab('approvals')">
                        <i class="fas fa-user-check"></i> Pending Approvals
                    </button>
                    <button class="btn btn-success" onclick="switchAdminTab('users')">
                        <i class="fas fa-users"></i> All Users
                    </button>
                    <button class="btn" onclick="switchAdminTab('upload')" style="background: #e5e7eb;">
                        <i class="fas fa-upload"></i> Upload Documents
                    </button>
                    <button class="btn btn-danger" onclick="adminLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout Admin
                    </button>
                </div>

                <!-- Pending Approvals Tab -->
                <div id="adminApprovalsTab" class="admin-tab-content" style="display: block;">
                    <div class="form-title">
                        <i class="fas fa-user-check"></i>
                        <span>Pending Approvals</span>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 15px; text-align: left;">Date</th>
                                    <th style="padding: 15px; text-align: left;">Student</th>
                                    <th style="padding: 15px; text-align: left;">Phone</th>
                                    <th style="padding: 15px; text-align: left;">University</th>
                                    <th style="padding: 15px; text-align: left;">Transaction Code</th>
                                    <th style="padding: 15px; text-align: left;">Amount</th>
                                    <th style="padding: 15px; text-align: left;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingPaymentsTable">
                                <!-- Payments will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- All Users Tab -->
                <div id="adminUsersTab" class="admin-tab-content" style="display: none;">
                    <div class="form-title">
                        <i class="fas fa-users"></i>
                        <span>All Users</span>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 15px; text-align: left;">Name</th>
                                    <th style="padding: 15px; text-align: left;">Email</th>
                                    <th style="padding: 15px; text-align: left;">Phone</th>
                                    <th style="padding: 15px; text-align: left;">University</th>
                                    <th style="padding: 15px; text-align: left;">Status</th>
                                    <th style="padding: 15px; text-align: left;">Last Login</th>
                                    <th style="padding: 15px; text-align: left;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allUsersTable">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Upload Documents Tab -->
                <div id="adminUploadTab" class="admin-tab-content" style="display: none;">
                    <div class="form-section">
                        <div class="form-title">
                            <i class="fas fa-upload"></i>
                            <span>Upload New Document</span>
                        </div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Document Title *</label>
                                <input type="text" id="docTitle" class="form-control" placeholder="Enter document title" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Unit Code *</label>
                                <input type="text" id="docUnitCode" class="form-control" placeholder="e.g., BOTA241" required>
                            </div>
                            
                            <div class="form-group">
                                <label>University *</label>
                                <select id="docUniversity" class="form-control" required>
                                    <option value="">-- Select University --</option>
                                    <option value="University of Nairobi">University of Nairobi</option>
                                    <option value="Kenyatta University">Kenyatta University</option>
                                    <option value="Jomo Kenyatta University of Agriculture and Technology">JKUAT</option>
                                    <option value="Moi University">Moi University</option>
                                    <option value="Egerton University">Egerton University</option>
                                    <option value="Maseno University">Maseno University</option>
                                    <option value="Technical University of Kenya">Technical University of Kenya</option>
                                    <option value="University of Eldoret">University of Eldoret (UoE)</option>
                                    <option value="Strathmore University">Strathmore University</option>
                                    <option value="All">All Universities</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Document Type *</label>
                                <select id="docType" class="form-control" required onchange="toggleLinkFields()">
                                    <option value="">-- Select Type --</option>
                                    <option value="pdf">PDF Document</option>
                                    <option value="word">Word Document</option>
                                    <option value="excel">Excel Spreadsheet</option>
                                    <option value="powerpoint">PowerPoint</option>
                                    <option value="image">Image</option>
                                    <option value="video">Video</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Subject</label>
                                <input type="text" id="docSubject" class="form-control" placeholder="e.g., Botany, Computer Science">
                            </div>
                            
                            <div class="form-group">
                                <label>Year</label>
                                <select id="docYear" class="form-control">
                                    <option value="">Any Year</option>
                                    <option value="1">Year 1</option>
                                    <option value="2">Year 2</option>
                                    <option value="3">Year 3</option>
                                    <option value="4">Year 4</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Document URL *</label>
                            <input type="url" id="docUrl" class="form-control" placeholder="https://drive.google.com/file/d/..." required>
                            <small style="color: var(--gray);">Enter direct link to document. For Google Drive, use "Anyone with link can view"</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="docDescription" class="form-control" rows="3" placeholder="Document description..."></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button class="btn btn-success" onclick="uploadDocument()" style="flex: 1; padding: 16px;">
                                <i class="fas fa-upload"></i> Upload Document
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Copyright Footer -->
        <div style="text-align: center; padding: 25px; color: var(--gray); border-top: 1px solid var(--border); background: #f8f9fa;">
            <p>&copy; 2025 RevisionVault Pro. Developed by Walter Zauko â€¢ Contact: 0765 098 865</p>
        </div>
    </div>

    <script>
        // ==================== INITIALIZATION ====================
        let currentStudent = null;
        let students = JSON.parse(localStorage.getItem('revisionvault_students')) || [];
        let payments = JSON.parse(localStorage.getItem('revisionvault_payments')) || [];
        let documents = JSON.parse(localStorage.getItem('revisionvault_documents')) || [];
        let adminPassword = "admin123";
        let currentPage = 1;
        const docsPerPage = 9;
        let currentUniversityFilter = 'all';
        let selectedStudentId = null;
        let currentViewingDocument = null;
        
        // PDF.js variables
        let pdfDoc = null;
        let currentPDFPage = 1;
        let scale = 1.0;
        let rotation = 0;
        let pdfRendering = false;
        let pdfQueue = [];

        // ==================== PERSISTENT LOGIN SYSTEM ====================
        function checkPersistentLogin() {
            const savedStudentId = localStorage.getItem('currentStudentId');
            const savedLoginTime = localStorage.getItem('loginTime');
            
            if (savedStudentId && savedLoginTime) {
                // Check if login is still valid (30 days)
                const loginTime = new Date(savedLoginTime);
                const now = new Date();
                const daysDifference = (now - loginTime) / (1000 * 60 * 60 * 24);
                
                if (daysDifference < 30) { // 30-day session
                    const student = students.find(s => s.id === savedStudentId);
                    if (student && student.status !== 'force-logged-out') {
                        currentStudent = student;
                        updateStudentDisplay(student);
                        updateAccessStatus();
                        
                        if (student.subscription.active) {
                            showStep(2);
                        } else if (student.paymentStatus === 'pending') {
                            showStep(4);
                            document.getElementById('pendingApproval').style.display = 'block';
                            document.getElementById('readyForUnlock').style.display = 'none';
                        } else if (student.paymentStatus === 'approved') {
                            showStep(4);
                            document.getElementById('pendingApproval').style.display = 'none';
                            document.getElementById('readyForUnlock').style.display = 'block';
                        } else {
                            showStep(2);
                        }
                        return true;
                    }
                }
            }
            
            // Clear invalid session
            localStorage.removeItem('currentStudentId');
            localStorage.removeItem('loginTime');
            return false;
        }

        function saveLoginSession(studentId) {
            localStorage.setItem('currentStudentId', studentId);
            localStorage.setItem('loginTime', new Date().toISOString());
        }

        function clearLoginSession() {
            localStorage.removeItem('currentStudentId');
            localStorage.removeItem('loginTime');
        }

        // ==================== ADVANCED DOCUMENT VIEWER ====================
        function openAdvancedViewer(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc) return;

            currentViewingDocument = doc;
            
            // Update view count
            doc.views = (doc.views || 0) + 1;
            doc.lastAccessed = new Date().toISOString();
            saveToStorage();
            
            // Update student's accessed documents
            if (currentStudent && !currentStudent.documentsAccessed) {
                currentStudent.documentsAccessed = [];
            }
            if (currentStudent && !currentStudent.documentsAccessed.includes(docId)) {
                currentStudent.documentsAccessed.push(docId);
                updateStudentInStorage(currentStudent);
            }

            // Show viewer
            document.getElementById('viewerDocTitle').textContent = doc.title;
            document.getElementById('advancedViewer').style.display = 'flex';
            
            // Reset viewer state
            currentPDFPage = 1;
            scale = 1.0;
            rotation = 0;
            
            // Load document based on type
            loadDocumentForViewer(doc);
        }

        function loadDocumentForViewer(doc) {
            // Hide all viewers first
            document.getElementById('pdfViewer').style.display = 'none';
            document.getElementById('imageViewer').style.display = 'none';
            document.getElementById('officeViewer').style.display = 'none';
            document.getElementById('fallbackViewer').style.display = 'none';
            
            const url = doc.url || doc.driveLink;
            if (!url) {
                document.getElementById('fallbackViewer').style.display = 'block';
                return;
            }

            const fileExtension = url.split('.').pop().toLowerCase();
            const docType = doc.type || getFileTypeFromExtension(fileExtension);

            switch(docType) {
                case 'pdf':
                    loadPDFDocument(url);
                    break;
                case 'image':
                    loadImageDocument(url);
                    break;
                case 'word':
                case 'excel':
                case 'powerpoint':
                    loadOfficeDocument(url);
                    break;
                default:
                    // Try to open in iframe as fallback
                    loadGenericDocument(url);
            }
        }

        function getFileTypeFromExtension(ext) {
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
            const pdfExts = ['pdf'];
            const wordExts = ['doc', 'docx'];
            const excelExts = ['xls', 'xlsx', 'csv'];
            const pptExts = ['ppt', 'pptx'];
            
            if (imageExts.includes(ext)) return 'image';
            if (pdfExts.includes(ext)) return 'pdf';
            if (wordExts.includes(ext)) return 'word';
            if (excelExts.includes(ext)) return 'excel';
            if (pptExts.includes(ext)) return 'powerpoint';
            return 'unknown';
        }

        function loadPDFDocument(url) {
            document.getElementById('pdfViewer').style.display = 'block';
            document.getElementById('pdfCanvasContainer').innerHTML = '';
            
            // Configure PDF.js
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            // Load the PDF
            const loadingTask = pdfjsLib.getDocument(url);
            loadingTask.promise.then(function(pdf) {
                pdfDoc = pdf;
                document.getElementById('totalPagesNum').textContent = pdf.numPages;
                renderPDFPage(currentPDFPage);
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
                // Fallback to iframe
                document.getElementById('pdfViewer').style.display = 'none';
                loadGenericDocument(url);
            });
        }

        function renderPDFPage(num) {
            if (pdfRendering) {
                pdfQueue.push(num);
                return;
            }
            
            pdfRendering = true;
            
            pdfDoc.getPage(num).then(function(page) {
                const container = document.getElementById('pdfCanvasContainer');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate viewport
                const viewport = page.getViewport({ scale: scale, rotation: rotation });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                // Render PDF page
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                renderTask.promise.then(function() {
                    // Clear container and add canvas
                    container.innerHTML = '';
                    
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'pdf-page';
                    pageDiv.style.width = viewport.width + 'px';
                    pageDiv.style.height = viewport.height + 'px';
                    pageDiv.appendChild(canvas);
                    
                    container.appendChild(pageDiv);
                    
                    // Update page counter
                    document.getElementById('currentPageNum').textContent = num;
                    
                    pdfRendering = false;
                    
                    // Render next in queue if any
                    if (pdfQueue.length > 0) {
                        renderPDFPage(pdfQueue.shift());
                    }
                });
            });
        }

        function loadImageDocument(url) {
            document.getElementById('imageViewer').style.display = 'flex';
            const img = document.getElementById('imageDisplay');
            img.src = url;
            img.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
            
            // Add zoom on wheel
            img.onwheel = function(e) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            };
        }

        function loadOfficeDocument(url) {
            document.getElementById('officeViewer').style.display = 'block';
            const iframe = document.getElementById('officeViewer');
            
            // Convert to Microsoft Office Online Viewer URL
            if (url.includes('drive.google.com')) {
                // Extract file ID from Google Drive URL
                const match = url.match(/\/d\/([^\/]+)/);
                if (match) {
                    const fileId = match[1];
                    // Use Google Drive preview for office docs
                    iframe.src = `https://drive.google.com/file/d/${fileId}/preview`;
                } else {
                    iframe.src = url;
                }
            } else {
                // Use Microsoft Office Online Viewer
                iframe.src = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
            }
        }

        function loadGenericDocument(url) {
            document.getElementById('officeViewer').style.display = 'block';
            document.getElementById('officeViewer').src = url;
        }

        function closeAdvancedViewer() {
            document.getElementById('advancedViewer').style.display = 'none';
            document.getElementById('pdfViewer').style.display = 'none';
            document.getElementById('imageViewer').style.display = 'none';
            document.getElementById('officeViewer').style.display = 'none';
            document.getElementById('fallbackViewer').style.display = 'none';
            
            // Clear PDF doc
            pdfDoc = null;
            pdfQueue = [];
        }

        function zoomIn() {
            scale += 0.1;
            updateViewerZoom();
        }

        function zoomOut() {
            if (scale > 0.2) {
                scale -= 0.1;
                updateViewerZoom();
            }
        }

        function resetZoom() {
            scale = 1.0;
            updateViewerZoom();
        }

        function updateViewerZoom() {
            // Update image viewer
            const img = document.getElementById('imageDisplay');
            if (img.style.display !== 'none') {
                img.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
            }
            
            // Update PDF viewer
            if (pdfDoc) {
                renderPDFPage(currentPDFPage);
            }
        }

        function rotateDocument() {
            rotation = (rotation + 90) % 360;
            updateViewerZoom();
        }

        function prevPage() {
            if (pdfDoc && currentPDFPage > 1) {
                currentPDFPage--;
                renderPDFPage(currentPDFPage);
            }
        }

        function nextPage() {
            if (pdfDoc && currentPDFPage < pdfDoc.numPages) {
                currentPDFPage++;
                renderPDFPage(currentPDFPage);
            }
        }

        function downloadCurrentDocument() {
            if (!currentViewingDocument) return;
            
            const url = currentViewingDocument.url || currentViewingDocument.driveLink;
            if (!url) return;
            
            // Create download link
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentViewingDocument.unitCode}_${currentViewingDocument.title.replace(/\s+/g, '_')}`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printDocument() {
            const printWindow = window.open('', '_blank');
            if (currentViewingDocument) {
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>${currentViewingDocument.title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h1 { color: #1a2980; }
                            .meta { color: #666; margin-bottom: 20px; }
                            iframe { width: 100%; height: 90vh; border: none; }
                        </style>
                    </head>
                    <body>
                        <h1>${currentViewingDocument.title}</h1>
                        <div class="meta">
                            ${currentViewingDocument.unitCode} â€¢ ${currentViewingDocument.university}
                        </div>
                        <iframe src="${currentViewingDocument.url || currentViewingDocument.driveLink}"></iframe>
                        <script>
                            window.onload = function() {
                                setTimeout(function() {
                                    window.print();
                                    setTimeout(function() { window.close(); }, 1000);
                                }, 2000);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            }
        }

        function toggleFullscreen() {
            const viewer = document.getElementById('advancedViewer');
            if (!document.fullscreenElement) {
                if (viewer.requestFullscreen) {
                    viewer.requestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // ==================== STUDENT FUNCTIONS ====================
        function registerStudent() {
            const fullName = document.getElementById('regFullName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const university = document.getElementById('regUniversity').value;
            const course = document.getElementById('regCourse').value.trim();
            const year = document.getElementById('regYear').value;

            if (!fullName || !email || !phone || !university || !course || !year) {
                alert('Please fill all required fields');
                return;
            }

            if (phone.length !== 10 || !phone.startsWith('07')) {
                alert('Please enter a valid 10-digit Kenyan phone number starting with 07');
                return;
            }

            // Check if student already exists
            if (students.some(s => s.phone === phone)) {
                alert('Student with this phone already exists. Please login.');
                return;
            }

            // Create student
            const student = {
                id: 'STU_' + Date.now() + Math.random().toString(36).substr(2, 9),
                fullName,
                email,
                phone,
                university,
                course,
                year,
                status: 'registered',
                registrationDate: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                loginHistory: [new Date().toISOString()],
                subscription: {
                    active: false,
                    startDate: null,
                    endDate: null
                },
                paymentStatus: 'none',
                unlockCode: null,
                documentsAccessed: [],
                isForceLoggedOut: false
            };

            students.push(student);
            currentStudent = student;
            saveToStorage();
            
            // Save login session
            saveLoginSession(student.id);

            updateStudentDisplay(student);
            showStep(2);
            alert(`Registration successful! Welcome ${fullName.split(' ')[0]}!`);
        }

        function loginStudent() {
            const phone = document.getElementById('loginPhone').value.trim();
            const student = students.find(s => s.phone === phone && !s.isForceLoggedOut);
            
            if (!student) {
                alert('Student not found or account has been logged out by admin.');
                return;
            }

            // Update login info
            student.lastLogin = new Date().toISOString();
            if (!student.loginHistory) student.loginHistory = [];
            student.loginHistory.push(new Date().toISOString());
            updateStudentInStorage(student);
            
            currentStudent = student;
            
            // Save login session
            saveLoginSession(student.id);

            updateStudentDisplay(student);
            updateAccessStatus();
            
            if (student.subscription.active) {
                showStep(2);
            } else if (student.paymentStatus === 'pending') {
                showStep(4);
                document.getElementById('pendingApproval').style.display = 'block';
                document.getElementById('readyForUnlock').style.display = 'none';
            } else if (student.paymentStatus === 'approved') {
                showStep(4);
                document.getElementById('pendingApproval').style.display = 'none';
                document.getElementById('readyForUnlock').style.display = 'block';
            } else {
                showStep(2);
            }
            
            alert(`Welcome back, ${student.fullName.split(' ')[0]}!`);
        }

        function showStep(step) {
            for (let i = 1; i <= 4; i++) {
                document.getElementById('step' + i).style.display = 'none';
            }
            document.getElementById('step' + step).style.display = 'block';
        }

        function goToPayment() {
            showStep(3);
        }

        function goToAccount() {
            showStep(2);
        }

        // ==================== PAYMENT & WHATSAPP NOTIFICATION ====================
        function submitPayment() {
            if (!currentStudent) return;

            const paymentCode = document.getElementById('paymentCode').value.trim().toUpperCase();
            const paymentDate = document.getElementById('paymentDate').value;

            if (!paymentCode || !paymentDate) {
                alert('Please fill all payment details');
                return;
            }

            // Create payment
            const payment = {
                id: 'PAY_' + Date.now() + Math.random().toString(36).substr(2, 9),
                studentId: currentStudent.id,
                studentName: currentStudent.fullName,
                studentPhone: currentStudent.phone,
                studentEmail: currentStudent.email,
                studentUniversity: currentStudent.university,
                amount: 67,
                transactionCode: paymentCode,
                paymentDate,
                status: 'pending',
                submissionDate: new Date().toISOString(),
                whatsappNotificationSent: false
            };

            // Update student
            currentStudent.paymentStatus = 'pending';
            updateStudentInStorage(currentStudent);
            
            // Add payment
            payments.push(payment);
            saveToStorage();

            // Send WhatsApp notification to admin
            sendWhatsAppNotification(payment);

            showStep(4);
            alert('Payment submitted! Admin will review and send unlock code via WhatsApp.');
        }

        function sendWhatsAppNotification(payment) {
            const adminPhone = "254765098865";
            const message = `ðŸ“± *NEW PAYMENT SUBMISSION* ðŸ“±

ðŸ‘¤ *Student:* ${payment.studentName}
ðŸ“§ *Email:* ${payment.studentEmail}
ðŸ“ž *Phone:* ${payment.studentPhone}
ðŸŽ“ *University:* ${payment.studentUniversity}
ðŸ’° *Amount:* Ksh ${payment.amount}
ðŸ”¢ *Transaction Code:* ${payment.transactionCode}
ðŸ“… *Date:* ${new Date(payment.submissionDate).toLocaleString()}

Please review and approve at: ${window.location.href}`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/${adminPhone}?text=${encodedMessage}`;
            
            // Open WhatsApp in new tab
            window.open(whatsappURL, '_blank');
            
            // Mark notification as sent
            payment.whatsappNotificationSent = true;
            saveToStorage();
            
            alert('WhatsApp notification sent to admin!');
        }

        function verifyUnlockCode() {
            const inputCode = document.getElementById('unlockCodeInput').value.trim().toUpperCase();
            
            if (!inputCode) {
                alert('Please enter unlock code');
                return;
            }

            if (currentStudent.unlockCode === inputCode) {
                currentStudent.subscription = {
                    active: true,
                    startDate: new Date().toISOString(),
                    endDate: new Date(Date.now() + 5 * 30 * 24 * 60 * 60 * 1000).toISOString()
                };
                currentStudent.paymentStatus = 'approved';
                updateStudentInStorage(currentStudent);
                
                document.getElementById('readyForUnlock').style.display = 'none';
                document.getElementById('accessGranted').style.display = 'block';
                
                updateAccessStatus();
                alert('ðŸŽ‰ Account unlocked! All materials are now available.');
            } else {
                alert('Invalid unlock code');
            }
        }

        // ==================== DOCUMENTS SECTION ====================
        function loadDocuments() {
            const grid = document.getElementById('documentsGrid');
            if (!grid) return;

            let filteredDocs = [...documents];
            
            // Check access
            if (!currentStudent || !currentStudent.subscription.active) {
                grid.innerHTML = `
                    <div class="document-card" style="text-align: center; grid-column: 1 / -1; justify-content: center;">
                        <div class="doc-icon" style="margin: 0 auto 20px;">
                            <i class="fas fa-lock"></i>
                        </div>
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Access Locked</h4>
                        <p style="color: var(--gray); margin-bottom: 20px;">Subscribe to access premium university study materials</p>
                        <button class="btn btn-primary" onclick="switchTab('student')" style="margin-top: 20px;">
                            <i class="fas fa-crown"></i> Subscribe to Unlock
                        </button>
                    </div>
                `;
                return;
            }

            // Apply university filter
            if (currentUniversityFilter !== 'all') {
                filteredDocs = filteredDocs.filter(doc => 
                    doc.university === currentUniversityFilter || doc.university === 'All'
                );
            }

            // Apply search
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            if (searchTerm) {
                filteredDocs = filteredDocs.filter(doc => 
                    doc.title.toLowerCase().includes(searchTerm) ||
                    doc.unitCode.toLowerCase().includes(searchTerm) ||
                    doc.subject?.toLowerCase().includes(searchTerm)
                );
            }

            // Pagination
            const totalPages = Math.ceil(filteredDocs.length / docsPerPage);
            const startIndex = (currentPage - 1) * docsPerPage;
            const endIndex = startIndex + docsPerPage;
            const paginatedDocs = filteredDocs.slice(startIndex, endIndex);

            if (paginatedDocs.length === 0) {
                grid.innerHTML = `
                    <div class="document-card" style="text-align: center; grid-column: 1 / -1; justify-content: center;">
                        <div class="doc-icon" style="margin: 0 auto 20px;">
                            <i class="fas fa-search"></i>
                        </div>
                        <h4 style="color: var(--primary); margin-bottom: 15px;">No Documents Found</h4>
                        <p style="color: var(--gray);">Try changing your search or university filter</p>
                    </div>
                `;
                return;
            }

            // Display documents
            grid.innerHTML = paginatedDocs.map(doc => `
                <div class="document-card">
                    <div class="doc-icon">
                        ${getDocIcon(doc.type)}
                    </div>
                    <div class="doc-title" title="${doc.title}">${doc.title}</div>
                    <div class="doc-meta">
                        <strong>${doc.unitCode}</strong> â€¢ ${doc.university}
                        ${doc.year ? 'â€¢ Year ' + doc.year : ''}
                    </div>
                    <div class="doc-description">
                        ${doc.subject ? '<strong>Subject:</strong> ' + doc.subject + '<br>' : ''}
                        ${doc.description || 'Study material for ' + doc.unitCode}
                        ${doc.views ? `<br><small>ðŸ‘ï¸ ${doc.views} views</small>` : ''}
                    </div>
                    <div class="doc-actions">
                        <button class="btn btn-primary" onclick="openAdvancedViewer('${doc.id}')">
                            <i class="fas fa-eye"></i> View Document
                        </button>
                    </div>
                </div>
            `).join('');

            // Update pagination
            if (filteredDocs.length > docsPerPage) {
                document.getElementById('pagination').style.display = 'block';
                document.getElementById('currentPage').textContent = currentPage;
                document.getElementById('totalPages').textContent = totalPages;
            } else {
                document.getElementById('pagination').style.display = 'none';
            }
        }

        function getDocIcon(type) {
            switch(type) {
                case 'pdf': return '<i class="fas fa-file-pdf"></i>';
                case 'word': return '<i class="fas fa-file-word"></i>';
                case 'excel': return '<i class="fas fa-file-excel"></i>';
                case 'powerpoint': return '<i class="fas fa-file-powerpoint"></i>';
                case 'image': return '<i class="fas fa-file-image"></i>';
                case 'video': return '<i class="fas fa-file-video"></i>';
                default: return '<i class="fas fa-file-alt"></i>';
            }
        }

        function filterByUniversity(university) {
            currentUniversityFilter = university;
            currentPage = 1;
            
            // Update active button
            document.querySelectorAll('.university-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadDocuments();
        }

        function changePage(direction) {
            currentPage += direction;
            if (currentPage < 1) currentPage = 1;
            loadDocuments();
        }

        function updateAccessStatus() {
            const statusBar = document.getElementById('accessStatusBar');
            const statusText = document.getElementById('accessStatusText');
            
            if (currentStudent && currentStudent.subscription.active) {
                statusBar.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                statusBar.style.borderColor = 'var(--success)';
                statusText.innerHTML = '<i class="fas fa-unlock"></i> Access Granted';
                statusText.style.color = 'var(--success)';
                document.getElementById('subscribeBtnDocs').style.display = 'none';
            } else {
                statusBar.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
                statusBar.style.borderColor = 'var(--warning)';
                statusText.innerHTML = '<i class="fas fa-lock"></i> Access Locked';
                statusText.style.color = 'var(--danger)';
                document.getElementById('subscribeBtnDocs').style.display = 'inline-flex';
            }
        }

        // ==================== ADMIN FUNCTIONS ====================
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === adminPassword) {
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadAdminDashboard();
                loadPendingPayments();
                loadAllUsers();
                alert('Welcome to Admin Dashboard!');
            } else {
                alert('Invalid admin password');
            }
        }

        function adminLogout() {
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('adminPassword').value = 'admin123';
            alert('Admin logged out');
        }

        function loadAdminDashboard() {
            document.getElementById('totalUsers').textContent = students.length;
            document.getElementById('pendingApprovals').textContent = 
                payments.filter(p => p.status === 'pending').length;
            document.getElementById('totalDocuments').textContent = documents.length;
            
            const totalRevenue = payments
                .filter(p => p.status === 'approved')
                .reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('totalRevenue').textContent = `Ksh ${totalRevenue}`;
        }

        function loadPendingPayments() {
            const table = document.getElementById('pendingPaymentsTable');
            const pendingPayments = payments.filter(p => p.status === 'pending');
            
            if (pendingPayments.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--gray);">
                            No pending payments
                        </td>
                    </tr>
                `;
                return;
            }
            
            table.innerHTML = pendingPayments.map(payment => `
                <tr>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">${new Date(payment.submissionDate).toLocaleDateString()}</td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">
                        <strong>${payment.studentName}</strong>
                    </td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">${payment.studentPhone}</td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">${payment.studentUniversity}</td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);"><code>${payment.transactionCode}</code></td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);"><strong>Ksh ${payment.amount}</strong></td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">
                        <button onclick="viewStudentDetails('${payment.studentId}')" class="btn btn-primary btn-sm" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button onclick="approvePayment('${payment.id}')" class="btn btn-success btn-sm" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-check"></i> Approve
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function viewStudentDetails(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            selectedStudentId = studentId;
            
            document.getElementById('studentDetailsContent').innerHTML = `
                <div class="grid-2">
                    <div class="form-group">
                        <label>Full Name</label>
                        <div class="form-control" style="background: #f8fafc;">${student.fullName}</div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <div class="form-control" style="background: #f8fafc;">${student.email}</div>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <div class="form-control" style="background: #f8fafc;">${student.phone}</div>
                    </div>
                    <div class="form-group">
                        <label>University</label>
                        <div class="form-control" style="background: #f8fafc;">${student.university}</div>
                    </div>
                    <div class="form-group">
                        <label>Course</label>
                        <div class="form-control" style="background: #f8fafc;">${student.course}</div>
                    </div>
                    <div class="form-group">
                        <label>Year</label>
                        <div class="form-control" style="background: #f8fafc;">Year ${student.year}</div>
                    </div>
                    <div class="form-group">
                        <label>Registration Date</label>
                        <div class="form-control" style="background: #f8fafc;">${new Date(student.registrationDate).toLocaleDateString()}</div>
                    </div>
                    <div class="form-group">
                        <label>Last Login</label>
                        <div class="form-control" style="background: #f8fafc;">${student.lastLogin ? new Date(student.lastLogin).toLocaleString() : 'Never'}</div>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <div class="form-control" style="background: #f8fafc;">
                            ${student.subscription.active ? 
                                '<span style="color: var(--success);">Active Subscription</span>' : 
                                student.paymentStatus === 'pending' ?
                                '<span style="color: var(--warning);">Payment Pending</span>' :
                                '<span style="color: var(--danger);">Not Subscribed</span>'}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Force Logout Status</label>
                        <div class="form-control" style="background: #f8fafc;">
                            ${student.isForceLoggedOut ? 
                                '<span style="color: var(--danger);">Force Logged Out</span>' : 
                                '<span style="color: var(--success);">Active Session</span>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('studentDetailsModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }

        function closeStudentModal() {
            document.getElementById('studentDetailsModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            selectedStudentId = null;
        }

        function unlockStudentFromModal() {
            if (!selectedStudentId) return;
            approvePaymentForStudent(selectedStudentId);
            closeStudentModal();
        }

        function forceLogoutStudent() {
            if (!selectedStudentId) return;
            
            if (confirm('Are you sure you want to force logout this student? They will need to login again.')) {
                const student = students.find(s => s.id === selectedStudentId);
                if (student) {
                    student.isForceLoggedOut = true;
                    updateStudentInStorage(student);
                    
                    // If this is the current student, log them out
                    if (currentStudent && currentStudent.id === selectedStudentId) {
                        currentStudent = null;
                        clearLoginSession();
                        showStep(1);
                        updateAccessStatus();
                    }
                    
                    alert('Student has been force logged out.');
                    closeStudentModal();
                    loadAllUsers();
                }
            }
        }

        function approvePayment(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;

            // Generate unlock code
            const unlockCode = 'RV' + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Update payment
            payment.status = 'approved';
            payment.approvalDate = new Date().toISOString();
            payment.unlockCode = unlockCode;
            
            // Update student
            const student = students.find(s => s.id === payment.studentId);
            if (student) {
                student.paymentStatus = 'approved';
                student.unlockCode = unlockCode;
                updateStudentInStorage(student);
                
                // Send WhatsApp to student
                sendUnlockCodeToStudent(student, unlockCode);
            }
            
            saveToStorage();
            
            // Reload admin data
            loadPendingPayments();
            loadAllUsers();
            loadAdminDashboard();
            
            alert(`Payment approved! Unlock code sent to student: ${unlockCode}`);
        }

        function approvePaymentForStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            // Generate unlock code
            const unlockCode = 'RV' + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Update student
            student.paymentStatus = 'approved';
            student.unlockCode = unlockCode;
            student.subscription = {
                active: true,
                startDate: new Date().toISOString(),
                endDate: new Date(Date.now() + 5 * 30 * 24 * 60 * 60 * 1000).toISOString()
            };
            student.isForceLoggedOut = false; // Re-activate account
            
            updateStudentInStorage(student);
            
            // Send WhatsApp to student
            sendUnlockCodeToStudent(student, unlockCode);
            
            alert(`Student unlocked! Code sent: ${unlockCode}`);
        }

        function sendUnlockCodeToStudent(student, unlockCode) {
            const studentPhone = student.phone.startsWith('0') ? '254' + student.phone.substr(1) : student.phone;
            const message = `ðŸŽ‰ *PAYMENT APPROVED!* ðŸŽ‰

Dear ${student.fullName},

Your payment has been approved! Here is your unlock code:

ðŸ”‘ *Unlock Code:* ${unlockCode}

Go to RevisionVault Pro and enter this code to unlock full access to all study materials.

ðŸ“š Access: ${window.location.href}

Thank you for subscribing!
- RevisionVault Pro Team`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/${studentPhone}?text=${encodedMessage}`;
            
            // Open WhatsApp in new tab
            window.open(whatsappURL, '_blank');
        }

        function loadAllUsers() {
            const table = document.getElementById('allUsersTable');
            
            if (students.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--gray);">
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }
            
            table.innerHTML = students.map(student => `
                <tr>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">
                        <strong>${student.fullName}</strong>
                    </td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">${student.email}</td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">${student.phone}</td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">${student.university}</td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">
                        ${student.subscription.active ? 
                            '<span style="color: var(--success);">Active</span>' : 
                            student.paymentStatus === 'pending' ?
                            '<span style="color: var(--warning);">Pending</span>' :
                            '<span style="color: var(--danger);">Inactive</span>'}
                    </td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">
                        ${student.lastLogin ? new Date(student.lastLogin).toLocaleDateString() : 'Never'}
                    </td>
                    <td style="padding: 15px; border-bottom: 1px solid var(--border);">
                        <button onclick="viewStudentDetails('${student.id}')" class="btn btn-primary btn-sm" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="adminUnlockStudent('${student.id}')" class="btn btn-success btn-sm" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-unlock"></i>
                        </button>
                        ${student.isForceLoggedOut ? 
                            `<button onclick="adminReactivateStudent('${student.id}')" class="btn btn-info btn-sm" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-power-off"></i>
                            </button>` : 
                            `<button onclick="adminForceLogout('${student.id}')" class="btn btn-danger btn-sm" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>`}
                    </td>
                </tr>
            `).join('');
        }

        function adminUnlockStudent(studentId) {
            if (confirm('Are you sure you want to unlock this student?')) {
                approvePaymentForStudent(studentId);
            }
        }

        function adminForceLogout(studentId) {
            if (confirm('Force logout this student? They will need to login again.')) {
                const student = students.find(s => s.id === studentId);
                if (student) {
                    student.isForceLoggedOut = true;
                    updateStudentInStorage(student);
                    loadAllUsers();
                    alert('Student force logged out.');
                }
            }
        }

        function adminReactivateStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                student.isForceLoggedOut = false;
                updateStudentInStorage(student);
                loadAllUsers();
                alert('Student account reactivated.');
            }
        }

        function uploadDocument() {
            const title = document.getElementById('docTitle').value.trim();
            const unitCode = document.getElementById('docUnitCode').value.trim().toUpperCase();
            const university = document.getElementById('docUniversity').value;
            const docType = document.getElementById('docType').value;
            const url = document.getElementById('docUrl').value.trim();
            
            if (!title || !unitCode || !university || !docType || !url) {
                alert('Please fill all required fields');
                return;
            }

            const document = {
                id: 'DOC_' + Date.now() + Math.random().toString(36).substr(2, 9),
                title,
                unitCode,
                university,
                type: docType,
                subject: document.getElementById('docSubject').value.trim(),
                year: document.getElementById('docYear').value,
                description: document.getElementById('docDescription').value.trim(),
                url,
                uploadDate: new Date().toISOString(),
                views: 0,
                lastAccessed: null
            };

            documents.push(document);
            saveToStorage();
            
            // Clear form
            document.getElementById('docTitle').value = '';
            document.getElementById('docUnitCode').value = '';
            document.getElementById('docUniversity').value = '';
            document.getElementById('docType').value = '';
            document.getElementById('docSubject').value = '';
            document.getElementById('docDescription').value = '';
            document.getElementById('docUrl').value = '';
            
            alert('Document uploaded successfully!');
            loadAdminDashboard();
        }

        function toggleLinkFields() {
            const docType = document.getElementById('docType').value;
            const urlField = document.getElementById('docUrl');
            
            switch(docType) {
                case 'pdf':
                    urlField.placeholder = 'https://example.com/document.pdf';
                    break;
                case 'image':
                    urlField.placeholder = 'https://example.com/image.jpg';
                    break;
                case 'word':
                    urlField.placeholder = 'https://example.com/document.docx';
                    break;
                case 'excel':
                    urlField.placeholder = 'https://example.com/spreadsheet.xlsx';
                    break;
                case 'powerpoint':
                    urlField.placeholder = 'https://example.com/presentation.pptx';
                    break;
                default:
                    urlField.placeholder = 'Enter document URL';
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function updateStudentDisplay(student) {
            document.getElementById('accountName').textContent = student.fullName;
            document.getElementById('accountEmail').textContent = student.email;
            document.getElementById('accountPhone').textContent = student.phone;
            document.getElementById('accountUniversity').textContent = student.university;
            document.getElementById('accountCourse').textContent = student.course;
            document.getElementById('accountYear').textContent = 'Year ' + student.year;
            
            if (student.subscription.active) {
                document.getElementById('subscriptionStatus').innerHTML = `
                    <div style="padding: 15px; background: #d1fae5; border-radius: 8px; display: inline-block;">
                        <i class="fas fa-unlock" style="color: var(--success);"></i>
                        <span style="color: var(--success); font-weight: 600;">Subscription Active</span>
                    </div>
                `;
            } else if (student.paymentStatus === 'pending') {
                document.getElementById('subscriptionStatus').innerHTML = `
                    <div style="padding: 15px; background: #fef3c7; border-radius: 8px; display: inline-block;">
                        <i class="fas fa-clock" style="color: var(--warning);"></i>
                        <span style="color: var(--warning); font-weight: 600;">Payment Under Review</span>
                    </div>
                `;
            } else {
                document.getElementById('subscriptionStatus').innerHTML = `
                    <div style="padding: 15px; background: #fee2e2; border-radius: 8px; display: inline-block;">
                        <i class="fas fa-lock" style="color: var(--danger);"></i>
                        <span style="color: var(--danger); font-weight: 600;">Not Subscribed</span>
                    </div>
                `;
            }
        }

        function updateStudentInStorage(student) {
            const index = students.findIndex(s => s.id === student.id);
            if (index !== -1) {
                students[index] = student;
                saveToStorage();
            }
        }

        function saveToStorage() {
            localStorage.setItem('revisionvault_students', JSON.stringify(students));
            localStorage.setItem('revisionvault_payments', JSON.stringify(payments));
            localStorage.setItem('revisionvault_documents', JSON.stringify(documents));
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (tabName === 'documents') {
                loadDocuments();
            }
        }

        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').style.display = 'block';
        }

        // ==================== INITIALIZE ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loading
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Check persistent login
                if (!checkPersistentLogin()) {
                    showStep(1);
                }
                
                // Load sample documents if empty
                if (documents.length === 0) {
                    loadSampleDocuments();
                }
                
                // Set today's date in payment form
                const today = new Date().toISOString().split('T')[0];
                if (document.getElementById('paymentDate')) {
                    document.getElementById('paymentDate').value = today;
                }
                
                // Setup search
                document.getElementById('searchInput')?.addEventListener('input', loadDocuments);
                
                // Setup keyboard shortcuts for document viewer
                document.addEventListener('keydown', function(e) {
                    if (document.getElementById('advancedViewer').style.display === 'flex') {
                        switch(e.key) {
                            case 'Escape':
                                closeAdvancedViewer();
                                break;
                            case '+':
                            case '=':
                                zoomIn();
                                break;
                            case '-':
                                zoomOut();
                                break;
                            case 'ArrowLeft':
                                prevPage();
                                break;
                            case 'ArrowRight':
                                nextPage();
                                break;
                            case '0':
                                resetZoom();
                                break;
                        }
                    }
                });
                
                alert('Welcome to RevisionVault Pro!');
            }, 1000);
        });

        function loadSampleDocuments() {
            const sampleDocs = [
                {
                    id: 'DOC_1',
                    title: 'Introduction to Botany - Complete Notes',
                    unitCode: 'BOTA241',
                    university: 'University of Nairobi',
                    type: 'pdf',
                    subject: 'Botany',
                    year: '2',
                    description: 'Comprehensive notes covering all botany concepts with diagrams and illustrations.',
                    url: 'https://drive.google.com/file/d/1sJ4z6X8Y9qA0rT7bV2cN3mD4eF5gH6/preview',
                    uploadDate: new Date().toISOString(),
                    views: 45
                },
                {
                    id: 'DOC_2',
                    title: 'Computer Networks Fundamentals',
                    unitCode: 'CS401',
                    university: 'JKUAT',
                    type: 'pdf',
                    subject: 'Computer Science',
                    year: '4',
                    description: 'Advanced computer networking concepts, protocols, and implementation.',
                    url: 'https://drive.google.com/file/d/1sJ4z6X8Y9qA0rT7bV2cN3mD4eF5gH7/preview',
                    uploadDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                    views: 32
                },
                {
                    id: 'DOC_3',
                    title: 'Financial Accounting Principles',
                    unitCode: 'ACC101',
                    university: 'Kenyatta University',
                    type: 'pdf',
                    subject: 'Accounting',
                    year: '1',
                    description: 'Introduction to financial accounting principles and practices.',
                    url: 'https://drive.google.com/file/d/1sJ4z6X8Y9qA0rT7bV2cN3mD4eF5gH8/preview',
                    uploadDate: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(),
                    views: 78
                },
                {
                    id: 'DOC_4',
                    title: 'Agricultural Economics Notes',
                    unitCode: 'AGE201',
                    university: 'University of Eldoret',
                    type: 'pdf',
                    subject: 'Agriculture',
                    year: '2',
                    description: 'Economic principles applied to agricultural systems and management.',
                    url: 'https://drive.google.com/file/d/1sJ4z6X8Y9qA0rT7bV2cN3mD4eF5gH9/preview',
                    uploadDate: new Date().toISOString(),
                    views: 23
                }
            ];
            
            documents = [...sampleDocs];
            saveToStorage();
        }
    </script>
</body>
</html>